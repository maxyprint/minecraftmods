
/**
 * YPrint Custom Checkout System - Teil 1: Hauptshortcode
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Hauptshortcode für das gesamte Checkout-Layout
 */
function yprint_checkout_shortcode() {
    if (!function_exists('WC')) {
        return '<div class="yprint-error-message">WooCommerce ist nicht aktiviert.</div>';
    }

   // Überprüfen, ob Warenkorb leer ist
$cart_empty = WC()->cart->is_empty();

    // Checkout-Kommunikationssystem einbinden
    ob_start();
    echo do_shortcode('[yprint_checkout_communication]');
    
    ?>
    <div class="yprint-checkout-container">
        <div class="yprint-back-button-container">
            <a href="javascript:history.back()" class="yprint-back-button">← Zurück</a>
        </div>
        <div class="yprint-checkout-columns">

            <!-- Linke Spalte: Adressen und Zahlungsoptionen -->
            <div class="yprint-checkout-left">
                <div class="yprint-checkout-section">
                    <h2 class="yprint-section-title">Lieferadresse</h2>
                    <?php echo do_shortcode('[yprint_shipping_address]'); ?>
                </div>

                <div class="yprint-checkout-section">
                    <h2 class="yprint-section-title">Zahlungsmethode</h2>
                    <?php echo do_shortcode('[yprint_payment_options]'); ?>
                </div>
            </div>

            <!-- Rechte Spalte: Bestellübersicht und Checkout-Button -->
            <div class="yprint-checkout-right">
                <div class="yprint-checkout-section yprint-order-summary-section">
                    <?php echo do_shortcode('[yprint_order_summary]'); ?>
                </div>

                <div class="yprint-checkout-section">
                    <?php echo do_shortcode('[yprint_coupon_buy]'); ?>
                </div>
                
                <div class="yprint-checkout-section">
                    <?php echo do_shortcode('[yprint_different_billing]'); ?>
                </div>

                <!-- Datenschutz-Checkbox -->
                <div class="yprint-checkout-section yprint-privacy-section">
                    <div class="yprint-checkbox-group">
                        <input type="checkbox" id="privacy_checkbox" name="privacy_checkbox" required>
                        <label for="privacy_checkbox">Ich habe die <a href="https://yprint.de/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und akzeptiere diese.</label>
                    </div>
                    <div id="privacy_error" class="yprint-field-error" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <?php
    
    // Checkout-CSS und JavaScript einbinden
    yprint_checkout_scripts_and_styles();
    
    return ob_get_clean();
}
add_shortcode('yprint_checkout', 'yprint_checkout_shortcode');

/**
 * CSS und JavaScript für den Checkout
 */
function yprint_checkout_scripts_and_styles() {
    ?>
    <style>
    .yprint-checkout-container {
        font-family: 'Roboto', -apple-system, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        justify-content: center;
    }

    .yprint-checkout-columns {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .yprint-checkout-left {
        flex: 1 1 50%;
        min-width: 300px;
    }

    .yprint-checkout-right {
        flex: 1 1 45%;
        min-width: 300px;
    }

    .yprint-checkout-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .yprint-section-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1d1d1f;
    }

    .yprint-checkbox-group {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .yprint-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 3px;
    }

    .yprint-checkbox-group label {
        font-size: 14px;
        line-height: 1.4;
        color: #1d1d1f;
    }

    .yprint-checkbox-group a {
        color: #0079FF;
        text-decoration: none;
    }

    .yprint-checkbox-group a:hover {
        text-decoration: underline;
    }

    .yprint-field-error {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .yprint-empty-cart-message, 
    .yprint-error-message {
        text-align: center;
        padding: 50px 20px;
        font-size: 18px;
    }

    .yprint-empty-cart-message a {
        color: #0079FF;
        text-decoration: none;
    }

    .yprint-validation-feedback {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        display: none;
    }

    .yprint-validation-feedback.error {
        background-color: #fff2f2;
        border: 1px solid #ffcdd2;
        color: #d32f2f;
    }

    .yprint-validation-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
    }

    .yprint-validation-item::before {
        content: "•";
        color: #d32f2f;
    }

    .yprint-back-button-container {
    margin-bottom: 20px;
}

.yprint-back-button {
    display: inline-flex;
    align-items: center;
    color: #0079FF;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
}

.yprint-back-button:hover {
    color: #0068e1;
}

    @media (max-width: 768px) {
        .yprint-checkout-columns {
            flex-direction: column;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        // Datenschutz-Validierung
        $(document).on('click', '#yprint_checkout_submit', function(e) {
            // Datenschutz-Checkbox prüfen
            if (!$('#privacy_checkbox').is(':checked')) {
                e.preventDefault();
                $('#privacy_error').text('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.').show();
                
                $('html, body').animate({
                    scrollTop: $('.yprint-privacy-section').offset().top - 100
                }, 500);
                
                return false;
            } else {
                $('#privacy_error').hide();
            }
        });
        
        // Fehlermeldung bei Änderung der Checkbox entfernen
        $('#privacy_checkbox').on('change', function() {
            if ($(this).is(':checked')) {
                $('#privacy_error').hide();
            }
        });
    });
    </script>
    <?php
}

/**
 * YPrint Checkout Communication System
 * 
 * System für die Datenkoordination zwischen den Shortcodes im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Checkout-Kommunikationssystem Shortcode
 */
function yprint_checkout_communication_shortcode() {
    ob_start();
    ?>
    <script>
    // YPrint Checkout Communication System
    const YPrintCheckoutSystem = {
        // Zentraler Datenspeicher
        state: {
            shippingAddress: {},
            billingAddress: {},
            differentBilling: { enabled: false },
            differentBillingAddress: {},
            paymentMethod: {},
            couponCode: {}
        },

        // Initialisierung
        init: function() {
            this.initializeState();
            this.setupEventListeners();
        },

        // Initialen State aus WooCommerce laden
        initializeState: function() {
            const user_id = '<?php echo get_current_user_id(); ?>';
            
            // AJAX-Aufruf um initiale Daten zu laden
            jQuery.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_get_checkout_state',
                    user_id: user_id,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: (response) => {
                    if (response.success) {
                        // Stellen sicher, dass different_billing immer als deaktiviert geladen wird
                        const data = {...response.data};
                        if (data.differentBilling) {
                            data.differentBilling.enabled = false;
                        }
                        this.state = {...this.state, ...data};
                        this.updateAllFields();
                        this.notifyStateChange();
                    }
                }
            });
        },

        // Event Listener Setup
        setupEventListeners: function() {
            const $ = jQuery;
            
            // Shipping Address Events
            $(document).on('change', '.yprint-shipping-field', (e) => {
                const field = e.target.name.replace('shipping_', '');
                const value = e.target.value;
                this.updateState('shippingAddress', {
                    [field]: value
                });
            });

            // Different Billing Events
            $(document).on('change', '#different_billing', (e) => {
                this.updateState('differentBilling', {
                    enabled: e.target.checked
                });
            });

            // Different Billing Address Events
            $(document).on('change', '.yprint-billing-field', (e) => {
                const field = e.target.name;
                const value = e.target.value;
                this.updateState('differentBillingAddress', {
                    [field]: value
                });
            });

            // Payment Method Events
            $(document).on('change', '[name="payment_method"]', (e) => {
                this.updateState('paymentMethod', {
                    method: e.target.value,
                    timestamp: Date.now()
                });
            });

            // Coupon Events
            $(document).on('change', '#coupon_code', (e) => {
                this.updateState('couponCode', {
                    code: e.target.value
                });
            });
        },

        // State Updates
        updateState: function(section, data) {
            if (!this.state[section]) {
                this.state[section] = {};
            }
            
            // Aktualisiere den jeweiligen Abschnitt im State
            this.state[section] = {
                ...this.state[section],
                ...data
            };
            
            this.saveState();
            this.notifyStateChange();
        },

        // Speichern des States
        saveState: function() {
            jQuery.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_checkout_state',
                    state: this.state,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: (response) => {
                    if (response.success) {
                        console.log('State saved successfully');
                    }
                }
            });
        },

        // Benachrichtigung über State-Änderungen
        notifyStateChange: function() {
            jQuery(document).trigger('checkoutStateUpdate', [this.state]);
        },

        // Formularvalidierung
        validateForm: function() {
            let isValid = true;
            const errors = [];
            
            // Validiere Lieferadresse
            if (!this.state.shippingAddress || !this.state.shippingAddress.address_1) {
                isValid = false;
                errors.push('Bitte gib eine Lieferadresse an');
            }
            
            // Validiere Zahlungsmethode
            if (!this.state.paymentMethod || !this.state.paymentMethod.method) {
                isValid = false;
                errors.push('Bitte wähle eine Zahlungsmethode aus');
            }

            // Validiere abweichende Rechnungsadresse falls aktiviert
            if (this.state.differentBilling && this.state.differentBilling.enabled) {
                if (!this.state.differentBillingAddress || !this.state.differentBillingAddress.different_billing_address_1) {
                    isValid = false;
                    errors.push('Bitte gib eine abweichende Rechnungsadresse an');
                }
            }
            
            return {
                isValid: isValid,
                errors: errors
            };
        },

        // State abrufen
        getState: function() {
            return this.state;
        },

        // Formulardaten sammeln
        getFormData: function() {
            return {
                shipping_address: this.state.shippingAddress,
                billing_address: this.state.billingAddress,
                different_billing: this.state.differentBilling ? this.state.differentBilling.enabled : false,
                different_billing_address: this.state.differentBillingAddress,
                payment_method: this.state.paymentMethod ? this.state.paymentMethod.method : '',
                coupon_code: this.state.couponCode ? this.state.couponCode.code : ''
            };
        },

        // Alle Felder aktualisieren
        updateAllFields: function() {
            const $ = jQuery;
            
            // Shipping Address Felder
            if (this.state.shippingAddress) {
                Object.entries(this.state.shippingAddress).forEach(([field, value]) => {
                    if (field !== 'slot' && field !== 'address' && field !== 'field') {
                        $(`[name="shipping_${field}"]`).val(value);
                    }
                });
            }

            // Different Billing Checkbox
            if (this.state.differentBilling && this.state.differentBilling.enabled !== undefined) {
                $('#different_billing').prop('checked', this.state.differentBilling.enabled);
                
                // Zeige/verstecke abweichende Adressfelder
                if (this.state.differentBilling.enabled) {
                    $('#different_billing_fields').show();
                } else {
                    $('#different_billing_fields').hide();
                }
            }

            // Different Billing Address Felder
            if (this.state.differentBillingAddress) {
                Object.entries(this.state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }

            // Payment Method
            if (this.state.paymentMethod && this.state.paymentMethod.method) {
                const paymentMethod = this.state.paymentMethod.method;
                $(`[name="payment_method"][value="${paymentMethod}"]`)
                    .prop('checked', true)
                    .closest('.yprint-payment-option')
                    .addClass('selected');
            }

            // Coupon Code
            if (this.state.couponCode && this.state.couponCode.code) {
                $('#coupon_code').val(this.state.couponCode.code);
            }
        },

        // Checkout-Prozess starten
        processCheckout: function() {
        const $ = jQuery;
        const checkoutData = this.getFormData();
        
        // Überprüfen, ob Privatsphäre-Checkbox aktiviert ist
        if (!$('#privacy_checkbox').is(':checked')) {
            $('#privacy_error').text('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.').show();
            
            $('html, body').animate({
                scrollTop: $('.yprint-privacy-section').offset().top - 100
            }, 500);
            
            return;
        }

        // Validierung vor dem Absenden
        const validation = this.validateForm();
        if (!validation.isValid) {
            // Fehler anzeigen
            $('.yprint-validation-feedback')
                .empty()
                .addClass('error');
                
            validation.errors.forEach(error => {
                $('.yprint-validation-feedback').append(
                    $('<div class="yprint-validation-item"></div>').text(error)
                );
            });
            
            $('.yprint-validation-feedback').show();
            
            $('html, body').animate({
                scrollTop: $('.yprint-validation-feedback').offset().top - 100
            }, 500);
            
            return;
        }

        // Loading-State aktivieren
        $('#yprint_checkout_submit').addClass('loading');
        $('.yprint-validation-feedback').hide();
        
        // Debug-Ausgabe der Daten
        console.log('Checkout data being sent:', checkoutData);
        
        // Zahlungsmethode überprüfen für Validierung
        const paymentMethod = checkoutData.payment_method;
        
        // Erst temporäre Bestellung vorbereiten, aber noch nicht finalisieren
        $.ajax({
            type: 'POST',
            url: '<?php echo admin_url("admin-ajax.php"); ?>',
            data: {
                action: 'yprint_prepare_order',
                checkout_data: checkoutData,
                security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
            },
            success: (prepareResponse) => {
                if (prepareResponse.success) {
                    console.log('Order vorbereitet:', prepareResponse.data);
                    
                    // Temporäre Bestellungs-ID speichern
                    const tempOrderId = prepareResponse.data.temp_order_id;
                    
                    // Jetzt Zahlungsprozess beginnen
                    this.processPayment(paymentMethod, checkoutData, tempOrderId, function(paymentResult) {
                        if (paymentResult.success) {
                            // Zahlungsverarbeitung erfolgreich, Bestellung finalisieren
                            $.ajax({
                                type: 'POST',
                                url: '<?php echo admin_url("admin-ajax.php"); ?>',
                                data: {
                                    action: 'yprint_finalize_order',
                                    temp_order_id: tempOrderId,
                                    payment_id: paymentResult.payment_id,
                                    payment_method: paymentMethod,
                                    security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
                                },
                                success: function(response) {
                                    console.log('Finalize response:', response);
                                    
                                    if (response.success) {
                                        // Weiterleitung zur Thank You Seite
                                        window.location.href = response.data.redirect;
                                    } else {
                                        // Fehleranzeige
                                        $('.yprint-validation-feedback')
                                            .empty()
                                            .addClass('error')
                                            .append($('<div class="yprint-validation-item"></div>')
                                            .text(response.data.message || 'Ein Fehler ist aufgetreten beim Finalisieren der Bestellung.'))
                                            .show();
                                        
                                        $('#yprint_checkout_submit').removeClass('loading');
                                        
                                        $('html, body').animate({
                                            scrollTop: $('.yprint-validation-feedback').offset().top - 100
                                        }, 500);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('AJAX-Fehler:', xhr.responseText, status, error);
                                    
                                    // Fehlerdetails anzeigen wenn vorhanden
                                    let errorMessage = 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.';
                                    try {
                                        const response = JSON.parse(xhr.responseText);
                                        if (response && response.data && response.data.message) {
                                            errorMessage = response.data.message;
                                        }
                                    } catch (e) {
                                        console.error('Fehler beim Parsen der Antwort:', e);
                                    }
                                    
                                    // Allgemeiner Fehler
                                    $('.yprint-validation-feedback')
                                        .empty()
                                        .addClass('error')
                                        .append($('<div class="yprint-validation-item"></div>')
                                        .text(errorMessage))
                                        .show();
                                    
                                    $('#yprint_checkout_submit').removeClass('loading');
                                }
                            });
                        } else {
                            // Zahlungsverifizierung fehlgeschlagen
                            $('.yprint-validation-feedback')
                                .empty()
                                .addClass('error')
                                .append($('<div class="yprint-validation-item"></div>')
                                .text(paymentResult.message || 'Die Zahlung konnte nicht bestätigt werden. Bitte versuchen Sie es erneut oder wählen Sie eine andere Zahlungsmethode.'))
                                .show();
                            
                            $('#yprint_checkout_submit').removeClass('loading');
                            
                            $('html, body').animate({
                                scrollTop: $('.yprint-validation-feedback').offset().top - 100
                            }, 500);
                        }
                    });
                } else {
                    // Fehler bei der Vorbereitung der Bestellung
                    $('.yprint-validation-feedback')
                        .empty()
                        .addClass('error')
                        .append($('<div class="yprint-validation-item"></div>')
                        .text(prepareResponse.data.message || 'Fehler bei der Vorbereitung der Bestellung.'))
                        .show();
                    
                    $('#yprint_checkout_submit').removeClass('loading');
                    
                    $('html, body').animate({
                        scrollTop: $('.yprint-validation-feedback').offset().top - 100
                    }, 500);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX-Fehler:', xhr.responseText, status, error);
                
                // Allgemeiner Fehler
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text('Ein Fehler ist aufgetreten bei der Vorbereitung der Bestellung.'))
                    .show();
                
                $('#yprint_checkout_submit').removeClass('loading');
            }
        });
    },

    // Zahlungsvalidierung
    validatePayment: function(paymentMethod, checkoutData, callback) {
        const $ = jQuery;
        
        // Je nach Zahlungsart verschiedene Validierungen durchführen
        if (paymentMethod.includes('paypal')) {
            // PayPal Validierung mit API
            this.validatePayPalPayment(checkoutData, callback);
        } else if (paymentMethod.includes('stripe') || paymentMethod.includes('apple_pay') || paymentMethod.includes('google_pay') || paymentMethod.includes('credit')) {
            // Stripe Validierung mit API
            this.validateStripePayment(checkoutData, callback);
        } else if (paymentMethod.includes('sepa') || paymentMethod.includes('lastschrift')) {
            // SEPA/Lastschrift Validierung
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_validate_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data.validated) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                },
                error: function() {
                    callback(false);
                }
            });
        } else if (paymentMethod.includes('bacs') || paymentMethod.includes('bank')) {
            // Überweisung benötigt keine Echtzeit-Validierung
            callback(true);
        } else {
            // Standardvalidierung für andere Zahlungsmethoden
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_validate_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data.validated) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                },
                error: function() {
                    callback(false);
                }
            });
        }
    },
    
    // Zahlungsverarbeitung - neue Methode
    processPayment: function(paymentMethod, checkoutData, tempOrderId, callback) {
        const $ = jQuery;
        
        // Je nach Zahlungsart verschiedene Verarbeitungen durchführen
        if (paymentMethod.includes('paypal')) {
            // PayPal Verarbeitung
            this.processPayPalPayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('stripe') || paymentMethod.includes('apple_pay') || paymentMethod.includes('google_pay') || paymentMethod.includes('credit')) {
            // Stripe Verarbeitung
            this.processStripePayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('sepa') || paymentMethod.includes('lastschrift')) {
            // SEPA/Lastschrift Verarbeitung
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_process_sepa_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        callback({
                            success: true,
                            payment_id: response.data.payment_id || 'sepa_direct'
                        });
                    } else {
                        callback({
                            success: false,
                            message: response.data.message || 'SEPA-Zahlung konnte nicht verarbeitet werden.'
                        });
                    }
                },
                error: function() {
                    callback({
                        success: false,
                        message: 'Fehler bei der SEPA-Zahlungsverarbeitung.'
                    });
                }
            });
        } else if (paymentMethod.includes('bacs') || paymentMethod.includes('bank')) {
            // Überweisung benötigt keine direkte Verarbeitung
            callback({
                success: true,
                payment_id: 'bank_transfer_' + Date.now()
            });
        } else {
            // Standardverarbeitung für andere Zahlungsmethoden
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_process_standard_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        callback({
                            success: true,
                            payment_id: response.data.payment_id || 'standard_' + Date.now()
                        });
                    } else {
                        callback({
                            success: false,
                            message: response.data.message || 'Zahlung konnte nicht verarbeitet werden.'
                        });
                    }
                },
                error: function() {
                    callback({
                        success: false,
                        message: 'Fehler bei der Zahlungsverarbeitung.'
                    });
                }
            });
        }
    },
    
    // Zahlungsverarbeitung - neue Methode
    processPayment: function(paymentMethod, checkoutData, tempOrderId, callback) {
        const $ = jQuery;
        
        // Je nach Zahlungsart verschiedene Verarbeitungen durchführen
        if (paymentMethod.includes('paypal')) {
            // PayPal Verarbeitung
            this.processPayPalPayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('stripe') || paymentMethod.includes('apple_pay') || paymentMethod.includes('google_pay') || paymentMethod.includes('credit')) {
            // Stripe Verarbeitung
            this.processStripePayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('sepa') || paymentMethod.includes('lastschrift')) {
            // SEPA/Lastschrift Verarbeitung
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_process_sepa_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        callback({
                            success: true,
                            payment_id: response.data.payment_id || 'sepa_direct'
                        });
                    } else {
                        callback({
                            success: false,
                            message: response.data.message || 'SEPA-Zahlung konnte nicht verarbeitet werden.'
                        });
                    }
                },
                error: function() {
                    callback({
                        success: false,
                        message: 'Fehler bei der SEPA-Zahlungsverarbeitung.'
                    });
                }
            });
        } else if (paymentMethod.includes('bacs') || paymentMethod.includes('bank')) {
            // Überweisung benötigt keine direkte Verarbeitung
            callback({
                success: true,
                payment_id: 'bank_transfer_' + Date.now()
            });
        } else {
            // Standardverarbeitung für andere Zahlungsmethoden
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_process_standard_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce('yprint-c
    
    // PayPal Zahlungsvalidierung (für alte Funktionalität, wird nicht mehr direkt genutzt)
validatePayPalPayment: function(checkoutData, callback) {
    callback(true); // Nur für Abwärtskompatibilität
},

// PayPal Zahlungsverarbeitung - neue Methode
processPayPalPayment: function(checkoutData, tempOrderId, callback) {
    const $ = jQuery;
    
    // PayPal-Session initialisieren
    $.ajax({
        type: 'POST',
        url: '<?php echo admin_url('admin-ajax.php'); ?>',
        data: {
            action: 'yprint_init_paypal_payment',
            checkout_data: checkoutData,
            temp_order_id: tempOrderId,
            security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
        },
        success: function(response) {
            if (response.success && response.data.paypal_order_id) {
                // PayPal-Zahlung initiiert, jetzt PayPal-Modal öffnen
                const paypalOrderId = response.data.paypal_order_id;
                
                // PayPal Modal öffnen mit zugewiesener Order ID
                paypal.Buttons({
                    fundingSource: paypal.FUNDING.PAYPAL,
                    createOrder: function() {
                        return paypalOrderId; // Wir geben die bereits erstellte Order ID zurück
                    },
                    onApprove: function(data, actions) {
                        // Zahlung wurde von Benutzer genehmigt, abschließen
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('success')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('PayPal-Zahlung wird verarbeitet...'))
                            .show();
                            
                        // Zahlung bestätigen
                        $.ajax({
                            type: 'POST',
                            url: '<?php echo admin_url('admin-ajax.php'); ?>',
                            data: {
                                action: 'yprint_capture_paypal_payment',
                                paypal_order_id: paypalOrderId,
                                temp_order_id: tempOrderId,
                                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                            },
                            success: function(captureResponse) {
                                if (captureResponse.success) {
                                    // PayPal-Modal schließen
                                    $('#yprint-paypal-modal').hide();
                                    
                                    callback({
                                        success: true,
                                        payment_id: captureResponse.data.transaction_id || paypalOrderId
                                    });
                                } else {
                                    $('.yprint-validation-feedback')
                                        .empty()
                                        .addClass('error')
                                        .append($('<div class="yprint-validation-item"></div>')
                                        .text(captureResponse.data.message || 'Fehler bei der PayPal-Zahlung'))
                                        .show();
                                        
                                    callback({
                                        success: false,
                                        message: captureResponse.data.message || 'Fehler bei der PayPal-Zahlung'
                                    });
                                }
                            },
                            error: function() {
                                $('.yprint-validation-feedback')
                                    .empty()
                                    .addClass('error')
                                    .append($('<div class="yprint-validation-item"></div>')
                                    .text('Fehler bei der PayPal-Zahlungsverarbeitung'))
                                    .show();
                                    
                                callback({
                                    success: false,
                                    message: 'Fehler bei der PayPal-Zahlungsverarbeitung'
                                });
                            }
                        });
                    },
                    onCancel: function() {
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('error')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('PayPal-Zahlung wurde abgebrochen'))
                            .show();
                            
                        callback({
                            success: false,
                            message: 'PayPal-Zahlung wurde abgebrochen'
                        });
                    },
                    onError: function(err) {
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('error')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('Fehler bei der PayPal-Zahlung: ' + err))
                            .show();
                            
                        callback({
                            success: false,
                            message: 'Fehler bei der PayPal-Zahlung: ' + err
                        });
                    }
                }).render('#paypal-button-container');
                
                // PayPal-Modal anzeigen
                $('#yprint-paypal-modal').show();
            } else {
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text(response.data.message || 'Fehler bei der Initialisierung der PayPal-Zahlung'))
                    .show();
                    
                callback({
                    success: false,
                    message: response.data.message || 'Fehler bei der Initialisierung der PayPal-Zahlung'
                });
            }
        },
        error: function() {
            $('.yprint-validation-feedback')
                .empty()
                .addClass('error')
                .append($('<div class="yprint-validation-item"></div>')
                .text('Fehler bei der Verbindung mit dem Zahlungsserver'))
                .show();
                
            callback({
                success: false,
                message: 'Fehler bei der Verbindung mit dem Zahlungsserver'
            });
        }
    });
},
    
    // Stripe Zahlungsvalidierung (für alte Funktionalität, wird nicht mehr direkt genutzt)
    validateStripePayment: function(checkoutData, callback) {
        callback(true); // Nur für Abwärtskompatibilität
    },
    
    // Stripe Zahlungsverarbeitung - neue Methode
    processStripePayment: function(checkoutData, tempOrderId, callback) {
        const $ = jQuery;
        
        // Stripe-Session initialisieren
        $.ajax({
            type: 'POST',
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            data: {
                action: 'yprint_init_stripe_payment',
                checkout_data: checkoutData,
                temp_order_id: tempOrderId,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                if (response.success && response.data.client_secret) {
                    // Stripe Session initialisiert
                    const clientSecret = response.data.client_secret;
                    const paymentIntentId = response.data.payment_intent_id;
                    
                    // Stripe Elements anzeigen
                    $('#yprint-stripe-modal').show();
                    
                    // Stripe Elements initialisieren, falls noch nicht geschehen
                    if (!window.stripeElements) {
                        const stripe = Stripe('<?php echo get_option('yprint_stripe_public_key', 'pk_live_51QomI4Efl8wKMoZvo59c44NsSuDkXqUtgvqg5qpTU5D7JmJf5XGfM8wNli25KpAAhrbPf2O0gjXNg3hWCtxpyG9G00Dxkv5oxL'); ?>');
                        const elements = stripe.elements({
                            clientSecret: clientSecret,
                            appearance: {
                                theme: 'stripe',
                                variables: {
                                    colorPrimary: '#0079FF',
                                    colorBackground: '#ffffff',
                                    colorText: '#1d1d1f',
                                    colorDanger: '#dc3545',
                                    fontFamily: 'Roboto, sans-serif',
                                    borderRadius: '4px'
                                }
                            }
                        });
                        
                        // Payment Element erstellen und mounten
                        const paymentElement = elements.create('payment');
                        paymentElement.mount('#yprint-stripe-payment-element');
                        
                        // Stripe-Formular abschicken
                        document.getElementById('yprint-stripe-payment-form').addEventListener('submit', function(event) {
                            event.preventDefault();
                            
                            // Bestätigen-Button deaktivieren und Ladeanimation anzeigen
                            $('#yprint-stripe-submit').prop('disabled', true).addClass('loading');
                            
                            stripe.confirmPayment({
                                elements,
                                confirmParams: {
                                    return_url: '<?php echo home_url('/stripe-return'); ?>',
                                },
                                redirect: 'if_required'
                            }).then(function(result) {
                                if (result.error) {
                                    // Fehler anzeigen
                                    $('.yprint-stripe-error-message').text(result.error.message).show();
                                    $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                    
                                    callback({
                                        success: false,
                                        message: result.error.message
                                    });
                                } else {
                                    // Zahlung erfolgreich, Bestellung bestätigen
                                    $.ajax({
                                        type: 'POST',
                                        url: '<?php echo admin_url('admin-ajax.php'); ?>',
                                        data: {
                                            action: 'yprint_confirm_stripe_payment',
                                            payment_intent: result.paymentIntent.id,
                                            temp_order_id: tempOrderId,
                                            security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                                        },
                                        success: function(confirmResponse) {
                                            if (confirmResponse.success) {
                                                $('#yprint-stripe-modal').hide();
                                                
                                                callback({
                                                    success: true,
                                                    payment_id: result.paymentIntent.id
                                                });
                                            } else {
                                                $('.yprint-stripe-error-message').text(confirmResponse.data.message || 'Fehler bei der Zahlungsbestätigung').show();
                                                $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                                
                                                callback({
                                                    success: false,
                                                    message: confirmResponse.data.message || 'Fehler bei der Zahlungsbestätigung'
                                                });
                                            }
                                        },
                                        error: function() {
                                            $('.yprint-stripe-error-message').text('Verbindungsfehler bei der Zahlungsbestätigung').show();
                                            $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                            
                                            callback({
                                                success: false,
                                                message: 'Verbindungsfehler bei der Zahlungsbestätigung'
                                            });
                                        }
                                    });
                                }
                            });
                        });
                        
                        // Schließen-Button
                        $('#yprint-stripe-modal-close').on('click', function() {
                            $('#yprint-stripe-modal').hide();
                            
                            callback({
                                success: false,
                                message: 'Zahlungsvorgang abgebrochen'
                            });
                        });
                        
                        // Speichern für späteren Zugriff
                        window.stripeElements = {
                            stripe: stripe,
                            elements: elements
                        };
                    } else {
                        // Elements bereits initialisiert, aktualisieren
                        window.stripeElements.elements.update({
                            clientSecret: clientSecret
                        });
                    }
                } else {
                    $('.yprint-validation-feedback')
                        .empty()
                        .addClass('error')
                        .append($('<div class="yprint-validation-item"></div>')
                        .text(response.data.message || 'Fehler bei der Initialisierung der Stripe-Zahlung'))
                        .show();
                        
                    callback({
                        success: false,
                        message: response.data.message || 'Fehler bei der Initialisierung der Stripe-Zahlung'
                    });
                }
            },
            error: function() {
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text('Fehler bei der Verbindung mit dem Zahlungsserver'))
                    .show();
                    
                callback({
                    success: false,
                    message: 'Fehler bei der Verbindung mit dem Zahlungsserver'
                });
            }
        });
    };

    // System initialisieren
    jQuery(document).ready(function() {
        YPrintCheckoutSystem.init();
    });
    </script>
    
    <!-- Validierungsfeedback Element -->
    <div class="yprint-validation-feedback" style="display: none;"></div>
    
    <!-- PayPal Modal -->
    <div id="yprint-paypal-modal" class="yprint-payment-modal" style="display: none;">
        <div class="yprint-modal-content">
            <div class="yprint-modal-header">
                <h3>PayPal Zahlung</h3>
                <span class="yprint-modal-close" id="yprint-paypal-modal-close">&times;</span>
            </div>
            <div class="yprint-modal-body">
                <p>Bitte schließen Sie Ihre Zahlung mit PayPal ab:</p>
                <div id="paypal-button-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Stripe Modal -->
    <div id="yprint-stripe-modal" class="yprint-payment-modal" style="display: none;">
        <div class="yprint-modal-content">
            <div class="yprint-modal-header">
                <h3>Kreditkartenzahlung</h3>
                <span class="yprint-modal-close" id="yprint-stripe-modal-close">&times;</span>
            </div>
            <div class="yprint-modal-body">
                <form id="yprint-stripe-payment-form">
                    <div id="yprint-stripe-payment-element"></div>
                    <div class="yprint-stripe-error-message" style="display: none;"></div>
                    <button id="yprint-stripe-submit" type="submit">
                        <span class="yprint-button-text">Zahlung bestätigen</span>
                        <div class="yprint-button-loader" style="display: none;">
                            <div class="yprint-loader-spinner"></div>
                        </div>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-payment-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto;
    }
    
    .yprint-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .yprint-modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .yprint-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #1d1d1f;
    }
    
    .yprint-modal-close {
        color: #aaa;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .yprint-modal-close:hover {
        color: #555;
    }
    
    .yprint-modal-body {
        padding: 20px;
    }
    
    #yprint-stripe-payment-form {
        width: 100%;
    }
    
    #yprint-stripe-payment-element {
        margin-bottom: 20px;
    }
    
    .yprint-stripe-error-message {
        color: #dc3545;
        margin-bottom: 15px;
        padding: 8px 12px;
        background-color: #f8d7da;
        border-radius: 4px;
    }
    
    #yprint-stripe-submit {
        width: 100%;
        padding: 12px;
        background-color: #0079FF;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
    }
    
    #yprint-stripe-submit:hover {
        background-color: #0068e1;
    }
    
    #yprint-stripe-submit:disabled {
        background-color: #a0a0a0;
        cursor: not-allowed;
    }
    
    #yprint-stripe-submit.loading .yprint-button-text {
        visibility: hidden;
    }
    
    #yprint-stripe-submit.loading .yprint-button-loader {
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    #paypal-button-container {
        width: 100%;
        min-height: 60px;
        margin-top: 20px;
    }
    </style>
    
    <!-- PayPal SDK einbinden -->
    <script src="https://www.paypal.com/sdk/js?client-id=<?php echo get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB'); ?>&currency=EUR&intent=capture"></script>
    
    <!-- Stripe JS einbinden -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
    jQuery(document).ready(function($) {
        // PayPal Modal schließen
        $('#yprint-paypal-modal-close').on('click', function() {
            $('#yprint-paypal-modal').hide();
        });
        
        // Schließen bei Klick außerhalb des Modals
        $(window).on('click', function(event) {
            if ($(event.target).hasClass('yprint-payment-modal')) {
                $('.yprint-payment-modal').hide();
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_checkout_communication', 'yprint_checkout_communication_shortcode');

/**
 * YPrint Checkout AJAX-Handler
 * 
 * Handler für AJAX-Anfragen des Checkout-Systems
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * AJAX-Handler für initiale Checkout-Daten
 */
function yprint_get_checkout_state() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = isset($_POST['user_id']) ? intval($_POST['user_id']) : 0;
    
    if (function_exists('WC')) {
        // Kundendaten abrufen
        if ($user_id) {
            $customer = new WC_Customer($user_id);
            
            // Shipping Address
            $shipping = array(
                'first_name' => $customer->get_shipping_first_name(),
                'last_name' => $customer->get_shipping_last_name(),
                'address_1' => $customer->get_shipping_address_1(),
                'address_2' => $customer->get_shipping_address_2(),
                'postcode' => $customer->get_shipping_postcode(),
                'city' => $customer->get_shipping_city(),
                'country' => $customer->get_shipping_country() ?: 'DE'
            );
            
            // Billing Address
            $billing = array(
                'first_name' => $customer->get_billing_first_name(),
                'last_name' => $customer->get_billing_last_name(),
                'email' => $customer->get_billing_email(),
                'address_1' => $customer->get_billing_address_1(),
                'address_2' => $customer->get_billing_address_2(),
                'postcode' => $customer->get_billing_postcode(),
                'city' => $customer->get_billing_city(),
                'country' => $customer->get_billing_country() ?: 'DE'
            );
            
            // State zusammenbauen
            $state = array(
                'shippingAddress' => $shipping,
                'billingAddress' => $billing,
                'differentBilling' => array(
                    'enabled' => get_user_meta($user_id, 'different_billing_enabled', true) ?: false
                ),
                'paymentMethod' => array(
                    'method' => WC()->session ? WC()->session->get('chosen_payment_method') : ''
                ),
                'couponCode' => array(
                    'code' => ''
                )
            );
        } else {
            // Fallback für nicht eingeloggte Benutzer
            $state = array(
                'shippingAddress' => array('country' => 'DE'),
                'billingAddress' => array('country' => 'DE'),
                'differentBilling' => array('enabled' => false),
                'paymentMethod' => array('method' => ''),
                'couponCode' => array('code' => '')
            );
        }
        
        // Session-Daten überschreiben falls vorhanden
        if (WC()->session) {
            $session_state = WC()->session->get('yprint_checkout_state');
            if ($session_state) {
                $state = wp_parse_args($session_state, $state);
            }
        }
        
        wp_send_json_success($state);
    } else {
        wp_send_json_error('WooCommerce ist nicht aktiviert');
    }
}
add_action('wp_ajax_yprint_get_checkout_state', 'yprint_get_checkout_state');
add_action('wp_ajax_nopriv_yprint_get_checkout_state', 'yprint_get_checkout_state');

/**
 * AJAX-Handler für State-Speicherung
 */
function yprint_save_checkout_state() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (isset($_POST['state'])) {
        $state = $_POST['state'];
        $user_id = get_current_user_id();
        
        // State in user_meta speichern falls Benutzer eingeloggt ist
        if ($user_id) {
            update_user_meta($user_id, 'yprint_checkout_state', $state);
        }
        
        // State in WooCommerce Session speichern
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_checkout_state', $state);
        }
        
        wp_send_json_success();
    } else {
        wp_send_json_error('Keine Daten zum Speichern vorhanden');
    }
}
add_action('wp_ajax_yprint_save_checkout_state', 'yprint_save_checkout_state');
add_action('wp_ajax_nopriv_yprint_save_checkout_state', 'yprint_save_checkout_state');

/**
 * AJAX-Handler für Checkout-Prozess
 */
function yprint_process_checkout() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $payment_verified = isset($_POST['payment_verified']) && $_POST['payment_verified'] === 'true';
    
    // Validierung der Daten
    $errors = array();
    
    // Lieferadresse prüfen
    if (empty($checkout_data['shipping_address']) || empty($checkout_data['shipping_address']['address_1'])) {
        $errors[] = 'Bitte gib eine Lieferadresse an';
    }
    
    // Zahlungsmethode prüfen
    if (empty($checkout_data['payment_method'])) {
        $errors[] = 'Bitte wähle eine Zahlungsmethode aus';
    }
    
    // Abweichende Rechnungsadresse prüfen wenn aktiviert
$different_billing_enabled = isset($checkout_data['different_billing']) && 
($checkout_data['different_billing'] === true || 
 $checkout_data['different_billing'] === 'true' || 
 $checkout_data['different_billing'] === 1 || 
 $checkout_data['different_billing'] === '1');

error_log('Different billing value: ' . print_r($checkout_data['different_billing'], true));
error_log('Different billing enabled: ' . ($different_billing_enabled ? 'true' : 'false'));

if ($different_billing_enabled) {
$has_different_billing_address = !empty($checkout_data['different_billing_address']) && 
        !empty($checkout_data['different_billing_address']['different_billing_address_1']);
        
if (!$has_different_billing_address) {
$errors[] = 'Bitte gib eine abweichende Rechnungsadresse an';
}
}
    
    // Bei Fehlern abbrechen
    if (!empty($errors)) {
        wp_send_json_error(array(
            'message' => implode(', ', $errors)
        ));
        return;
    }

    try {
        // Daten in WooCommerce Session speichern
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_checkout_data', $checkout_data);
            
            // Zahlungsmethode in WooCommerce Session speichern
            if (!empty($checkout_data['payment_method'])) {
                WC()->session->set('chosen_payment_method', $checkout_data['payment_method']);
            }
            
            // Gutscheincode anwenden falls vorhanden
            if (!empty($checkout_data['coupon_code'])) {
                $coupon_code = sanitize_text_field($checkout_data['coupon_code']);
                if (!WC()->cart->has_discount($coupon_code)) {
                    WC()->cart->apply_coupon($coupon_code);
                }
            }
            
            // Kundendaten speichern, wenn angemeldet
            $user_id = get_current_user_id();
            if ($user_id > 0 && !empty($checkout_data['shipping_address'])) {
                foreach ($checkout_data['shipping_address'] as $key => $value) {
                    if ($key !== 'slot' && $key !== 'timestamp') {
                        update_user_meta($user_id, 'shipping_' . $key, sanitize_text_field($value));
                    }
                }
            }
            
            // Bestellung erstellen
$order_id = create_woocommerce_order($checkout_data);

if ($order_id) {
    // Zahlungsstatus speichern
    update_post_meta($order_id, '_payment_verified', $payment_verified);

    // Zahlungsart speichern
    if (!empty($checkout_data['payment_method'])) {
        update_post_meta($order_id, '_payment_method', sanitize_text_field($checkout_data['payment_method']));
    }
    
    // Zur individuellen Thank You Page weiterleiten
    $redirect_url = 'https://yprint.de/thank-you/';
    
    // Warenkorb leeren
    WC()->cart->empty_cart();
    
    wp_send_json_success(array(
        'redirect' => $redirect_url
    ));
} else {
    wp_send_json_error(array(
        'message' => 'Die Bestellung konnte nicht erstellt werden.'
    ));
}

        } else {
            throw new Exception('WooCommerce Session ist nicht verfügbar');
        }
    } catch (Exception $e) {
        error_log('YPrint Checkout Error: ' . $e->getMessage());
        wp_send_json_error(array(
            'message' => 'Ein technischer Fehler ist aufgetreten: ' . $e->getMessage()
        ));
    }
}

add_action('wp_ajax_yprint_process_checkout', 'yprint_process_checkout');
add_action('wp_ajax_nopriv_yprint_process_checkout', 'yprint_process_checkout');

/**
 * AJAX-Handler für Zahlungsvalidierung (allgemein)
 */
function yprint_validate_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_method']) || empty($_POST['payment_method'])) {
        wp_send_json_error(array(
            'message' => 'Keine Zahlungsmethode angegeben'
        ));
        return;
    }
    
    $payment_method = sanitize_text_field($_POST['payment_method']);
    $checkout_data = isset($_POST['checkout_data']) ? $_POST['checkout_data'] : array();
    
    // Zahlungsabwicklung je nach Zahlungsmethode (für Methoden ohne API-Integration)
    if (strpos($payment_method, 'sepa') !== false || strpos($payment_method, 'lastschrift') !== false) {
        // SEPA/Lastschrift Validierung - hier würde die echte Integration erfolgen
        $validated = true; // Für Testzwecke
    } else {
        // Standard-Validierung für andere Zahlungsmethoden
        $validated = true; // Für Testzwecke
    }
    
    if ($validated) {
        wp_send_json_success(array(
            'validated' => true,
            'message' => 'Zahlung erfolgreich validiert'
        ));
    } else {
        wp_send_json_error(array(
            'validated' => false,
            'message' => 'Zahlung konnte nicht validiert werden'
        ));
    }
}
add_action('wp_ajax_yprint_validate_payment', 'yprint_validate_payment');
add_action('wp_ajax_nopriv_yprint_validate_payment', 'yprint_validate_payment');

/**
 * AJAX-Handler zur Initialisierung einer PayPal-Zahlung
 */
function yprint_init_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    
    try {
        // Temporäre Bestellung erstellen
        $temp_order_id = yprint_create_temp_order($checkout_data);
        
        if (!$temp_order_id) {
            throw new Exception('Fehler beim Erstellen der temporären Bestellung');
        }
        
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // WooCommerce Order abrufen
        $order = wc_get_order($temp_order_id);
        
        // Order-Daten für PayPal vorbereiten
        $request = new \PayPalCheckoutSdk\Orders\OrdersCreateRequest();
        $request->prefer('return=representation');
        
        // Währung abrufen
        $currency = get_woocommerce_currency();
        $request->body = [
            'intent' => 'CAPTURE',
            'purchase_units' => [
                [
                    'reference_id' => $temp_order_id,
                    'description' => 'Bestellung bei YPrint',
                    'amount' => [
                        'currency_code' => $currency,
                        'value' => number_format($order->get_total(), 2, '.', ''),
                        'breakdown' => [
                            'item_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_subtotal(), 2, '.', '')
                            ],
                            'shipping' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_shipping_total(), 2, '.', '')
                            ],
                            'tax_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_total_tax(), 2, '.', '')
                            ],
                            'discount' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_discount_total(), 2, '.', '')
                            ]
                        ]
                    ]
                ]
            ],
            'application_context' => [
                'brand_name' => 'YPrint',
                'user_action' => 'PAY_NOW',
                'return_url' => home_url('/paypal-return'),
                'cancel_url' => home_url('/checkout')
            ]
        ];
        
        // PayPal Order erstellen
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201) {
            // Order ID in Meta speichern
            update_post_meta($temp_order_id, '_paypal_order_id', $response->result->id);
            
            wp_send_json_success(array(
                'paypal_order_id' => $response->result->id,
                'temp_order_id' => $temp_order_id
            ));
        } else {
            throw new Exception('Fehler bei der Kommunikation mit PayPal');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der PayPal-Initialisierung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_init_paypal_payment', 'yprint_init_paypal_payment');
add_action('wp_ajax_nopriv_yprint_init_paypal_payment', 'yprint_init_paypal_payment');

/**
 * AJAX-Handler zur Erfassung einer PayPal-Zahlung
 */
function yprint_capture_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // Zahlung erfassen
        $request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201 || $response->statusCode === 200) {
            // Bestellstatus aktualisieren
            $order = wc_get_order($temp_order_id);
            
            if ($order) {
                // Bestellstatus auf "processing" setzen
                $order->update_status('processing', 'Zahlung mit PayPal erfolgreich erhalten.');
                
                // PayPal-Transaktions-ID speichern
                if (isset($response->result->purchase_units[0]->payments->captures[0]->id)) {
                    $transaction_id = $response->result->purchase_units[0]->payments->captures[0]->id;
                    $order->set_transaction_id($transaction_id);
                    $order->add_order_note("PayPal Transaktion ID: " . $transaction_id);
                }
                
                $order->save();
                
                // Warenkorb leeren
                WC()->cart->empty_cart();
                
                wp_send_json_success(array(
                    'message' => 'Zahlung erfolgreich erfasst',
                    'order_id' => $temp_order_id,
                    'redirect' => $order->get_checkout_order_received_url()
                ));
            } else {
                throw new Exception('Bestellung konnte nicht gefunden werden');
            }
        } else {
            throw new Exception('Fehler bei der Zahlungserfassung');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Capture Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungserfassung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_capture_paypal_payment', 'yprint_capture_paypal_payment');
add_action('wp_ajax_nopriv_yprint_capture_paypal_payment', 'yprint_capture_paypal_payment');

/**
 * AJAX-Handler zur Initialisierung einer Stripe-Zahlung
 */
function yprint_init_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    
    try {
        // Temporäre Bestellung erstellen
        $temp_order_id = yprint_create_temp_order($checkout_data);
        
        if (!$temp_order_id) {
            throw new Exception('Fehler beim Erstellen der temporären Bestellung');
        }
        
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // WooCommerce Order abrufen
        $order = wc_get_order($temp_order_id);
        
        // Kundenadresse
        $customer_info = array(
            'address' => array(
                'line1' => $order->get_billing_address_1(),
                'line2' => $order->get_billing_address_2(),
                'city' => $order->get_billing_city(),
                'postal_code' => $order->get_billing_postcode(),
                'country' => $order->get_billing_country()
            ),
            'email' => $order->get_billing_email(),
            'name' => $order->get_formatted_billing_full_name(),
            'phone' => $order->get_billing_phone()
        );
        
        // Währung abrufen
        $currency = strtolower(get_woocommerce_currency());
        
        // Betrag in Cents/Kleinsten Einheiten
        $amount = intval($order->get_total() * 100);
        
        // Stripe Payment Intent erstellen
        $payment_intent_args = array(
            'amount' => $amount,
            'currency' => $currency,
            'payment_method_types' => ['card'],
            'description' => 'Bestellung #' . $order->get_order_number() . ' auf YPrint',
            'metadata' => array(
                'order_id' => $temp_order_id,
                'customer_name' => $customer_info['name'],
                'customer_email' => $customer_info['email']
            ),
            'receipt_email' => $customer_info['email']
        );
        
        // Stripe API aufrufen
        $response = \WC_Stripe_API::request($payment_intent_args, 'payment_intents');
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        if (empty($response->id) || empty($response->client_secret)) {
            throw new Exception('Ungültige Antwort von Stripe');
        }
        
        // Payment Intent ID in Order Meta speichern
        update_post_meta($temp_order_id, '_stripe_payment_intent', $response->id);
        
        wp_send_json_success(array(
            'client_secret' => $response->client_secret,
            'payment_intent_id' => $response->id,
            'temp_order_id' => $temp_order_id
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Stripe-Initialisierung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_init_stripe_payment', 'yprint_init_stripe_payment');
add_action('wp_ajax_nopriv_yprint_init_stripe_payment', 'yprint_init_stripe_payment');

/**
 * AJAX-Handler zur Bestätigung einer Stripe-Zahlung
 */
function yprint_confirm_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_intent']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $payment_intent_id = sanitize_text_field($_POST['payment_intent']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Payment Intent Status prüfen
        $response = \WC_Stripe_API::retrieve('payment_intents/' . $payment_intent_id);
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        // Prüfen, ob Payment Intent zum Order passt
        $stored_payment_intent = get_post_meta($temp_order_id, '_stripe_payment_intent', true);
        
        if ($stored_payment_intent !== $payment_intent_id) {
            throw new Exception('Payment Intent stimmt nicht mit Bestellung überein');
        }
        
        // Prüfen, ob Zahlung erfolgreich war
        if ($response->status !== 'succeeded') {
            throw new Exception('Zahlung wurde nicht erfolgreich abgeschlossen');
        }
        
        // Bestellstatus aktualisieren
        $order = wc_get_order($temp_order_id);
        
        if ($order) {
            // Bestellstatus auf "processing" setzen
            $order->update_status('processing', 'Zahlung mit Stripe erfolgreich erhalten.');
            
            // Stripe-Transaktions-ID speichern
            $charge_id = isset($response->charges->data[0]->id) ? $response->charges->data[0]->id : $payment_intent_id;
            $order->set_transaction_id($charge_id);
            $order->add_order_note("Stripe Zahlung erfolgreich (ID: " . $charge_id . ")");
            
            $order->save();
            
            // Warenkorb leeren
            WC()->cart->empty_cart();
            
            wp_send_json_success(array(
                'message' => 'Zahlung erfolgreich bestätigt',
                'order_id' => $temp_order_id,
                'redirect' => $order->get_checkout_order_received_url()
            ));
        } else {
            throw new Exception('Bestellung konnte nicht gefunden werden');
        }
    } catch (Exception $e) {
        error_log('YPrint Stripe Confirm Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungsbestätigung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_confirm_stripe_payment', 'yprint_confirm_stripe_payment');
add_action('wp_ajax_nopriv_yprint_confirm_stripe_payment', 'yprint_confirm_stripe_payment');

/**
 * Hilfsfunktion: Temporäre WooCommerce-Bestellung erstellen
 */
function yprint_create_temp_order($checkout_data) {
    try {
        // Neues WooCommerce Order-Objekt erstellen
        $order = wc_create_order();
        
        // Benutzer zuweisen, falls angemeldet
        $user_id = get_current_user_id();
        if ($user_id > 0) {
            $order->set_customer_id($user_id);
        }
        
        // Warenkorb-Produkte zur Bestellung hinzufügen
        foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
            $product = $cart_item['data'];
            $quantity = $cart_item['quantity'];
            
            // Produkt zur Bestellung hinzufügen
            $order->add_product($product, $quantity);
        }
        
        // Shipping-Methode hinzufügen
        if (WC()->session && WC()->session->get('chosen_shipping_methods')) {
            $chosen_shipping_methods = WC()->session->get('chosen_shipping_methods');
            $shipping_rate = new WC_Shipping_Rate('flat_rate', 'Versand', WC()->cart->get_shipping_total(), array(), 'flat_rate');
            $order->add_shipping($shipping_rate);
        }
        
        // Adressen setzen
        if (isset($checkout_data['shipping_address'])) {
            $order->set_shipping_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_shipping_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_shipping_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_shipping_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_shipping_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_shipping_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_shipping_country($checkout_data['shipping_address']['country'] ?? 'DE');
        }
        
        // Billing-Adresse setzen (entweder von different_billing oder von shipping kopieren)
        if (isset($checkout_data['different_billing']) && $checkout_data['different_billing'] === true && isset($checkout_data['different_billing_address'])) {
            $order->set_billing_first_name($checkout_data['different_billing_address']['different_billing_first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['different_billing_address']['different_billing_last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['different_billing_address']['different_billing_address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['different_billing_address']['different_billing_address_2'] ?? '');
            $order->set_billing_city($checkout_data['different_billing_address']['different_billing_city'] ?? '');
            $order->set_billing_postcode($checkout_data['different_billing_address']['different_billing_postcode'] ?? '');
            $order->set_billing_country($checkout_data['different_billing_address']['different_billing_country'] ?? 'DE');
            $order->set_billing_email($checkout_data['different_billing_address']['different_billing_email'] ?? '');
        } else if (isset($checkout_data['shipping_address'])) {
            $order->set_billing_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_billing_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_billing_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_billing_country($checkout_data['shipping_address']['country'] ?? 'DE');
            
            // E-Mail-Adresse aus Benutzeraccount oder Session
            if ($user_id > 0) {
                $user = get_userdata($user_id);
                $order->set_billing_email($user->user_email);
            } else if (WC()->session && WC()->session->get('customer') && WC()->session->get('customer')['email']) {
                $order->set_billing_email(WC()->session->get('customer')['email']);
            }
        }
        
        // Zahlungsmethode setzen
        if (isset($checkout_data['payment_method'])) {
            $order->set_payment_method($checkout_data['payment_method']);
            $order->set_payment_method_title(yprint_get_payment_method_title($checkout_data['payment_method']));
        }
        
        // Gutschein anwenden, falls vorhanden
        if (isset($checkout_data['coupon_code']) && !empty($checkout_data['coupon_code'])) {
            $coupon_code = sanitize_text_field($checkout_data['coupon_code']);
            $coupon = new WC_Coupon($coupon_code);
            
            if ($coupon->is_valid()) {
                $order->apply_coupon($coupon_code);
            }
        }
        
        // Bestellung speichern
        $order->calculate_totals();
        $order->update_status('pending', 'Bestellung über YPrint-Checkout erstellt.');
        
        // Bestellungs-ID zurückgeben
        return $order->get_id();
    } catch (Exception $e) {
        error_log('YPrint Checkout - Fehler bei Bestellerstellung: ' . $e->getMessage());
        return false;
    }
}

/**
 * Hilfsfunktion: Zahlungsmethoden-Titel abrufen
 */
function yprint_get_payment_method_title($payment_method) {
    $payment_gateways = WC()->payment_gateways()->payment_gateways();
    
    if (isset($payment_gateways[$payment_method])) {
        return $payment_gateways[$payment_method]->get_title();
    }
    
    // Fallback-Titel
    if (strpos($payment_method, 'paypal') !== false) {
        return 'PayPal';
    } elseif (strpos($payment_method, 'stripe') !== false) {
        return 'Kreditkarte (Stripe)';
    } elseif (strpos($payment_method, 'credit') !== false) {
        return 'Kreditkarte';
    } elseif (strpos($payment_method, 'bacs') !== false) {
        return 'Überweisung';
    } elseif (strpos($payment_method, 'sepa') !== false) {
        return 'SEPA-Lastschrift';
    }
    
    return 'Unbekannte Zahlungsmethode';
}

/**
 * AJAX-Handler für Zahlungsmethoden-Updates
 */
function yprint_update_payment_method() {
    if (!isset($_POST['payment_method'])) {
        wp_send_json_error('Keine Zahlungsmethode angegeben');
        return;
    }

    $payment_method = sanitize_text_field($_POST['payment_method']);
    
    // WooCommerce Session aktualisieren
    if (function_exists('WC') && WC()->session) {
        WC()->session->set('chosen_payment_method', $payment_method);
    }
    
    wp_send_json_success();
}
add_action('wp_ajax_yprint_update_payment_method', 'yprint_update_payment_method');
add_action('wp_ajax_nopriv_yprint_update_payment_method', 'yprint_update_payment_method');

/**
 * YPrint Shipping Address Shortcode
 * 
 * Shortcode für die Lieferadresse im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für die Lieferadresse
 */
function yprint_shipping_address_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    $user_id = get_current_user_id();
    
    // Primäre Adresse abrufen
    $customer = new WC_Customer($user_id);
    $primary_address = [
        'first_name' => $customer->get_shipping_first_name(),
        'last_name' => $customer->get_shipping_last_name(),
        'address_1' => $customer->get_shipping_address_1(),
        'address_2' => $customer->get_shipping_address_2(),
        'postcode' => $customer->get_shipping_postcode(),
        'city' => $customer->get_shipping_city(),
        'country' => $customer->get_shipping_country()
    ];

    // Zusätzliche Adressen abrufen
    $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: [];
    
    // Aktuelle ausgewählte Adresse
    $current_slot = WC()->session ? WC()->session->get('yprint_selected_shipping_slot') : 'primary';
    if (!$current_slot) {
        $current_slot = 'primary';
    }

    ob_start();
    ?>
    <div class="yprint-shipping-address">
        <div class="yprint-address-selector">
            <h3>Lieferadresse auswählen</h3>
            <div class="yprint-address-slots">
                <!-- Primäre Adresse -->
                <div class="yprint-address-slot <?php echo ($current_slot === 'primary') ? 'active' : ''; ?>" 
                     data-slot="primary">
                    <span class="yprint-slot-title">Meine Lieferanschrift</span>
                    <?php if (!empty($primary_address['address_1'])): ?>
                    <span class="yprint-slot-preview">
                        <?php echo esc_html($primary_address['address_1'] . ', ' . $primary_address['postcode'] . ' ' . $primary_address['city']); ?>
                    </span>
                    <?php endif; ?>
                </div>

                <!-- Zusätzliche Adressen -->
                <?php foreach ($secondary_addresses as $index => $address): ?>
                    <div class="yprint-address-slot <?php echo ($current_slot === 'secondary_' . $index) ? 'active' : ''; ?>" 
                         data-slot="secondary_<?php echo $index; ?>">
                        <span class="yprint-slot-title">Lieferanschrift <?php echo ($index + 2); ?></span>
                        <?php if (!empty($address['address_1'])): ?>
                        <span class="yprint-slot-preview">
                            <?php echo esc_html($address['address_1'] . ', ' . $address['postcode'] . ' ' . $address['city']); ?>
                        </span>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>

                <!-- Neue Adresse Button -->
                <?php if (count($secondary_addresses) < 2): ?>
                    <div class="yprint-address-slot yprint-new-slot" data-slot="new">
                        <span class="yprint-slot-title">+ Neue Lieferanschrift</span>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <div class="yprint-form-section">
            <input type="hidden" name="current_address_slot" id="current_address_slot" value="<?php echo esc_attr($current_slot); ?>">
            
            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_first_name" 
                       class="yprint-shipping-field"
                       placeholder="Vorname"
                       required>
                
                <input type="text" 
                       name="shipping_last_name" 
                       class="yprint-shipping-field"
                       placeholder="Name"
                       required>
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_address_1" 
                       class="yprint-shipping-field"
                       placeholder="Straße"
                       required>
                
                <input type="text" 
                       name="shipping_address_2" 
                       class="yprint-shipping-field"
                       placeholder="Hausnummer"
                       required>
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_postcode" 
                       class="yprint-shipping-field"
                       placeholder="PLZ"
                       required>
                
                <input type="text" 
                       name="shipping_city" 
                       class="yprint-shipping-field"
                       placeholder="Ort"
                       required>
            </div>

            <div class="yprint-form-row">
                <select name="shipping_country" class="yprint-shipping-field" required>
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_shipping_countries();
                    $default_country = $primary_address['country'] ?: $countries_obj->get_base_country();
                    
                    foreach ($countries as $code => $name) {
                        echo '<option value="' . esc_attr($code) . '" ' . 
                             selected($default_country, $code, false) . '>' . 
                             esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-shipping-address {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-address-selector {
        margin-bottom: 30px;
    }

    .yprint-address-selector h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
    }

    .yprint-address-slots {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .yprint-address-slot {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #333;
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
    }

    .yprint-slot-title {
        font-weight: 500;
        margin-bottom: 5px;
    }

    .yprint-slot-preview {
        font-size: 0.9em;
        color: #666;
    }

    .yprint-address-slot:hover {
        border-color: #2997FF;
        color: #2997FF;
    }

    .yprint-address-slot.active {
        border-color: #2997FF;
        background: #f0f6ff;
    }

    .yprint-new-slot {
        border-style: dashed;
        color: #2997FF;
        justify-content: center;
        align-items: center;
    }

    .yprint-form-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .yprint-form-row {
        display: flex;
        gap: 15px;
    }

    .yprint-form-row input,
    .yprint-form-row select {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1rem;
        background-color: #FFF;
        transition: all 0.3s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .yprint-form-row select {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px;
        cursor: pointer;
    }

    .yprint-form-row input:focus,
    .yprint-form-row select:focus {
        border-color: #2997FF;
        box-shadow: 0 0 0 2px rgba(41, 151, 255, 0.1);
        outline: none;
    }

    .yprint-form-row input:hover,
    .yprint-form-row select:hover {
        border-color: #aaa;
    }

    .yprint-form-row select::-ms-expand {
        display: none;
    }

    .yprint-form-row input.error {
        border-color: #dc3545;
    }

    @media (max-width: 600px) {
        .yprint-form-row {
            flex-direction: column;
        }
        
        .yprint-settings-content {
            padding: 15px 0;
        }

        .yprint-address-slot {
            min-width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const primaryAddress = <?php echo json_encode($primary_address); ?>;
        const secondaryAddresses = <?php echo json_encode($secondary_addresses); ?>;
        let currentSlot = '<?php echo esc_js($current_slot); ?>';

        // Adressdaten laden
        function loadAddressData(slot) {
            let addressData;
            
            if (slot === 'primary') {
                addressData = primaryAddress;
            } else if (slot === 'new') {
                $('.yprint-shipping-field').val('');
                return;
            } else {
                const index = slot.replace('secondary_', '');
                addressData = secondaryAddresses[index] || {};
            }

            // Felder füllen
            Object.entries(addressData).forEach(([key, value]) => {
                $(`[name="shipping_${key}"]`).val(value);
            });

            // YPrintCheckoutSystem aktualisieren
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('shippingAddress', {
                    slot: slot,
                    ...addressData
                });
            }
        }
        // Initiale Adresse laden
        loadAddressData(currentSlot);

        // Adress-Slot Auswahl
        $('.yprint-address-slot').click(function() {
            const slot = $(this).data('slot');
            
            $('.yprint-address-slot').removeClass('active');
            $(this).addClass('active');
            
            currentSlot = slot;
            $('#current_address_slot').val(slot);
            
            loadAddressData(slot);

            // Session aktualisieren
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_update_shipping_slot',
                    slot: slot,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        });

        // Feldänderungen
        $('.yprint-shipping-field').on('change input', function() {
            const field = $(this).attr('name').replace('shipping_', '');
            const value = $(this).val();

            // YPrintCheckoutSystem aktualisieren
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('shippingAddress', {
                    [field]: value
                });
            }

            // Automatisches Speichern
            saveAddress();
        });

        // Adresse speichern
        function saveAddress() {
            const addressData = {};
            $('.yprint-shipping-field').each(function() {
                const field = $(this).attr('name').replace('shipping_', '');
                addressData[field] = $(this).val();
            });

            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_shipping_address',
                    slot: currentSlot,
                    address: addressData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        // Adressvorschau aktualisieren
                        updateAddressPreview(currentSlot, addressData);
                    }
                }
            });
        }

        // Adressvorschau aktualisieren
        function updateAddressPreview(slot, address) {
            const $slot = $(`.yprint-address-slot[data-slot="${slot}"]`);
            const preview = `${address.address_1}, ${address.postcode} ${address.city}`;
            
            let $preview = $slot.find('.yprint-slot-preview');
            if (!$preview.length) {
                $preview = $('<span class="yprint-slot-preview"></span>').appendTo($slot);
            }
            $preview.text(preview);
        }

        // Auf State-Updates reagieren
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state.shippingAddress && state.shippingAddress.slot === currentSlot) {
                const address = state.shippingAddress;
                if (address) {
                    Object.entries(address).forEach(([field, value]) => {
                        if (field !== 'slot' && field !== 'timestamp') {
                            $(`[name="shipping_${field}"]`).val(value);
                        }
                    });
                }
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_shipping_address', 'yprint_shipping_address_shortcode');

// AJAX Handler für Slot-Updates
function yprint_update_shipping_slot() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (isset($_POST['slot'])) {
        $slot = sanitize_text_field($_POST['slot']);
        
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_selected_shipping_slot', $slot);
        }
        
        wp_send_json_success();
    }
    
    wp_send_json_error('Kein Slot angegeben');
}
add_action('wp_ajax_yprint_update_shipping_slot', 'yprint_update_shipping_slot');
add_action('wp_ajax_nopriv_yprint_update_shipping_slot', 'yprint_update_shipping_slot');

// AJAX Handler für Adress-Speicherung
function yprint_save_shipping_address() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $slot = isset($_POST['slot']) ? sanitize_text_field($_POST['slot']) : '';
    $address = isset($_POST['address']) ? $_POST['address'] : array();

    if (empty($slot) || empty($address)) {
        wp_send_json_error('Ungültige Daten');
        return;
    }

    if ($slot === 'primary') {
        // Primäre Adresse aktualisieren
        foreach ($address as $key => $value) {
            update_user_meta($user_id, "shipping_{$key}", sanitize_text_field($value));
        }
    } else if (strpos($slot, 'secondary_') === 0) {
        // Zusätzliche Adresse speichern
        $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: array();
        $index = intval(str_replace('secondary_', '', $slot));
        $secondary_addresses[$index] = array_map('sanitize_text_field', $address);
        update_user_meta($user_id, 'yprint_additional_shipping_addresses', $secondary_addresses);
    } else if ($slot === 'new') {
        // Neue Adresse erstellen
        $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: array();
        $secondary_addresses[] = array_map('sanitize_text_field', $address);
        update_user_meta($user_id, 'yprint_additional_shipping_addresses', $secondary_addresses);
    }

    wp_send_json_success();
}
add_action('wp_ajax_yprint_save_shipping_address', 'yprint_save_shipping_address');
add_action('wp_ajax_nopriv_yprint_save_shipping_address', 'yprint_save_shipping_address');

/**
 * YPrint Payment Options Shortcode
 * 
 * Shortcode für die Zahlungsmethoden im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

function yprint_payment_options_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    $available_gateways = WC()->payment_gateways()->get_available_payment_gateways();
    $chosen_payment_method = WC()->session ? WC()->session->get('chosen_payment_method') : '';

    ob_start();
    ?>
    <div class="yprint-payment-options">
        <div class="yprint-payment-grid">
            <?php if (!empty($available_gateways)) : ?>
                <?php foreach ($available_gateways as $gateway) : ?>
                    <div class="yprint-payment-option <?php echo ($chosen_payment_method == $gateway->id) ? 'selected' : ''; ?>" data-payment-id="<?php echo $gateway->id; ?>">
                        <input 
                            type="radio" 
                            id="payment_method_<?php echo $gateway->id; ?>" 
                            name="payment_method" 
                            value="<?php echo $gateway->id; ?>"
                            <?php checked($chosen_payment_method, $gateway->id); ?>
                            class="yprint-hidden-radio"
                            required
                        >
                        <label for="payment_method_<?php echo $gateway->id; ?>" class="yprint-payment-label">
                            <?php
                            $icon_class = '';
                            if (strpos($gateway->id, 'paypal') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-paypal';
                            } elseif (strpos($gateway->id, 'stripe') !== false || strpos($gateway->id, 'credit') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-card';
                            } elseif (strpos($gateway->id, 'bacs') !== false || strpos($gateway->id, 'bank') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-bank';
                            } elseif (strpos($gateway->id, 'cod') !== false || strpos($gateway->id, 'cash') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-cash';
                            } elseif (strpos($gateway->id, 'klarna') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-klarna';
                            } elseif (strpos($gateway->id, 'sofort') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-sofort';
                            } elseif (strpos($gateway->id, 'sepa') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-sepa';
                            } else {
                                $icon_class = 'yprint-payment-icon yprint-icon-default';
                            }
                            ?>
                            <div class="<?php echo $icon_class; ?>"></div>
                            <span class="yprint-payment-title"><?php echo $gateway->get_title(); ?></span>
                            <?php if ($gateway->has_fields() || $gateway->get_description()) : ?>
                                <div class="yprint-payment-description">
                                    <?php echo $gateway->get_description(); ?>
                                </div>
                            <?php endif; ?>
                        </label>
                    </div>
                <?php endforeach; ?>
            <?php else : ?>
                <p class="yprint-no-payment-methods">Keine Zahlungsmethoden verfügbar.</p>
            <?php endif; ?>
        </div>
    </div>

    <style>
    .yprint-payment-options {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-payment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }

    .yprint-payment-option {
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
    }

    .yprint-payment-option:hover {
        border-color: #2997FF;
    }

    .yprint-payment-option.selected {
        border-color: #2997FF;
        background-color: #f0f6ff;
    }

    .yprint-hidden-radio {
        position: absolute;
        opacity: 0;
        height: 0;
        width: 0;
    }

    .yprint-payment-label {
        display: block;
        padding: 15px;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }

    .yprint-payment-icon {
        width: 40px;
        height: 40px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-bottom: 10px;
    }

    .yprint-icon-paypal {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%230070E0" d="M19.2,5.4c-0.5-0.5-1.1-1-1.8-1.2C16.5,4,15.6,3.9,14.7,3.9H9.6c-0.5,0-0.9,0.3-1,0.8L6.3,16c-0.1,0.3,0.2,0.6,0.5,0.6h3.5l0.3-1.7v0.1c0.1-0.5,0.5-0.8,1-0.8h2.1c3,0,5.3-1.2,6-4.5c0-0.1,0-0.2,0.1-0.3c0.2-1.3,0-2.2-0.6-3"></path><path fill="%231F264F" d="M9.3,7.9c0.1-0.4,0.3-0.7,0.6-0.9C10.1,6.9,10.4,6.8,10.7,6.8l4.3,0c0.5,0,1,0.1,1.4,0.2c0.1,0,0.2,0.1,0.3,0.1c0.1,0,0.2,0.1,0.3,0.1c0.1,0,0.2,0.1,0.2,0.1c0.1,0,0.2,0.1,0.2,0.1c0.3,0.1,0.5,0.3,0.7,0.5c0.5-2.9-0.02-4.9-1.7-6.7C14.9-0.3,12.2,0,10,0H3.6C3,0,2.5,0.4,2.4,1L0,17.2c-0.1,0.5,0.3,1,0.8,1h6l1.5-9.3L9.3,7.9z"></path></svg>');
    }

    .yprint-icon-card {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4V12h16V18z M20,8H4V6h16V8z"></path><path fill="%231F264F" d="M6,14h4v2H6V14z M12,14h6v2h-6V14z"></path></svg>');
    }

    .yprint-icon-bank {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M12,3L2,8v2h20V8L12,3z M4,12h4v6H4V12z M10,12h4v6h-4V12z M16,12h4v6h-4V12z M2,20v2h20v-2H2z"></path></svg>');
    }

    .yprint-icon-cash {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M11,8v3H9v2h2v2H9v2h2v3h2v-3h2v-2h-2v-2h2v-2h-2V8H11z M21,4H3C1.9,4,1,4.9,1,6v12c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V6C23,4.9,22.1,4,21,4z M21,18H3V6h18V18z"></path></svg>');
    }

    .yprint-icon-klarna {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%23FFB3C7" d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M12,20c-4.4,0-8-3.6-8-8s3.6-8,8-8s8,3.6,8,8S16.4,20,12,20z"></path><path fill="%23FFB3C7" d="M12,6c-1.1,0-2,0.9-2,2v8c0,1.1,0.9,2,2,2s2-0.9,2-2V8C14,6.9,13.1,6,12,6z"></path></svg>');
    }

    .yprint-icon-sofort {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%23EB6F93" d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M15.5,15.5h-7v-7h7V15.5z"></path><path fill="%23EB6F93" d="M10.5,10.5h3v3h-3V10.5z"></path></svg>');
    }

    .yprint-icon-sepa {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M4,4h16c1.1,0,2,0.9,2,2v12c0,1.1-0.9,2-2,2H4c-1.1,0-2-0.9-2-2V6C2,4.9,2.9,4,4,4z M4,6v12h16V6H4z"></path><path fill="%231F264F" d="M6,10h12v2H6V10z M6,14h8v2H6V14z"></path></svg>');
    }

    .yprint-icon-default {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4V6h16V18z"></path><path fill="%231F264F" d="M13,15h4v2h-4V15z M11,11H7v2h4V11z M15,11h2v2h-2V11z"></path></svg>');
    }

    .yprint-payment-title {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1rem;
    }

    .yprint-payment-description {
        font-size: 0.85rem;
        color: #666;
        margin-top: 8px;
        display: none;
    }

    .yprint-payment-option.selected .yprint-payment-description {
        display: block;
    }

    .yprint-payment-option.error {
        animation: yprint-shake 0.5s;
        border-color: #dc3545;
    }

    @keyframes yprint-shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .yprint-no-payment-methods {
        text-align: center;
        color: #dc3545;
        padding: 20px;
        border: 1px solid #dc3545;
        border-radius: 4px;
        grid-column: 1 / -1;
    }

    @media (max-width: 600px) {
        .yprint-payment-grid {
            grid-template-columns: 1fr;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const $paymentOptions = $('.yprint-payment-option');
        const $paymentInputs = $('input[name="payment_method"]');
        
        // Initial State setzen
        const initialPayment = $('input[name="payment_method"]:checked').val();
        if (initialPayment) {
            // YPrintCheckoutSystem aktualisieren wenn verfügbar
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('paymentMethod', {
                    method: initialPayment,
                    timestamp: Date.now()
                });
            }
        }

        // Zahlungsmethode ändern
$paymentInputs.on('change', function() {
    const $selectedOption = $(this).closest('.yprint-payment-option');
    
    // UI Update
    $paymentOptions.removeClass('selected');
    $selectedOption.addClass('selected');
    
    // Fehlerklasse entfernen
    $paymentOptions.removeClass('error');
    
    // YPrintCheckoutSystem aktualisieren wenn verfügbar
    if (typeof YPrintCheckoutSystem !== 'undefined') {
        YPrintCheckoutSystem.updateState('paymentMethod', {
            method: this.value,
            timestamp: Date.now()
        });
    }

    // WooCommerce Integration - Standard-Event trigger
    $(document.body).trigger('payment_method_selected');
    
    // Die Standard-WooCommerce Zahlungsmethode aktualisieren
    $('input[name="payment_method"][value="' + this.value + '"]').prop('checked', true).trigger('click');
});
        // WooCommerce Payment Update
        function updateWooCommercePayment(method) {
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_update_payment_method',
                    payment_method: method,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        $(document.body).trigger('payment_method_selected');
                    }
                }
            });
        }

        // Auf State-Updates reagieren wenn YPrintCheckoutSystem verfügbar
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.paymentMethod && state.paymentMethod.method) {
                const $radio = $(`input[value="${state.paymentMethod.method}"]`);
                if (!$radio.is(':checked')) {
                    $radio.prop('checked', true).trigger('change');
                }
            }
        });

        // Fehlerbehandlung
        $(document).on('checkout_error', function() {
            if (!$paymentInputs.filter(':checked').length) {
                $paymentOptions.addClass('error');
                $('html, body').animate({
                    scrollTop: $('.yprint-payment-options').offset().top - 100
                }, 500);
            }
        });

        // Validierung vor Submit
        $(document).on('checkout_place_order', function() {
            if (!$paymentInputs.filter(':checked').length) {
                $paymentOptions.addClass('error');
                return false;
            }
            return true;
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_payment_options', 'yprint_payment_options_shortcode');

/**
 * YPrint Different Billing Shortcode
 * 
 * Shortcode für die abweichende Rechnungsadresse im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für abweichende Rechnungsadresse
 */
function yprint_different_billing_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    // Aktuelle Benutzerdaten abrufen
    $user_id = get_current_user_id();
    
    // WooCommerce Billing Felder abrufen
    $different_billing_first_name = get_user_meta($user_id, 'billing_first_name', true);
    $different_billing_last_name = get_user_meta($user_id, 'billing_last_name', true);
    $different_billing_email = get_user_meta($user_id, 'billing_email', true);
    $different_billing_address_1 = get_user_meta($user_id, 'billing_address_1', true);
    $different_billing_address_2 = get_user_meta($user_id, 'billing_address_2', true);
    $different_billing_postcode = get_user_meta($user_id, 'billing_postcode', true);
    $different_billing_city = get_user_meta($user_id, 'billing_city', true);
    $different_billing_country = get_user_meta($user_id, 'billing_country', true);
    $different_billing_enabled = false; // Immer als deaktiviert starten

    ob_start();
    ?>
    <div class="yprint-different-billing">
        <div class="yprint-checkbox-group">
            <input type="checkbox" 
                   id="different_billing" 
                   name="different_billing" 
                   class="yprint-billing-toggle"
                   <?php checked($different_billing_enabled, true); ?> />
            <label for="different_billing">Abweichende Rechnungsadresse</label>
        </div>
        
        <div id="different_billing_fields" class="yprint-conditional-fields" style="display: <?php echo $different_billing_enabled ? 'block' : 'none'; ?>;">
            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_first_name" 
                       placeholder="Vorname" 
                       value="<?php echo esc_attr($different_billing_first_name); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_last_name" 
                       placeholder="Name" 
                       value="<?php echo esc_attr($different_billing_last_name); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="email" 
                       name="different_billing_email" 
                       placeholder="E-Mail" 
                       value="<?php echo esc_attr($different_billing_email); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_address_1" 
                       placeholder="Straße" 
                       value="<?php echo esc_attr($different_billing_address_1); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_address_2" 
                       placeholder="Hausnummer" 
                       value="<?php echo esc_attr($different_billing_address_2); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_postcode" 
                       placeholder="PLZ" 
                       value="<?php echo esc_attr($different_billing_postcode); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_city" 
                       placeholder="Ort" 
                       value="<?php echo esc_attr($different_billing_city); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <select name="different_billing_country" class="yprint-billing-field">
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_countries();
                    $default_country = $different_billing_country ?: $countries_obj->get_base_country();
                    
                    foreach ($countries as $code => $name) {
                        echo '<option value="' . esc_attr($code) . '" ' . 
                             selected($default_country, $code, false) . '>' . 
                             esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-different-billing {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        color: #1d1d1f;
        cursor: pointer;
    }

    .yprint-checkbox-group a {
        color: #2997FF;
        text-decoration: none;
    }

    .yprint-checkbox-group a:hover {
        text-decoration: underline;
    }

    .yprint-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
    }

    .yprint-conditional-fields {
        margin-top: 15px;
    }

    .yprint-form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .yprint-form-row input,
    .yprint-form-row select {
        flex: 1;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-form-row input:focus,
    .yprint-form-row select:focus {
        border-color: #2997FF;
        outline: none;
    }

    @media (max-width: 600px) {
        .yprint-form-row {
            flex-direction: column;
        }
        
        .yprint-form-row input,
        .yprint-form-row select {
            width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const checkbox = $('#different_billing');
        const fieldsContainer = $('#different_billing_fields');
        const hasExistingData = <?php echo !empty($different_billing_first_name) || 
                                         !empty($different_billing_last_name) || 
                                         !empty($different_billing_email) ? 'true' : 'false'; ?>;
        
        // Force unchecked state
        checkbox.prop('checked', false);
        fieldsContainer.hide();

        // Toggle Felder
        checkbox.change(function() {
            if (this.checked) {
                fieldsContainer.slideDown(300);
            } else {
                fieldsContainer.slideUp(300);
            }

            // Update YPrintCheckoutSystem
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('differentBilling', {
                    enabled: this.checked
                });
            }
            
            // Metadaten aktualisieren
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_update_different_billing_enabled',
                    enabled: this.checked ? 1 : 0,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        });

        // Feldänderungen
        $('.yprint-billing-field').on('change', function() {
            // Update YPrintCheckoutSystem
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('differentBillingAddress', {
                    [this.name]: this.value
                });
            }
            
            // Metadaten aktualisieren
            saveBillingAddress();
        });

        // Adresse speichern
        function saveBillingAddress() {
            const addressData = {};
            $('.yprint-billing-field').each(function() {
                addressData[$(this).attr('name')] = $(this).val();
            });
            
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_different_billing_address',
                    address: addressData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        }

        // Auf State-Updates reagieren
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.differentBillingAddress) {
                Object.entries(state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }
            
            // Wir ignorieren den State für die Checkbox und behalten den initialen Zustand bei
            // Immer deaktiviert bleiben, es sei denn, der Benutzer aktiviert es manuell
        });
    });
    </script>

    <?php
    return ob_get_clean();
}
add_shortcode('yprint_different_billing', 'yprint_different_billing_shortcode');

// AJAX Handler für Different Billing Toggle
function yprint_update_different_billing_enabled() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $enabled = isset($_POST['enabled']) ? (bool)$_POST['enabled'] : false;
    
    update_user_meta($user_id, 'different_billing_enabled', $enabled);
    wp_send_json_success();
}
add_action('wp_ajax_yprint_update_different_billing_enabled', 'yprint_update_different_billing_enabled');
add_action('wp_ajax_nopriv_yprint_update_different_billing_enabled', 'yprint_update_different_billing_enabled');

// AJAX Handler für Different Billing Adresse
function yprint_save_different_billing_address() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $address = isset($_POST['address']) ? $_POST['address'] : array();
    
    if ($address) {
        foreach ($address as $key => $value) {
            // Konvertieren von different_billing_* zu billing_*
            $meta_key = str_replace('different_billing_', 'billing_', $key);
            update_user_meta($user_id, $meta_key, sanitize_text_field($value));
        }
    }
    
    wp_send_json_success();
}
add_action('wp_ajax_yprint_save_different_billing_address', 'yprint_save_different_billing_address');
add_action('wp_ajax_nopriv_yprint_save_different_billing_address', 'yprint_save_different_billing_address');



/**
 * YPrint Order Summary Shortcode
 * 
 * Shortcode für die Bestellübersicht im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für die Bestellübersicht
 */
function yprint_order_summary_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    ob_start();
    ?>
    <div class="yprint-order-summary" id="yprint-order-summary">
        <h3 class="yprint-summary-title">Warenkorb</h3>
        
        <?php 
        foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
            $_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
            
            $thumbnail = $_product->get_image('thumbnail', array('class' => 'yprint-item-image'));
            $product_name = apply_filters('woocommerce_cart_item_name', $_product->get_name(), $cart_item, $cart_item_key);
            $price = $cart_item['line_total'];
            $product_id = $_product->get_id();
            ?>
            <div class="yprint-order-item" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>" data-product-id="<?php echo esc_attr($product_id); ?>">
                <?php echo $thumbnail; ?>
                <div class="yprint-item-details">
                    <span class="yprint-item-title"><?php echo $product_name; ?></span>
                    <div class="yprint-item-quantity-wrapper">
        <button class="yprint-item-quantity-btn yprint-item-quantity-minus" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">−</button>
        <span class="yprint-item-quantity-value"><?php echo esc_attr($cart_item['quantity']); ?></span>
        <input type="number" class="yprint-item-quantity-input" value="<?php echo esc_attr($cart_item['quantity']); ?>" min="1" style="display: none;">
        <button class="yprint-item-quantity-btn yprint-item-quantity-plus" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">+</button>
    </div>
                </div>
                <div class="yprint-item-remove" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">×</div>
                <span class="yprint-item-total"><?php echo wc_price($price); ?></span>
            </div>
            <?php 
        } 
        ?>

        <div class="yprint-summary-totals">
        <div class="yprint-subtotal">
            <span>Zwischensumme</span>
            <span><?php echo WC()->cart->get_cart_subtotal(); ?></span>
        </div>
        <div class="yprint-shipping">
            <span>Versand</span>
            <span><?php echo WC()->cart->get_cart_shipping_total(); ?></span>
        </div>
        <?php if (WC()->cart->get_discount_total() > 0) : ?>
        <div class="yprint-discount">
            <span>Rabatt</span>
            <span>-<?php echo wc_price(WC()->cart->get_discount_total()); ?></span>
        </div>
        <?php endif; ?>
        <div class="yprint-total">
            <span>Gesamtsumme</span>
            <span><?php echo WC()->cart->get_total(); ?></span>
        </div>
    </div>
</div>

<style>
.yprint-order-summary {
    width: 100%;
    font-family: 'Roboto', sans-serif;
    position: relative;
}

.yprint-summary-title {
    text-transform: none;
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #1d1d1f;
}

.yprint-order-item {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f5f5f7;
    position: relative;
}

.yprint-item-image {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 4px;
}

.yprint-item-details {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

.yprint-item-title {
    font-weight: 500;
    margin-bottom: 8px;
    color: #1d1d1f;
}

.yprint-item-quantity-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.yprint-item-quantity-value {
    min-width: 24px;
    text-align: center;
    color: #0079FF;
    font-weight: 600;
    cursor: pointer;
}

.yprint-item-quantity-input {
    width: 30px;
    padding: 0;
    text-align: center;
    border: 1px solid #ddd;
    color: #0079FF;
    font-weight: 600;
}

.yprint-item-quantity-input::-webkit-outer-spin-button,
.yprint-item-quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.yprint-item-quantity-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    color: #1d1d1f;
    padding: 0;
}

.yprint-item-quantity-btn:hover {
    background: transparent;
}

.yprint-item-remove {
    cursor: pointer;
    color: #999;
    font-size: 18px;
    line-height: 1;
    padding: 0 5px;
    position: absolute;
    right: 0;
    top: 0;
}

.yprint-item-remove:hover {
    color: #0079FF;
}

.yprint-item-price {
    display: none;
}

.yprint-item-total {
    font-weight: 600;
    color: #0079FF;
}

.yprint-summary-totals {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #f5f5f7;
}

.yprint-subtotal, 
.yprint-shipping,
.yprint-discount,
.yprint-total {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.yprint-subtotal span, 
.yprint-shipping span,
.yprint-discount span {
    color: #6e6e73;
}

.yprint-total {
    font-weight: 600;
    border-top: 1px solid #f5f5f7;
    padding-top: 12px;
    margin-top: 12px;
}

.yprint-total span {
    color: #1d1d1f;
}

.yprint-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.yprint-loading-overlay.active {
    opacity: 1;
    visibility: visible;
}
</style>

<script>
jQuery(document).ready(function($) {
    // Variable um zu verfolgen, ob ein Eingabefeld aktiv ist
    var isEditing = false;
    var $orderSummary = $('#yprint-order-summary');
    
    // Overlay zum Order Summary hinzufügen, falls noch nicht vorhanden
    if ($orderSummary.find('.yprint-loading-overlay').length === 0) {
        $orderSummary.prepend('<div class="yprint-loading-overlay"><img src="https://yprint.de/wp-content/uploads/2025/02/120225-logo.svg" alt="Loading..."></div>');
    }
    
    // PLUS/MINUS BUTTONS
    $orderSummary.on('click', '.yprint-item-quantity-btn', function() {
        if (isEditing) return; // Ignorieren, wenn Eingabe aktiv
        
        var $btn = $(this);
        var $item = $btn.closest('.yprint-order-item');
        var $qtyValue = $item.find('.yprint-item-quantity-value');
        var cartItemKey = $item.data('cart-item-key');
        var currentQty = parseInt($qtyValue.text());
        var newQty = $btn.hasClass('yprint-item-quantity-minus') ? 
                     Math.max(1, currentQty - 1) : 
                     currentQty + 1;
        
        // Menge sofort aktualisieren
        $qtyValue.text(newQty);
        
        // AJAX-Update der Menge
        updateQuantity(cartItemKey, newQty);
    });
    
    // DIREKTEINGABE DER MENGE
    // Klick auf Menge (zum Bearbeiten)
    $orderSummary.on('click', '.yprint-item-quantity-value', function() {
        if (isEditing) return; // Bereits im Bearbeitungsmodus
        
        isEditing = true;
        var $value = $(this);
        var $input = $value.siblings('.yprint-item-quantity-input');
        
        // Eingabefeld vorbereiten und anzeigen
        $input.val($value.text());
        $value.hide();
        $input.show().focus().select();
    });
    
    // Eingabefeld verlassen
    $orderSummary.on('blur', '.yprint-item-quantity-input', function() {
        var $input = $(this);
        var $item = $input.closest('.yprint-order-item');
        var $value = $item.find('.yprint-item-quantity-value');
        var cartItemKey = $item.data('cart-item-key');
        var oldQty = parseInt($value.text());
        var newQty = parseInt($input.val());
        
        // Gültigen Wert sicherstellen
        if (isNaN(newQty) || newQty < 1) newQty = 1;
        
        // UI zurücksetzen
        $input.hide();
        $value.show();
        
        // Bearbeitungsmodus beenden
        isEditing = false;
        
        // Nur bei Änderung aktualisieren
        if (newQty !== oldQty) {
            $value.text(newQty);
            updateQuantity(cartItemKey, newQty);
        }
    });
    
    // Enter-Taste im Eingabefeld
    $orderSummary.on('keypress', '.yprint-item-quantity-input', function(e) {
        if (e.which === 13) { // Enter
            e.preventDefault();
            $(this).blur();
        }
    });
    
    // Klick außerhalb schließt Eingabefeld
    $(document).on('mousedown', function(e) {
        if (isEditing) {
            var $target = $(e);
            if (!$target.is('.yprint-item-quantity-input') && !$target.is('.yprint-item-quantity-value')) {
                $orderSummary.find('.yprint-item-quantity-input:visible').blur();
            }
        }
    });
    
    // ENTFERNEN-BUTTON
    $orderSummary.on('click', '.yprint-item-remove', function() {
        var $item = $(this).closest('.yprint-order-item');
        var cartItemKey = $item.data('cart-item-key');
        
        // Overlay aktivieren
        $orderSummary.find('.yprint-loading-overlay').addClass('active');
        
        $.ajax({
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            type: 'POST',
            data: {
                action: 'yprint_remove_from_cart',
                cart_item_key: cartItemKey,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                // Nach Erfolg Seite neu laden
                if (response.cart_count !== undefined) {
                    location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error('Fehler beim Entfernen:', status, error);
                $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                alert('Ein Fehler ist aufgetreten.');
            }
        });
    });
    
    // Funktion zum Aktualisieren der Menge
    function updateQuantity(cartItemKey, quantity) {
        // Overlay aktivieren
        $orderSummary.find('.yprint-loading-overlay').addClass('active');
        
        $.ajax({
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            type: 'POST',
            data: {
                action: 'yprint_update_cart_quantity',
                cart_item_key: cartItemKey,
                quantity: quantity,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                if (response.success || response.cart_subtotal !== undefined) {
                    location.reload();
                } else {
                    $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                    alert(response.data || 'Ein Fehler ist aufgetreten.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Fehler beim Aktualisieren:', status, error);
                $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                alert('Ein Fehler ist aufgetreten.');
            }
        });
    }
});
</script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_order_summary', 'yprint_order_summary_shortcode');

/**
 * YPrint Coupon and Buy Shortcode
 * 
 * Shortcode für das Gutschein-Feld und den Kaufen-Button im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für Gutschein-Feld und Kaufen-Button
 */
function yprint_coupon_buy_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    // Hole gespeicherten Gutscheincode
    $saved_coupon = WC()->session ? WC()->session->get('applied_coupon') : '';

    ob_start();
    ?>
    <div class="yprint-coupon-buy-section">
        <div class="yprint-coupon-form">
            <div class="yprint-coupon-input-wrapper">
                <input 
                    type="text" 
                    name="coupon_code" 
                    class="yprint-coupon-input" 
                    placeholder="Gutschein-Code eingeben" 
                    id="coupon_code" 
                    value="<?php echo esc_attr($saved_coupon); ?>" 
                />
                <button 
                    type="button"
                    class="yprint-coupon-button" 
                    id="apply_coupon"
                >
                    Anwenden
                </button>
            </div>
            <div class="yprint-coupon-message" style="display: none;"></div>
        </div>

        <button 
            type="button"
            id="yprint_checkout_submit"
            class="yprint-buy-button"
        >
            <span class="yprint-button-text">Jetzt kaufen</span>
            <div class="yprint-button-loader" style="display: none;">
                <div class="yprint-loader-spinner"></div>
            </div>
        </button>

        <!-- Validierungsfeedback -->
        <div class="yprint-validation-feedback" style="display: none;"></div>
    </div>

    <style>
    .yprint-coupon-buy-section {
        margin-top: 20px;
    }

    .yprint-coupon-form {
        margin-bottom: 20px;
    }

    .yprint-coupon-input-wrapper {
        display: flex;
        gap: 10px;
    }

    .yprint-coupon-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1rem;
    }

    .yprint-coupon-input:focus {
        border-color: #2997FF;
        outline: none;
    }

    .yprint-coupon-button {
        padding: 0 20px;
        background-color: #f5f5f7;
        color: #1d1d1f;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
    }

    .yprint-coupon-button:hover {
        background-color: #e0e0e0;
    }

    .yprint-buy-button {
        width: 100%;
        padding: 15px;
        background-color: #0079FF;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
        position: relative;
    }

    .yprint-buy-button:disabled {
    background-color: #a0a0a0;
    cursor: not-allowed;
    opacity: 0.6;
}

    .yprint-buy-button:hover {
        background-color: #0068e1;
    }

    .yprint-button-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .yprint-loader-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: yprint-spin 0.8s linear infinite;
    }

    @keyframes yprint-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .yprint-buy-button.loading .yprint-button-text {
        visibility: hidden;
    }

    .yprint-buy-button.loading .yprint-button-loader {
        display: block;
    }

    .yprint-coupon-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .yprint-coupon-message.success {
        background-color: #d4edda;
        color: #155724;
    }

    .yprint-coupon-message.error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .yprint-validation-feedback {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .yprint-validation-feedback.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .yprint-validation-item {
        margin: 5px 0;
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const $buyButton = $('#yprint_checkout_submit');
        const $couponButton = $('#apply_coupon');
        const $couponInput = $('#coupon_code');
        const $couponMessage = $('.yprint-coupon-message');
        const $validationFeedback = $('.yprint-validation-feedback');
        
        // Bei Seitenladung Warenkorb-Status prüfen
        function checkCartStatus() {
            const cartIsEmpty = <?php echo WC()->cart->is_empty() ? 'true' : 'false'; ?>;
            $buyButton.prop('disabled', cartIsEmpty);
        }

        checkCartStatus();

        // Gutschein anwenden
        $couponButton.on('click', function() {
            const couponCode = $couponInput.val().trim();
            
            if (!couponCode) {
                showCouponMessage('Bitte gib einen Gutschein-Code ein.', 'error');
                return;
            }
            
            // Button deaktivieren während der Anfrage
            $couponButton.prop('disabled', true);
            
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_apply_coupon',
                    coupon_code: couponCode,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    $couponButton.prop('disabled', false);
                    
                    if (response.success) {
                        showCouponMessage('Gutschein wurde erfolgreich angewendet.', 'success');
                        
                        // YPrintCheckoutSystem aktualisieren
                        if (typeof YPrintCheckoutSystem !== 'undefined') {
                            YPrintCheckoutSystem.updateState('couponCode', {
                                code: couponCode
                            });
                        }
                        
                        // Seite neuladen um Preise zu aktualisieren
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showCouponMessage(response.data || 'Gutschein konnte nicht angewendet werden.', 'error');
                    }
                },
                error: function() {
                    $couponButton.prop('disabled', false);
                    showCouponMessage('Ein Fehler ist aufgetreten. Bitte versuche es erneut.', 'error');
                }
            });
        });

        // Gutschein-Nachricht anzeigen
        function showCouponMessage(text, type) {
            $couponMessage
                .text(text)
                .removeClass('success error')
                .addClass(type)
                .fadeIn();
            
            // Nach 3 Sekunden ausblenden
            setTimeout(function() {
                $couponMessage.fadeOut();
            }, 3000);
        }

        // Checkout Submit
        $buyButton.on('click', function(e) {
            // Prüfen, ob Warenkorb leer ist
            if (<?php echo WC()->cart->is_empty() ? 'true' : 'false'; ?>) {
                return false;
            }
            
            e.preventDefault();
            
            // Button Loading State
            $buyButton.addClass('loading');
            $validationFeedback.hide();
    
    // Checkout Validierung durchführen
    if (typeof YPrintCheckoutSystem !== 'undefined') {
        const validationResult = YPrintCheckoutSystem.validateForm();
        
        if (validationResult.isValid) {
            // Checkout Prozess starten
            YPrintCheckoutSystem.processCheckout();
        } else {
            // Fehler anzeigen
            showValidationErrors(validationResult.errors);
            $buyButton.removeClass('loading');
        }
    } else {
        // Fallback wenn YPrintCheckoutSystem nicht verfügbar ist
        $validationFeedback
            .empty()
            .addClass('error')
            .append($('<div class="yprint-validation-item"></div>').text('Das Checkout-System konnte nicht geladen werden.'))
            .show();
        
        $buyButton.removeClass('loading');
    }
});

        // Validierungsfehler anzeigen
        function showValidationErrors(errors) {
            $validationFeedback.empty().addClass('error');
            
            errors.forEach(error => {
                $validationFeedback.append(
                    $('<div class="yprint-validation-item"></div>').text(error)
                );
            });

            $validationFeedback.show();

            // Scroll zu den Fehlern
            $('html, body').animate({
                scrollTop: $validationFeedback.offset().top - 100
            }, 500);
        }
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_coupon_buy', 'yprint_coupon_buy_shortcode');

// AJAX Handler für Gutscheine
function yprint_apply_coupon() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['coupon_code']) || empty($_POST['coupon_code'])) {
        wp_send_json_error('Kein Gutschein-Code angegeben');
        return;
    }
    
    $coupon_code = sanitize_text_field($_POST['coupon_code']);
    
    if (function_exists('WC') && WC()->cart) {
        // Prüfen ob Gutschein bereits angewendet wurde
        if (WC()->cart->has_discount($coupon_code)) {
            wp_send_json_error('Dieser Gutschein wurde bereits angewendet');
            return;
        }
        
        // Gutschein anwenden
        $result = WC()->cart->apply_coupon($coupon_code);
        
        if ($result) {
            wp_send_json_success('Gutschein erfolgreich angewendet');
        } else {
            wp_send_json_error('Der Gutschein konnte nicht angewendet werden');
        }
    } else {
        wp_send_json_error('WooCommerce ist nicht aktiviert');
    }
}
add_action('wp_ajax_yprint_apply_coupon', 'yprint_apply_coupon');
add_action('wp_ajax_nopriv_yprint_apply_coupon', 'yprint_apply_coupon');

/**
 * YPrint Checkout WooCommerce Integration
 * 
 * Integration des benutzerdefinierten Checkouts mit WooCommerce
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Filter zur Übernahme der Daten aus dem benutzerdefinierten Checkout in den normalen WooCommerce-Checkout
 */
add_filter('woocommerce_checkout_posted_data', function($data) {
    // Checkout-Daten aus der Session abrufen
    $checkout_data = WC()->session ? WC()->session->get('yprint_checkout_data') : null;
    
    if ($checkout_data) {
        // Shipping-Daten übernehmen
        if (isset($checkout_data['shipping_address'])) {
            foreach ($checkout_data['shipping_address'] as $key => $value) {
                if ($key !== 'slot' && $key !== 'timestamp') {
                    $data['shipping_' . $key] = $value;
                }
            }
        }
        
        // Billing-Daten übernehmen wenn Different Billing aktiviert ist
        if (isset($checkout_data['different_billing']) && $checkout_data['different_billing']) {
            if (isset($checkout_data['different_billing_address'])) {
                foreach ($checkout_data['different_billing_address'] as $key => $value) {
                    // Konvertieren von different_billing_* zu billing_*
                    $billing_key = str_replace('different_billing_', 'billing_', $key);
                    $data[$billing_key] = $value;
                }
            }
        } else {
            // Wenn keine abweichende Rechnungsadresse, dann Lieferadresse für Rechnungsadresse verwenden
            if (isset($checkout_data['shipping_address'])) {
                foreach ($checkout_data['shipping_address'] as $key => $value) {
                    if ($key !== 'slot' && $key !== 'timestamp') {
                        $data['billing_' . $key] = $value;
                    }
                }
            }
        }
        
        // Zahlungsart übernehmen
        if (isset($checkout_data['payment_method']) && !empty($checkout_data['payment_method'])) {
            $data['payment_method'] = $checkout_data['payment_method'];
        }
    }
    
    return $data;
});

/**
 * Checkout Validierung erweitern
 */

add_action('woocommerce_checkout_process', function() {
    // Datenschutz-Checkbox prüfen
    if (!isset($_POST['privacy_checkbox']) || $_POST['privacy_checkbox'] !== 'on') {
        wc_add_notice('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.', 'error');
    }

    // Zahlungsmethode prüfen
    if (!isset($_POST['payment_method']) || empty($_POST['payment_method'])) {
        wc_add_notice('Bitte wähle eine Zahlungsmethode aus.', 'error');
    }

    // Lieferadresse prüfen
    $shipping_fields = array(
        'shipping_first_name' => 'Vorname',
        'shipping_last_name' => 'Nachname',
        'shipping_address_1' => 'Straße',
        'shipping_postcode' => 'PLZ',
        'shipping_city' => 'Ort',
        'shipping_country' => 'Land'
    );

    foreach ($shipping_fields as $field => $label) {
        if (!isset($_POST[$field]) || empty($_POST[$field])) {
            wc_add_notice(sprintf('Bitte gib %s für die Lieferadresse an.', $label), 'error');
        }
    }

    // Abweichende Rechnungsadresse prüfen wenn aktiviert
    if (isset($_POST['different_billing']) && $_POST['different_billing'] === 'on') {
        $billing_fields = array(
            'billing_first_name' => 'Vorname',
            'billing_last_name' => 'Nachname',
            'billing_address_1' => 'Straße',
            'billing_postcode' => 'PLZ',
            'billing_city' => 'Ort',
            'billing_country' => 'Land'
        );

        foreach ($billing_fields as $field => $label) {
            if (!isset($_POST[$field]) || empty($_POST[$field])) {
                wc_add_notice(sprintf('Bitte gib %s für die Rechnungsadresse an.', $label), 'error');
            }
        }
    }
});

/**
 * YPrint Checkout Shortcodes registrieren
 */
function register_yprint_checkout_shortcodes() {
    add_shortcode('yprint_checkout', 'yprint_checkout_shortcode');
    add_shortcode('yprint_checkout_communication', 'yprint_checkout_communication_shortcode');
    add_shortcode('yprint_shipping_address', 'yprint_shipping_address_shortcode');
    add_shortcode('yprint_payment_options', 'yprint_payment_options_shortcode');
    add_shortcode('yprint_different_billing', 'yprint_different_billing_shortcode');
    add_shortcode('yprint_order_summary', 'yprint_order_summary_shortcode');
    add_shortcode('yprint_coupon_buy', 'yprint_coupon_buy_shortcode');
}
add_action('init', 'register_yprint_checkout_shortcodes');

/**
 * Thankyou Redirect Shortcode
 * Zeigt eine Ladeanimation und leitet nach 5 Sekunden weiter
 */
function thankyou_redirect_shortcode() {
    ob_start();
    ?>
    <div class="thankyou-redirect-container">
        <div class="loader-animation">
            <div class="spinner"></div>
        </div>
        <div class="redirect-message">
            <h2>Vielen Dank für deinen Einkauf!</h2>
            <p>Du wirst in wenigen Sekunden weitergeleitet...</p>
        </div>
    </div>
    
    <style>
        .thankyou-redirect-container {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        .loader-animation {
            margin-bottom: 30px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 121, 255, 0.2);
            border-radius: 50%;
            border-top-color: #0079FF;
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .redirect-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #1d1d1f;
        }
        
        .redirect-message p {
            font-size: 16px;
            color: #6e6e73;
        }
    </style>
    
    <script>
        // Führe diese Funktion aus, sobald die Seite geladen ist
        (function() {
            // Setze den Timer für die Weiterleitung
            setTimeout(function() {
                window.location.href = 'https://yprint.de/basics/';
            }, 5000); // 5000 Millisekunden = 5 Sekunden
        })();
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('thankyou_redirect', 'thankyou_redirect_shortcode');

/**
 * Passt die Bestellbestätigungsseite an und ersetzt sie mit unserem benutzerdefinierten Redirect
 */
function customize_order_received_page($title, $id) {
    // Prüfen, ob es sich um die Order-Received-Seite handelt
    if (is_wc_endpoint_url('order-received') && $id == wc_get_page_id('checkout')) {
        // Mache den normalen Titel unsichtbar
        add_filter('the_content', 'replace_thankyou_content', 1);
        return '';
    }
    return $title;
}
add_filter('the_title', 'customize_order_received_page', 10, 2);

/**
 * Ersetzt den Inhalt der Bestellbestätigungsseite
 */
function replace_thankyou_content($content) {
    // Nur auf der Order-Received-Seite
    if (is_wc_endpoint_url('order-received')) {
        // Ersetze den Inhalt mit unserem Shortcode
        return do_shortcode('[thankyou_redirect]');
    }
    return $content;
}

/**
 * Entferne das standardmäßige WooCommerce Dankeschön-Template
 */
function remove_woocommerce_order_details_table() {
    if (is_wc_endpoint_url('order-received')) {
        remove_action('woocommerce_thankyou', 'woocommerce_order_details_table', 10);
        
        // Verhindere auch alle anderen WooCommerce-Ausgaben
        remove_all_actions('woocommerce_thankyou');
        remove_all_actions('woocommerce_order_details_before_order_table');
        remove_all_actions('woocommerce_order_details_after_order_table');
        remove_all_actions('woocommerce_order_details_before_customer_details');
        remove_all_actions('woocommerce_order_details_after_customer_details');
    }
}
add_action('template_redirect', 'remove_woocommerce_order_details_table');

/**
 * PayPal Webhook-Handler
 */
function yprint_paypal_webhook_handler() {
    // Webhook-Verarbeitung
    $payload = file_get_contents('php://input');
    $headers = getallheaders();
    
    // Nur an der PayPal Webhook-URL aktivieren
    if (!isset($_GET['yprint-paypal-webhook'])) {
        return;
    }
    
    // Debug-Log für Webhook-Anfragen
    error_log('PayPal Webhook received: ' . $payload);
    
    // JSON Payload verarbeiten
    $event_json = json_decode($payload);
    
    if (!$event_json || !isset($event_json->event_type)) {
        error_log('PayPal Webhook error: Invalid payload');
        status_header(400);
        exit('Invalid payload');
    }
    
    error_log('PayPal Webhook event type: ' . $event_json->event_type);
    
    // Event-Typ verarbeiten
    switch ($event_json->event_type) {
        case 'PAYMENT.CAPTURE.COMPLETED':
            // Zahlung abgeschlossen
            process_paypal_payment_completed($event_json);
            break;
            
        case 'PAYMENT.CAPTURE.DENIED':
        case 'PAYMENT.CAPTURE.REFUNDED':
        case 'PAYMENT.CAPTURE.REVERSED':
            // Zahlung abgelehnt/zurückerstattet/storniert
            process_paypal_payment_failed($event_json);
            break;
            
        case 'CHECKOUT.ORDER.APPROVED':
            // Bestellung genehmigt
            process_paypal_order_approved($event_json);
            break;
            
        case 'CHECKOUT.ORDER.COMPLETED':
            // Bestellung abgeschlossen
            process_paypal_order_completed($event_json);
            break;
            
        case 'CHECKOUT.ORDER.DECLINED':
            // Bestellung abgelehnt
            process_paypal_order_declined($event_json);
            break;
    }
    
    status_header(200);
    exit('Webhook processed');
}
add_action('init', 'yprint_paypal_webhook_handler');

/**
 * PayPal erfolgreiche Zahlung verarbeiten
 */
function process_paypal_payment_completed($event_json) {
    error_log('Processing PayPal payment completed');
    
    if (isset($event_json->resource->id) && isset($event_json->resource->supplementary_data->related_ids->order_id)) {
        $transaction_id = $event_json->resource->id;
        $paypal_order_id = $event_json->resource->supplementary_data->related_ids->order_id;
        
        error_log('PayPal payment completed - Transaction ID: ' . $transaction_id . ', Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Bestellung bereits bezahlt wurde
        if ($order->is_paid()) {
            error_log('Order already paid: ' . $order->get_id());
            return;
        }
        
        // Bestellung als bezahlt markieren
        $order->payment_complete($transaction_id);
        $order->add_order_note('Zahlung via PayPal Webhook bestätigt (Transaktion ID: ' . $transaction_id . ')');
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as paid');
    } else {
        error_log('PayPal webhook missing required fields for payment completed');
    }
}

/**
 * PayPal fehlgeschlagene Zahlung verarbeiten
 */
function process_paypal_payment_failed($event_json) {
    error_log('Processing PayPal payment failed');
    
    if (isset($event_json->resource->supplementary_data->related_ids->order_id)) {
        $paypal_order_id = $event_json->resource->supplementary_data->related_ids->order_id;
        
        error_log('PayPal payment failed - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Bestellung als fehlgeschlagen markieren
        $order->update_status('failed', 'PayPal-Zahlung fehlgeschlagen: ' . $event_json->event_type);
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as failed');
    } else {
        error_log('PayPal webhook missing required fields for payment failed');
    }
}

/**
 * PayPal Bestellung genehmigt verarbeiten
 */
function process_paypal_order_approved($event_json) {
    error_log('Processing PayPal order approved');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order approved - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Status auf "on-hold" setzen, da die Zahlung zwar genehmigt, aber noch nicht abgeschlossen ist
        if ($order->get_status() === 'pending') {
            $order->update_status('on-hold', 'PayPal-Bestellung genehmigt, warte auf Zahlungsabschluss');
            $order->save();
            error_log('Order ' . $order->get_id() . ' marked as on-hold');
        }
    } else {
        error_log('PayPal webhook missing required fields for order approved');
    }
}

/**
 * PayPal Bestellung abgeschlossen verarbeiten
 */
function process_paypal_order_completed($event_json) {
    error_log('Processing PayPal order completed');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order completed - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Bestellung bereits bezahlt wurde
        if (!$order->is_paid()) {
            // Bestellung als bezahlt markieren, falls noch keine Zahlung eingegangen ist
            $order->payment_complete($paypal_order_id);
            $order->add_order_note('Zahlung via PayPal Webhook bestätigt (Order ID: ' . $paypal_order_id . ')');
            $order->save();
            error_log('Order ' . $order->get_id() . ' marked as paid');
        }
    } else {
        error_log('PayPal webhook missing required fields for order completed');
    }
}

/**
 * PayPal Bestellung abgelehnt verarbeiten
 */
function process_paypal_order_declined($event_json) {
    error_log('Processing PayPal order declined');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order declined - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Bestellung als fehlgeschlagen markieren
        $order->update_status('failed', 'PayPal-Bestellung abgelehnt');
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as failed');
    } else {
        error_log('PayPal webhook missing required fields for order declined');
    }
}

/**
 * Stripe Webhook-Handler
 */
function yprint_stripe_webhook_handler() {
    // Webhook-Verarbeitung
    $payload = file_get_contents('php://input');
    $headers = getallheaders();
    
    // Nur an der Stripe Webhook-URL aktivieren
    if (!isset($_GET['yprint-stripe-webhook'])) {
        return;
    }
    
    // Debug-Log für Webhook-Anfragen
    error_log('Stripe Webhook received: ' . $payload);
    
    // Webhook-Signatur prüfen
    $webhook_secret = get_option('yprint_stripe_webhook_secret', '');
    $signature = isset($headers['Stripe-Signature']) ? $headers['Stripe-Signature'] : '';
    
    if (empty($webhook_secret) || empty($signature)) {
        error_log('Stripe Webhook error: Invalid webhook configuration - missing secret or signature');
        status_header(400);
        exit('Invalid webhook configuration');
    }
    
    try {
        // Stripe-Bibliothek laden
        if (!class_exists('Stripe\Stripe')) {
            require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
            require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/vendor/autoload.php';
        }
        
        // Event verifizieren
        $event = \Stripe\Webhook::constructEvent(
            $payload, $signature, $webhook_secret
        );
        
        error_log('Stripe Webhook event verified: ' . $event->type);
    } catch (\Exception $e) {
        error_log('Stripe Webhook error: ' . $e->getMessage());
        status_header(400);
        exit('Webhook Error: ' . $e->getMessage());
    }
    
    // Event-Typ verarbeiten
    switch ($event->type) {
        case 'payment_intent.succeeded':
            // Zahlung erfolgreich
            process_stripe_payment_succeeded($event->data->object);
            break;
            
        case 'payment_intent.payment_failed':
            // Zahlung fehlgeschlagen
            process_stripe_payment_failed($event->data->object);
            break;
            
        case 'charge.refunded':
            // Zahlung zurückerstattet
            process_stripe_refund($event->data->object);
            break;
        
        default:
            error_log('Stripe Webhook: Unhandled event type: ' . $event->type);
            break;
    }
    
    status_header(200);
    exit('Webhook processed');
}
add_action('init', 'yprint_stripe_webhook_handler');

/**
 * Stripe erfolgreiche Zahlung verarbeiten
 */
function process_stripe_payment_succeeded($payment_intent) {
    error_log('Processing Stripe payment succeeded');
    
    if (!isset($payment_intent->id)) {
        error_log('Stripe payment intent ID missing');
        return;
    }
    
    $payment_intent_id = $payment_intent->id;
    error_log('Stripe payment succeeded - Payment Intent ID: ' . $payment_intent_id);
    
    // Order ID aus Stripe Payment Intent ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_stripe_payment_intent',
        'meta_value' => $payment_intent_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe payment intent ID: ' . $payment_intent_id);
        
        // Versuche über Metadaten zu finden, wenn vorhanden
        if (isset($payment_intent->metadata->order_id)) {
            $order_id = $payment_intent->metadata->order_id;
            error_log('Trying to find order by ID from metadata: ' . $order_id);
            $order = wc_get_order($order_id);
            
            if ($order) {
                $orders = array($order);
                error_log('Order found by ID from metadata');
            } else {
                error_log('Order not found by ID from metadata');
                return;
            }
        } else {
            error_log('No order ID in metadata');
            return;
        }
    }
    
    $order = $orders[0];
    error_log('Order found: ' . $order->get_id());
    
    // Prüfen, ob Bestellung bereits bezahlt wurde
    if ($order->is_paid()) {
        error_log('Order already paid: ' . $order->get_id());
        return;
    }
    
    // Bestellung als bezahlt markieren
    $charge_id = isset($payment_intent->latest_charge) ? $payment_intent->latest_charge : $payment_intent_id;
    $order->payment_complete($charge_id);
    $order->add_order_note('Zahlung via Stripe Webhook bestätigt (Charge ID: ' . $charge_id . ')');
    
    // Speichere Payment Intent ID, falls noch nicht gespeichert
    if (!get_post_meta($order->get_id(), '_stripe_payment_intent', true)) {
        update_post_meta($order->get_id(), '_stripe_payment_intent', $payment_intent_id);
    }
    
    $order->save();
    error_log('Order ' . $order->get_id() . ' marked as paid');
}

/**
 * Stripe fehlgeschlagene Zahlung verarbeiten
 */
function process_stripe_payment_failed($payment_intent) {
    error_log('Processing Stripe payment failed');
    
    if (!isset($payment_intent->id)) {
        error_log('Stripe payment intent ID missing');
        return;
    }
    
    $payment_intent_id = $payment_intent->id;
    error_log('Stripe payment failed - Payment Intent ID: ' . $payment_intent_id);
    
    // Order ID aus Stripe Payment Intent ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_stripe_payment_intent',
        'meta_value' => $payment_intent_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe payment intent ID: ' . $payment_intent_id);
        
        // Versuche über Metadaten zu finden, wenn vorhanden
        if (isset($payment_intent->metadata->order_id)) {
            $order_id = $payment_intent->metadata->order_id;
            error_log('Trying to find order by ID from metadata: ' . $order_id);
            $order = wc_get_order($order_id);
            
            if ($order) {
                $orders = array($order);
                error_log('Order found by ID from metadata');
            } else {
                error_log('Order not found by ID from metadata');
                return;
            }
        } else {
            error_log('No order ID in metadata');
            return;
        }
    }
    
    $order = $orders[0];
    
    // Fehlermeldung extrahieren
    $error_message = 'Zahlung fehlgeschlagen';
    
    if (isset($payment_intent->last_payment_error->message)) {
        $error_message = $payment_intent->last_payment_error->message;
    }
    
    error_log('Payment error message: ' . $error_message);
    
    // Bestellung als fehlgeschlagen markieren
    $order->update_status('failed', 'Stripe-Zahlung fehlgeschlagen: ' . $error_message);
    $order->save();
    error_log('Order ' . $order->get_id() . ' marked as failed');
}

/**
 * Stripe Rückerstattung verarbeiten
 */
function process_stripe_refund($charge) {
    error_log('Processing Stripe refund');
    
    if (!isset($charge->id)) {
        error_log('Stripe charge ID missing');
        return;
    }
    
    $charge_id = $charge->id;
    error_log('Stripe refund - Charge ID: ' . $charge_id);
    
    // Order ID aus Stripe Charge ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_transaction_id',
        'meta_value' => $charge_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe charge ID: ' . $charge_id);
        
        // Alternative Suche nach Payment Intent ID
        if (isset($charge->payment_intent)) {
            error_log('Trying to find order by payment intent: ' . $charge->payment_intent);
            $orders = wc_get_orders(array(
                'meta_key' => '_stripe_payment_intent',
                'meta_value' => $charge->payment_intent,
                'limit' => 1
            ));
            
            if (empty($orders)) {
                error_log('No order found by payment intent either');
                return;
            }
        } else {
            return;
        }
    }
    
    $order = $orders[0];
    error_log('Order found: ' . $order->get_id());
    
    // Prüfen ob vollständige oder teilweise Rückerstattung
    $refunded_amount = $charge->amount_refunded;
    $total_amount = $charge->amount;
    
    error_log(sprintf('Refund amount: %s of %s', $refunded_amount, $total_amount));
    
    if ($refunded_amount === $total_amount) {
        // Vollständige Rückerstattung
        $order->update_status('refunded', 'Stripe Zahlung vollständig zurückerstattet.');
        error_log('Order fully refunded');
    } else {
        // Teilweise Rückerstattung
        $refund_note = sprintf(
            'Stripe Zahlung teilweise zurückerstattet: %s von %s',
            wc_price($refunded_amount / 100),
            wc_price($total_amount / 100)
        );
        $order->add_order_note($refund_note);
        error_log('Order partially refunded: ' . $refund_note);
        
        // WooCommerce Refund erstellen
        $refund_amount = wc_format_decimal($refunded_amount / 100);
        wc_create_refund(array(
            'order_id' => $order->get_id(),
            'amount' => $refund_amount,
            'reason' => 'Stripe Teilrückerstattung (Webhook)'
        ));
    }
    
    $order->save();
}

/**
 * Einstellungsseite für die Zahlungsintegration hinzufügen
 */
function yprint_payment_settings_menu() {
    add_options_page(
        'YPrint Zahlungseinstellungen',
        'YPrint Zahlungen',
        'manage_options',
        'yprint-payment-settings',
        'yprint_payment_settings_page'
    );
}
add_action('admin_menu', 'yprint_payment_settings_menu');

/**
 * Zahlungseinstellungen-Seite rendern
 */
function yprint_payment_settings_page() {
    // Einstellungen speichern
    if (isset($_POST['yprint_payment_settings_nonce']) && wp_verify_nonce($_POST['yprint_payment_settings_nonce'], 'yprint_payment_settings')) {
        // PayPal Einstellungen
        if (isset($_POST['yprint_paypal_client_id'])) {
            update_option('yprint_paypal_client_id', sanitize_text_field($_POST['yprint_paypal_client_id']));
        }
        
        if (isset($_POST['yprint_paypal_secret_key'])) {
            update_option('yprint_paypal_secret_key', sanitize_text_field($_POST['yprint_paypal_secret_key']));
        }
        
        if (isset($_POST['yprint_paypal_webhook_id'])) {
            update_option('yprint_paypal_webhook_id', sanitize_text_field($_POST['yprint_paypal_webhook_id']));
        }
        
        // Stripe Einstellungen
        if (isset($_POST['yprint_stripe_public_key'])) {
            update_option('yprint_stripe_public_key', sanitize_text_field($_POST['yprint_stripe_public_key']));
        }
        
        if (isset($_POST['yprint_stripe_secret_key'])) {
            update_option('yprint_stripe_secret_key', sanitize_text_field($_POST['yprint_stripe_secret_key']));
        }
        
        if (isset($_POST['yprint_stripe_webhook_secret'])) {
            update_option('yprint_stripe_webhook_secret', sanitize_text_field($_POST['yprint_stripe_webhook_secret']));
        }
        
        echo '<div class="updated"><p>Einstellungen gespeichert.</p></div>';
    }
    
// Aktuelle Werte abrufen
$paypal_client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
$paypal_secret_key = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
$paypal_webhook_id = get_option('yprint_paypal_webhook_id', '1AP621966T021942C');

$stripe_public_key = get_option('yprint_stripe_public_key', 'pk_live_51QomI4Efl8wKMoZvo59c44NsSuDkXqUtgvqg5qpTU5D7JmJf5XGfM8wNli25KpAAhrbPf2O0gjXNg3hWCtxpyG9G00Dxkv5oxL');
$stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
$stripe_webhook_secret = get_option('yprint_stripe_webhook_secret', 'whsec_vkmfKrTYzIgzgdxDLDRlp3qAryBSowFw');

// Webhook-URLs
$paypal_webhook_url = add_query_arg('yprint-paypal-webhook', '1', home_url('/'));
$stripe_webhook_url = add_query_arg('yprint-stripe-webhook', '1', home_url('/'));
    
    ?>
    <div class="wrap">
        <h1>YPrint Zahlungseinstellungen</h1>
        
        <form method="post" action="">
            <?php wp_nonce_field('yprint_payment_settings', 'yprint_payment_settings_nonce'); ?>
            
            <h2>PayPal Einstellungen</h2>
            <table class="form-table">
                <tr>
                    <th scope="row"><label for="yprint_paypal_client_id">Client ID</label></th>
                    <td>
                        <input type="text" id="yprint_paypal_client_id" name="yprint_paypal_client_id" 
                               value="<?php echo esc_attr($paypal_client_id); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_paypal_secret_key">Secret Key</label></th>
                    <td>
                        <input type="password" id="yprint_paypal_secret_key" name="yprint_paypal_secret_key" 
                               value="<?php echo esc_attr($paypal_secret_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_paypal_webhook_id">Webhook ID</label></th>
                    <td>
                        <input type="text" id="yprint_paypal_webhook_id" name="yprint_paypal_webhook_id" 
                               value="<?php echo esc_attr($paypal_webhook_id); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row">Webhook URL (für PayPal)</th>
                    <td>
                        <code><?php echo esc_url($paypal_webhook_url); ?></code>
                        <p class="description">Diese URL im PayPal Developer Dashboard als Webhook-URL eintragen.</p>
                    </td>
                </tr>
            </table>
            
            <h2>Stripe Einstellungen</h2>
            <table class="form-table">
                <tr>
                    <th scope="row"><label for="yprint_stripe_public_key">Public Key</label></th>
                    <td>
                        <input type="text" id="yprint_stripe_public_key" name="yprint_stripe_public_key" 
                               value="<?php echo esc_attr($stripe_public_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_stripe_secret_key">Secret Key</label></th>
                    <td>
                        <input type="password" id="yprint_stripe_secret_key" name="yprint_stripe_secret_key" 
                               value="<?php echo esc_attr($stripe_secret_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_stripe_webhook_secret">Webhook Secret</label></th>
                    <td>
                        <input type="password" id="yprint_stripe_webhook_secret" name="yprint_stripe_webhook_secret" 
                               value="<?php echo esc_attr($stripe_webhook_secret); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row">Webhook URL (für Stripe)</th>
                    <td>
                        <code><?php echo esc_url($stripe_webhook_url); ?></code>
                        <p class="description">Diese URL im Stripe Dashboard als Webhook-URL eintragen.</p>
                    </td>
                </tr>
            </table>
            
            <p class="submit">
                <input type="submit" name="submit" id="submit" class="button button-primary" value="Einstellungen speichern">
            </p>
        </form>
    </div>
    <?php
}

/**
 * Erstelle Rückgabeseiten für Zahlungsprozesse
 */
function yprint_payment_return_endpoints() {
    // PayPal Rückgabeseite
    add_rewrite_rule(
        '^paypal-return/?$',
        'index.php?paypal_return=1',
        'top'
    );
    
    // Stripe Rückgabeseite
    add_rewrite_rule(
        '^stripe-return/?$',
        'index.php?stripe_return=1',
        'top'
    );
    
    // Query-Vars hinzufügen
    add_filter('query_vars', function($vars) {
        $vars[] = 'paypal_return';
        $vars[] = 'stripe_return';
        return $vars;
    });
    
    // Template für Rückgabeseiten laden
    add_action('template_redirect', function() {
        global $wp_query;
        
        if (isset($wp_query->query_vars['paypal_return']) && $wp_query->query_vars['paypal_return']) {
            include(dirname(__FILE__) . '/templates/paypal-return.php');
            exit;
        }
        
        if (isset($wp_query->query_vars['stripe_return']) && $wp_query->query_vars['stripe_return']) {
            include(dirname(__FILE__) . '/templates/stripe-return.php');
            exit;
        }
    });
}
add_action('init', 'yprint_payment_return_endpoints');

/**
 * Stelle sicher, dass die Rückgabeseiten-Templates existieren
 */
function yprint_create_payment_return_templates() {
    // PayPal-Rückgabeseite
    $paypal_template_path = dirname(__FILE__) . '/templates/paypal-return.php';
    if (!file_exists($paypal_template_path)) {
        // Ordner erstellen, falls nicht vorhanden
        if (!file_exists(dirname(__FILE__) . '/templates')) {
            mkdir(dirname(__FILE__) . '/templates', 0755, true);
        }
        
        // Template-Datei erstellen
        $paypal_template_content = '<?php
// Verhindere direkten Zugriff
if (!defined("ABSPATH")) exit;

// Order ID aus der Session abrufen
$order_id = WC()->session ? WC()->session->get("yprint_last_order_id") : 0;

// PayPal-Order ID aus URL abrufen
$paypal_order_id = isset($_GET["token"]) ? sanitize_text_field($_GET["token"]) : "";

// Prüfen, ob Benutzer abgebrochen hat
$canceled = isset($_GET["cancel"]) && $_GET["cancel"] === "true";

get_header();
?>

<div class="yprint-payment-return-container">
    <?php if ($canceled): ?>
        <div class="yprint-payment-message yprint-payment-error">
            <h2>Zahlung abgebrochen</h2>
            <p>Die PayPal-Zahlung wurde abgebrochen. Bitte versuchen Sie es erneut oder wählen Sie eine andere Zahlungsmethode.</p>
            <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
        </div>
    <?php else: ?>
        <div class="yprint-payment-message yprint-payment-success">
            <h2>Zahlung wird verarbeitet</h2>
            <p>Ihre PayPal-Zahlung wird verarbeitet. Bitte warten Sie einen Moment...</p>
            <div class="yprint-loader"></div>
        </div>
    <?php endif; ?>
</div>

<style>
.yprint-payment-return-container {
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    text-align: center;
}

.yprint-payment-message {
    padding: 30px;
    border-radius: 8px;
}

.yprint-payment-success {
    background-color: #f0f9ff;
    border: 1px solid #d1e7f7;
}

.yprint-payment-error {
    background-color: #fff2f2;
    border: 1px solid #ffcdd2;
}

.yprint-loader {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0079FF;
    border-radius: 50%;
    animation: yprint-spin 1s linear infinite;
    margin-top: 20px;
}

@keyframes yprint-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.yprint-return-button {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #0079FF;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}

.yprint-return-button:hover {
    background-color: #0068e1;
    color: white;
}
</style>

<script>
jQuery(document).ready(function($) {
    <?php if (!$canceled && !empty($paypal_order_id)): ?>
    // PayPal-Zahlung bestätigen
    $.ajax({
        type: "POST",
        url: "<?php echo admin_url("admin-ajax.php"); ?>",
        data: {
            action: "yprint_verify_paypal_return",
            paypal_order_id: "<?php echo esc_js($paypal_order_id); ?>",
            security: "<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>"
        },
        success: function(response) {
            if (response.success && response.data.redirect) {
                window.location.href = response.data.redirect;
            } else {
                // Fehler anzeigen
                $(".yprint-payment-message")
                    .removeClass("yprint-payment-success")
                    .addClass("yprint-payment-error")
                    .html(`
                        <h2>Fehler bei der Zahlung</h2>
                        <p>${response.data.message || "Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten."}</p>
                        <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                    `);
            }
        },
        error: function() {
            // Allgemeiner Fehler
            $(".yprint-payment-message")
                .removeClass("yprint-payment-success")
                .addClass("yprint-payment-error")
                .html(`
                    <h2>Fehler bei der Zahlung</h2>
                    <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
                    <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                `);
        }
    });
    <?php endif; ?>
});
</script>

<?php get_footer(); ?>';
        
        file_put_contents($paypal_template_path, $paypal_template_content);
    }
    
    // Stripe-Rückgabeseite
    $stripe_template_path = dirname(__FILE__) . '/templates/stripe-return.php';
    if (!file_exists($stripe_template_path)) {
        // Template-Datei erstellen
        $stripe_template_content = '<?php
// Verhindere direkten Zugriff
if (!defined("ABSPATH")) exit;

// Stripe-Parameter aus URL abrufen
$payment_intent = isset($_GET["payment_intent"]) ? sanitize_text_field($_GET["payment_intent"]) : "";
$payment_intent_client_secret = isset($_GET["payment_intent_client_secret"]) ? sanitize_text_field($_GET["payment_intent_client_secret"]) : "";
$redirect_status = isset($_GET["redirect_status"]) ? sanitize_text_field($_GET["redirect_status"]) : "";

get_header();
?>

<div class="yprint-payment-return-container">
    <div class="yprint-payment-message <?php echo $redirect_status === "succeeded" ? "yprint-payment-success" : "yprint-payment-error"; ?>">
        <?php if ($redirect_status === "succeeded"): ?>
            <h2>Zahlung erfolgreich</h2>
            <p>Ihre Zahlung wurde erfolgreich verarbeitet. Sie werden in Kürze weitergeleitet...</p>
            <div class="yprint-loader"></div>
        <?php else: ?>
            <h2>Zahlung nicht abgeschlossen</h2>
            <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
            <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
        <?php endif; ?>
    </div>
</div>

<style>
.yprint-payment-return-container {
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    text-align: center;
}

.yprint-payment-message {
    padding: 30px;
    border-radius: 8px;
}

.yprint-payment-success {
    background-color: #f0f9ff;
    border: 1px solid #d1e7f7;
}

.yprint-payment-error {
    background-color: #fff2f2;
    border: 1px solid #ffcdd2;
}

.yprint-loader {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0079FF;
    border-radius: 50%;
    animation: yprint-spin 1s linear infinite;
    margin-top: 20px;
}

@keyframes yprint-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.yprint-return-button {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #0079FF;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}

.yprint-return-button:hover {
    background-color: #0068e1;
    color: white;
}
</style>

<script>
jQuery(document).ready(function($) {
    <?php if ($redirect_status === "succeeded" && !empty($payment_intent)): ?>
    // Stripe-Zahlung bestätigen
    $.ajax({
        type: "POST",
        url: "<?php echo admin_url("admin-ajax.php"); ?>",
        data: {
            action: "yprint_verify_stripe_return",
            payment_intent: "<?php echo esc_js($payment_intent); ?>",
            client_secret: "<?php echo esc_js($payment_intent_client_secret); ?>",
            security: "<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>"
        },
        success: function(response) {
            if (response.success && response.data.redirect) {
                window.location.href = response.data.redirect;
            } else {
                // Fehler anzeigen
                $(".yprint-payment-message")
                    .removeClass("yprint-payment-success")
                    .addClass("yprint-payment-error")
                    .html(`
                        <h2>Fehler bei der Zahlung</h2>
                        <p>${response.data.message || "Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten."}</p>
                        <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                    `);
            }
        },
        error: function() {
            // Allgemeiner Fehler
            $(".yprint-payment-message")
                .removeClass("yprint-payment-success")
                .addClass("yprint-payment-error")
                .html(`
                    <h2>Fehler bei der Zahlung</h2>
                    <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
                    <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                `);
        }
    });
    <?php endif; ?>
});
</script>

<?php get_footer(); ?>';
        
        file_put_contents($stripe_template_path, $stripe_template_content);
    }
}
add_action('init', 'yprint_create_payment_return_templates');

/**
 * AJAX-Handler für die Überprüfung von PayPal-Rückgaben
 */
function yprint_verify_paypal_return() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || empty($_POST['paypal_order_id'])) {
        wp_send_json_error(array(
            'message' => 'PayPal Order ID fehlt'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    
    try {
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            throw new Exception('Keine zugehörige Bestellung gefunden');
        }
        
        $order = $orders[0];
        
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // PayPal Order Status abrufen
        $request = new \PayPalCheckoutSdk\Orders\OrdersGetRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 200) {
            $paypal_status = $response->result->status;
            
            if ($paypal_status === 'COMPLETED' || $paypal_status === 'APPROVED') {
                // Bei APPROVED versuchen, die Zahlung zu erfassen
                if ($paypal_status === 'APPROVED') {
                    $capture_request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
                    $capture_response = $provider->execute($capture_request);
                    
                    if ($capture_response->statusCode !== 201) {
                        throw new Exception('Fehler bei der Zahlungserfassung');
                    }
                    
                    // Transaktions-ID extrahieren
                    $transaction_id = isset($capture_response->result->purchase_units[0]->payments->captures[0]->id)
                        ? $capture_response->result->purchase_units[0]->payments->captures[0]->id
                        : '';
                } else {
                    // Bei COMPLETED die Transaktions-ID aus der Antwort extrahieren
                    $transaction_id = isset($response->result->purchase_units[0]->payments->captures[0]->id)
                        ? $response->result->purchase_units[0]->payments->captures[0]->id
                        : '';
                }
                
                // Bestellung aktualisieren
                if (!$order->is_paid()) {
                    $order->payment_complete($transaction_id);
                    $order->add_order_note('PayPal-Zahlung abgeschlossen (Transaktion ID: ' . $transaction_id . ')');
                    $order->save();
                }
                
                // Warenkorb leeren
                WC()->cart->empty_cart();
                
                wp_send_json_success(array(
                    'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
                ));
            } else {
                throw new Exception('PayPal-Status ist nicht COMPLETED oder APPROVED: ' . $paypal_status);
            }
        } else {
            throw new Exception('Fehler beim Abrufen des PayPal-Status');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Verify Return Error: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Verarbeitung der PayPal-Zahlung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_verify_paypal_return', 'yprint_verify_paypal_return');
add_action('wp_ajax_nopriv_yprint_verify_paypal_return', 'yprint_verify_paypal_return');

/**
 * AJAX-Handler für die Überprüfung von Stripe-Rückgaben
 */
function yprint_verify_stripe_return() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_intent']) || empty($_POST['payment_intent'])) {
        wp_send_json_error(array(
            'message' => 'Payment Intent ID fehlt'
        ));
        return;
    }
    
    $payment_intent_id = sanitize_text_field($_POST['payment_intent']);
    
    try {
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Payment Intent Status prüfen
        $response = \WC_Stripe_API::retrieve('payment_intents/' . $payment_intent_id);
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        // Order ID aus Stripe Payment Intent ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_stripe_payment_intent',
            'meta_value' => $payment_intent_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            throw new Exception('Keine zugehörige Bestellung gefunden');
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Zahlung erfolgreich war
        if ($response->status !== 'succeeded') {
            throw new Exception('Zahlung wurde nicht erfolgreich abgeschlossen (Status: ' . $response->status . ')');
        }
        
        // Bestellung aktualisieren
        if (!$order->is_paid()) {
            // Charge ID extrahieren
            $charge_id = isset($response->charges->data[0]->id) ? $response->charges->data[0]->id : $payment_intent_id;
            
            $order->payment_complete($charge_id);
            $order->add_order_note('Stripe-Zahlung abgeschlossen (Charge ID: ' . $charge_id . ')');
            $order->save();
        }
        
        // Warenkorb leeren
        WC()->cart->empty_cart();
        
        wp_send_json_success(array(
            'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Verify Return Error: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Verarbeitung der Stripe-Zahlung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_verify_stripe_return', 'yprint_verify_stripe_return');
add_action('wp_ajax_nopriv_yprint_verify_stripe_return', 'yprint_verify_stripe_return');

/**
 * WordPress und WooCommerce Hooks beim Aktivieren aktualisieren
 */
function yprint_payment_activation() {
    // Rewrite-Regeln aktualisieren
    flush_rewrite_rules();
    
    // Prüfen, ob erforderliche Plugins aktiviert sind
    if (!is_plugin_active('woocommerce/woocommerce.php')) {
        deactivate_plugins(plugin_basename(__FILE__));
        wp_die('Dieses Plugin benötigt WooCommerce, um zu funktionieren. Bitte installieren und aktivieren Sie WooCommerce zuerst.');
    }
    
    // Erstellen und überprüfen Sie die Webhook-Ordner und Templates
    yprint_create_payment_return_templates();
}
register_activation_hook(__FILE__, 'yprint_payment_activation');

/**
 * AJAX-Handler für die Vorbereitung einer Bestellung
 */
function yprint_prepare_order() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    
    // Temporäre Bestellung erstellen (aber noch nicht finalisieren)
    try {
        $temp_order_id = yprint_create_temp_order($checkout_data, 'pending');
        
        if ($temp_order_id) {
            // Order ID in Session speichern
            if (function_exists('WC') && WC()->session) {
                WC()->session->set('yprint_temp_order_id', $temp_order_id);
            }
            
            wp_send_json_success(array(
                'temp_order_id' => $temp_order_id,
                'message' => 'Bestellung vorbereitet'
            ));
        } else {
            wp_send_json_error(array(
                'message' => 'Fehler bei der Vorbereitung der Bestellung'
            ));
        }
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_prepare_order', 'yprint_prepare_order');
add_action('wp_ajax_nopriv_yprint_prepare_order', 'yprint_prepare_order');

/**
 * AJAX-Handler für die Finalisierung einer Bestellung nach erfolgreicher Zahlung
 */
function yprint_finalize_order() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['temp_order_id']) || empty($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Keine Bestellungs-ID angegeben'
        ));
        return;
    }
    
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_id = isset($_POST['payment_id']) ? sanitize_text_field($_POST['payment_id']) : '';
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    // Bestellung abrufen
    $order = wc_get_order($temp_order_id);
    
    if (!$order) {
        wp_send_json_error(array(
            'message' => 'Bestellung konnte nicht gefunden werden'
        ));
        return;
    }
    
    try {
        // Zahlungsinformationen speichern
        if (!empty($payment_id)) {
            $order->set_transaction_id($payment_id);
            update_post_meta($temp_order_id, '_payment_transaction_id', $payment_id);
        }
        
        if (!empty($payment_method)) {
            update_post_meta($temp_order_id, '_payment_method', $payment_method);
            $order->set_payment_method($payment_method);
            $order->set_payment_method_title(yprint_get_payment_method_title($payment_method));
        }
        
        // Bestellung als bezahlt markieren, außer bei Überweisung
        if (strpos($payment_method, 'bacs') !== false || strpos($payment_method, 'bank') !== false) {
            // Bei Überweisung: Status auf "on-hold" setzen
            $order->update_status('on-hold', __('Warte auf Zahlungseingang via Überweisung.', 'yprint'));
        } else {
            // Bei anderen Zahlungsmethoden: als bezahlt markieren
            $order->payment_complete($payment_id);
        }
        
        // Notiz hinzufügen
        $order->add_order_note(__('Zahlung erfolgreich verarbeitet.', 'yprint'));
        
        // Kundendaten speichern, wenn angemeldet
        $user_id = get_current_user_id();
        if ($user_id > 0) {
            $order->set_customer_id($user_id);
        }
        
        // Bestellung speichern
        $order->save();
        
        // Warenkorb leeren
        WC()->cart->empty_cart();
        
        // Erfolg melden
        wp_send_json_success(array(
            'order_id' => $temp_order_id,
            'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der Finalisierung der Bestellung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_finalize_order', 'yprint_finalize_order');
add_action('wp_ajax_nopriv_yprint_finalize_order', 'yprint_finalize_order');

/**
 * Modifizierte PayPal Initialisierung
 */
function yprint_init_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = isset($_POST['temp_order_id']) ? intval($_POST['temp_order_id']) : 0;
    
    try {
        // Prüfen, ob wir eine vorbereitete Bestellung haben
        if (!$temp_order_id) {
            wp_send_json_error(array(
                'message' => 'Keine temporäre Bestellungs-ID vorhanden'
            ));
            return;
        }
        
        // Bestellung abrufen
        $order = wc_get_order($temp_order_id);
        
        if (!$order) {
            wp_send_json_error(array(
                'message' => 'Bestellung konnte nicht gefunden werden'
            ));
            return;
        }
        
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // Order-Daten für PayPal vorbereiten
        $request = new \PayPalCheckoutSdk\Orders\OrdersCreateRequest();
        $request->prefer('return=representation');
        
        // Währung abrufen
        $currency = get_woocommerce_currency();
        $request->body = [
            'intent' => 'CAPTURE',
            'purchase_units' => [
                [
                    'reference_id' => $temp_order_id,
                    'description' => 'Bestellung bei YPrint',
                    'amount' => [
                        'currency_code' => $currency,
                        'value' => number_format($order->get_total(), 2, '.', ''),
                        'breakdown' => [
                            'item_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_subtotal(), 2, '.', '')
                            ],
                            'shipping' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_shipping_total(), 2, '.', '')
                            ],
                            'tax_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_total_tax(), 2, '.', '')
                            ],
                            'discount' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_discount_total(), 2, '.', '')
                            ]
                        ]
                    ]
                ]
            ],
            'application_context' => [
                'brand_name' => 'YPrint',
                'user_action' => 'PAY_NOW',
                'return_url' => home_url('/paypal-return'),
                'cancel_url' => home_url('/checkout')
            ]
        ];
        
        // PayPal Order erstellen
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201) {
            // Order ID in Meta speichern
            update_post_meta($temp_order_id, '_paypal_order_id', $response->result->id);
            
            wp_send_json_success(array(
                'paypal_order_id' => $response->result->id,
                'temp_order_id' => $temp_order_id
            ));
        } else {
            throw new Exception('Fehler bei der Kommunikation mit PayPal');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der PayPal-Initialisierung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_init_paypal_payment', 'yprint_init_paypal_payment');
add_action('wp_ajax_nopriv_yprint_init_paypal_payment', 'yprint_init_paypal_payment');

/**
 * Modifizierte PayPal Payment Capture
 */
function yprint_capture_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // Zahlung erfassen
        $request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201 || $response->statusCode === 200) {
            // Transaktions-ID extrahieren
            $transaction_id = isset($response->result->purchase_units[0]->payments->captures[0]->id)
                ? $response->result->purchase_units[0]->payments->captures[0]->id
                : $paypal_order_id;
            
            // Status und Transaktions-ID in Order Meta speichern
            update_post_meta($temp_order_id, '_paypal_payment_status', 'COMPLETED');
            update_post_meta($temp_order_id, '_paypal_transaction_id', $transaction_id);
            
            wp_send_json_success(array(
                'message' => 'Zahlung erfolgreich erfasst',
                'transaction_id' => $transaction_id
            ));
        } else {
            throw new Exception('Fehler bei der Zahlungserfassung');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Capture Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungserfassung: ' . $e->getMessage()
        ));
    }
}

/**
 * Modifizierte Stripe Initialisierung
 */
function yprint_init_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = isset($_POST['temp_order_id']) ? intval($_POST['temp_order_id']) : 0;
    
    try {
        // Prüfen, ob wir eine vorbereitete Bestellung haben
        if (!$temp_order_id) {
            wp_send_json_error(array(
                'message' => 'Keine temporäre Bestellungs-ID vorhanden'
            ));
            return;
        }
        
        // Bestellung abrufen
        $order = wc_get_order($temp_order_id);
        
        if (!$order) {
            wp_send_json_error(array(
                'message' => 'Bestellung konnte nicht gefunden werden'
            ));
            return;
        }
        
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Kundenadresse
        $customer_info = array(
            'address' => array(
                'line1' => $order->get_billing_address_1(),
                'line2' => $order->get_billing_address_2(),
                'city' => $order->get_billing_city(),
                'postal_code' => $order->get_billing_postcode(),
                'country' => $order->get_billing_country()
            ),
            'email' => $order->get_billing_email(),
            'name' => $order->get_formatted_billing_full_name(),
            'phone' => $order->get_billing_phone()
        );
        
        // Währung abrufen
        $currency = strtolower(get_woocommerce_currency());
        
        // Betrag in Cents/Kleinsten Einheiten
        $amount = intval($order->get_total() * 100);
        
        // Stripe Payment Intent erstellen
        $payment_intent_args = array(
            'amount' => $amount,
            'currency' => $currency,
            'payment_method_types' => ['card'],
            'description' => 'Bestellung #' . $order->get_order_number() . ' auf YPrint',
            'metadata' => array(
                'order_id' => $temp_order_id,
                'customer_name' => $customer_info['name'],
                'customer_email' => $customer_info['email']
            ),
            'receipt_email' => $customer_info['email']
        );
        
        // Stripe API aufrufen
        $response = \WC_Stripe_API::request($payment_intent_args, 'payment_intents');
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        if (empty($response->id) || empty($response->client_secret)) {
            throw new Exception('Ungültige Antwort von Stripe');
        }
        
        // Payment Intent ID in Order Meta speichern
        update_post_meta($temp_order_id, '_stripe_payment_intent', $response->id);
        
        wp_send_json_success(array(
            'client_secret' => $response->client_secret,
            'payment_intent_id' => $response->id,
            'temp_order_id' => $temp_order_id
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Stripe-Initialisierung: ' . $e->getMessage()
        ));
    }
}

/**
 * Modifizierte Stripe Payment Bestätigung
 */
function yprint_confirm_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_intent']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $payment_intent_id = sanitize_text_field($_POST['payment_intent']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Payment Intent Status prüfen
        $response = \WC_Stripe_API::retrieve('payment_intents/' . $payment_intent_id);
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        // Prüfen, ob Payment Intent zum Order passt
        $stored_payment_intent = get_post_meta($temp_order_id, '_stripe_payment_intent', true);
        
        if ($stored_payment_intent !== $payment_intent_id) {
            throw new Exception('Payment Intent stimmt nicht mit Bestellung überein');
        }
        
        // Prüfen, ob Zahlung erfolgreich war
        if ($response->status !== 'succeeded') {
            throw new Exception('Zahlung wurde nicht erfolgreich abgeschlossen (Status: ' . $response->status . ')');
        }
        
        // Charge ID extrahieren
        $charge_id = isset($response->charges->data[0]->id) ? $response->charges->data[0]->id : $payment_intent_id;
        
        // Status und Charge ID in Order Meta speichern
        update_post_meta($temp_order_id, '_stripe_payment_status', 'COMPLETED');
        update_post_meta($temp_order_id, '_stripe_charge_id', $charge_id);
        
        wp_send_json_success(array(
            'message' => 'Zahlung erfolgreich bestätigt',
            'charge_id' => $charge_id
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Confirm Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungsbestätigung: ' . $e->getMessage()
        ));
    }
}

/**
 * AJAX-Handler für SEPA-Zahlungsverarbeitung
 */
function yprint_process_sepa_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Daten'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    try {
        // Hier würde die echte SEPA-Verarbeitung stattfinden
        // Für dieses Beispiel generieren wir nur eine eindeutige ID
        $payment_id = 'sepa_' . time() . '_' . rand(1000, 9999);
        
        // Zahlungsdaten in Order Meta speichern
        update_post_meta($temp_order_id, '_sepa_payment_id', $payment_id);
        update_post_meta($temp_order_id, '_payment_method', $payment_method);
        
        wp_send_json_success(array(
            'payment_id' => $payment_id,
            'message' => 'SEPA-Zahlung erfolgreich verarbeitet'
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der SEPA-Zahlungsverarbeitung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_process_sepa_payment', 'yprint_process_sepa_payment');
add_action('wp_ajax_nopriv_yprint_process_sepa_payment', 'yprint_process_sepa_payment');

/**
 * AJAX-Handler für Standard-Zahlungsverarbeitung
 */
function yprint_process_standard_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Daten'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    try {
        // Hier würde die echte Zahlungsverarbeitung stattfinden
        // Für dieses Beispiel generieren wir nur eine eindeutige ID
        $payment_id = 'standard_' . time() . '_' . rand(1000, 9999);
        
        // Zahlungsdaten in Order Meta speichern
        update_post_meta($temp_order_id, '_standard_payment_id', $payment_id);
        update_post_meta($temp_order_id, '_payment_method', $payment_method);
        
        wp_send_json_success(array(
            'payment_id' => $payment_id,
            'message' => 'Zahlung erfolgreich verarbeitet'
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungsverarbeitung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_process_standard_payment', 'yprint_process_standard_payment');
add_action('wp_ajax_nopriv_yprint_process_standard_payment', 'yprint_process_standard_payment');

/**
 * Modifizierte Funktion zum Erstellen einer temporären WooCommerce-Bestellung
 */
function yprint_create_temp_order($checkout_data, $status = 'pending') {
    try {
        // Neues WooCommerce Order-Objekt erstellen
        $order = wc_create_order();
        
        // Benutzer zuweisen, falls angemeldet
        $user_id = get_current_user_id();
        if ($user_id > 0) {
            $order->set_customer_id($user_id);
        }
        
        // Warenkorb-Produkte zur Bestellung hinzufügen
        foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
            $product = $cart_item['data'];
            $quantity = $cart_item['quantity'];
            
            // Produkt zur Bestellung hinzufügen
            $order->add_product($product, $quantity);
        }
        
        // Shipping-Methode hinzufügen
        if (WC()->session && WC()->session->get('chosen_shipping_methods')) {
            $chosen_shipping_methods = WC()->session->get('chosen_shipping_methods');
            $shipping_rate = new WC_Shipping_Rate('flat_rate', 'Versand', WC()->cart->get_shipping_total(), array(), 'flat_rate');
            $order->add_shipping($shipping_rate);
        }
        
        // Adressen setzen
        if (isset($checkout_data['shipping_address'])) {
            $order->set_shipping_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_shipping_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_shipping_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_shipping_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_shipping_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_shipping_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_shipping_country($checkout_data['shipping_address']['country'] ?? 'DE');
        }
        
        // Billing-Adresse setzen (entweder von different_billing oder von shipping kopieren)
        if (isset($checkout_data['different_billing']) && ($checkout_data['different_billing'] === true || $checkout_data['different_billing'] === 'true' || $checkout_data['different_billing'] === 1 || $checkout_data['different_billing'] === '1') && isset($checkout_data['different_billing_address'])) {
            $order->set_billing_first_name($checkout_data['different_billing_address']['different_billing_first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['different_billing_address']['different_billing_last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['different_billing_address']['different_billing_address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['different_billing_address']['different_billing_address_2'] ?? '');
            $order->set_billing_city($checkout_data['different_billing_address']['different_billing_city'] ?? '');
            $order->set_billing_postcode($checkout_data['different_billing_address']['different_billing_postcode'] ?? '');
            $order->set_billing_country($checkout_data['different_billing_address']['different_billing_country'] ?? 'DE');
            $order->set_billing_email($checkout_data['different_billing_address']['different_billing_email'] ?? '');
        } else if (isset($checkout_data['shipping_address'])) {
            $order->set_billing_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_billing_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_billing_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_billing_country($checkout_data['shipping_address']['country'] ?? 'DE');
            
            // E-Mail-Adresse aus Benutzeraccount oder Session
            if ($user_id > 0) {
                $user = get_userdata($user_id);
                $order->set_billing_email($user->user_email);
            } else if (WC()->session && WC()->session->get('customer') && WC()->session->get('customer')['email']) {
                $order->set_billing_email(WC()->session->get('customer')['email']);
            }
        }
        
        // Zahlungsmethode setzen
        if (isset($checkout_data['payment_method'])) {
            $order->set_payment_method($checkout_data['payment_method']);
            $order->set_payment_method_title(yprint_get_payment_method_title($checkout_data['payment_method']));
        }
        
        // Gutschein anwenden, falls vorhanden
        if (isset($checkout_data['coupon_code']) && !empty($checkout_data['coupon_code'])) {
            $coupon_code = sanitize_text_field($checkout_data['coupon_code']);
            $coupon = new WC_Coupon($coupon_code);
            
            if ($coupon->is_valid()) {
                $order->apply_coupon($coupon_code);
            }
        }
        
        // Bestellung speichern mit dem gewünschten Status
        $order->calculate_totals();
        $order->update_status($status, 'Temporäre Bestellung erstellt für Zahlungsverarbeitung.');
        
        // Meta-Tag hinzufügen, um temporäre Bestellungen zu kennzeichnen
        update_post_meta($order->get_id(), '_yprint_temp_order', 'yes');
        
        // Bestellungs-ID zurückgeben
        return $order->get_id();
    } catch (Exception $e) {
        error_log('YPrint Checkout - Fehler bei temporärer Bestellerstellung: ' . $e->getMessage());
        return false;
    }
}
