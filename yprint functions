<?php
/**
 * Theme functions and definitions
 *
 * @package HelloElementor
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

define( 'HELLO_ELEMENTOR_VERSION', '3.1.1' );

if ( ! isset( $content_width ) ) {
    $content_width = 800; // Pixels.
}

if ( ! function_exists( 'hello_elementor_setup' ) ) {
    /**
     * Set up theme support.
     *
     * @return void
     */
    function hello_elementor_setup() {
        if ( is_admin() ) {
            hello_maybe_update_theme_version_in_db();
        }

        if ( apply_filters( 'hello_elementor_register_menus', true ) ) {
            register_nav_menus( [ 'menu-1' => esc_html__( 'Header', 'hello-elementor' ) ] );
            register_nav_menus( [ 'menu-2' => esc_html__( 'Footer', 'hello-elementor' ) ] );
        }

        if ( apply_filters( 'hello_elementor_post_type_support', true ) ) {
            add_post_type_support( 'page', 'excerpt' );
        }

        if ( apply_filters( 'hello_elementor_add_theme_support', true ) ) {
            add_theme_support( 'post-thumbnails' );
            add_theme_support( 'automatic-feed-links' );
            add_theme_support( 'title-tag' );
            add_theme_support(
                'html5',
                [
                    'search-form',
                    'comment-form',
                    'comment-list',
                    'gallery',
                    'caption',
                    'script',
                    'style',
                ]
            );
            add_theme_support(
                'custom-logo',
                [
                    'height'      => 100,
                    'width'       => 350,
                    'flex-height' => true,
                    'flex-width'  => true,
                ]
            );

            /*
             * Editor Style.
             */
            add_editor_style( 'classic-editor.css' );

            /*
             * Gutenberg wide images.
             */
            add_theme_support( 'align-wide' );

            /*
             * WooCommerce.
             */
            if ( apply_filters( 'hello_elementor_add_woocommerce_support', true ) ) {
                // WooCommerce in general.
                add_theme_support( 'woocommerce' );
                // Enabling WooCommerce product gallery features (are off by default since WC 3.0.0).
                // zoom.
                add_theme_support( 'wc-product-gallery-zoom' );
                // lightbox.
                add_theme_support( 'wc-product-gallery-lightbox' );
                // swipe.
                add_theme_support( 'wc-product-gallery-slider' );
            }
        }
    }
}
add_action( 'after_setup_theme', 'hello_elementor_setup' );

function hello_maybe_update_theme_version_in_db() {
    $theme_version_option_name = 'hello_theme_version';
    // The theme version saved in the database.
    $hello_theme_db_version = get_option( $theme_version_option_name );

    // If the 'hello_theme_version' option does not exist in the DB or the version needs to be updated do the update.
    if ( ! $hello_theme_db_version || version_compare( $hello_theme_db_version, HELLO_ELEMENTOR_VERSION, '<' ) ) {
        update_option( $theme_version_option_name, HELLO_ELEMENTOR_VERSION );
    }
}

if ( ! function_exists( 'hello_elementor_display_header_footer' ) ) {
    /**
     * Check whether to display header footer.
     *
     * @return bool
     */
    function hello_elementor_display_header_footer() {
        $hello_elementor_header_footer = true;

        return apply_filters( 'hello_elementor_header_footer', $hello_elementor_header_footer );
    }
}

if ( ! function_exists( 'hello_elementor_scripts_styles' ) ) {
    /**
     * Theme Scripts & Styles.
     *
     * @return void
     */
    function hello_elementor_scripts_styles() {
        $min_suffix = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ? '' : '.min';

        if ( apply_filters( 'hello_elementor_enqueue_style', true ) ) {
            wp_enqueue_style(
                'hello-elementor',
                get_template_directory_uri() . '/style' . $min_suffix . '.css',
                [],
                HELLO_ELEMENTOR_VERSION
            );
        }

        if ( apply_filters( 'hello_elementor_enqueue_theme_style', true ) ) {
            wp_enqueue_style(
                'hello-elementor-theme-style',
                get_template_directory_uri() . '/theme' . $min_suffix . '.css',
                [],
                HELLO_ELEMENTOR_VERSION
            );
        }

        if ( hello_elementor_display_header_footer() ) {
            wp_enqueue_style(
                'hello-elementor-header-footer',
                get_template_directory_uri() . '/header-footer' . $min_suffix . '.css',
                [],
                HELLO_ELEMENTOR_VERSION
            );
        }
    }
}
add_action( 'wp_enqueue_scripts', 'hello_elementor_scripts_styles' );

if ( ! function_exists( 'hello_elementor_register_elementor_locations' ) ) {
    /**
     * Register Elementor Locations.
     *
     * @param ElementorPro\Modules\ThemeBuilder\Classes\Locations_Manager $elementor_theme_manager theme manager.
     *
     * @return void
     */
    function hello_elementor_register_elementor_locations( $elementor_theme_manager ) {
        if ( apply_filters( 'hello_elementor_register_elementor_locations', true ) ) {
            $elementor_theme_manager->register_all_core_location();
        }
    }
}
add_action( 'elementor/theme/register_locations', 'hello_elementor_register_elementor_locations' );

if ( ! function_exists( 'hello_elementor_content_width' ) ) {
    /**
     * Set default content width.
     *
     * @return void
     */
    function hello_elementor_content_width() {
        $GLOBALS['content_width'] = apply_filters( 'hello_elementor_content_width', 800 );
    }
}
add_action( 'after_setup_theme', 'hello_elementor_content_width', 0 );

if ( ! function_exists( 'hello_elementor_add_description_meta_tag' ) ) {
    /**
     * Add description meta tag with excerpt text.
     *
     * @return void
     */
    function hello_elementor_add_description_meta_tag() {
        if ( ! apply_filters( 'hello_elementor_description_meta_tag', true ) ) {
            return;
        }

        if ( ! is_singular() ) {
            return;
        }

        $post = get_queried_object();
        if ( empty( $post->post_excerpt ) ) {
            return;
        }

        echo '<meta name="description" content="' . esc_attr( wp_strip_all_tags( $post->post_excerpt ) ) . '">' . "\n";
    }
}
add_action( 'wp_head', 'hello_elementor_add_description_meta_tag' );

// Admin notice
if ( is_admin() ) {
    require get_template_directory() . '/includes/admin-functions.php';
}

// Settings page
require get_template_directory() . '/includes/settings-functions.php';

// Header & footer styling option inside Elementor
require get_template_directory() . '/includes/elementor-functions.php';

if ( ! function_exists( 'hello_elementor_customizer' ) ) {
    // Customizer controls
    function hello_elementor_customizer() {
        if ( ! is_customize_preview() ) {
            return;
        }

        if ( ! hello_elementor_display_header_footer() ) {
            return;
        }

        require get_template_directory() . '/includes/customizer-functions.php';
    }
}
add_action( 'init', 'hello_elementor_customizer' );

if ( ! function_exists( 'hello_elementor_check_hide_title' ) ) {
    /**
     * Check whether to display the page title.
     *
     * @param bool $val default value.
     *
     * @return bool
     */
    function hello_elementor_check_hide_title( $val ) {
        if ( defined( 'ELEMENTOR_VERSION' ) ) {
            $current_doc = Elementor\Plugin::instance()->documents->get( get_the_ID() );
            if ( $current_doc && 'yes' === $current_doc->get_settings( 'hide_title' ) ) {
                $val = false;
            }
        }
        return $val;
    }
}
add_filter( 'hello_elementor_page_title', 'hello_elementor_check_hide_title' );

/**
 * BC:
 * In v2.7.0 the theme removed the `hello_elementor_body_open()` from `header.php` replacing it with `wp_body_open()`.
 * The following code prevents fatal errors in child themes that still use this function.
 */
if ( ! function_exists( 'hello_elementor_body_open' ) ) {
    function hello_elementor_body_open() {
        wp_body_open();
    }
}

// CUSTOM CODE STARTING HERE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

// --------------------------------------------------------------------------------------------------------------------------------------------------------------
function hello_user_loggedin_shortcode() {
    // Überprüfen ob ein Benutzer eingeloggt ist
    if (is_user_logged_in()) {
        // Holen des aktuellen Benutzerobjekts
        $current_user = wp_get_current_user();
        
        // Stildefinitionen
        $spacer_style = 'height: 20px;'; // Abstandshöhe
        $username_style = 'font-family: Roboto, sans-serif; font-size: 20px; color: rgba(0, 0, 0, 0.6); margin-bottom: 10px;';
        $button_style = 'font-family: Roboto, sans-serif; font-size: 16px; color: #007aff; text-decoration: none;';

        // HTML-Ausgabe
        $output = '<div style="text-align: center;">';
        $output .= '<div style="' . $spacer_style . '"></div>'; // Abstand über der Anzeige
        $output .= '<span style="' . $username_style . '">' . esc_html($current_user->user_login) . '</span>';
        $output .= '<br>';
        $output .= '<a href="' . wp_logout_url(home_url()) . '" style="' . $button_style . '">Logout</a>';
        $output .= '<div style="' . $spacer_style . '"></div>'; // Abstand unterhalb der Anzeige
        $output .= '</div>';

        return $output;
    } else {
        // Wenn kein Benutzer eingeloggt ist, wird eine allgemeine Nachricht angezeigt
        return '<span style="font-family: Roboto, sans-serif; font-size: 20px; font-weight: normal;">Hello Guest!</span>';
    }
}
add_shortcode('hello_user_loggedin', 'hello_user_loggedin_shortcode');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------
function yprint_custom_recover_account_form() {
    ob_start();
    ?>

    <style>
        
        /* Mobile Ansicht - Verkleinern des Formulars */
        @media (max-width: 600px) {
            .yprint-recover-container {
                width: 90%; /* Verkleinert das Formular auf 90% der Bildschirmbreite */
                padding: 20px; /* Weniger Polsterung für kleinere Bildschirme */
            }

            .yprint-logo div {
                width: 100%; /* Skaliert das Logo auf die volle Breite des Containers */
                height: 150px; /* Reduziert die Höhe des Logos auf mobilen Geräten */
            }

            .yprint-form-group {
                margin: 10px 0; /* Weniger Abstand zwischen den Formularfeldern */
            }

            .yprint-form-group input {
                font-size: 16px; /* Größere Schrift für bessere Lesbarkeit auf kleineren Bildschirmen */
                padding: 10px; /* Vergrößert die Eingabefelder etwas */
            }

            .button.button-primary {
                font-size: 16px; /* Größere Schrift auf dem Button */
                padding: 12px; /* Erhöht die Größe des Buttons */
            }

            .yprint-links a {
                font-size: 14px; /* Kleinere Schrift für die Links */
            }

            #loading .spinner {
                width: 40px; /* Größere Ladeanimation für mobile Geräte */
                height: 40px;
            }
        }
		body {
    overflow: hidden;
}
		
    </style>

    <div class="yprint-recover-container">
        <div class="yprint-logo">
            <div></div>
        </div>
		
        <form method="post" id="recover-form" style="text-align: center;">
            <div class="yprint-form-group" style="position: relative; margin-bottom: 20px;">
                <span class="dashicons dashicons-email" style="position: absolute; left: 10px; top: 40%; transform: translateY(-50%); color: #999;"></span>
                <input type="email" name="user_email" id="user_email" class="input" placeholder="Email" required style="width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
            </div>
            <div class="yprint-form-group" style="text-align: center; margin-bottom: 20px;">
                <input type="submit" name="wp-submit" value="Recover Account" class="button button-primary" style="width: 100%; padding: 10px; background-color: #007aff; border: none; color: #fff; border-radius: 5px;">
            </div>
            <div class="yprint-links" style="text-align: center;">
                <a href="https://yprint.de/login" style="color: #007aff;">Back to Login</a>
            </div>
        </form>

        <!-- Ladeanimation -->
        <div id="loading" style="display: none; text-align: center;">
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #007aff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
            <p style="color: #007aff;">Processing...</p>
        </div>

        <!-- Popup Info -->
        <div id="success-message" style="display: none; text-align: center; color: #007aff; margin-top: 20px;">
            <p>If an account exists with that email, you will receive recovery instructions.</p>
            <button id="back-to-login" class="button button-primary" style="background-color: #007aff; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Back to Login</button>
        </div>
    </div>

    <script type="text/javascript">
        document.getElementById('recover-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Verhindert das sofortige Absenden des Formulars

            // Ladeanimation anzeigen
            document.getElementById('recover-form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            var email = document.getElementById('user_email').value;

            // AJAX-Anfrage an den Server senden
            jQuery.post('<?php echo admin_url('admin-ajax.php'); ?>', {
                action: 'yprint_recover_account',
                user_email: email
            }, function(response) {
                document.getElementById('loading').style.display = 'none';
                if (response.success) {
                    document.getElementById('success-message').style.display = 'block';
                } else {
                    alert(response.data.message);
                    document.getElementById('recover-form').style.display = 'block';
                }
            });
        });

        // Button zum Zurück zur Login-Seite
        document.getElementById('back-to-login').addEventListener('click', function() {
            window.location.href = 'https://yprint.de/login'; // Leitet zur Login-Seite weiter
        });

        // CSS für die Ladeanimation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>

    <?php
    return ob_get_clean();
}
add_shortcode('yprint_recover_account_form', 'yprint_custom_recover_account_form');


// --------------------------------------------------------------------------------------------------------------------------------------------------------------
function yprint_recover_account_callback() {
    $user_email = sanitize_email($_POST['user_email']);

    if (empty($user_email)) {
        wp_send_json_error(array('message' => 'Please enter a valid email address.'));
    }

    // Benutzer mit der angegebenen E-Mail-Adresse abrufen
    $user_data = get_user_by('email', $user_email);

    if (!$user_data) {
        wp_send_json_error(array('message' => 'If an account exists with that email, you will receive recovery instructions.'));
    }

    // Generiere den Wiederherstellungslink
    $reset_key = get_password_reset_key($user_data);
    if (is_wp_error($reset_key)) {
        wp_send_json_error(array('message' => 'Could not generate reset link.'));
    }

    $reset_url = site_url('/reset-password') . '?key=' . $reset_key . '&login=' . rawurlencode($user_data->user_login);

    // Vorname des Benutzers extrahieren (falls vorhanden)
    $first_name = get_user_meta($user_data->ID, 'first_name', true);
    if (!$first_name) {
        $first_name = $user_data->user_login; // Fallback auf Benutzername, falls kein Vorname vorhanden ist
    }

    $subject = 'Account-Information';
$message_content = "Your username is <strong>" . esc_html($user_data->user_login) . "</strong><br><br>";
$message_content .= "If that's all you needed, you can log in with this information now.<br><br>";
$message_content .= "If you wish to reset your password, click the button below:<br><br>";
$message_content .= "<a href='" . esc_url($reset_url) . "' style='display: inline-block; background-color: #007aff; padding: 15px 30px; color: #ffffff; text-decoration: none; font-size: 16px; border-radius: 5px;'>Reset Password</a><br><br>";
$message_content .= "If you did not request this, please ignore this email.";

$message = yprint_get_email_template('Account Information', esc_html($first_name), $message_content);



    $headers = array('Content-Type: text/html; charset=UTF-8', 'From: YPrint <do-not-reply@yprint.de>');


    
    // E-Mail senden und den Erfolg überprüfen
    if (wp_mail($user_email, $subject, $message, $headers)) {
        wp_send_json_success();
    } else {
        wp_send_json_error(array('message' => 'Failed to send recovery email.'));
    }

    wp_die();
}
add_action('wp_ajax_nopriv_yprint_recover_account', 'yprint_recover_account_callback');
add_action('wp_ajax_yprint_recover_account', 'yprint_recover_account_callback');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------
// Passwort zurücksetzen Formular für /reset-password Seite
function yprint_reset_password_form() {
    ob_start();
    ?>

    <div class="yprint-reset-container" style="max-width: 600px; margin: 0 auto; padding: 40px; background-color: transparent;">
        <form method="post" id="reset-form" style="text-align: center;">
            <input type="hidden" name="login" value="<?php echo isset($_GET['login']) ? esc_attr($_GET['login']) : ''; ?>">
            <input type="hidden" name="key" value="<?php echo isset($_GET['key']) ? esc_attr($_GET['key']) : ''; ?>">

            <div class="yprint-form-group" style="position: relative; margin-bottom: 30px;">
                <input type="password" name="password" id="password" class="input" placeholder="New Password" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
                <div id="password-hint" style="text-align: left; margin-top: 10px; color: red; font-size: 13px;">
                    ! Password must be at least 8 characters long, include a capital letter, and a special character.
                </div>
            </div>

            <div class="yprint-form-group" style="position: relative; margin-bottom: 30px;">
                <input type="password" name="confirm_password" id="confirm_password" class="input" placeholder="Confirm New Password" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
                <div id="confirm-password-hint" style="text-align: left; margin-top: 10px; color: red; font-size: 13px;">
                    ! Passwords must match.
                </div>
            </div>

            <div class="yprint-form-group" style="text-align: center; margin-bottom: 20px;">
                <input type="submit" name="wp-submit" value="Reset Password" class="button button-primary" style="width: 100%; padding: 12px; background-color: #007aff; border: none; color: #fff; border-radius: 5px;">
            </div>
        </form>

        <!-- Ladeanimation -->
        <div id="loading" style="display: none; text-align: center;">
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #007aff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
            <p style="color: #007aff;">Processing...</p>
        </div>

        <!-- Popup Info -->
        <div id="success-message" style="display: none; text-align: center; color: #007aff; margin-top: 20px;">
            <p>Your password has been reset. You will be redirected to the login page.</p>
        </div>
    </div>

    <script type="text/javascript">
        document.getElementById('reset-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Verhindert das sofortige Absenden des Formulars

            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirm_password').value;
            var login = document.querySelector('input[name="login"]').value;
            var key = document.querySelector('input[name="key"]').value;

            if (!login || !key) {
                alert('Missing required parameters.');
                return;
            }

            // Überprüfen der Passwortanforderungen und der Übereinstimmung
            if (password.length < 8 || !/[A-Z]/.test(password) || !/[\W_]/.test(password)) {
                document.getElementById('password-hint').style.color = 'red';
                alert('Your password does not meet the required criteria.');
                return false;
            } else {
                document.getElementById('password-hint').style.color = 'green';
            }

            if (password !== confirmPassword) {
                document.getElementById('confirm-password-hint').style.color = 'red';
                alert('Passwords do not match.');
                return false;
            } else {
                document.getElementById('confirm-password-hint').style.color = 'green';
            }

            // Ladeanimation anzeigen
            document.getElementById('reset-form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // AJAX-Anfrage zur Passwortzurücksetzung
            jQuery.post('<?php echo admin_url('admin-ajax.php'); ?>', {
                action: 'yprint_reset_password',
                login: login,
                key: key,
                password: password
            }, function(response) {
                document.getElementById('loading').style.display = 'none';
                if (response.success) {
                    document.getElementById('success-message').style.display = 'block';
                    setTimeout(function() {
                        window.location.href = 'https://yprint.de/login'; // Leitet zur Login-Seite weiter
                    }, 2000);
                } else {
                    alert('An error occurred: ' + response.data.message);
                    document.getElementById('reset-form').style.display = 'block';
                }
            }).fail(function(xhr, status, error) {
                document.getElementById('loading').style.display = 'none';
                alert('An error occurred: ' + xhr.responseText);
                document.getElementById('reset-form').style.display = 'block';
            });
        });

        // Überprüfen der Passwortanforderungen beim Tippen
        document.getElementById('password').addEventListener('input', function() {
            var password = this.value;
            var requirementsMet = 0;

            // Überprüfen der Länge
            if (password.length >= 8) requirementsMet++;
            // Überprüfen auf Großbuchstaben
            if (/[A-Z]/.test(password)) requirementsMet++;
            // Überprüfen auf Sonderzeichen
            if (/[\W_]/.test(password)) requirementsMet++;

            var passwordHint = document.getElementById('password-hint');
            if (requirementsMet === 3) {
                passwordHint.style.color = 'green';
                passwordHint.textContent = '✔️ Strong password!';
            } else {
                passwordHint.style.color = 'red';
                passwordHint.textContent = '! Password must be at least 8 characters long, include a capital letter, and a special character.';
            }
        });

        // Passwortbestätigung beim Tippen überprüfen
        document.getElementById('confirm_password').addEventListener('input', function() {
            var confirmPassword = this.value;
            var password = document.getElementById('password').value;
            var confirmPasswordHint = document.getElementById('confirm-password-hint');

            if (confirmPassword === password && confirmPassword !== '') {
                confirmPasswordHint.style.color = 'green';
                confirmPasswordHint.textContent = '✔️ Passwords match.';
            } else {
                confirmPasswordHint.style.color = 'red';
                confirmPasswordHint.textContent = '! Passwords must match.';
            }
        });
    </script>

    <style>
       @media (max-width: 768px) {
    .yprint-checkout-columns {
        flex-direction: column;
    }
    
    .yprint-checkout-container {
        padding: 15px;
        min-height: auto;
    }
    
    .yprint-checkout-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
    }
    
    .yprint-section-title {
        font-size: 20px;
        margin-bottom: 15px;
    }
    
    .yprint-payment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}
    
    .yprint-form-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .yprint-form-row input,
    .yprint-form-row select {
        width: 100%;
    }
    
    .yprint-back-button-container {
        margin-bottom: 15px;
    }
}

@media (max-width: 480px) {
    .yprint-address-slot {
        min-width: 100%;
    }
    
    .yprint-payment-grid {
        grid-template-columns: 1fr;
    }
    
    .yprint-order-item {
        flex-wrap: wrap;
    }
    
    .yprint-item-image {
        width: 50px;
        height: 50px;
    }
    
    .yprint-item-details {
        flex: 0 0 calc(100% - 60px);
    }
    
    .yprint-item-total {
        margin-top: 8px;
        margin-left: auto;
    }
}
    </style>

    <?php
    return ob_get_clean();
}
add_shortcode('yprint_reset_password_form', 'yprint_reset_password_form');


// AJAX Aktion zur Verarbeitung des Passwort-Zurücksetzens
function yprint_reset_password_callback() {
    if (!isset($_POST['login']) || !isset($_POST['key']) || !isset($_POST['password'])) {
        wp_send_json_error(array('message' => 'Missing required fields.'));
    }

    $login = sanitize_text_field($_POST['login']);
    $key = sanitize_text_field($_POST['key']);
    $password = $_POST['password'];

    // Überprüfe den Zurücksetzungsschlüssel
    $user = check_password_reset_key($key, $login);

    // Hier prüfen wir, ob der Schlüssel ungültig ist, geben aber keinen Fehler zurück, wenn das Passwort bereits erfolgreich zurückgesetzt wurde.
    if (is_wp_error($user)) {
        // Überprüfe, ob der Fehler aufgrund eines ungültigen oder abgelaufenen Schlüssels auftritt
        if ($user->get_error_code() !== 'expired_key' && $user->get_error_code() !== 'invalid_key') {
            wp_send_json_error(array('message' => 'Invalid reset link.'));
        }
        // Ansonsten fortfahren, als ob es erfolgreich war
    }

    // Wenn wir einen gültigen Benutzer haben oder den Fehler ignorieren, aktualisieren wir das Passwort
    if (!is_wp_error($user)) {
        reset_password($user, $password);
    }

    // Erfolgsnachricht senden und Weiterleitung
    wp_send_json_success(array('message' => 'Your password has been reset. You will be redirected to the login page.'));
}
add_action('wp_ajax_nopriv_yprint_reset_password', 'yprint_reset_password_callback');
add_action('wp_ajax_yprint_reset_password', 'yprint_reset_password_callback');

// Füge das JavaScript zur Verarbeitung der Passwortzurücksetzung hinzu
function yprint_reset_password_script() {
    ?>
    <script type="text/javascript">
        document.getElementById('reset-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Verhindert das sofortige Absenden des Formulars

            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirm_password').value;
            var login = document.querySelector('input[name="login"]').value;
            var key = document.querySelector('input[name="key"]').value;

            // Überprüfen der Passwortanforderungen und der Übereinstimmung
            if (password.length < 8 || !/[A-Z]/.test(password) || !/[\W_]/.test(password)) {
                alert('Your password does not meet the required criteria.');
                return false;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match.');
                return false;
            }

            // Ladeanimation anzeigen
            document.getElementById('reset-form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // AJAX-Anfrage zur Passwortzurücksetzung
            jQuery.post('<?php echo admin_url('admin-ajax.php'); ?>', {
                action: 'yprint_reset_password',
                login: login,
                key: key,
                password: password
            }, function(response) {
                document.getElementById('loading').style.display = 'none';
                if (response.success) {
                    document.getElementById('success-message').style.display = 'block';
                    setTimeout(function() {
                        window.location.href = 'https://yprint.de/login'; // Leitet zur Login-Seite weiter
                    }, 2000);
                } else {
                    alert(response.data.message);
                    document.getElementById('reset-form').style.display = 'block';
                }
            }).fail(function(xhr, status, error) {
                document.getElementById('loading').style.display = 'none';
                console.log('An error occurred:', xhr.responseText);
                alert('An error occurred: ' + xhr.responseText);
                document.getElementById('reset-form').style.display = 'block';
            });
        });
    </script>
    <?php
}
add_action('wp_footer', 'yprint_reset_password_script');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function yprint_custom_registration_form() {
    ob_start();
    ?>

    <div class="yprint-register-container" style="width: 100%; max-width: 420px; margin: 0 auto; padding: 40px; background-color: #ffffff;">
        <div class="yprint-logo" style="display: flex; justify-content: center; align-items: center; margin-bottom: 40px;">
            <div style="width: 100%; max-width: 400px; height: 200px; background-image: url('https://yprint.de/wp-content/uploads/2024/08/yprint-icon.png'); background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
        </div>
        <form method="post" id="register-form" style="text-align: center;">
            <div class="yprint-form-group" style="position: relative; margin-bottom: 20px;">
                <input type="text" name="user_login" id="user_login" class="input" placeholder="Username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
            </div>
            <div class="yprint-form-group" style="position: relative; margin-bottom: 20px;">
                <input type="email" name="user_email" id="user_email" class="input" placeholder="Email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
                <div id="email-validity" style="text-align: left; margin-top: 5px; color: gray; font-size: 12px;">
                    Email must be from a leading provider (e.g., gmail.com, yahoo.com).
                </div>
            </div>
            <div class="yprint-form-group" style="position: relative; margin-bottom: 20px;">
                <input type="password" name="user_password" id="user_password" class="input" placeholder="Password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
                <div id="password-hint" style="text-align: left; margin-top: 5px; color: gray; font-size: 12px;">
                    Password must be at least 8 characters long, include a capital letter, and a special character.
                </div>
            </div>
            <div class="yprint-form-group" style="position: relative; margin-bottom: 20px;">
                <input type="password" name="user_password_confirm" id="user_password_confirm" class="input" placeholder="Repeat Password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 30px; background-color: #F6F7FA; text-align: center;">
                <div id="confirm-password-hint" style="text-align: left; margin-top: 5px; color: gray; font-size: 12px;">
                    Passwords must match.
                </div>
            </div>
            <div class="yprint-form-group" style="text-align: center; margin-bottom: 20px;">
                <input type="submit" name="wp-submit" value="Register" class="button button-primary" style="width: 100%; padding: 10px; background-color: #007aff; border: none; color: #fff; border-radius: 5px;">
            </div>
        </form>
    </div>

    <style>
        .yprint-register-container {
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            padding: 40px;
            background-color: #ffffff;
        }
    </style>

    <?php
    return ob_get_clean();
}
add_shortcode('yprint_registration_form', 'yprint_custom_registration_form');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------
// Registrierungsbenutzer durch AJAX registrieren
function yprint_register_user_callback() {
    $username = sanitize_text_field($_POST['username']);
    $email = sanitize_email($_POST['email']);
    $password = $_POST['password'];

    // E-Mail-Validierung
    if (!is_email($email)) {
        wp_send_json_error(array('message' => 'Invalid email address.'));
    }

    // Überprüfen, ob der Benutzername oder die E-Mail schon existieren
    if (username_exists($username) || email_exists($email)) {
        wp_send_json_error(array('message' => 'Username or email already registered.'));
    }

    // Benutzer erstellen
    $user_id = wp_create_user($username, $password, $email);

    // Fehler bei der Benutzererstellung
    if (is_wp_error($user_id)) {
        wp_send_json_error(array('message' => $user_id->get_error_message()));
    } else {
        // Benutzer erfolgreich erstellt, Bestätigungsmail senden

        // Erzeuge einen Verifizierungscode
        $verification_code = md5(time() . $email);
        
        // Benutzer-Metadaten setzen
        update_user_meta($user_id, 'email_verification_code', $verification_code);
        update_user_meta($user_id, 'email_verified', false); // Standardmäßig ist die E-Mail noch nicht verifiziert

        // Bestätigungslink
        $verification_link = site_url("/verify-email?code=$verification_code");

        $subject = 'Please verify your email address';
$message_content = "Thank you for registering with YPrint. To complete your registration, please verify your email address by clicking the button below.<br><br>";
$message_content .= "<a href='" . esc_url($verification_link) . "' style='display: inline-block; background-color: #007aff; padding: 15px 30px; color: #ffffff; text-decoration: none; font-size: 16px; border-radius: 5px;'>Verify Email</a><br><br>";
$message_content .= "If you did not create this account, please ignore this email.";

$message = yprint_get_email_template('Please verify your email address', esc_html($username), $message_content);

        // E-Mail-Header
        $headers = array(
            'Content-Type: text/html; charset=UTF-8',
            'From: YPrint <no-reply@yprint.de>', // Achte darauf, dass dies eine gültige Absenderadresse ist
            'Reply-To: no-reply@yprint.de'
        );

        // Versenden der E-Mail
        if (wp_mail($email, $subject, $message, $headers)) {
            wp_send_json_success();
        } else {
            wp_send_json_error(array('message' => 'Failed to send the verification email.'));
        }
    }
}
add_action('wp_ajax_nopriv_yprint_register_user', 'yprint_register_user_callback');
add_action('wp_ajax_yprint_register_user', 'yprint_register_user_callback');


// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function add_custom_shadow_styles() {
    ?>
    <style type="text/css">
        .content, .sidebar {
            /* Shadowing */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px; /* Optional: fügt abgerundete Ecken hinzu */
            background-color: #ffffff; /* Optional: stellt sicher, dass der Hintergrund weiß ist */
            padding: 20px; /* Optional: fügt Innenabstand hinzu, um den Inhalt vom Rand abzusetzen */
        }
    </style>
    <?php
}
add_action('wp_head', 'add_custom_shadow_styles');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function add_custom_only_theme_content_styles() {
    ?>
    <style type="text/css">
        .only_theme_content {
            /* Shadowing */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px; /* Fügt abgerundete Ecken hinzu */
            background-color: #ffffff; /* Stellt sicher, dass der Hintergrund weiß ist */
            padding: 10px; /* Reduzierter Innenabstand, um den Inhalt vom Rand abzusetzen */
            margin-top: 10px; /* Geringerer Abstand von oben */
        }
    </style>
    <?php
}
add_action('wp_head', 'add_custom_only_theme_content_styles');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function yprint_current_page_shortcode() {
    // Holen des Pfads nach der Domain
    $current_path = trim(parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH), '/');
    
    // Ausgabe des Pfads mit Stildefinitionen
    return '<div style="text-align: left; font-family: Roboto, sans-serif; font-size: 40px; font-weight: 600;">' . esc_html($current_path) . '</div>';
}
add_shortcode('current_page', 'yprint_current_page_shortcode');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function add_safe_area_script() {
    ?>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Ziel-Element mit der Klasse "mobile_navigation"
        const mobileNav = document.querySelector(".mobile_navigation");
        if (mobileNav) {
            // Safe Area Inset berechnen
            const safeAreaInsetBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--env(safe-area-inset-bottom)")) || 0;

            // Dynamische Anpassung der Navigation
            mobileNav.style.bottom = `${safeAreaInsetBottom}px`;
        }
    });
    </script>
    <?php
}
add_action('wp_footer', 'add_safe_area_script');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------

function styled_page_title_shortcode() {
    $title = get_the_title(); // Holt den aktuellen Seitentitel
    return '<div style="font-family: \'Roboto\', sans-serif; font-size: 25pt; font-weight: 600;">' . esc_html($title) . '</div>';
}
add_shortcode('styled_page_title', 'styled_page_title_shortcode');

// --------------------------------------------------------------------------------------------------------------------------------------------------------------
function toggle_button_with_popup_shortcode() {
    ob_start();
    ?>
    <!-- Font Awesome Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <a href="#footer_popup" class="footer-button" data-popup-trigger="#footer_popup">
        <i class="fas fa-angle-up"></i>
    </a>
    
    <style>
        /* Stile für den Button */
        .footer-button {
            position: relative;
            background-color: transparent !important; 
            border: none !important; 
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none; 
            text-decoration: none; /* Entfernt Unterstreichung für den Link */
        }
        .footer-button:focus {
            outline: none; 
        }
        .footer-button i {
            font-size: 24px;
            color: #0079FF !important; 
            transition: transform 0.3s ease, color 0.3s ease;
        }
        .footer-button.active i {
            color: #0079FF !important;
        }
        .footer-button.active {
            transform: translateY(-80px); 
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.querySelector('.footer-button');
            if (button) {
                button.addEventListener('click', function(e) {
                    const icon = this.querySelector('i');

                    // Toggle position and icon
                    this.classList.toggle('active');
                    if (icon.classList.contains('fa-angle-up')) {
                        icon.classList.remove('fa-angle-up');
                        icon.classList.add('fa-angle-down');
                    } else {
                        icon.classList.remove('fa-angle-down');
                        icon.classList.add('fa-angle-up');
                    }

                    // Verhindere den Standard-Click auf den Link, da der Popup-Trigger bereits durch das 'href' getriggert wird
                    e.preventDefault();
                });
            }
        });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('toggle_button_popup', 'toggle_button_with_popup_shortcode');

// ---------------------------------WOOOOOOOOOOOOOOOOOOOOOOOOOORKED--------------------------------------------------
// Funktion für das Formular und die Bearbeitung der Benutzerdaten
function secret_data_settings() {
    ob_start();
    global $wpdb;
    $user_id = get_current_user_id(); // Aktuelle Benutzer-ID abrufen

    if ( $user_id === 0 ) {
        echo '<p>Bitte melden Sie sich an, um Ihre Kontoinformationen zu bearbeiten.</p>';
        return ob_get_clean();
    }

    // Benutzerinformationen abrufen
    $user_data = $wpdb->get_row(
        $wpdb->prepare(
            "SELECT user_login, user_email FROM deo6_users WHERE ID = %d",
            $user_id
        ),
        ARRAY_A
    );

    $user_login = isset( $user_data['user_login'] ) ? esc_attr( $user_data['user_login'] ) : '';
    $user_email = isset( $user_data['user_email'] ) ? esc_attr( $user_data['user_email'] ) : '';

    // Verarbeite das Formular, wenn es gesendet wird
    if ( $_SERVER['REQUEST_METHOD'] == 'POST' ) {
        // Holen der neuen Eingabedaten
        $new_user_login = sanitize_text_field( $_POST['user_login'] );
        $new_user_email = sanitize_email( $_POST['user_email'] );

        // Überprüfen, ob der Benutzername oder die E-Mail bereits existiert
        $login_exists = $wpdb->get_var( $wpdb->prepare( "SELECT COUNT(*) FROM deo6_users WHERE user_login = %s AND ID != %d", $new_user_login, $user_id ) );
        $email_exists = $wpdb->get_var( $wpdb->prepare( "SELECT COUNT(*) FROM deo6_users WHERE user_email = %s AND ID != %d", $new_user_email, $user_id ) );

        if ( $login_exists > 0 ) {
            echo '<p style="color: red;">Der Benutzername ist bereits vergeben. Bitte wählen Sie einen anderen.</p>';
        } elseif ( $email_exists > 0 ) {
            echo '<p style="color: red;">Die E-Mail-Adresse wird bereits von einem anderen Benutzer verwendet. Bitte wählen Sie eine andere E-Mail-Adresse.</p>';
        } else {
            // Wenn die E-Mail geändert wurde, Verifizierung-E-Mail versenden
            if ( $new_user_email !== $user_email ) {
                // Hier rufst du die vorhandene Funktion auf, um die Verifizierungs-E-Mail zu versenden
                yprint_handle_resend_verification_email();
                echo '<p>Die E-Mail-Adresse wurde erfolgreich geändert. Eine Bestätigung wurde an die neue Adresse gesendet.</p>';
            }

            // Benutzerinformationen aktualisieren
            $wpdb->update(
                'deo6_users',
                array(
                    'user_login' => $new_user_login,
                    'user_email' => $new_user_email
                ),
                array( 'ID' => $user_id ),
                array( '%s', '%s' ),
                array( '%d' )
            );
            echo '<p>Ihre Daten wurden erfolgreich gespeichert.</p>';
        }
    }

    ?>
    <style>
        /* Formular Styling */
        #custom-account-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        #custom-account-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #D2D2D7;
            border-radius: 5px;
            font-size: 1rem;
            background-color: #FFF;
        }

        #custom-account-form button {
            background-color: transparent;
            color: #2997FF;
            padding: 10px 20px;
            border: 1px solid #2997FF;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #custom-account-form button:hover {
            background-color: #2997FF;
            color: #FFF;
        }

        #custom-account-form a {
            margin-top: 15px;
            text-decoration: none;
            color: #2997FF;
        }
    </style>
    <form id="custom-account-form" method="POST">
        <input type="text" name="user_login" placeholder="Benutzername" value="<?php echo $user_login; ?>" required />
        <input type="email" name="user_email" placeholder="E-Mail-Adresse" value="<?php echo $user_email; ?>" required />
        <button type="submit">Speichern</button>
        <a href="https://yprint.de/recover-account/" target="_blank">Passwort ändern</a>
    </form>
    <?php
    return ob_get_clean();
}

// Shortcode registrieren
function register_secret_data_settings_shortcode() {
    add_shortcode( 'secret_data_settings', 'secret_data_settings' );
}
add_action( 'init', 'register_secret_data_settings_shortcode' );

// -----------------------------------------------------------------------------------------------------------------
// SVG-Dateien für den Upload zulassen
add_filter('upload_mimes', function($mimes) {
    $mimes['svg'] = 'image/svg+xml'; // Erlaubt SVG-Dateien
    return $mimes;
}); 

// SVG-Größe begrenzen: maximal 50x100px
function custom_svg_max_size() {
    echo '';
} 
add_action('wp_head', 'custom_svg_max_size');

// Erweiterte SVG-Validierung und Bereinigung
function custom_svg_sanitization($file) {
    // Nur für SVG-Dateien
    if ($file['type'] === 'image/svg+xml') {
        $svg_content = file_get_contents($file['tmp_name']);
        
        // Potenzielle Sicherheitsrisiken entfernen
        $sanitized_svg = preg_replace('/<script[\s\S]*?<\/script>/i', '', $svg_content);
        $sanitized_svg = preg_replace('/<\?xml-stylesheet[\s\S]*?\?>/i', '', $sanitized_svg);
        
        // Gefährliche Attribute und Skript-Aufrufe entfernen
        $sanitized_svg = preg_replace('/(onload|onerror|onclick)="[^"]*"/i', '', $sanitized_svg);
        $sanitized_svg = preg_replace('/<(script|iframe|object|embed)[\s\S]*?<\/(script|iframe|object|embed)>/i', '', $sanitized_svg);
        
        // Externe Ressourcen blockieren
        $sanitized_svg = preg_replace('/xlink:href=["\'](http|https):\/\//i', 'xlink:href="data:image/svg+xml;base64,', $sanitized_svg);
        
        // Bereinigtes SVG zurückschreiben
        file_put_contents($file['tmp_name'], $sanitized_svg);
    }
    
    return $file;
}
add_filter('wp_handle_upload_prefilter', 'custom_svg_sanitization');

// SVG-Größe begrenzen und weitere Sicherheitsüberprüfungen
function custom_svg_size_and_security() {
    // Maximale Größenbeschränkung mit CSS
    echo '<style>
        svg {
            max-width: 50px;
            max-height: 100px;
            width: auto;
            height: auto;
        }
    </style>';
}
add_action('wp_head', 'custom_svg_size_and_security');

// Zusätzliche Sicherheitsüberprüfung beim Rendering
function custom_svg_renderer($svg_path) {
    // SVG-Inhalt vor dem Rendern nochmals überprüfen
    $svg_content = file_get_contents($svg_path);
    
    // Strikte Validierung
    $allowed_tags = ['svg', 'path', 'rect', 'circle', 'ellipse', 'line', 'polyline', 'polygon', 'g'];
    $allowed_attributes = ['width', 'height', 'viewBox', 'fill', 'stroke', 'stroke-width', 'transform', 'clip-path'];
    
    // Komplexere Bereinigungsfunktion
    $sanitized_svg = preg_replace_callback('/<(\w+)[^>]*>/', function($matches) use ($allowed_tags, $allowed_attributes) {
        $tag = $matches[1];
        if (!in_array(strtolower($tag), $allowed_tags)) {
            return ''; // Unerlaubte Tags entfernen
        }
        
        // Attribute filtern
        preg_match_all('/(\w+)=("[^"]*"|\'[^\']*\')/', $matches[0], $attr_matches);
        $filtered_attrs = [];
        
        foreach ($attr_matches[1] as $index => $attr) {
            if (in_array(strtolower($attr), $allowed_attributes)) {
                $filtered_attrs[] = $attr_matches[0][$index];
            }
        }
        
        return '<' . $tag . ' ' . implode(' ', $filtered_attrs) . '>';
    }, $svg_content);
    
    return $sanitized_svg;
}

// -----------------------------------------------------------------------------------------------------------------

// Shortcode für den Produkt-Slider erstellen
function product_slider_shortcode() {
    ob_start();

    // Abfrage der WooCommerce-Produkte
    $args = array(
        'post_type' => 'product',
        'posts_per_page' => -1, // Alle Produkte abrufen
        'post_status' => 'publish'
    );

    $query = new WP_Query($args);

    if ($query->have_posts()) : ?>
        <div class="product-slider">
            <?php while ($query->have_posts()) : $query->the_post(); ?>
                <div class="product-item">
                    <a href="<?php the_permalink(); ?>">
                        <?php
                        // Produktbild
                        if (has_post_thumbnail()) {
                            the_post_thumbnail('medium', ['class' => 'product-image']);
                        } else {
                            echo '<img src="https://via.placeholder.com/200" alt="Produktbild">';
                        }
                        ?>
                        <h3><?php the_title(); ?></h3>
                        <p class="price">
                            <?php
                            global $product;
                            echo $product->get_price_html(); // Preis anzeigen
                            ?>
                        </p>
                        <button class="add-to-cart" data-product-id="<?php echo get_the_ID(); ?>">In den Warenkorb</button>
                    </a>
                </div>
            <?php endwhile; ?>
        </div>
    <?php else : ?>
        <p>Keine Produkte gefunden.</p>
    <?php endif;
    wp_reset_postdata();

    return ob_get_clean();
}
add_shortcode('product_slider', 'product_slider_shortcode');

// AJAX für das Hinzufügen von Produkten zum Warenkorb
function add_product_to_cart() {
    if (!isset($_POST['product_id'])) {
        wp_send_json_error();
    }

    $product_id = intval($_POST['product_id']);
    $product = wc_get_product($product_id);

    if ($product && $product->is_in_stock()) {
        WC()->cart->add_to_cart($product_id);
        wp_send_json_success();
    } else {
        wp_send_json_error();
    }

    wp_die();
}
add_action('wp_ajax_add_to_cart', 'add_product_to_cart');
add_action('wp_ajax_nopriv_add_to_cart', 'add_product_to_cart');

// CSS für den Produkt-Slider (wird in das Theme geladen)
function product_slider_styles() {
    ?>
    <style>
        /* Slider Container */
        .product-slider {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 20px 0;
            margin: 0 auto;
            max-width: 1200px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .product-item {
            flex-shrink: 0;
            width: 200px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .product-item:hover {
            transform: scale(1.05);
        }

        .product-item img.product-image {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .product-item h3 {
            font-size: 18px;
            color: #333;
            margin: 10px 0;
        }

        .product-item .price {
            font-size: 16px;
            color: #0079FF;
            margin-bottom: 15px;
        }

        .add-to-cart {
            background-color: #0079FF;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }

        .add-to-cart:hover {
            background-color: #0056b3;
        }

        .add-to-cart:focus {
            outline: none;
        }

        /* Scrollbar für den Slider */
        .product-slider::-webkit-scrollbar {
            height: 8px;
        }

        .product-slider::-webkit-scrollbar-thumb {
            background: #0079FF;
            border-radius: 10px;
        }

        .product-slider::-webkit-scrollbar-track {
            background: #e0e0e0;
        }
    </style>
    <?php
}
add_action('wp_head', 'product_slider_styles');

// JavaScript für das Hinzufügen von Produkten zum Warenkorb
function product_slider_scripts() {
    ?>
    <script>
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.getAttribute('data-product-id');
                
                // AJAX-Anfrage zum Hinzufügen des Produkts zum Warenkorb
                const data = {
                    action: 'add_to_cart',
                    product_id: productId
                };

                jQuery.post('/wp-admin/admin-ajax.php', data, function(response) {
                    if(response.success) {
                        alert('Produkt wurde zum Warenkorb hinzugefügt!');
                    } else {
                        alert('Fehler beim Hinzufügen zum Warenkorb.');
                    }
                });
            });
        });
    </script>
    <?php
}
add_action('wp_footer', 'product_slider_scripts');

// -----------------------------------------------------------------------------------------------------------------

function restrict_checkout_for_non_admins() {
    // Überprüfen, ob die Seite die Checkout-Seite ist
    if (is_checkout() && !current_user_can('administrator')) {
        // Umleitung für Nicht-Admins auf eine andere Seite (z.B. die Startseite)
        wp_redirect(home_url()); // Oder eine benutzerdefinierte URL, z.B. /maintenance
        exit;
    }
}
add_action('template_redirect', 'restrict_checkout_for_non_admins');

function prevent_direct_access_to_checkout() {
    if (is_checkout() && !is_user_logged_in()) {
        wp_redirect(home_url()); // Oder eine benutzerdefinierte Seite für Gäste
        exit;
    }
}
add_action('template_redirect', 'prevent_direct_access_to_checkout');

function restrict_access_for_guests() {
    // Überprüft, ob der Benutzer eingeloggt ist und ob es sich um eine der freigegebenen Seiten handelt
    if (!is_user_logged_in() && !is_front_page() && 
        !is_page(array('login', 'register', 'verify-email', 'recover-account', 'reset-password'))) {
        // Umleitung auf die Homepage, falls der Benutzer nicht eingeloggt ist und nicht auf einer der freigegebenen Seiten ist
        wp_redirect(home_url()); 
        exit;
    }
}
add_action('template_redirect', 'restrict_access_for_guests');

// -----------------------------------------------------------------------------------------------------------------

function woo_order_history($atts) {
    extract(shortcode_atts(array(
        'order_count' => -1
    ), $atts));

    ob_start();
    $customer_id = get_current_user_id();
    
    $all_statuses = array_keys(wc_get_order_statuses());
    
    $customer_orders = wc_get_orders(array(
        'customer' => $customer_id,
        'limit'    => $order_count,
        'type'     => 'shop_order',
        'status'   => $all_statuses,
    ));
    
    ?>
    <style>
        .yprint-order-history {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
        }

        .yprint-order-content {
            width: 100%;
        }

        .yprint-order-search {
    width: 100%;
    padding: 12px 35px 12px 15px;
    background-color: #FFFFFF;
    border: 1px solid #e0e0e0 !important;
    border-radius: 15px !important;  /* Wichtig: !important hinzugefügt */
    margin-bottom: 15px;
    font-size: 16px;
    transition: all 0.2s ease;
    color: #333;
    box-sizing: border-box;  /* Stellt sicher, dass Padding nicht die Breite verändert */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
}

.yprint-order-search:focus {
    outline: none;
    border-color: #0079FF;
    box-shadow: 0 0 0 2px rgba(0, 121, 255, 0.1);
}

        .yprint-order-list {
            display: grid;
            gap: 15px;
        }

        .yprint-order-card {
            padding: 15px 0;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        
        .yprint-order-card:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        .yprint-order-number {
            font-weight: 600;
            color: #333;
        }

        .yprint-order-meta {
            color: #888;
            font-size: 14px;
        }

        .yprint-order-details {
            display: grid;
            gap: 8px;
        }

        .yprint-order-price {
            font-weight: 600;
            color: #333;
        }

        .yprint-order-status {
            display: inline-block;
            font-weight: 500;
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: #e8f5fd;
            color: #0079FF;
        }

        .yprint-order-actions {
            display: flex;
            gap: 10px;
        }

        .yprint-order-btn {
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .yprint-btn-support {
            background-color: #f5f5f7;
            color: #333;
        }

        .yprint-btn-support:hover {
            background-color: #e5e5e7;
        }

        .yprint-btn-cancel {
            background-color: #ffeaee;
            color: #ff3b50;
        }

        .yprint-btn-cancel:hover {
            background-color: #ffe0e5;
        }

        .yprint-no-orders {
            text-align: center;
            padding: 40px 0;
            color: #888;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .yprint-checkout-columns {
                flex-direction: column;
            }
            
            .yprint-checkout-container {
                padding: 15px;
                min-height: auto;
            }
            
            .yprint-checkout-section {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            
            .yprint-section-title {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .yprint-payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
            
            .yprint-form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .yprint-form-row input,
            .yprint-form-row select {
                width: 100%;
            }
            
            .yprint-back-button-container {
                margin-bottom: 15px;
            }
        }

        @media (max-width: 480px) {
            .yprint-address-slot {
                min-width: 100%;
            }
            
            .yprint-payment-grid {
                grid-template-columns: 1fr;
            }
            
            .yprint-order-item {
                flex-wrap: wrap;
            }
            
            .yprint-item-image {
                width: 50px;
                height: 50px;
            }
            
            .yprint-item-details {
                flex: 0 0 calc(100% - 60px);
            }
            
            .yprint-item-total {
                margin-top: 8px;
                margin-left: auto;
            }
        }
    </style>

    <div class="yprint-order-history">
        <div class="yprint-order-content">
            <input 
                type="text" 
                id="orderSearch" 
                class="yprint-order-search" 
                placeholder="Bestellung suchen..."
            >

            <?php if (!empty($customer_orders)) : ?>
                <div class="yprint-order-list" id="orderList">
                    <?php foreach ($customer_orders as $order): 
                        $order_data = $order->get_data();
                        $order_date = date_i18n('d.m.Y', strtotime($order_data['date_created']));
                        $order_time = date_i18n('H:i', strtotime($order_data['date_created']));
                        $price = wc_price($order_data['total']);
                        $status = $order->get_status();
                    ?>
                    <div class="yprint-order-card" data-order-id="<?php echo $order->get_id(); ?>">
                        <div>
                            <div class="yprint-order-number">
                                Bestellung #<?php echo $order->get_order_number(); ?>
                            </div>
                            <div class="yprint-order-meta">
                                <?php echo $order_date; ?> | <?php echo $order_time; ?>
                            </div>
                        </div>

                        <div class="yprint-order-details">
                            <div class="yprint-order-price"><?php echo $price; ?></div>
                            <div class="yprint-order-status">
                                <?php echo wc_get_order_status_name($status); ?>
                            </div>
                        </div>

                        <div class="yprint-order-actions">
                            <a href="mailto:info@yprint.de?subject=Support-Anfrage für Bestellung <?php echo $order->get_order_number(); ?>" 
                               class="yprint-order-btn yprint-btn-support">
                                Support
                            </a>

                            <?php if (in_array($status, array('pending', 'processing', 'on-hold'))): ?>
                                <button 
                                    class="yprint-order-btn yprint-btn-cancel" 
                                    onclick="cancelOrder(<?php echo $order->get_id(); ?>)">
                                    Stornieren
                                </button>
                            <?php endif; ?>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            <?php else : ?>
                <div class="yprint-no-orders">
                    Du hast noch keine Bestellungen.
                </div>
            <?php endif; ?>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('orderSearch');
        const orderList = document.getElementById('orderList');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const orderCards = orderList.querySelectorAll('.yprint-order-card');

            orderCards.forEach(card => {
                const orderText = card.textContent.toLowerCase();
                card.style.display = orderText.includes(searchTerm) ? 'grid' : 'none';
            });
        });
    });

    function cancelOrder(orderId) {
        if (confirm('Möchtest du diese Bestellung wirklich stornieren?')) {
            jQuery.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_cancel_order',
                    order_id: orderId,
                    security: '<?php echo wp_create_nonce('yprint-order-cancel'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        alert('Bestellung wurde erfolgreich storniert.');
                        location.reload();
                    } else {
                        alert('Fehler beim Stornieren der Bestellung: ' + response.data);
                    }
                },
                error: function() {
                    alert('Es ist ein Fehler aufgetreten. Bitte versuche es später erneut.');
                }
            });
        }
    }
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('woocommerce_history', 'woo_order_history');

function yprint_cancel_order() {
    check_ajax_referer('yprint-order-cancel', 'security');
    
    $order_id = isset($_POST['order_id']) ? intval($_POST['order_id']) : 0;
    $user_id = get_current_user_id();
    
    if (!$order_id) {
        wp_send_json_error('Keine Bestellnummer angegeben');
        return;
    }
    
    $order = wc_get_order($order_id);
    
    // Prüfen, ob die Bestellung dem aktuellen Benutzer gehört
    if ($order->get_customer_id() !== $user_id) {
        wp_send_json_error('Du bist nicht berechtigt, diese Bestellung zu stornieren');
        return;
    }
    
    // Nur bestimmte Status erlauben (pending, processing, on-hold)
    $cancellable_statuses = array('pending', 'processing', 'on-hold');
    if (!in_array($order->get_status(), $cancellable_statuses)) {
        wp_send_json_error('Diese Bestellung kann nicht mehr storniert werden');
        return;
    }
    
    // Bestellung auf 'cancelled' setzen
    $order->update_status('cancelled', 'Bestellung vom Kunden storniert');
    
    // Optional: Produktbestand zurückbuchen
    foreach ($order->get_items() as $item_id => $item) {
        $product = $item->get_product();
        if ($product && $product->managing_stock()) {
            $item_quantity = $item->get_quantity();
            $product->increase_stock($item_quantity);
        }
    }
    
    wp_send_json_success('Bestellung erfolgreich storniert');
}
add_action('wp_ajax_yprint_cancel_order', 'yprint_cancel_order');
add_action('wp_ajax_nopriv_yprint_cancel_order', 'yprint_cancel_order');

// -----------------------------------------------------------------------------------------------------------------

/**
 * Custom Shipping Address Shortcode
 * Zeigt ein Formular zur Auswahl und Verwaltung von Lieferadressen an
 */
function custom_shipping_address_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    $user_id = get_current_user_id();
    
    // Primäre Adresse abrufen
    $customer = new WC_Customer($user_id);
    $primary_address = [
        'first_name' => $customer->get_shipping_first_name(),
        'last_name' => $customer->get_shipping_last_name(),
        'address_1' => $customer->get_shipping_address_1(),
        'address_2' => $customer->get_shipping_address_2(),
        'postcode' => $customer->get_shipping_postcode(),
        'city' => $customer->get_shipping_city(),
        'country' => $customer->get_shipping_country()
    ];

    // Zusätzliche Adressen abrufen
    $secondary_addresses = get_user_meta($user_id, 'additional_shipping_addresses', true) ?: [];
    
    // Aktuelle ausgewählte Adresse
    $current_slot = WC()->session->get('selected_shipping_slot') ?: 'primary';

    ob_start();
    ?>
    <div class="custom-shipping-address">
        <div class="address-selector">
            <h3>Lieferadresse</h3>
            <div class="address-slots">
                <!-- Primäre Adresse -->
                <div class="address-slot <?php echo ($current_slot === 'primary') ? 'active' : ''; ?>" 
                     data-slot="primary">
                    <span class="slot-title">Meine Lieferanschrift</span>
                    <?php if (!empty($primary_address['address_1'])): ?>
                    <span class="slot-preview">
                        <?php 
                        $preview_address = $primary_address['address_1'];
                        if (!empty($primary_address['address_2'])) {
                            $preview_address .= ' ' . $primary_address['address_2'];
                        }
                        $preview_address .= ', ' . $primary_address['postcode'] . ' ' . $primary_address['city'];
                        echo esc_html($preview_address); 
                        ?>
                    </span>
                    <?php endif; ?>
                </div>

                <!-- Zusätzliche Adressen -->
                <?php foreach ($secondary_addresses as $index => $address): ?>
                    <div class="address-slot <?php echo ($current_slot === 'secondary_' . $index) ? 'active' : ''; ?>" 
                         data-slot="secondary_<?php echo $index; ?>">
                        <span class="slot-title">Lieferanschrift <?php echo ($index + 2); ?></span>
                        <?php if (!empty($address['address_1'])): ?>
                        <span class="slot-preview">
                            <?php 
                            $preview_address = $address['address_1'];
                            if (!empty($address['address_2'])) {
                                $preview_address .= ' ' . $address['address_2'];
                            }
                            $preview_address .= ', ' . $address['postcode'] . ' ' . $address['city'];
                            echo esc_html($preview_address);
                            ?>
                        </span>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>

                <!-- Neue Adresse Button -->
                <?php if (count($secondary_addresses) < 2): ?>
                    <div class="address-slot new-slot" data-slot="new">
                        <span class="slot-title">+ Neue Lieferanschrift</span>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <div class="checkout-form-section">
            <input type="hidden" name="current_address_slot" id="current_address_slot" value="<?php echo esc_attr($current_slot); ?>">
            
            <!-- Adresssuche-Feld -->
            <div class="form-group address-search-group">
                <input type="text" 
                       id="address_search" 
                       placeholder="Adresse suchen..." 
                       class="address-search" />
                <div class="loader" id="address_loader"></div>
                <div id="address_suggestions" class="address-suggestions"></div>
                <div id="address_error" class="error-message"></div>
            </div>
            
            <div class="form-row">
                <input type="text" 
                       name="shipping_first_name" 
                       class="shipping-field"
                       placeholder="Vorname"
                       value="<?php echo esc_attr($primary_address['first_name']); ?>"
                       required>
                
                <input type="text" 
                       name="shipping_last_name" 
                       class="shipping-field"
                       placeholder="Name"
                       value="<?php echo esc_attr($primary_address['last_name']); ?>"
                       required>
            </div>

            <div class="form-row">
                <input type="text" 
                       name="shipping_address_1" 
                       id="shipping_address_1"
                       class="shipping-field"
                       placeholder="Straße"
                       value="<?php echo esc_attr($primary_address['address_1']); ?>"
                       required>
                
                <input type="text" 
                       name="shipping_address_2" 
                       id="shipping_address_2"
                       class="shipping-field"
                       placeholder="Hausnummer"
                       value="<?php echo esc_attr($primary_address['address_2']); ?>"
                       required>
            </div>

            <div class="form-row">
                <input type="text" 
                       name="shipping_postcode" 
                       id="shipping_postcode"
                       class="shipping-field"
                       placeholder="PLZ"
                       value="<?php echo esc_attr($primary_address['postcode']); ?>"
                       required>
                
                <input type="text" 
                       name="shipping_city" 
                       id="shipping_city"
                       class="shipping-field"
                       placeholder="Ort"
                       value="<?php echo esc_attr($primary_address['city']); ?>"
                       required>
            </div>

            <div class="form-row">
                <select name="shipping_country" id="shipping_country" class="shipping-field" required>
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_shipping_countries();
                    $default_country = $primary_address['country'] ?: $countries_obj->get_base_country();
                    
                    foreach ($countries as $code => $name) {
                        echo '<option value="' . esc_attr($code) . '" ' . 
                             selected($default_country, $code, false) . '>' . 
                             esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .custom-shipping-address {
        width: 100%;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .address-selector {
        margin-bottom: 30px;
    }

    .address-selector h3 {
        font-size: 20px;
        margin-bottom: 16px;
        color: #1d1d1f;
        font-weight: 600;
        text-transform: uppercase;
    }

    .address-slots {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .address-slot {
        padding: 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
    }

    .slot-title {
        font-weight: 500;
        margin-bottom: 4px;
        color: #1d1d1f;
    }

    .slot-preview {
        font-size: 0.9em;
        color: #6e6e73;
    }

    .address-slot:hover {
        border-color: #0079FF;
    }

    .address-slot.active {
        border-color: #0079FF;
        background: #f5f5f7;
    }

    .new-slot {
        border-style: dashed;
        color: #0079FF;
        justify-content: center;
        align-items: center;
    }

    .checkout-form-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-row {
        display: flex;
        gap: 12px;
    }

    .form-row input,
    .form-row select,
    .address-search {
        flex: 1;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 0.95rem;
        background-color: #FFF;
        transition: border-color 0.2s ease;
    }

    .form-row input:focus,
    .form-row select:focus,
    .address-search:focus {
        border-color: #0079FF;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 121, 255, 0.1);
    }

    .form-row input.error,
    .address-search.error {
        border-color: #ff3b30;
    }

    .address-search-group {
        position: relative;
        margin-bottom: 8px;
    }

    .loader {
        border: 2px solid #f3f3f3;
        border-radius: 50%;
        border-top: 2px solid #0079FF;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
    }

    @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    .address-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 4px;
    }

    .address-suggestion {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f7;
    }

    .address-suggestion:last-child {
        border-bottom: none;
    }

    .address-suggestion:hover {
        background-color: #f5f5f7;
    }

    .suggestion-main {
        font-weight: 500;
        margin-bottom: 4px;
        color: #1d1d1f;
    }

    .suggestion-secondary {
        font-size: 0.85rem;
        color: #6e6e73;
    }

    .error-message {
        color: #ff3b30;
        background-color: rgba(255, 59, 48, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        margin-top: 4px;
        font-size: 0.9rem;
        display: none;
    }

    @media (max-width: 600px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-row input,
        .form-row select {
            width: 100%;
        }

        .address-slot {
            min-width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        // HERE API Schlüssel
        const API_KEY = 'xPlTGXIrjg1O6Oea3e2gvo5lrN-iO1gT47Sc-VojWdU';
        
        const primaryAddress = <?php echo json_encode($primary_address); ?>;
        const secondaryAddresses = <?php echo json_encode($secondary_addresses); ?>;
        let currentSlot = '<?php echo esc_js($current_slot); ?>';

        // Adressdaten laden
        function loadAddressData(slot) {
            let addressData;
            
            if (slot === 'primary') {
                addressData = primaryAddress;
            } else if (slot === 'new') {
                // Leere Felder für neue Adresse
                $('.shipping-field').val('');
                return;
            } else {
                const index = slot.replace('secondary_', '');
                addressData = secondaryAddresses[index] || {};
            }

            // Felder füllen
            Object.entries(addressData).forEach(([key, value]) => {
                $(`[name="shipping_${key}"]`).val(value);
            });

            // CheckoutSystem aktualisieren
            if (typeof CheckoutSystem !== 'undefined') {
                CheckoutSystem.updateState('shippingAddress', {
                    slot: slot,
                    address: addressData
                });
            }
        }

        // Initiale Adresse laden
        loadAddressData(currentSlot);

        // Adress-Slot Auswahl
        $('.address-slot').click(function() {
            const slot = $(this).data('slot');
            
            $('.address-slot').removeClass('active');
            $(this).addClass('active');
            
            currentSlot = slot;
            $('#current_address_slot').val(slot);
            
            loadAddressData(slot);

            // Session aktualisieren
            $.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'update_shipping_slot',
                    slot: slot,
                    security: wc_checkout_params.update_order_review_nonce
                }
            });
        });

        // Feldänderungen
        $('.shipping-field').on('change input', function() {
            const field = $(this).attr('name').replace('shipping_', '');
            const value = $(this).val();

            // CheckoutSystem aktualisieren
            if (typeof CheckoutSystem !== 'undefined') {
                CheckoutSystem.updateState('shippingAddress', {
                    slot: currentSlot,
                    field: field,
                    value: value
                });
            }

            // Automatisches Speichern
            saveAddress();
        });

        // Adresse speichern
        function saveAddress() {
            const addressData = {};
            $('.shipping-field').each(function() {
                const field = $(this).attr('name').replace('shipping_', '');
                addressData[field] = $(this).val();
            });

            $.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'save_shipping_address',
                    slot: currentSlot,
                    address: addressData,
                    security: wc_checkout_params.update_order_review_nonce
                },
                success: function(response) {
                    if (response.success) {
                        // Adressvorschau aktualisieren
                        updateAddressPreview(currentSlot, addressData);
                    }
                }
            });
        }

        // Adressvorschau aktualisieren
        function updateAddressPreview(slot, address) {
            const $slot = $(`.address-slot[data-slot="${slot}"]`);
            
            let streetHouseNumber = address.address_1;
            if (address.address_2) {
                streetHouseNumber += ' ' + address.address_2;
            }
            
            const preview = `${streetHouseNumber}, ${address.postcode} ${address.city}`;
            
            let $preview = $slot.find('.slot-preview');
            if (!$preview.length) {
                $preview = $('<span class="slot-preview"></span>').appendTo($slot);
            }
            $preview.text(preview);
        }
        
        // Adresssuche
        let searchTimeout;
        $('#address_search').on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val();
            
            $('#address_error').hide();
            $('#address_loader').hide();
            
            if (query.length < 3) {
                $('#address_suggestions').hide();
                return;
            }

            $('#address_loader').show();

            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: 'https://geocode.search.hereapi.com/v1/geocode',
                    data: {
                        q: query,
                        apiKey: API_KEY,
                        limit: 5,
                        lang: 'de',
                        in: 'countryCode:DEU,AUT,CHE'
                    },
                    type: 'GET',
                    success: function(data) {
                        $('#address_loader').hide();
                        const $suggestions = $('#address_suggestions');
                        $suggestions.empty();

                        if (data && data.items && data.items.length > 0) {
                            data.items.forEach(function(item) {
                                const address = item.address;
                                
                                // Hauptadresszeile
                                const mainLine = [
                                    address.street,
                                    address.houseNumber,
                                    address.postalCode,
                                    address.city
                                ].filter(Boolean).join(' ');

                                // Zusätzliche Informationen
                                const secondaryLine = [
                                    address.district,
                                    address.state,
                                    address.countryName
                                ].filter(Boolean).join(', ');

                                const $suggestion = $('<div>').addClass('address-suggestion')
                                    .append($('<div>').addClass('suggestion-main').text(mainLine))
                                    .append($('<div>').addClass('suggestion-secondary').text(secondaryLine))
                                    .data('address', address);

                                $suggestion.on('click', function() {
                                    const address = $(this).data('address');
                                    
                                    // Wichtige Änderung: Straße und Hausnummer werden getrennt
                                    // Straße ins address_1-Feld
                                    $('#shipping_address_1').val(address.street || '');
                                    
                                    // Hausnummer ins address_2-Feld
                                    $('#shipping_address_2').val(address.houseNumber || '');
                                    
                                    // PLZ und Stadt
                                    $('#shipping_postcode').val(address.postalCode || '');
                                    $('#shipping_city').val(address.city || '');
                                    
                                    // Land - Großbuchstaben für WooCommerce
                                    if (address.countryCode) {
                                        const countryCode = address.countryCode.toUpperCase();
                                        $('#shipping_country').val(countryCode);
                                    }

                                    // Alle Felder als geändert markieren und speichern
                                    $('.shipping-field').trigger('change');
                                    
                                    // UI-Aktualisierung
                                    $suggestions.hide();
                                    $('#address_search').val('');
                                });

                                $suggestions.append($suggestion);
                            });

                            $suggestions.show();
                        } else {
                            showError('Keine Adressen gefunden.');
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#address_loader').hide();
                        console.error('Fehler bei der Adresssuche:', error);
                        
                        let errorMessage = 'Ein Fehler ist bei der Adresssuche aufgetreten.';
                        if (xhr.status === 401) {
                            errorMessage = 'Authentifizierungsfehler bei der Adresssuche.';
                        } else if (xhr.status === 429) {
                            errorMessage = 'Zu viele Anfragen. Bitte versuchen Sie es später erneut.';
                        }
                        
                        showError(errorMessage);
                    }
                });
            }, 500);
        });

        function showError(message) {
            const $error = $('#address_error');
            $error.text(message).show();
            $('#address_suggestions').hide();
        }

        // Klick außerhalb schließt Vorschläge
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#address_search, #address_suggestions').length) {
                $('#address_suggestions').hide();
                $('#address_error').hide();
            }
        });

        // Auf State-Updates reagieren wenn CheckoutSystem verfügbar
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.shippingAddress) {
                // Aktualisiere nur, wenn es sich um den aktuellen Slot handelt
                if (state.shippingAddress.slot === currentSlot) {
                    // Bei Feldupdates
                    if (state.shippingAddress.field && state.shippingAddress.value) {
                        $(`[name="shipping_${state.shippingAddress.field}"]`).val(state.shippingAddress.value);
                    }
                    // Bei kompletter Adressaktualisierung
                    else if (state.shippingAddress.address) {
                        Object.entries(state.shippingAddress.address).forEach(([field, value]) => {
                            $(`[name="shipping_${field}"]`).val(value);
                        });
                    }
                }
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('custom_shipping_address', 'custom_shipping_address_shortcode');

// AJAX Handler für Slot-Updates
function update_shipping_slot() {
    if (!isset($_POST['security']) || !wp_verify_nonce($_POST['security'], 'woocommerce-process_checkout')) {
        wp_send_json_error(['message' => 'Sicherheitsüberprüfung fehlgeschlagen.']);
        exit;
    }
    
    if (isset($_POST['slot'])) {
        $slot = sanitize_text_field($_POST['slot']);
        WC()->session->set('selected_shipping_slot', $slot);
        wp_send_json_success(['message' => 'Slot erfolgreich aktualisiert.']);
    } else {
        wp_send_json_error(['message' => 'Slot nicht angegeben.']);
    }
}
add_action('wp_ajax_update_shipping_slot', 'update_shipping_slot');
add_action('wp_ajax_nopriv_update_shipping_slot', 'update_shipping_slot');

// AJAX Handler für Adress-Speicherung
function save_shipping_address() {
    if (!isset($_POST['security']) || !wp_verify_nonce($_POST['security'], 'woocommerce-process_checkout')) {
        wp_send_json_error(['message' => 'Sicherheitsüberprüfung fehlgeschlagen.']);
        exit;
    }
    
    $user_id = get_current_user_id();
    
    if (!isset($_POST['slot']) || !isset($_POST['address']) || !is_array($_POST['address'])) {
        wp_send_json_error(['message' => 'Ungültige Parameter.']);
        return;
    }
    
    $slot = sanitize_text_field($_POST['slot']);
    $address = array_map('sanitize_text_field', $_POST['address']);
    
    if ($slot === 'primary') {
        // Primäre Adresse aktualisieren
        foreach ($address as $key => $value) {
            update_user_meta($user_id, "shipping_{$key}", $value);
        }
    } else {
        // Zusätzliche Adresse speichern
        $secondary_addresses = get_user_meta($user_id, 'additional_shipping_addresses', true) ?: [];
        $index = intval(str_replace('secondary_', '', $slot));
        $secondary_addresses[$index] = $address;
        update_user_meta($user_id, 'additional_shipping_addresses', $secondary_addresses);
    }
    
    wp_send_json_success(['message' => 'Adresse erfolgreich gespeichert.']);
}
add_action('wp_ajax_save_shipping_address', 'save_shipping_address');
add_action('wp_ajax_nopriv_save_shipping_address', 'save_shipping_address');

// -----------------------------------------------------------------------------------------------------------------

function checkout_communication_shortcode() {
    ob_start();
    ?>
    <script>
    // Checkout Communication System
    const CheckoutSystem = {
        // Zentraler Datenspeicher
        state: {
            shippingAddress: {},
            billingAddress: {},
            differentBilling: {},
            differentBillingAddress: {},
            paymentMethod: {},
            couponCode: {}
        },

        // Event-Handler Registrierung
        init: function() {
            this.initializeState();
            this.setupEventListeners();
            console.log('CheckoutSystem initialized');
        },

        // Initialer State aus WooCommerce
        initializeState: function() {
            const user_id = '<?php echo get_current_user_id(); ?>';
            
            // AJAX-Aufruf um initiale Daten zu laden
            jQuery.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'get_checkout_initial_state',
                    user_id: user_id
                },
                success: (response) => {
                    if (response.success) {
                        this.state = {...this.state, ...response.data};
                        this.updateAllFields();
                        this.notifyStateChange();
                        console.log('State initialized', this.state);
                    }
                }
            });
        },

        // Event Listener Setup
        setupEventListeners: function() {
            const $ = jQuery;
            
            // Shipping Address Events
            $(document).on('change', '.shipping-field', (e) => {
                const field = e.target.name.replace('shipping_', '');
                const value = e.target.value;
                this.updateState('shippingAddress', {
                    field: field,
                    value: value
                });
            });

            // Billing Address Events (falls verwendet)
            $(document).on('change', '.billing-field', (e) => {
                const field = e.target.name;
                const value = e.target.value;
                this.updateState('billingAddress', {
                    field: field,
                    value: value
                });
            });

            // Different Billing Events
            $(document).on('change', '#different_billing', (e) => {
                this.updateState('differentBilling', {
                    enabled: e.target.checked
                });
            });

            // Payment Method Events
            $(document).on('change', '[name="payment_method"]', (e) => {
                this.updateState('paymentMethod', {
                    method: e.target.value,
                    timestamp: Date.now()
                });
            });

            // Coupon Events
            $(document).on('change', '#coupon_code', (e) => {
                this.updateState('couponCode', {
                    code: e.target.value
                });
            });
        },

        // State Updates
        updateState: function(section, data) {
            if (!this.state[section]) {
                this.state[section] = {};
            }
            
            // Aktualisiere den jeweiligen Abschnitt im State
            this.state[section] = {
                ...this.state[section],
                ...data
            };
            
            console.log(`State updated: ${section}`, data);
            this.saveState();
            this.notifyStateChange();
        },

        // Speichern des States
        saveState: function() {
            jQuery.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'save_checkout_state',
                    state: this.state
                },
                success: (response) => {
                    if (response.success) {
                        console.log('State saved successfully');
                    }
                }
            });
        },

        // Benachrichtigung über State-Änderungen
        notifyStateChange: function() {
            jQuery(document).trigger('checkoutStateUpdate', [this.state]);
        },// Formularvalidierung
        validateForm: function() {
            let isValid = true;
            const errors = [];
            
            // Validiere Lieferadresse
            if (!this.validateShippingAddress()) {
                isValid = false;
                errors.push('Bitte geben Sie eine vollständige Lieferadresse an');
            }
            
            // Validiere Zahlungsmethode
            if (!this.validatePaymentMethod()) {
                isValid = false;
                errors.push('Bitte wählen Sie eine Zahlungsmethode aus');
            }
            
            // Validiere abweichende Rechnungsadresse falls aktiviert
            if (this.state.differentBilling && this.state.differentBilling.enabled) {
                if (!this.validateBillingAddress()) {
                    isValid = false;
                    errors.push('Bitte geben Sie eine vollständige Rechnungsadresse an');
                }
            }
            
            return {
                isValid: isValid,
                errors: errors
            };
        },

        // Validiere Lieferadresse
        validateShippingAddress: function() {
            const required = ['first_name', 'last_name', 'address_1', 'address_2', 'postcode', 'city', 'country'];
            
            if (!this.state.shippingAddress) return false;
            
            if (this.state.shippingAddress.slot && this.state.shippingAddress.address) {
                // Falls komplette Adresse im State
                return required.every(field => 
                    this.state.shippingAddress.address[field] && 
                    this.state.shippingAddress.address[field].trim() !== ''
                );
            } else {
                // Falls einzelne Felder
                return required.every(field => 
                    this.state.shippingAddress[field] && 
                    this.state.shippingAddress[field].trim() !== ''
                );
            }
        },

        // Validiere Rechnungsadresse
        validateBillingAddress: function() {
            const required = ['first_name', 'last_name', 'email', 'address_1', 'address_2', 'postcode', 'city', 'country'];
            
            if (!this.state.differentBillingAddress) return false;
            
            return required.every(field => {
                const fieldName = 'different_billing_' + field;
                return this.state.differentBillingAddress[fieldName] && 
                       this.state.differentBillingAddress[fieldName].trim() !== '';
            });
        },

        // Validiere Zahlungsmethode
        validatePaymentMethod: function() {
            return this.state.paymentMethod && 
                   this.state.paymentMethod.method && 
                   this.state.paymentMethod.method.trim() !== '';
        },

        // State abrufen
        getState: function() {
            return this.state;
        },

        // Formulardaten sammeln
        getFormData: function() {
            return {
                shipping_address: this.getShippingAddressData(),
                billing_address: this.getBillingAddressData(),
                different_billing: this.state.differentBilling ? this.state.differentBilling.enabled : false,
                different_billing_address: this.state.differentBillingAddress,
                payment_method: this.state.paymentMethod ? this.state.paymentMethod.method : '',
                coupon_code: this.state.couponCode ? this.state.couponCode.code : ''
            };
        },

        // Lieferadressdaten abrufen
        getShippingAddressData: function() {
            if (this.state.shippingAddress.slot && this.state.shippingAddress.address) {
                return this.state.shippingAddress.address;
            } else {
                const shippingData = {};
                Object.keys(this.state.shippingAddress).forEach(key => {
                    if (key !== 'slot' && key !== 'field' && key !== 'value') {
                        shippingData[key] = this.state.shippingAddress[key];
                    }
                });
                return shippingData;
            }
        },

        // Rechnungsadressdaten abrufen
        getBillingAddressData: function() {
            // Wenn keine abweichende Rechnungsadresse, Lieferadresse verwenden
            if (!this.state.differentBilling || !this.state.differentBilling.enabled) {
                return this.getShippingAddressData();
            }
            
            const billingData = {};
            Object.keys(this.state.differentBillingAddress).forEach(key => {
                // Konvertiere different_billing_* zu normalem Feld
                const newKey = key.replace('different_billing_', '');
                billingData[newKey] = this.state.differentBillingAddress[key];
            });
            
            return billingData;
        },

        // Alle Felder aktualisieren
        updateAllFields: function() {
            const $ = jQuery;
            
            // Shipping Address Felder
            if (this.state.shippingAddress) {
                // Bei Adressobjekt
                if (this.state.shippingAddress.address) {
                    Object.entries(this.state.shippingAddress.address).forEach(([field, value]) => {
                        $(`[name="shipping_${field}"]`).val(value);
                    });
                }
                // Bei Einzelfeldern
                else {
                    Object.entries(this.state.shippingAddress).forEach(([field, value]) => {
                        if (field !== 'slot' && field !== 'field' && field !== 'value') {
                            $(`[name="shipping_${field}"]`).val(value);
                        }
                    });
                }
            }

            // Different Billing Checkbox
            if (this.state.differentBilling && this.state.differentBilling.enabled !== undefined) {
                $('#different_billing').prop('checked', this.state.differentBilling.enabled);
                
                // Zeige/verstecke abweichende Adressfelder
                if (this.state.differentBilling.enabled) {
                    $('#different_billing_fields').show();
                } else {
                    $('#different_billing_fields').hide();
                }
            }

            // Different Billing Address Felder
            if (this.state.differentBillingAddress) {
                Object.entries(this.state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }

            // Payment Method
            if (this.state.paymentMethod && this.state.paymentMethod.method) {
                const paymentMethod = this.state.paymentMethod.method;
                $(`[name="payment_method"][value="${paymentMethod}"]`)
                    .prop('checked', true)
                    .closest('.payment-option')
                    .addClass('selected');
            }

            // Coupon Code
            if (this.state.couponCode && this.state.couponCode.code) {
                $('#coupon_code').val(this.state.couponCode.code);
            }
        }
    };

    // System initialisieren
    jQuery(document).ready(function() {
        // Nur initialisieren, wenn auf der Checkout-Seite
        if (typeof wc_checkout_params !== 'undefined') {
            CheckoutSystem.init();
        }
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('checkout_communication', 'checkout_communication_shortcode');

// AJAX Handler für initiale Daten
function get_checkout_initial_state() {
    $user_id = isset($_POST['user_id']) ? intval($_POST['user_id']) : 0;
    
    // State für eingeloggte Benutzer
    if ($user_id) {
        $customer = new WC_Customer($user_id);
        
        // Shipping Address
        $shipping = array(
            'first_name' => $customer->get_shipping_first_name(),
            'last_name' => $customer->get_shipping_last_name(),
            'address_1' => $customer->get_shipping_address_1(),
            'address_2' => $customer->get_shipping_address_2(),
            'postcode' => $customer->get_shipping_postcode(),
            'city' => $customer->get_shipping_city(),
            'country' => $customer->get_shipping_country() ?: 'DE'
        );
        
        // Billing Address
        $billing = array(
            'first_name' => $customer->get_billing_first_name(),
            'last_name' => $customer->get_billing_last_name(),
            'email' => $customer->get_billing_email(),
            'address_1' => $customer->get_billing_address_1(),
            'address_2' => $customer->get_billing_address_2(),
            'postcode' => $customer->get_billing_postcode(),
            'city' => $customer->get_billing_city(),
            'country' => $customer->get_billing_country() ?: 'DE'
        );
        
        // Different Billing Address
        $different_billing = array();
        $fields = array('first_name', 'last_name', 'email', 'address_1', 'address_2', 'postcode', 'city', 'country');
        
        foreach ($fields as $field) {
            $different_billing['different_billing_' . $field] = $customer->get_meta('different_billing_' . $field) ?: $billing[$field];
        }
        
        // State zusammenbauen
        $state = array(
            'shippingAddress' => array(
                'slot' => WC()->session ? WC()->session->get('selected_shipping_slot') : 'primary',
                'address' => $shipping
            ),
            'billingAddress' => $billing,
            'differentBilling' => array(
                'enabled' => get_user_meta($user_id, 'different_billing_enabled', true) ?: false
            ),
            'differentBillingAddress' => $different_billing,
            'paymentMethod' => array(
                'method' => WC()->session ? WC()->session->get('chosen_payment_method') : ''
            ),
            'couponCode' => array(
                'code' => WC()->session ? WC()->session->get('applied_coupon') : ''
            )
        );
        
        wp_send_json_success($state);
    } else {
        // Fallback für nicht eingeloggte Benutzer
        $state = array(
            'shippingAddress' => array('country' => 'DE'),
            'billingAddress' => array('country' => 'DE'),
            'differentBilling' => array('enabled' => false),
            'paymentMethod' => array('method' => ''),
            'couponCode' => array('code' => '')
        );
        
        wp_send_json_success($state);
    }
}
add_action('wp_ajax_get_checkout_initial_state', 'get_checkout_initial_state');
add_action('wp_ajax_nopriv_get_checkout_initial_state', 'get_checkout_initial_state');

// AJAX Handler für State-Speicherung
function save_checkout_state() {
    if (isset($_POST['state'])) {
        $state = $_POST['state'];
        $user_id = get_current_user_id();
        
        // State in user_meta speichern falls Benutzer eingeloggt ist
        if ($user_id) {
            update_user_meta($user_id, 'checkout_state', $state);
        }
        
        // State in WC Session speichern
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('checkout_state', $state);
        }
        
        wp_send_json_success();
    }
    wp_send_json_error();
}
add_action('wp_ajax_save_checkout_state', 'save_checkout_state');
add_action('wp_ajax_nopriv_save_checkout_state', 'save_checkout_state');

// -----------------------------------------------------------------------------------------------------------------



// -----------------------------------------------------------------------------------------------------------------

function custom_different_billing_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    // Aktuelle Benutzerdaten abrufen
    $user_id = get_current_user_id();
    
    // WooCommerce Billing Felder abrufen
    $different_billing_first_name = get_user_meta($user_id, 'billing_first_name', true);
    $different_billing_last_name = get_user_meta($user_id, 'billing_last_name', true);
    $different_billing_email = get_user_meta($user_id, 'billing_email', true);
    $different_billing_address_1 = get_user_meta($user_id, 'billing_address_1', true);
    $different_billing_address_2 = get_user_meta($user_id, 'billing_address_2', true);
    $different_billing_postcode = get_user_meta($user_id, 'billing_postcode', true);
    $different_billing_city = get_user_meta($user_id, 'billing_city', true);
    $different_billing_country = get_user_meta($user_id, 'billing_country', true);
    $different_billing_enabled = get_user_meta($user_id, 'different_billing_enabled', true);

    ob_start();
    ?>
    <div class="custom-billing-address">
        <div class="checkbox-group">
            <input type="checkbox" 
                   id="different_billing" 
                   name="different_billing" 
                   class="billing-toggle"
                   <?php checked($different_billing_enabled, true); ?> />
            <label for="different_billing">Abweichende Rechnungsadresse</label>
        </div>
        
        <div id="different_billing_fields" class="conditional-fields" style="<?php echo $different_billing_enabled ? 'display: block;' : 'display: none;'; ?>">
            <!-- Adresssuche-Feld -->
            <div class="form-group address-search-group">
                <input type="text" 
                       id="billing_address_search" 
                       placeholder="Adresse suchen..." 
                       class="address-search" />
                <div class="loader" id="billing_address_loader"></div>
                <div id="billing_address_suggestions" class="address-suggestions"></div>
                <div id="billing_address_error" class="error-message"></div>
            </div>

            <div class="form-row">
                <input type="text" 
                       name="different_billing_first_name" 
                       placeholder="Vorname" 
                       value="<?php echo esc_attr($different_billing_first_name); ?>" 
                       class="billing-field" />
                
                <input type="text" 
                       name="different_billing_last_name" 
                       placeholder="Name" 
                       value="<?php echo esc_attr($different_billing_last_name); ?>" 
                       class="billing-field" />
            </div>

            <div class="form-row">
                <input type="email" 
                       name="different_billing_email" 
                       placeholder="E-Mail" 
                       value="<?php echo esc_attr($different_billing_email); ?>" 
                       class="billing-field" />
            </div>

            <div class="form-row">
                <input type="text" 
                       name="different_billing_address_1" 
                       id="different_billing_address_1"
                       placeholder="Straße" 
                       value="<?php echo esc_attr($different_billing_address_1); ?>" 
                       class="billing-field" />
                
                <input type="text" 
                       name="different_billing_address_2" 
                       id="different_billing_address_2"
                       placeholder="Hausnummer" 
                       value="<?php echo esc_attr($different_billing_address_2); ?>" 
                       class="billing-field" />
            </div>

            <div class="form-row">
                <input type="text" 
                       name="different_billing_postcode" 
                       id="different_billing_postcode"
                       placeholder="PLZ" 
                       value="<?php echo esc_attr($different_billing_postcode); ?>" 
                       class="billing-field" />
                
                <input type="text" 
                       name="different_billing_city" 
                       id="different_billing_city"
                       placeholder="Ort" 
                       value="<?php echo esc_attr($different_billing_city); ?>" 
                       class="billing-field" />
            </div>

            <div class="form-row">
                <select name="different_billing_country" 
                        id="different_billing_country"
                        class="billing-field">
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_countries();
                    $default_country = $different_billing_country ?: 'DE';
                    
                    foreach ($countries as $code => $name) {
                        $selected = ($default_country === $code) ? 'selected' : '';
                        echo '<option value="' . esc_attr($code) . '" ' . $selected . '>' . esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .custom-billing-address {
        width: 100%;
        margin-bottom: 30px;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        accent-color: #0079FF;
    }

    .checkbox-group label {
        color: #0079FF;
        font-weight: 500;
    }

    .conditional-fields {
        margin-top: 20px;
        display: none;
    }

    .form-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .form-row input,
    .form-row select,
    .address-search {
        flex: 1;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 0.95rem;
        background-color: #FFF;
        transition: border-color 0.2s ease;
    }

    .form-row input:focus,
    .form-row select:focus,
    .address-search:focus {
        border-color: #0079FF;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 121, 255, 0.1);
    }

    .address-search-group {
        position: relative;
        margin-bottom: 12px;
    }

    .loader {
        border: 2px solid #f3f3f3;
        border-radius: 50%;
        border-top: 2px solid #0079FF;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
    }@keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
    }

    .address-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 4px;
    }

    .address-suggestion {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f7;
    }

    .address-suggestion:last-child {
        border-bottom: none;
    }

    .address-suggestion:hover {
        background-color: #f5f5f7;
    }

    .suggestion-main {
        font-weight: 500;
        margin-bottom: 4px;
        color: #1d1d1f;
    }

    .suggestion-secondary {
        font-size: 0.85rem;
        color: #6e6e73;
    }

    .error-message {
        color: #ff3b30;
        background-color: rgba(255, 59, 48, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        margin-top: 4px;
        font-size: 0.9rem;
        display: none;
    }

    @media (max-width: 600px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-row input,
        .form-row select {
            width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const checkbox = $('#different_billing');
        const fieldsContainer = $('#different_billing_fields');
        
        // HERE API Schlüssel
        const API_KEY = 'xPlTGXIrjg1O6Oea3e2gvo5lrN-iO1gT47Sc-VojWdU';

        // Toggle Felder
        checkbox.change(function() {
            if (this.checked) {
                fieldsContainer.slideDown(300);
            } else {
                fieldsContainer.slideUp(300);
            }

            // Update CheckoutSystem wenn verfügbar
            if (typeof CheckoutSystem !== 'undefined') {
                CheckoutSystem.updateState('differentBilling', {
                    enabled: this.checked
                });
            }
            
            // Metadaten aktualisieren
            $.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'update_different_billing_enabled',
                    enabled: this.checked ? 1 : 0
                }
            });
        });

        // Feldänderungen
        $('.billing-field').on('change', function() {
            // Update CheckoutSystem wenn verfügbar
            if (typeof CheckoutSystem !== 'undefined') {
                CheckoutSystem.updateState('differentBillingAddress', {
                    [this.name]: this.value
                });
            }
            
            // Metadaten aktualisieren
            saveBillingAddress();
        });
        
        // Adresse speichern
        function saveBillingAddress() {
            const addressData = {};
            $('.billing-field').each(function() {
                addressData[$(this).attr('name')] = $(this).val();
            });
            
            $.ajax({
                url: wc_checkout_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'save_different_billing_address',
                    address: addressData
                }
            });
        }

        // Auf State-Updates reagieren wenn CheckoutSystem verfügbar
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.differentBillingAddress) {
                Object.entries(state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }
            
            // Different Billing Checkbox aktualisieren
            if (state && state.differentBilling && state.differentBilling.enabled !== undefined) {
                const isChecked = state.differentBilling.enabled;
                checkbox.prop('checked', isChecked);
                
                if (isChecked && !fieldsContainer.is(':visible')) {
                    fieldsContainer.show();
                } else if (!isChecked && fieldsContainer.is(':visible')) {
                    fieldsContainer.hide();
                }
            }
        });
        
        // Adresssuche
        let searchTimeout;
        $('#billing_address_search').on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val();
            
            $('#billing_address_error').hide();
            $('#billing_address_loader').hide();
            
            if (query.length < 3) {
                $('#billing_address_suggestions').hide();
                return;
            }

            $('#billing_address_loader').show();

            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: 'https://geocode.search.hereapi.com/v1/geocode',
                    data: {
                        q: query,
                        apiKey: API_KEY,
                        limit: 5,
                        lang: 'de',
                        in: 'countryCode:DEU,AUT,CHE'
                    },
                    type: 'GET',
                    success: function(data) {
                        $('#billing_address_loader').hide();
                        const $suggestions = $('#billing_address_suggestions');
                        $suggestions.empty();

                        if (data && data.items && data.items.length > 0) {
                            data.items.forEach(function(item) {
                                const address = item.address;
                                
                                // Hauptadresszeile
                                let streetPart = address.street || '';
                                let houseNumberPart = address.houseNumber ? ' ' + address.houseNumber : '';
                                
                                const mainLine = streetPart + houseNumberPart + 
                                                (address.postalCode ? ', ' + address.postalCode : '') + 
                                                (address.city ? ' ' + address.city : '');

                                // Zusätzliche Informationen
                                const secondaryLine = [
                                    address.district,
                                    address.state,
                                    address.countryName
                                ].filter(Boolean).join(', ');

                                const $suggestion = $('<div>').addClass('address-suggestion')
                                    .append($('<div>').addClass('suggestion-main').text(mainLine))
                                    .append($('<div>').addClass('suggestion-secondary').text(secondaryLine))
                                    .data('address', address);

                                $suggestion.on('click', function() {
                                    const address = $(this).data('address');
                                    
                                    // Straße und Hausnummer in separate Felder
                                    // Das ist die wichtige Verbesserung: Korrekte Trennung
                                    $('#different_billing_address_1').val(address.street || '');
                                    $('#different_billing_address_2').val(address.houseNumber || '');
                                    
                                    // PLZ und Stadt
                                    $('#different_billing_postcode').val(address.postalCode || '');
                                    $('#different_billing_city').val(address.city || '');
                                    
                                    // Land - Angepasst für WooCommerce Länderformat
                                    if (address.countryCode) {
                                        // HERE API liefert Ländercodes in Kleinbuchstaben (de, at),
                                        // WooCommerce erwartet sie in Großbuchstaben (DE, AT)
                                        const countryCode = address.countryCode.toUpperCase();
                                        $('#different_billing_country').val(countryCode);
                                    }

                                    // Felder als geändert markieren
                                    $('.billing-field').trigger('change');
                                    
                                    // UI aktualisieren
                                    $suggestions.hide();
                                    $('#billing_address_search').val('');
                                });

                                $suggestions.append($suggestion);
                            });

                            $suggestions.show();
                        } else {
                            showError('Keine Adressen gefunden.');
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#billing_address_loader').hide();
                        console.error('Fehler bei der Adresssuche:', error);
                        
                        let errorMessage = 'Ein Fehler ist bei der Adresssuche aufgetreten.';
                        if (xhr.status === 401) {
                            errorMessage = 'Authentifizierungsfehler bei der Adresssuche.';
                        } else if (xhr.status === 429) {
                            errorMessage = 'Zu viele Anfragen. Bitte versuchen Sie es später erneut.';
                        }
                        
                        showError(errorMessage);
                    }
                });
            }, 500);
        });

        function showError(message) {
            const $error = $('#billing_address_error');
            $error.text(message).show();
            $('#billing_address_suggestions').hide();
        }

        // Klick außerhalb schließt Vorschläge
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#billing_address_search, #billing_address_suggestions').length) {
                $('#billing_address_suggestions').hide();
                $('#billing_address_error').hide();
            }
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('custom_different_billing', 'custom_different_billing_shortcode');

// AJAX Handler für Different Billing Toggle
function update_different_billing_enabled() {
    $user_id = get_current_user_id();
    $enabled = isset($_POST['enabled']) ? (bool)$_POST['enabled'] : false;
    
    update_user_meta($user_id, 'different_billing_enabled', $enabled);
    wp_send_json_success();
}
add_action('wp_ajax_update_different_billing_enabled', 'update_different_billing_enabled');
add_action('wp_ajax_nopriv_update_different_billing_enabled', 'update_different_billing_enabled');

// AJAX Handler für Different Billing Adresse
function save_different_billing_address() {
    $user_id = get_current_user_id();
    $address = $_POST['address'];
    
    if ($address) {
        foreach ($address as $key => $value) {
            // Auch different_billing_* Felder speichern
            update_user_meta($user_id, $key, sanitize_text_field($value));
            
            // Konvertieren von different_billing_* zu billing_*
            $meta_key = str_replace('different_billing_', 'billing_', $key);
            update_user_meta($user_id, $meta_key, sanitize_text_field($value));
        }
    }
    
    wp_send_json_success();
}
add_action('wp_ajax_save_different_billing_address', 'save_different_billing_address');
add_action('wp_ajax_nopriv_save_different_billing_address', 'save_different_billing_address');

// -----------------------------------------------------------------------------------------------------------------

// -----------------------------------------------------------------------------------------------------------------
function yprint_login_form_shortcode() {
    // Sofortige Weiterleitung, wenn der Benutzer eingeloggt ist und kein Admin ist
    if (is_user_logged_in() && !current_user_can('administrator')) {
        ?>
        <script>
            window.location.href = '<?php echo esc_js(home_url('/my-products')); ?>';
        </script>
        <?php
        exit;
    }
    
    if (session_status() === PHP_SESSION_ACTIVE) {
        session_write_close();
    }
    
    ob_start();
    ?>
    <style>
        /* Grundstil für Loginform */
        #loginform {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Eingabefelder */
        #loginform input[type="text"],
        #loginform input[type="password"],
        #loginform input[type="email"] {
            font-family: 'Roboto' !important;
            background-color: #f1f1f1 !important;
            border-radius: 10px !important;
            border: 1px solid #000000 !important;
            text-align: center !important;
            padding: 10px !important;
            height: 40px !important;
            width: 400px !important;
            margin: 0px !important;
            color: #333 !important;
        }
        
        /* Platzhaltertext */
        #loginform input::placeholder {
            color: #333 !important;
            font-weight: normal !important;
        }
        
        /* Submit-Button */
        #loginform input[type="submit"] {
            width: 155px !important;
            height: 35px !important;
            font-family: 'Roboto' !important;
            font-size: 20px !important;
            font-weight: bold !important;
            color: white !important;
            background-color: #0079FF !important;
            border: 1px solid #707070 !important;
            text-transform: lowercase !important;
            cursor: pointer !important;
            line-height: 1px !important;
            margin-top: 20px !important;
            margin-bottom: -15px !important;
            border-radius: 0px !important;
        }
        
        /* Verstecken unnötiger Elemente */
        #loginform #rememberme,
        #loginform label {
            display: none !important;
        }
        
        /* E-Mail-Hinweis */
        #email-hint {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff9c4;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
            color: #333;
            display: none;
            z-index: 10;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 90%;
        }
        
        #email-hint:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #fff9c4;
        }
        
        #email-hint:before {
            content: '';
            position: absolute;
            bottom: -9px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-top: 9px solid #ffc107;
        }
        
        /* Neue Passwortfeld-Struktur */
        .password-container {
            position: relative;
            margin-bottom: 20px;
            width: 100%;
        }
        
        /* Augen-Icon für Passwort-Toggle */
        #eye-toggle {
            position: absolute;
            right: -45px; /* Position außerhalb des Felds */
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 10;
        }
        
        #eye-toggle i {
            font-size: 24px;
            color: #666;
        }
        
        /* Mobile Wrapper */
        .yprint-login-mobile-wrapper {
            width: 100%;
            display: block;
            position: relative;
        }
        
        @media screen and (max-width: 767px) {
            .yprint-login-mobile-wrapper {
                padding: 0 10%;
            }
            
            #loginform input[type="text"],
            #loginform input[type="password"],
            #loginform input[type="email"] {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Mobile-spezifische Position für das Augen-Icon */
            #eye-toggle {
                right: -35px; /* Anpassung für Mobile */
            }
        }
    </style>
    
    <div class="yprint-login-mobile-wrapper">
    <?php
    // Standard WordPress Login-Formular
    $args = array(
        'redirect' => home_url('/my-products'),
        'label_username' => '',
        'label_password' => '',
        'label_remember' => '',
        'value_username' => '',
        'value_remember' => false,
    );
    
    wp_login_form($args);
    ?>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var usernameField = document.querySelector('input[name="log"]');
            var passwordField = document.querySelector('input[name="pwd"]');
            
            // Username-Feld anpassen
            if (usernameField) {
                usernameField.setAttribute('placeholder', 'Username');
                
                // Username-Wrapper erstellen
                var usernameWrapper = document.createElement('div');
                usernameWrapper.style.position = 'relative';
                usernameWrapper.style.marginBottom = '20px';
                
                // Das original Benutzernamenfeld in den Wrapper verschieben
                usernameField.parentNode.insertBefore(usernameWrapper, usernameField);
                usernameWrapper.appendChild(usernameField);
                
                // Hinweis-Element erstellen
                var emailHint = document.createElement('div');
                emailHint.id = 'email-hint';
                emailHint.innerHTML = 'Bitte beachte: Hier wird dein Benutzername benötigt, nicht deine E-Mail-Adresse.';
                usernameWrapper.appendChild(emailHint);
                
                // Input-Event für den Benutzernamen
                usernameField.addEventListener('input', function() {
                    if (this.value.includes('@')) {
                        emailHint.style.display = 'block';
                    } else {
                        emailHint.style.display = 'none';
                    }
                });
            }
            
            // Passwort-Feld anpassen
            if (passwordField) {
                passwordField.setAttribute('placeholder', 'Password');
                
                // Container für Passwortfeld erstellen
                var passwordContainer = document.createElement('div');
                passwordContainer.className = 'password-container';
                
                // Passwortfeld in Container verschieben
                passwordField.parentNode.insertBefore(passwordContainer, passwordField);
                passwordContainer.appendChild(passwordField);
                
                // Augen-Icon erstellen - jetzt standardmäßig sichtbar
                var eyeToggle = document.createElement('div');
                eyeToggle.id = 'eye-toggle';
                eyeToggle.innerHTML = '<i class="eicon-eye"></i>';
                passwordContainer.appendChild(eyeToggle);
                
                // Icon-Funktionalität
                eyeToggle.addEventListener('click', function(e) {
                    e.preventDefault(); // Wichtig für Mobile
                    e.stopPropagation(); // Verhindert Bubblen
                    
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        this.querySelector('i').style.color = '#0079FF';
                    } else {
                        passwordField.type = 'password';
                        this.querySelector('i').style.color = '#666';
                    }
                });
                
                // Spezifisch für Touch-Geräte
                eyeToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        this.querySelector('i').style.color = '#0079FF';
                    } else {
                        passwordField.type = 'password';
                        this.querySelector('i').style.color = '#666';
                    }
                });
                
                // Auch ein normales "touch" Event hinzufügen für ältere Mobilgeräte
                eyeToggle.addEventListener('touch', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        this.querySelector('i').style.color = '#0079FF';
                    } else {
                        passwordField.type = 'password';
                        this.querySelector('i').style.color = '#666';
                    }
                });
                
                // Füge einen Fokus-Event hinzu, der sicherstellt, dass das Icon auch auf Mobile funktioniert
                passwordField.addEventListener('click', function() {
                    // Nichts tun, aber das Event abfangen
                });
            }
        });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('yprint_login_form', 'yprint_login_form_shortcode');

// Verhindert die Weiterleitung von wp-login.php
function yprint_login_failed_redirect($username) {
    if (isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], '/wp-login.php') !== false) {
        if (!isset($_POST['log'])) { 
            return;
        }
        wp_redirect(home_url('/login') . '?login=failed');
        exit;
    }
}
add_action('wp_login_failed', 'yprint_login_failed_redirect');

// Fehlerbehandlung für leere Felder
function yprint_empty_fields_redirect($user, $username, $password) {
    if (empty($username) || empty($password)) {
        if (isset($_POST['log']) && isset($_POST['pwd'])) {
            wp_redirect(home_url('/login') . '?login=empty');
            exit;
        }
    }
    return $user;
}
add_filter('authenticate', 'yprint_empty_fields_redirect', 30, 3);

// Weiterleitung nach fehlgeschlagenem Login
function yprint_redirect_after_failed_login($redirect_to, $request, $user) {
    if (is_wp_error($user)) {
        if (isset($_POST['log'])) {
            $redirect_to = home_url('/login') . '?login=failed';
        }
    }
    return $redirect_to;
}
add_filter('login_redirect', 'yprint_redirect_after_failed_login', 10, 3);

// E-Mail-Verifikation beim Login überprüfen
function yprint_authenticate_user($user, $username, $password) {
    if (is_wp_error($user)) {
        return $user;
    }
    
    global $wpdb;
    $table_name = 'wp_email_verifications';
    $user_id = $user->ID;
    
    $email_verified = $wpdb->get_var(
        $wpdb->prepare("SELECT email_verified FROM $table_name WHERE user_id = %d", $user_id)
    );
    
    if ($email_verified != 1) {
        wp_redirect(home_url('/login?login=email_not_verified&user_id=' . $user_id));
        exit;
    }
    
    return $user;
}
add_filter('authenticate', 'yprint_authenticate_user', 30, 3);

function yprint_login_feedback_shortcode() {
    ob_start();

    $error_message = '';
    $success_message = '';
    $info_message = '';
    $show_recover_option = false;
    $show_resend_verification = false;
    $user_id = isset($_GET['user_id']) ? intval($_GET['user_id']) : 0;

    if (isset($_GET['login'])) {
        switch ($_GET['login']) {
            case 'failed':
                $error_message = '⚠️ Falscher Benutzername oder Passwort!';
                $show_recover_option = true;
                break;
            case 'email_not_verified':
                $error_message = '⚠️ Deine E-Mail-Adresse wurde noch nicht bestätigt. Bitte überprüfe dein Postfach.';
                $show_resend_verification = true;
                break;
            case 'empty':
                $error_message = '⚠️ Bitte fülle alle Felder aus!';
                break;
        }
    }

    if (isset($_GET['verification_sent']) && $_GET['verification_sent'] == '1') {
        $success_message = '✅ Registrierung erfolgreich! Eine Bestätigungs-E-Mail wurde an deine E-Mail-Adresse gesendet. Bitte überprüfe dein Postfach und bestätige deine Adresse, um dich einloggen zu können.';
        $show_resend_verification = true;
    }
    
    if (isset($_GET['verification_issue']) && $_GET['verification_issue'] == '1') {
        $error_message = '⚠️ Dein Account wurde erstellt, aber es gab ein Problem beim Senden der Bestätigungs-E-Mail.';
        $info_message = 'Du kannst dich anmelden, sobald deine E-Mail-Adresse bestätigt ist. Bitte verwende die Option zum erneuten Senden der Bestätigungs-E-Mail.';
        $show_resend_verification = true;
    }

    if ($error_message) {
        echo '<div style="color: red; text-align: center; margin-bottom: 10px;">' . esc_html($error_message) . '</div>';
    }

    if ($info_message) {
        echo '<div style="color: #0079FF; text-align: center; margin-bottom: 10px;">' . esc_html($info_message) . '</div>';
    }

    if ($success_message) {
        echo '<div style="color: green; text-align: center; margin-bottom: 10px;">' . esc_html($success_message) . '</div>';
    }

    if ($show_recover_option) {
        echo '<div style="text-align: center; margin-top: 10px;">
                <a href="' . esc_url(home_url('/recover-account')) . '" style="color: #0079FF; font-weight: bold; text-decoration: none;">
                    ❓ Passwort vergessen? Konto wiederherstellen
                </a>
              </div>';
    }

    if ($show_resend_verification && $user_id) {
        echo '<div style="text-align: center; margin-top: 10px;">
                <form method="post">';
        // Hier war der Fehler - PHP-Tags müssen außerhalb des Strings sein
        wp_nonce_field('resend_verification_nonce', 'security');
        echo '<input type="hidden" name="resend_verification" value="' . esc_attr($user_id) . '">
                <button type="submit" style="background-color: #0079FF; color: white; padding: 10px; border: none; cursor: pointer;">
                ✉️ Bestätigungs-E-Mail erneut senden
                </button>
                </form>
              </div>';
    } else if ($show_resend_verification) {
        // Wenn kein User-ID Parameter vorhanden ist, aber trotzdem der Button gezeigt werden soll
        echo '<div style="text-align: center; margin-top: 10px; color: #0079FF;">
                Wenn du keine E-Mail erhalten hast, versuche dich mit deinen Daten anzumelden, um die Bestätigungs-E-Mail erneut zu senden.
              </div>';
    }

    return ob_get_clean();
}
add_shortcode('yprint_login_feedback', 'yprint_login_feedback_shortcode');

// Handler für das Resenden der Verifikations-E-Mail
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['resend_verification'])) {
    check_admin_referer('resend_verification_nonce', 'security');
    
    global $wpdb;
    
    $table_name = 'wp_email_verifications';
    $user_id = intval($_POST['resend_verification']);
    $user = get_userdata($user_id);
    
    if ($user) {
        $email = $user->user_email;
        $username = $user->user_login;
        $verification_code = bin2hex(random_bytes(16));
        $current_time = current_time('mysql');
        
        // Zuerst den alten Eintrag definitiv löschen
        $wpdb->delete(
            $table_name,
            array('user_id' => $user_id),
            array('%d')
        );
        
        // Dann einen neuen Eintrag erstellen
        $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'verification_code' => $verification_code,
                'email_verified' => 0,
                'created_at' => $current_time,
                'updated_at' => $current_time
            ),
            array('%d', '%s', '%d', '%s', '%s')
        );

        // Verification Link erstellen
        $verification_link = add_query_arg(
            array(
                'user_id' => $user_id,
                'verification_code' => $verification_code,
            ),
            home_url('/verify-email/')
        );

        // E-Mail Template laden und anpassen
        $template = file_get_contents('https://yprint.de/wp-content/uploads/2025/02/yprint-email-vorlage.html');
        $template = str_replace(
            array('{{headline}}', '{{first_name}}', '{{message}}'),
            array(
                'Verifiziere deine E-Mail-Adresse',
                esc_html($username),
                sprintf(
                    "Bitte klicke auf den folgenden Link, um deine E-Mail-Adresse zu verifizieren: <br><br> <a href='%s'>E-Mail verifizieren</a>",
                    esc_url($verification_link)
                )
            ),
            $template
        );

        // E-Mail senden
        $subject = 'Bitte verifiziere deine E-Mail-Adresse';
        $headers = array(
            'Content-Type: text/html; charset=UTF-8',
            'From: YPrint <do-not-reply@yprint.de>'
        );

        wp_mail($email, $subject, $template, $headers);
        
        if (session_status() === PHP_SESSION_ACTIVE) {
            session_write_close();
        }
        
        wp_redirect(home_url('/login?verification_sent=1'));
        exit;
    }
}

// -----------------------------------------------------------------------------------------------------------------
// REST-API Endpunkt registrieren
add_action('rest_api_init', 'wp_rest_user_endpoints');

function wp_rest_user_endpoints() {
    register_rest_route('wp/v2', 'users/register', array(
        'methods' => 'POST',
        'callback' => 'wc_rest_user_endpoint_handler',
    ));
}

function wc_rest_user_endpoint_handler($request) {
    global $wpdb;
    $response = array();
    $parameters = $request->get_json_params();
    
    // HMAC-basierte Validierung ist besser als Nonce für REST API
    // Keine Änderung, da WP REST API eigene Sicherheitsmaßnahmen hat

    // Eingabedaten validieren
    $username = sanitize_text_field($parameters['username']);
    $email = sanitize_text_field($parameters['email']);
    $password = sanitize_text_field($parameters['password']);

    $error = new WP_Error();

    if (empty($username)) {
        $error->add(400, __("Username field 'username' is required.", 'wp-rest-user'), array('status' => 400));
        return $error;
    }
    if (empty($email)) {
        $error->add(401, __("Email field 'email' is required.", 'wp-rest-user'), array('status' => 400));
        return $error;
    }
    if (empty($password)) {
        $error->add(404, __("Password field 'password' is required.", 'wp-rest-user'), array('status' => 400));
        return $error;
    }

    // Prüfen, ob Benutzername oder E-Mail bereits existiert
    if (username_exists($username) || email_exists($email)) {
        $error->add(406, __("Username or email already registered.", 'wp-rest-user'), array('status' => 400));
        return $error;
    }

    // Registrierungs-E-Mail von WordPress verhindern
    add_filter('wp_new_user_notification_email', '__return_false');

    // Benutzer erstellen
    $user_id = wp_create_user($username, $password, $email);

    if (is_wp_error($user_id)) {
        return $user_id;
    }

    // Benutzerrolle setzen
    $user = get_user_by('id', $user_id);
    $user->set_role('subscriber');
    if (class_exists('WooCommerce')) {
        $user->set_role('customer');
    }

    // Verifizierungscode generieren
    $verification_code = bin2hex(random_bytes(16));

    // Tabellenname
    $table_name = 'wp_email_verifications';

    // Prüfen, ob der Benutzer bereits in der Verifizierungstabelle existiert
    $existing_id = $wpdb->get_var(
        $wpdb->prepare("SELECT id FROM $table_name WHERE user_id = %d", $user_id)
    );

    if ($existing_id) {
        // Falls Eintrag existiert: UPDATE
        $wpdb->update(
            $table_name,
            array(
                'verification_code' => $verification_code,
                'email_verified' => 0,
                'updated_at' => current_time('mysql'),
            ),
            array('user_id' => $user_id),
            array('%s', '%d', '%s'),
            array('%d')
        );
    } else {
        // Falls kein Eintrag existiert: INSERT
        $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'verification_code' => $verification_code,
                'email_verified' => 0,
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            ),
            array('%d', '%s', '%d', '%s', '%s')
        );
    }

    // DEBUG: Fehler ausgeben
    if ($wpdb->last_error) {
        error_log("Datenbankfehler: " . $wpdb->last_error);
    }

    // Verifizierungslink erstellen
    $verification_link = add_query_arg(array(
        'user_id' => $user_id,
        'verification_code' => $verification_code,
    ), home_url('/verify-email/'));

    // Hier wird die E-Mail für die Verifizierung gesendet
    $email_sent = send_verification_email($email, $username, $verification_link);
    
    // Prüfen, ob die E-Mail gesendet wurde
    if (!$email_sent) {
        error_log("Email sending failed during registration for user: {$username} ({$email})");
        // Trotzdem fortfahren, da der Benutzer erstellt wurde
    }

    // Antwort zurückgeben
    $response['code'] = 200;
    $response['message'] = __("User '" . $username . "' Registration was Successful", "wp-rest-user");
    $response['email_sent'] = $email_sent; // Status der E-Mail-Versendung mitgeben
    
    return new WP_REST_Response($response, 200);
}

function send_verification_email($email, $username, $verification_link) {
    // Debug-Information in das Log schreiben
    error_log("Sending verification email to: {$email} with link: {$verification_link}");
    
    // Versuche die HTML-Vorlage zu laden
    $template_url = 'https://yprint.de/wp-content/uploads/2025/02/yprint-email-vorlage.html';
    $template = @file_get_contents($template_url);
    
    // Prüfen, ob die Vorlage geladen werden konnte
    if (!$template) {
        error_log("Email template could not be loaded from: {$template_url}");
        // Fallback zu einer einfachen HTML-Nachricht
        $template = '
        <!DOCTYPE html>
        <html>
        <head>
            <title>E-Mail-Verifizierung</title>
        </head>
        <body>
            <h1>{{headline}}</h1>
            <p>Hallo {{first_name}},</p>
            <p>{{message}}</p>
            <p>Dein YPrint-Team</p>
        </body>
        </html>';
    }
    
    // Ersetze die Platzhalter mit den tatsächlichen Werten
    $headline = 'Verifiziere deine E-Mail-Adresse';
    $first_name = $username;
    $message = "Bitte klicke auf den folgenden Link, um deine E-Mail-Adresse zu verifizieren: <br><br> <a href='{$verification_link}'>E-Mail verifizieren</a>";
    
// Nutze unsere neue Funktionalität für E-Mail-Vorlagen
$template = yprint_get_email_template($headline, $first_name, $message);

    // Betreff und Header für die E-Mail
    $subject = 'Bitte verifiziere deine E-Mail-Adresse';
    $headers = array(
        'Content-Type: text/html; charset=UTF-8',
        'From: YPrint <do-not-reply@yprint.de>',
    );

    // E-Mail senden und Ergebnis prüfen
    $mail_sent = wp_mail($email, $subject, $template, $headers);
    
    // Wenn die E-Mail nicht gesendet werden konnte, dies in das Fehlerlog schreiben
    if (!$mail_sent) {
        error_log("Failed to send verification email to: {$email}");
        
        // Überprüfen der wp_mail Fehler
        global $phpmailer;
        if (isset($GLOBALS['phpmailer'])) {
            $phpmailer = $GLOBALS['phpmailer'];
            if ($phpmailer->ErrorInfo != '') {
                error_log('PHPMailer error: ' . $phpmailer->ErrorInfo);
            }
        }
    } else {
        error_log("Verification email sent successfully to: {$email}");
    }

    // Nur den Sende-Status zurückgeben, keine REST Response
    return $mail_sent;
}

// E-Mail-Verifizierungscode verarbeiten
function verify_user_email($user_id, $verification_code) {
    global $wpdb;
    // Sicherstellen, dass der Code und die Benutzer-ID übereinstimmen
    $updated = $wpdb->update(
        'wp_email_verifications',
        ['email_verified' => 1], // Markiere als verifiziert
        ['user_id' => $user_id, 'verification_code' => $verification_code],
        ['%d'], // Format der Werte
        ['%d', '%s'] // Format der Bedingungen
    );

    return ($updated !== false); // Wenn das Update erfolgreich war
}

function verify_email_shortcode() {
    ob_start();

    if (isset($_GET['verification_code']) && isset($_GET['user_id'])) {
        global $wpdb;
        $verification_code = sanitize_text_field($_GET['verification_code']);
        $user_id = intval($_GET['user_id']);

        // Korrekte Tabelle für Verifizierungsdaten
        $table_name = 'wp_email_verifications';

        // Verifizierungscode in der Datenbank suchen
        $user = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_name WHERE user_id = %d AND verification_code = %s", 
            $user_id, $verification_code
        ));

        if ($user) {
            // Überprüfen, ob die E-Mail bereits verifiziert wurde
            if ($user->email_verified == 1) {
                echo '<p>Die E-Mail-Adresse wurde bereits bestätigt.</p>';
            } else {
                $verification_request_time = strtotime($user->created_at);
                $expiry_time = 24 * 60 * 60; // 24 Stunden
                $current_time = time();
                $remaining_time = $expiry_time - ($current_time - $verification_request_time);

                // Überprüfen, ob der Verifizierungscode noch gültig ist
                if ($remaining_time > 0) {
                    $verified = verify_user_email($user_id, $verification_code);

                    if ($verified) {
                        echo '<p>Die E-Mail-Adresse wurde erfolgreich bestätigt! Du wirst nun zum Login weitergeleitet.</p>';
                        echo '<script>
                            setTimeout(function() {
                                window.location.href = "' . home_url('/login') . '";
                            }, 3000);
                        </script>';
                    } else {
                        echo '<p>Es gab ein Problem bei der Verifizierung des Codes.</p>';
                    }
                } else {
                    echo '<p>Der Verifizierungscode ist abgelaufen. Bitte fordere einen neuen an.</p>';
                }
            }
        } else {
            echo '<p>Der Verifizierungscode ist ungültig oder abgelaufen.</p>';
        }
    } else {
        echo '<p>Kein Verifizierungscode gefunden. Bitte überprüfe deinen E-Mail-Link.</p>';
    }

    return ob_get_clean();
}
add_shortcode('verify_email', 'verify_email_shortcode');

function yprint_registration_form_mobile() {
    return '<form id="register-form-mobile" method="post" style="display: flex; flex-direction: column; align-items: center; background-color: #fff; border-radius: 25px; padding: 20px; width: 300px; box-sizing: border-box; border: 1px solid #000; position: relative;">
        <div style="display: flex; flex-direction: column; align-items: center; font-family: \'Roboto\', sans-serif; font-weight: bold; margin-bottom: 16px;">
            <!-- Username Feld -->
            <label style="font-size: 14px; margin-bottom: 4px; color: #000; text-align: center;">Username</label>
            <div style="width: 240px; height: 36px; display: flex; align-items: center; border: 1px solid #000; border-radius: 18px; padding: 0 12px; background-color: #f9f9f9; box-sizing: border-box;">
                <input type="text" name="username" id="user_login_mobile" placeholder="Enter your username" style="flex-grow: 1; text-align: center; border: none; outline: none; font-family: inherit; font-size: 14px; background: none; height: 100%; margin: 0;" required>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; font-family: \'Roboto\', sans-serif; font-weight: bold; margin-bottom: 16px;">
            <!-- Email Feld -->
            <label style="font-size: 14px; margin-bottom: 4px; color: #000; text-align: center;">Email</label>
            <div style="width: 240px; height: 36px; display: flex; align-items: center; border: 1px solid #000; border-radius: 18px; padding: 0 12px; background-color: #f9f9f9; box-sizing: border-box;">
                <input type="email" name="email" id="user_email_mobile" placeholder="Enter your email" style="flex-grow: 1; text-align: center; border: none; outline: none; font-family: inherit; font-size: 14px; background: none; height: 100%; margin: 0;" required>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; font-family: \'Roboto\', sans-serif; font-weight: bold; margin-bottom: 16px;">
            <!-- Password Feld -->
            <label style="font-size: 14px; margin-bottom: 4px; color: #000; text-align: center;">Password</label>
            <div style="width: 240px; height: 36px; display: flex; align-items: center; border: 1px solid #000; border-radius: 18px; padding: 0 12px; background-color: #f9f9f9; box-sizing: border-box;">
                <input type="password" name="password" id="user_password_mobile" placeholder="Enter your password" style="flex-grow: 1; text-align: center; border: none; outline: none; font-family: inherit; font-size: 14px; background: none; height: 100%; margin: 0;" required>
                <span id="password-toggle-mobile" style="cursor: pointer; padding-left: 5px;">
                    <i class="eicon-eye" style="font-size: 16px; color: #666;"></i>
                </span>
            </div>
            <!-- Passwortanforderungen -->
            <div id="password-requirements" style="margin-top: 8px; font-size: 12px; color: red;">
                <ul>
                    <li id="length" style="color: red;">Mindestens 8 Zeichen</li>
                    <li id="uppercase" style="color: red;">Mindestens ein Großbuchstabe</li>
                    <li id="number" style="color: red;">Mindestens eine Zahl</li>
                    <li id="special" style="color: red;">Mindestens ein Sonderzeichen</li>
                </ul>
            </div>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; font-family: \'Roboto\', sans-serif; font-weight: bold; margin-bottom: 16px;">
            <!-- Repeat Password Feld -->
            <label style="font-size: 14px; margin-bottom: 4px; color: #000; text-align: center;">Repeat Password</label>
            <div style="width: 240px; height: 36px; display: flex; align-items: center; border: 1px solid #000; border-radius: 18px; padding: 0 12px; background-color: #f9f9f9; box-sizing: border-box;">
                <input type="password" name="password_confirm" id="user_password_confirm_mobile" placeholder="Repeat your password" style="flex-grow: 1; text-align: center; border: none; outline: none; font-family: inherit; font-size: 14px; background: none; height: 100%; margin: 0;" required>
                <span id="confirm-password-toggle-mobile" style="cursor: pointer; padding-left: 5px;">
                    <i class="eicon-eye" style="font-size: 16px; color: #666;"></i>
                </span>
            </div>
        </div>

        <!-- Datenschutz-Checkbox -->
        <div style="display: flex; margin-bottom: 25px; width: 240px; font-family: \'Roboto\', sans-serif; font-size: 13px; align-items: flex-start;">
            <input type="checkbox" id="datenschutz_akzeptiert" name="datenschutz_akzeptiert" style="margin-right: 10px; margin-top: 4px;" required>
            <label for="datenschutz_akzeptiert" style="font-weight: normal;">
                Ich habe die <a href="https://yprint.de/datenschutz/" target="_blank" style="color: #0079FF; font-weight: bold; text-decoration: none;">Datenschutzerklärung</a> gelesen und akzeptiere diese.
            </label>
        </div>

        <!-- Fehlermeldung für Datenschutz -->
        <div id="datenschutz-error" style="color: red; font-size: 12px; margin-bottom: 10px; display: none; font-family: \'Roboto\', sans-serif;">
            Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.
        </div>

        <!-- Der Submit-Button wird innerhalb des Formulars, aber visuell außerhalb des Containers positioniert -->
        <div style="position: absolute; bottom: -75px; width: 100%; display: flex; justify-content: center;">
            <button type="submit" id="register-button-mobile" style="width: 155px; height: 35px; font-family: \'Roboto\', sans-serif; font-size: 20px; font-weight: bold; color: #FFFFFF; background-color: #0079FF; border: 1px solid #707070; border-radius: 0; cursor: pointer; text-transform: lowercase; line-height: 1px;">
                Register
            </button>
        </div>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Passwort-Validierung
            document.getElementById("user_password_mobile").addEventListener("input", function() {
                var password = this.value;
                var requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                };

                // Überprüfe jede Anforderung
                if (requirements.length) {
                    document.getElementById("length").style.display = "none";
                } else {
                    document.getElementById("length").style.display = "block";
                    document.getElementById("length").style.color = "red";
                }

                if (requirements.uppercase) {
                    document.getElementById("uppercase").style.display = "none";
                } else {
                    document.getElementById("uppercase").style.display = "block";
                    document.getElementById("uppercase").style.color = "red";
                }

                if (requirements.number) {
                    document.getElementById("number").style.display = "none";
                } else {
                    document.getElementById("number").style.display = "block";
                    document.getElementById("number").style.color = "red";
                }

                if (requirements.special) {
                    document.getElementById("special").style.display = "none";
                } else {
                    document.getElementById("special").style.display = "block";
                    document.getElementById("special").style.color = "red";
                }
            });

            // Formular-Validierung inklusive Datenschutz-Checkbox
            document.getElementById("register-form-mobile").addEventListener("submit", function(event) {
                var datenschutzCheckbox = document.getElementById("datenschutz_akzeptiert");
                var datenschutzError = document.getElementById("datenschutz-error");
                
                if (!datenschutzCheckbox.checked) {
                    event.preventDefault();
                    datenschutzError.style.display = "block";
                    return false;
                } else {
                    datenschutzError.style.display = "none";
                }
                
                // Hier kannst du weitere Validierungen hinzufügen wenn nötig
            });
            
            // Vereinfachte und robustere Password Toggle Funktionalität
            document.getElementById("password-toggle-mobile").onclick = function() {
                var field = document.getElementById("user_password_mobile");
                
                // Toggle zwischen Passwort und Text
                field.type = (field.type === "password") ? "text" : "password";
                
                // Verhindern, dass andere Event-Handler ausgelöst werden
                return false;
            };
            
            document.getElementById("confirm-password-toggle-mobile").onclick = function() {
                var field = document.getElementById("user_password_confirm_mobile");
                
                // Toggle zwischen Passwort und Text
                field.type = (field.type === "password") ? "text" : "password";
                
                // Verhindern, dass andere Event-Handler ausgelöst werden
                return false;
            };
        });
    </script>';
}
add_shortcode('yprint_registration_form_mobile', 'yprint_registration_form_mobile');

function yprint_enqueue_registration_script() {
    wp_add_inline_script('jquery', '
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("register-form-mobile").addEventListener("submit", function (event) {
                event.preventDefault();

                const username = document.getElementById("user_login_mobile").value;
                const email = document.getElementById("user_email_mobile").value;
                const password = document.getElementById("user_password_mobile").value;
                const confirmPassword = document.getElementById("user_password_confirm_mobile").value;

                if (password !== confirmPassword) {
                    alert("Passwords do not match.");
                    return;
                }

                const data = {
                    username: username,
                    email: email,
                    password: password
                };

                fetch("' . esc_url(rest_url('wp/v2/users/register')) . '", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200) {
                        // Überprüfen, ob die E-Mail erfolgreich gesendet wurde
                        if (result.email_sent === false) {
                            // Wenn die E-Mail nicht gesendet wurde, zur Login-Seite mit einem Parameter für Email-Probleme weiterleiten
                            window.location.href = "/login?verification_issue=1&user_id=" + result.user_id;
                        } else {
                            // Standardweiterleitung bei erfolgreicher Registrierung und E-Mail-Versand
                            window.location.href = "/login?verification_sent=1";
                        }
                    } else {
                        alert(result.message || "An error occurred.");
                    }
                })
                .catch(error => {
                    alert("An unexpected error occurred.");
                    console.error(error);
                });
            });
        });
    ');
}
add_action('wp_enqueue_scripts', 'yprint_enqueue_registration_script');

// -----------------------------------------------------------------------------------------------------------------

// Fügen Sie diesen Code zu Ihrer theme's functions.php hinzu oder in ein Site-spezifisches Plugin
function yprint_mobile_nav_toggle() {
    ?>
    <script>
    jQuery(document).ready(function($) {
        // Warten bis die Seite vollständig geladen ist
        $(window).on('load', function() {
            // Diese Funktion überprüft, ob das Menü geöffnet ist
            function isMenuOpen() {
                return window.location.hash === '#mobile-navigation' || 
                       window.location.search.indexOf('nav_open=1') !== -1;
            }
            
            // Finde alle Navigations-Buttons (es könnten mehrere sein)
            var $navButtons = $('a[href="#mobile-navigation"], a[href*="nav_open=1"]');
            console.log('Gefundene Nav-Buttons:', $navButtons.length);
            
            // Wenn wir Buttons gefunden haben
            if ($navButtons.length > 0) {
                // Speichere die originalen href-Werte
                $navButtons.each(function() {
                    $(this).data('original-href', $(this).attr('href'));
                });
                
                // Füge einen Event-Listener für Klicks hinzu, der NACH dem ursprünglichen Klick ausgeführt wird
                $navButtons.on('click', function(e) {
                    // Speichere eine Referenz auf den Button
                    var $clickedButton = $(this);
                    
                    // Überprüfe, ob das Menü bereits geöffnet ist
                    if (isMenuOpen()) {
                        console.log('Menü ist offen, schließe es');
                        // Verhindern Sie das Standard-Klick-Verhalten
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Wenn es offen ist, schließe es durch Neuladen der Seite ohne Parameter
                        var cleanUrl = window.location.protocol + '//' + window.location.host + 
                                    window.location.pathname;
                        
                        // Behalte andere Query-Parameter bei, falls vorhanden, aber entferne nav_open
                        var searchParams = new URLSearchParams(window.location.search);
                        searchParams.delete('nav_open');
                        
                        // Füge bereinigte Parameter hinzu, falls welche übrig sind
                        if (searchParams.toString()) {
                            cleanUrl += '?' + searchParams.toString();
                        }
                        
                        // Navigiere zur bereinigten URL
                        window.location.href = cleanUrl;
                        return false;
                    } else {
                        console.log('Menü ist geschlossen, lasse es öffnen');
                        // Wenn das Menü geschlossen ist, lasse das Standard-Verhalten zu
                        // Aber ändere den Text nach einer kurzen Verzögerung
                        setTimeout(function() {
                            if ($clickedButton.data('original-text')) {
                                $clickedButton.text('Menü schließen');
                            }
                        }, 500);
                        return true; // Lasse den normalen Klick durchlaufen
                    }
                });
                
                // Update Button-Text basierend auf Menü-Status
                function updateButtonsText() {
                    if (isMenuOpen()) {
                        $navButtons.each(function() {
                            // Speichere den originalen Text, falls wir ihn noch nicht gespeichert haben
                            var $btn = $(this);
                            if (!$btn.data('original-text') && $btn.text() !== 'Menü schließen') {
                                $btn.data('original-text', $btn.text());
                                console.log('Originaler Text gespeichert:', $btn.data('original-text'));
                            }
                            $btn.text('Menü schließen');
                        });
                    } else {
                        $navButtons.each(function() {
                            var $btn = $(this);
                            // Stelle den ursprünglichen Text wieder her, falls gespeichert
                            if ($btn.data('original-text')) {
                                $btn.text($btn.data('original-text'));
                            }
                        });
                    }
                }
                
                // Initialer Check und regelmäßiges Update
                setTimeout(updateButtonsText, 500);
                setInterval(updateButtonsText, 1000);
                
                console.log('Mobile Navigation Toggle initialisiert');
            }
        });
    });
    </script>
    <?php
}
add_action('wp_footer', 'yprint_mobile_nav_toggle', 999);

// -----------------------------------------------------------------------------------------------------------------

// Shortcode für die Navigation der rechtlichen Seiten
function legal_navigation_shortcode() {
    // Sammle alle rechtlichen Seiten in einem Array
    $legal_pages = array(
        'cookies' => array(
            'title' => 'Cookies',
            'id' => get_page_by_path('cookies')->ID,
            'icon' => 'cookie'
        ),
        'impressum' => array(
            'title' => 'Impressum',
            'id' => get_page_by_path('impressum')->ID,
            'icon' => 'info'
        ),
        'datenschutz' => array(
            'title' => 'Datenschutz',
            'id' => get_page_by_path('datenschutz')->ID,
            'icon' => 'shield'
        ),
        'rechtlicher-hinweis' => array(
            'title' => 'Rechtlicher Hinweis',
            'id' => get_page_by_path('rechtlicher-hinweis')->ID,
            'icon' => 'gavel'
        ),
        'gesetz-ueber-digitale-dienste' => array(
            'title' => 'Gesetz über digitale Dienste',
            'id' => get_page_by_path('gesetz-ueber-digitale-dienste')->ID,
            'icon' => 'globe'
        ),
        'produktsicherheitsverordnung' => array(
            'title' => 'Produktsicherheit',
            'id' => get_page_by_path('produktsicherheitsverordnung')->ID,
            'icon' => 'check-circle'
        ),
    );

    // Bestimme die aktuelle Seite
    $current_page_id = get_the_ID();
    $current_page_slug = get_post_field('post_name', get_post());

    // Speichere die vorherige URL in einer Session, falls sie nicht aus einer rechtlichen Seite kommt
    if (!isset($_SESSION)) {
        session_start();
    }

    $referer = wp_get_referer();
    if ($referer && !preg_match('/(cookies|impressum|datenschutz|rechtlicher-hinweis|gesetz-ueber-digitale-dienste|produktsicherheitsverordnung)/i', $referer)) {
        $_SESSION['previous_page'] = $referer;
    }

    // Wenn keine vorherige Seite in der Session gespeichert ist, setze Startseite als Standard
    if (!isset($_SESSION['previous_page'])) {
        $_SESSION['previous_page'] = home_url();
    }

    // Beginne mit dem Output-Buffering
    ob_start();
    ?>
    <!-- Google Fonts für Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <div class="yprint-legal-container">
        <div class="yprint-legal-sidebar">
            <!-- Zurück-Button immer als erster Button -->
            <a href="<?php echo $_SESSION['previous_page']; ?>" class="yprint-legal-button yprint-back-button">
                <i class="fas fa-arrow-left"></i> Zurück
            </a>
            
            <!-- Navigation für rechtliche Seiten -->
            <div class="yprint-legal-nav-title">Rechtliche Informationen</div>
            
            <?php foreach ($legal_pages as $slug => $page): ?>
                <?php 
                // Prüfe, ob dies die aktuelle Seite ist
                $is_current = ($page['id'] == $current_page_id || $slug == $current_page_slug);
                $class = $is_current ? 'yprint-current-legal-page' : '';
                ?>
                <a href="<?php echo get_permalink($page['id']); ?>" class="yprint-legal-button <?php echo $class; ?>">
                    <i class="fas fa-<?php echo $page['icon']; ?>"></i> <?php echo $page['title']; ?>
                </a>
            <?php endforeach; ?>
            
            <!-- Logo im Footer -->
            <div class="yprint-legal-footer">
                <img src="https://yprint.de/wp-content/uploads/2025/02/120225-y-icon.svg" alt="yprint Logo" class="yprint-footer-logo">
            </div>
        </div>
        
        <style>
            .yprint-legal-container {
                font-family: 'Roboto', sans-serif;
                max-width: 1200px;
                margin: 0 auto 40px auto;
                padding: 0;
                display: flex;
                flex-direction: column;
            }

            .yprint-legal-sidebar {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 30px;
                padding: 20px;
                border-radius: 8px;
                background-color: #FFFFFF;
                border: 1px solid #CFCFCF;
            }

            .yprint-legal-nav-title {
                font-weight: bold;
                font-size: 16px;
                color: #555;
                margin: 10px 0;
                padding-left: 10px;
                border-left: 3px solid #0079FF;
            }

            .yprint-legal-button {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                text-decoration: none;
                color: #333;
                background-color: #fff;
                border-radius: 6px;
                font-size: 15px;
                transition: all 0.3s ease;
                border: 1px solid #eee;
            }

            .yprint-legal-button:hover {
                background-color: #f0f7ff;
                border-color: #0079FF;
            }

            .yprint-legal-button i {
                margin-right: 10px;
                color: #0079FF;
                font-size: 18px;
                width: 20px;
                text-align: center;
            }

            /* Zurück-Button spezielles Styling */
            .yprint-back-button {
                background-color: #0079FF;
                color: white;
                border: none;
            }

            .yprint-back-button:hover {
                background-color: #0056b3;
            }

            .yprint-back-button i {
                color: white;
            }

            /* Hervorhebung der aktuellen Seite */
            .yprint-current-legal-page {
                background-color: #e6f2ff;
                border-color: #0079FF;
                font-size: 20px;
                font-weight: 700;
                color: #0079FF;
                padding: 15px;
                position: relative;
            }

            .yprint-current-legal-page::after {
                content: "";
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #0079FF;
            }

            .yprint-current-legal-page i {
                font-size: 22px;
            }

            /* Footer der Sidebar */
            .yprint-legal-footer {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #eee;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .yprint-footer-logo {
                width: 50px;
                height: 50px;
                margin-bottom: 10px;
            }

            /* Responsive Anpassungen */
            @media (min-width: 768px) {
                .yprint-legal-container {
                    flex-direction: row;
                }
                
                .yprint-legal-sidebar {
                    width: 280px;
                    position: sticky;
                    top: 20px;
                    align-self: flex-start;
                }
            }
        </style>
    </div>
    <?php
    // Gib den gepufferten Inhalt zurück
    return ob_get_clean();
}
add_shortcode('legal_navigation', 'legal_navigation_shortcode');

// Diese Funktion ermöglicht die Speicherung der zurückliegenden URL
function start_session_for_legal_pages() {
    // Nur Sessions starten, wenn sie wirklich benötigt werden
    $legal_pages = array('cookies', 'impressum', 'datenschutz', 'rechtlicher-hinweis', 
                         'gesetz-ueber-digitale-dienste', 'produktsicherheitsverordnung');
    
    $current_page = get_post_field('post_name', get_post());
    
    if (in_array($current_page, $legal_pages) && !session_id()) {
        session_start();
    }
    
    // Handler für das Beenden der Session nach der Anfrage
    add_action('shutdown', function() {
        if (session_status() === PHP_SESSION_ACTIVE) {
            session_write_close();
        }
    });
}
add_action('init', 'start_session_for_legal_pages', 1);

// Laden der Roboto Schriftart global
function add_roboto_font_for_legal_pages() {
    if (is_page(array('cookies', 'impressum', 'datenschutz', 'rechtlicher-hinweis', 'gesetz-ueber-digitale-dienste', 'produktsicherheitsverordnung'))) {
        wp_enqueue_style('roboto-font', 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    }
}
add_action('wp_enqueue_scripts', 'add_roboto_font_for_legal_pages');

// -----------------------------------------------------------------------------------------------------------------

/**
 * Add this code to your theme's functions.php file or a custom plugin
 */

/**
 * Add shortcode for CookieYes consent popup trigger button
 * 
 * @param array $atts Shortcode attributes
 * @param string $content Shortcode content
 * @return string HTML output
 */
function yprint_cookieyes_button_shortcode($atts, $content = null) {
    // Parse attributes
    $attributes = shortcode_atts(array(
        'class' => '',
        'text'  => 'Cookie Settings',
        'style' => '',
    ), $atts);
    
    // Generate unique ID
    $unique_id = 'cky-btn-' . uniqid();
    
    // Combine classes - include cky-banner-element class for automatic CookieYes detection
    $classes = 'cky-banner-element ' . esc_attr($attributes['class']);
    
    // Build button style
    $style = '';
    if ($attributes['style']) {
        $style = ' style="' . esc_attr($attributes['style']) . '"';
    }
    
    // Build the button HTML
    $button = '<button id="' . esc_attr($unique_id) . '" class="' . esc_attr($classes) . '"' . $style . '>';
    $button .= esc_html($attributes['text']);
    $button .= '</button>';
    
    return $button;
}
add_shortcode('cookieyes_button', 'yprint_cookieyes_button_shortcode');

add_action('wp_footer', 'replace_cookieyes_icon_with_cookie_bite', 999);

add_action('wp_footer', 'replace_cookieyes_icon_with_cookie_bite', 999);





add_action('wp_footer', 'replace_cookieyes_icon_with_cookie_bite', 999);
function replace_cookieyes_icon_with_cookie_bite() {
    ?>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        function checkAndReplaceIcon() {
            const revisitBtn = document.querySelector('[data-cky-tag="revisit-consent"] img');
            const buttonWrapper = document.querySelector('[data-cky-tag="revisit-consent"]');
            
            if (revisitBtn && buttonWrapper) {
                // Hintergrund transparent machen
                buttonWrapper.style.backgroundColor = 'transparent';
                buttonWrapper.style.border = 'none';
                buttonWrapper.style.boxShadow = 'none';
                
                // Das Bild-Element durch das Cookie-Bite-SVG ersetzen
                const cookieSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                cookieSvg.setAttribute('width', '40');
                cookieSvg.setAttribute('height', '40');
                cookieSvg.setAttribute('viewBox', '0 0 512 512');
                cookieSvg.setAttribute('fill', '#1b7cff');
                
                // Exakter Pfad für das Cookie-Bite-Icon
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M257.5 27.6c-.8-5.4-4.9-9.8-10.3-10.6c-22.1-3.1-44.6 .9-64.4 11.4l-74 39.5C89.1 78.4 73.2 94.9 63.4 115L26.7 190.6c-9.8 20.1-13 42.9-9.1 64.9l14.5 82.8c3.9 22.1 14.6 42.3 30.7 57.9l60.3 58.4c16.1 15.6 36.6 25.6 58.7 28.7l83 11.7c22.1 3.1 44.6-.9 64.4-11.4l74-39.5c19.7-10.5 35.6-27 45.4-47.2l36.7-75.5c9.8-20.1 13-42.9 9.1-64.9c-.9-5.3-5.3-9.3-10.6-10.1c-51.5-8.2-92.8-47.1-104.5-97.4c-1.8-7.6-8-13.4-15.7-14.6c-54.6-8.7-97.7-52-106.2-106.8zM208 144a32 32 0 1 1 0 64 32 32 0 1 1 0-64zM144 336a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm224-64a32 32 0 1 1 0 64 32 32 0 1 1 0-64z');
                
                cookieSvg.appendChild(path);
                revisitBtn.parentNode.replaceChild(cookieSvg, revisitBtn);
                
                // Optional: Größe des Button-Wrappers anpassen
                buttonWrapper.style.padding = '8px';
                
                return true;
            }
            return false;
        }
        
        // Sofort versuchen, das Icon zu ersetzen
        if (!checkAndReplaceIcon()) {
            // Wenn nicht sofort möglich, MutationObserver verwenden
            const observer = new MutationObserver(function(mutations) {
                if (checkAndReplaceIcon()) {
                    // Icon wurde ersetzt, Observer kann beendet werden
                    observer.disconnect();
                }
            });
            
            // Gesamtes body-Element beobachten
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Sicherheitsabbruch nach 10 Sekunden
            setTimeout(function() {
                observer.disconnect();
            }, 10000);
        }
    });
    </script>
    <?php
}

// Funktion zum WordPress-Hook hinzufügen
add_action('wp_footer', 'replace_cookieyes_icon_with_cookie_bite');

// -----------------------------------------------------------------------------------------------------------------
/**
 * YPrint Minimalist Cart Shortcode
 * 
 * Creates a minimalistic WooCommerce cart for popup display
 */

// Verhindere direkten Zugriff
if (!defined('ABSPATH')) {
    exit;
}

function yprint_minimalist_cart_shortcode() {
    // Puffer-Output starten
    ob_start();
    
    // Sicherstellen, dass WooCommerce aktiv ist
    if (!class_exists('WooCommerce')) {
        return '<p>WooCommerce ist nicht aktiviert.</p>';
    }
    
    // Eindeutige ID für diesen Warenkorb generieren
    $cart_id = 'yprint-cart-' . uniqid();
    
    // Warenkorb optimieren - gleiche Produkte zusammenführen
    yprint_consolidate_cart_items();
    
    // CSS für den minimalistischen Warenkorb
    ?>
    <style>
        .yprint-mini-cart {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
        }
        .yprint-mini-cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .yprint-mini-cart-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        .yprint-mini-cart-count {
            background: #0079FF;
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .yprint-mini-cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .yprint-mini-cart-item {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .yprint-mini-cart-item-image {
            width: 60px;
            margin-right: 10px;
        }
        .yprint-mini-cart-item-image img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .yprint-mini-cart-item-details {
            flex-grow: 1;
        }
        .yprint-mini-cart-item-title {
            font-size: 14px;
            margin: 0 0 5px;
        }
        .yprint-mini-cart-item-price {
            font-size: 14px;
            font-weight: 600;
        }
        .yprint-mini-cart-item-quantity-control {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .qty-btn {
            background: none;
            border: none;
            padding: 0;
            color: #0079FF;
            font-size: 16px;
            cursor: pointer;
            width: auto;
            height: auto;
        }

        .qty-btn:hover {
            background: none;
            border: none;
            padding: 0;
            color: #0079FF;
            font-size: 16px;
            cursor: pointer;
            width: auto;
            height: auto;
        }

        .qty-value {
            padding: 0 8px;
            font-size: 14px;
            min-width: 20px;
            text-align: center;
            cursor: pointer;
        }
        .qty-input {
            width: 24px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 14px;
            padding: 0;
            display: none;
        }
        .yprint-mini-cart-item-remove {
            cursor: pointer;
            color: #999;
            font-size: 18px;
            line-height: 1;
            padding: 0 5px;
        }
        .yprint-mini-cart-item-remove:hover {
            color: #0079FF;
        }
        .yprint-mini-cart-subtotal {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-weight: 600;
            border-top: 1px solid #eee;
        }
        .yprint-mini-cart-checkout {
            display: block;
            width: 100%;
            background: #0079FF;
            color: #fff;
            border: none;
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .yprint-mini-cart-checkout:hover {
            background: #0062cc;
        }
        .yprint-mini-cart-empty {
            text-align: center;
            padding: 20px 0;
            color: #777;
        }
        .yprint-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .yprint-loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .yprint-loading-overlay img {
            width: 80px;
            height: auto;
        }
        .yprint-mini-cart {
            position: relative;
        }
    </style>
    <div id="<?php echo esc_attr($cart_id); ?>" class="yprint-mini-cart">
        <div class="yprint-loading-overlay"><img src="https://yprint.de/wp-content/uploads/2025/02/120225-logo.svg" alt="Loading..."></div>
        <div class="yprint-mini-cart-header">
            <h3 class="yprint-mini-cart-title">Dein Warenkorb</h3>
            <div class="yprint-mini-cart-count"><?php echo WC()->cart->get_cart_contents_count(); ?></div>
        </div>
        
        <div class="yprint-mini-cart-items">
            <?php
            $cart_items = WC()->cart->get_cart();
            
            if (empty($cart_items)) {
                echo '<div class="yprint-mini-cart-empty">Dein Warenkorb ist leer.</div>';
            } else {
                foreach ($cart_items as $cart_item_key => $cart_item) {
                    $_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
                    $product_id = apply_filters('woocommerce_cart_item_product_id', $cart_item['product_id'], $cart_item, $cart_item_key);
                    
                    if ($_product && $_product->exists() && $cart_item['quantity'] > 0) {
                        $product_name = $_product->get_name();
                        $thumbnail = $_product->get_image();
                        $product_price = WC()->cart->get_product_price($_product);
                        $product_quantity = $cart_item['quantity'];
                        ?>
                        <div class="yprint-mini-cart-item" data-item-key="<?php echo esc_attr($cart_item_key); ?>">
                            <div class="yprint-mini-cart-item-image">
                                <?php echo $thumbnail; ?>
                            </div>
                            <div class="yprint-mini-cart-item-details">
                                <h4 class="yprint-mini-cart-item-title"><?php echo $product_name; ?></h4>
                                <div class="yprint-mini-cart-item-price"><?php echo $product_price; ?></div>
                                <div class="yprint-mini-cart-item-quantity-control">
                                    <button class="qty-btn qty-minus" data-action="minus">−</button>
                                    <span class="qty-value"><?php echo $product_quantity; ?></span>
                                    <input type="number" class="qty-input" value="<?php echo $product_quantity; ?>" min="1">
                                    <button class="qty-btn qty-plus" data-action="plus">+</button>
                                </div>
                            </div>
                            <div class="yprint-mini-cart-item-remove">×</div>
                        </div>
                        <?php
                    }
                }
            }
            ?>
        </div>
        
        <div class="yprint-mini-cart-subtotal">
            <span>Zwischensumme:</span>
            <span><?php echo WC()->cart->get_cart_subtotal(); ?></span>
        </div>
        
        <a href="https://yprint.de/checkout" class="yprint-mini-cart-checkout">Zur Kasse</a>
    </div>
    
    <script>
    (function($) {
        // Eindeutige ID für diesen Warenkorb
        var cartId = '<?php echo $cart_id; ?>';
        var $cart = $('#' + cartId);
        
        // WICHTIG: Event-Handler nur für diesen Warenkorb initialisieren
        // Verhindert doppelte Event-Bindung bei mehreren Warenkörben
        
        // Prüfen, ob dieser Warenkorb bereits initialisiert wurde
        if ($cart.data('initialized')) {
            return;
        }
        
        // Warenkorb als initialisiert markieren
$cart.data('initialized', true);

// Variable, um zu verfolgen, ob ein Eingabefeld aktiv ist
var isEditing = false;

// Automatische Aktualisierung beim Öffnen/Anzeigen des Warenkorbs
function refreshCartContent() {
    // Overlay aktivieren
    $cart.find('.yprint-loading-overlay').addClass('active');
    
    $.ajax({
        url: wc_add_to_cart_params.ajax_url,
        type: 'POST',
        data: {
            action: 'yprint_refresh_cart_content'
        },
        success: function(response) {
            if (response.success) {
                // Cart-Items aktualisieren
                $cart.find('.yprint-mini-cart-items').html(response.cart_items_html);
                // Warenkorb-Anzahl aktualisieren
                $cart.find('.yprint-mini-cart-count').text(response.cart_count);
                // Zwischensumme aktualisieren
                $cart.find('.yprint-mini-cart-subtotal span:last-child').html(response.cart_subtotal);
            }
            
            // Overlay deaktivieren
            $cart.find('.yprint-loading-overlay').removeClass('active');
        },
        error: function() {
            // Overlay deaktivieren bei Fehlern
            $cart.find('.yprint-loading-overlay').removeClass('active');
        }
    });
}

// Initialisiere die Aktualisierung, wenn der Warenkorb sichtbar wird
// Dies funktioniert sowohl für Popups als auch normale Einbindungen
var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
        if (entry.isIntersecting) {
            // Warenkorb ist jetzt sichtbar
            refreshCartContent();
        }
    });
}, { threshold: 0.1 }); // 10% sichtbar reicht aus

// Beobachte den Warenkorb
observer.observe($cart[0]);
        
        // Add to Cart Event abfangen, um doppelte Einträge zu verhindern
$(document.body).on('added_to_cart', function() {
    // Overlay aktivieren
    $cart.find('.yprint-loading-overlay').addClass('active');
    
    // Mehrfach konsolidieren, um sicherzustellen, dass alle doppelten Einträge erwischt werden
    function consolidateCart(attempts) {
        $.ajax({
            url: wc_add_to_cart_params.ajax_url,
            type: 'POST',
            data: {
                action: 'yprint_consolidate_cart'
            },
            success: function(response) {
                if (response.success) {
                    // Wenn Änderungen vorgenommen wurden und noch Versuche übrig sind, erneut konsolidieren
                    if (response.changes && attempts > 1) {
                        consolidateCart(attempts - 1);
                    } else {
                        // Aktualisiere UI-Elemente nach der Konsolidierung
                        $cart.find('.yprint-mini-cart-count').text(response.cart_count);
                        $cart.find('.yprint-mini-cart-subtotal span:last-child').html(response.cart_subtotal);
                        
                        // Overlay deaktivieren
                        $cart.find('.yprint-loading-overlay').removeClass('active');
                        
                        // Seite neu laden, wenn Änderungen vorgenommen wurden
                        if (response.changes) {
                            window.location.reload();
                        }
                    }
                } else {
                    // Overlay deaktivieren
                    $cart.find('.yprint-loading-overlay').removeClass('active');
                }
            },
            error: function() {
                // Overlay deaktivieren bei Fehlern
                $cart.find('.yprint-loading-overlay').removeClass('active');
            }
        });
    }
    
    // Starte mit 2 Versuchen (kann bei Bedarf angepasst werden)
    setTimeout(function() {
        consolidateCart(2);
    }, 200);
});
        
        // ENTFERNEN-BUTTON
        $cart.on('click', '.yprint-mini-cart-item-remove', function() {
            var $item = $(this).closest('.yprint-mini-cart-item');
            var cartItemKey = $item.data('item-key');
            
            // Overlay aktivieren
            $cart.find('.yprint-loading-overlay').addClass('active');
            
            $.ajax({
                url: wc_add_to_cart_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'yprint_remove_from_cart',
                    cart_item_key: cartItemKey
                },
                success: function(response) {
                    // Artikel visuell entfernen
                    $item.fadeOut(300, function() {
                        $(this).remove();
                        
                        // Warenkorb-Anzahl aktualisieren
                        if (response.cart_count !== undefined) {
                            $cart.find('.yprint-mini-cart-count').text(response.cart_count);
                        }
                        
                        // Zwischensumme aktualisieren
                        if (response.cart_subtotal !== undefined) {
                            $cart.find('.yprint-mini-cart-subtotal span:last-child').html(response.cart_subtotal);
                        }
                        
                        // Leeren Warenkorb zeigen, wenn keine Artikel mehr
                        if (response.cart_count === 0) {
                            $cart.find('.yprint-mini-cart-items').html('<div class="yprint-mini-cart-empty">Dein Warenkorb ist leer.</div>');
                        }
                    });
                    
                    // Overlay deaktivieren
                    $cart.find('.yprint-loading-overlay').removeClass('active');
                },
                error: function(xhr, status, error) {
                    console.error('Fehler beim Entfernen:', status, error);
                    $cart.find('.yprint-loading-overlay').removeClass('active');
                }
            });
        });
        
        // PLUS/MINUS BUTTONS
        $cart.on('click', '.qty-btn', function() {
            if (isEditing) return; // Ignorieren, wenn Eingabe aktiv
            
            var $btn = $(this);
            var $item = $btn.closest('.yprint-mini-cart-item');
            var $qtyValue = $item.find('.qty-value');
            var cartItemKey = $item.data('item-key');
            var currentQty = parseInt($qtyValue.text());
            var newQty = $btn.data('action') === 'minus' ? 
                         Math.max(1, currentQty - 1) : 
                         currentQty + 1;
            
            // Menge sofort aktualisieren
            $qtyValue.text(newQty);
            
            // AJAX-Update der Menge
            updateQuantity(cartItemKey, newQty);
        });
        
        // DIREKTEINGABE DER MENGE
        // Klick auf Menge (zum Bearbeiten)
        $cart.on('click', '.qty-value', function() {
            if (isEditing) return; // Bereits im Bearbeitungsmodus
            
            isEditing = true;
            var $value = $(this);
            var $input = $value.siblings('.qty-input');
            
            // Eingabefeld vorbereiten und anzeigen
            $input.val($value.text());
            $value.hide();
            $input.show().focus().select();
        });
        
        // Eingabefeld verlassen
        $cart.on('blur', '.qty-input', function() {
            var $input = $(this);
            var $item = $input.closest('.yprint-mini-cart-item');
            var $value = $input.siblings('.qty-value');
            var cartItemKey = $item.data('item-key');
            var oldQty = parseInt($value.text());
            var newQty = parseInt($input.val());
            
            // Gültigen Wert sicherstellen
            if (isNaN(newQty) || newQty < 1) newQty = 1;
            
            // UI zurücksetzen
            $input.hide();
            $value.show();
            
            // Bearbeitungsmodus beenden
            isEditing = false;
            
            // Nur bei Änderung aktualisieren
            if (newQty !== oldQty) {
                $value.text(newQty);
                updateQuantity(cartItemKey, newQty);
            }
        });
        
        // Enter-Taste im Eingabefeld
        $cart.on('keypress', '.qty-input', function(e) {
            if (e.which === 13) { // Enter
                e.preventDefault();
                $(this).blur();
            }
        });
        
        // Klick außerhalb schließt Eingabefeld
        $(document).on('mousedown', function(e) {
            if (isEditing) {
                var $target = $(e.target);
                if (!$target.is('.qty-input') && !$target.is('.qty-value')) {
                    $cart.find('.qty-input:visible').blur();
                }
            }
        });
        
        // Funktion zum Aktualisieren der Menge
        function updateQuantity(cartItemKey, quantity) {
            // Overlay aktivieren
            $cart.find('.yprint-loading-overlay').addClass('active');
            
            $.ajax({
                url: wc_add_to_cart_params.ajax_url,
                type: 'POST',
                data: {
                    action: 'yprint_update_cart_quantity',
                    cart_item_key: cartItemKey,
                    quantity: quantity
                },
                success: function(response) {
                    // Zwischensumme aktualisieren
                    if (response.cart_subtotal !== undefined) {
                        $cart.find('.yprint-mini-cart-subtotal span:last-child').html(response.cart_subtotal);
                    }
                    
                    // Overlay deaktivieren
                    $cart.find('.yprint-loading-overlay').removeClass('active');
                },
                error: function(xhr, status, error) {
                    console.error('Fehler beim Aktualisieren:', status, error);
                    $cart.find('.yprint-loading-overlay').removeClass('active');
                }
            });
        }
    })(jQuery);
    </script>
    <?php
    
    // Puffer-Output zurückgeben
    return ob_get_clean();
}

function yprint_ajax_consolidate_cart() {
    // Warenkorb-Zustand vor der Konsolidierung speichern
    $item_count_before = count(WC()->cart->get_cart());
    
    // Konsolidieren
    yprint_consolidate_cart_items();
    
    // Warenkorb-Zustand nach der Konsolidierung
    $item_count_after = count(WC()->cart->get_cart());
    
    // Definiere, ob es Änderungen gab
    $changes = ($item_count_before !== $item_count_after);
    
    // Zähle zusammen, ob noch weitere Konsolidierung notwendig ist
    wp_send_json_success(array(
        'changes' => $changes,
        'cart_count' => WC()->cart->get_cart_contents_count(),
        'cart_subtotal' => WC()->cart->get_cart_subtotal(),
        'before' => $item_count_before,
        'after' => $item_count_after
    ));
}

// Add to Cart Hook, um doppelte Artikel direkt zu vermeiden
add_action('woocommerce_add_to_cart', 'yprint_after_add_to_cart', 20, 6);

// Ajax-Actions für den Warenkorb registrieren
add_action('wp_ajax_yprint_remove_from_cart', 'yprint_remove_from_cart');
add_action('wp_ajax_nopriv_yprint_remove_from_cart', 'yprint_remove_from_cart');

add_action('wp_ajax_yprint_update_cart_quantity', 'yprint_update_cart_quantity');
add_action('wp_ajax_nopriv_yprint_update_cart_quantity', 'yprint_update_cart_quantity');

// Ajax-Funktion zum Entfernen eines Produkts aus dem Warenkorb
function yprint_remove_from_cart() {
    $cart_item_key = isset($_POST['cart_item_key']) ? sanitize_text_field($_POST['cart_item_key']) : '';
    
    if ($cart_item_key) {
        WC()->cart->remove_cart_item($cart_item_key);
    }
    
    // Minimale Daten zurückgeben
    wp_send_json(array(
        'cart_count' => WC()->cart->get_cart_contents_count(),
        'cart_subtotal' => WC()->cart->get_cart_subtotal()
    ));
    
    wp_die();
}

// Ajax-Funktion zum Aktualisieren der Produktmenge
function yprint_update_cart_quantity() {
    $cart_item_key = isset($_POST['cart_item_key']) ? sanitize_text_field($_POST['cart_item_key']) : '';
    $quantity = isset($_POST['quantity']) ? intval($_POST['quantity']) : 1;
    
    if ($cart_item_key && $quantity > 0) {
        WC()->cart->set_quantity($cart_item_key, $quantity);
        
        // Minimale Daten zurückgeben
        wp_send_json(array(
            'cart_subtotal' => WC()->cart->get_cart_subtotal()
        ));
    } else {
        wp_send_json_error('Invalid cart item key or quantity');
    }
    
    wp_die();
}

// Verhindert doppelte Artikel beim Seitenneuladen
add_action('woocommerce_cart_loaded_from_session', 'yprint_cart_loaded_from_session');
function yprint_cart_loaded_from_session($cart) {
    // Prüfe, ob der Warenkorb Print-Design-Produkte enthält
    $has_print_design = false;
    foreach ($cart->get_cart() as $cart_item) {
        if (isset($cart_item['print_design'])) {
            $has_print_design = true;
            break;
        }
    }
    
    // Konsolidiere den Warenkorb nur, wenn keine Print-Design-Produkte vorhanden sind
    if (!$has_print_design) {
        yprint_consolidate_cart_items();
    }
}

// Shortcode registrieren
add_shortcode('yprint_minimalist_cart', 'yprint_minimalist_cart_shortcode');

// AJAX-Handler zur Aktualisierung des Warenkorb-Inhalts
function yprint_refresh_cart_content_callback() {
    ob_start();
    
    // Warenkorb optimieren
    yprint_consolidate_cart_items();
    
    // Warenkorb-Einträge generieren
    $cart_items = WC()->cart->get_cart();
    
    if (empty($cart_items)) {
        echo '<div class="yprint-mini-cart-empty">Dein Warenkorb ist leer.</div>';
    } else {
        foreach ($cart_items as $cart_item_key => $cart_item) {
            $_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
            $product_id = apply_filters('woocommerce_cart_item_product_id', $cart_item['product_id'], $cart_item, $cart_item_key);
            
            if ($_product && $_product->exists() && $cart_item['quantity'] > 0) {
                $product_name = $_product->get_name();
                $thumbnail = $_product->get_image();
                $product_price = WC()->cart->get_product_price($_product);
                $product_quantity = $cart_item['quantity'];
                ?>
                <div class="yprint-mini-cart-item" data-item-key="<?php echo esc_attr($cart_item_key); ?>">
                    <div class="yprint-mini-cart-item-image">
                        <?php echo $thumbnail; ?>
                    </div>
                    <div class="yprint-mini-cart-item-details">
                        <h4 class="yprint-mini-cart-item-title"><?php echo $product_name; ?></h4>
                        <div class="yprint-mini-cart-item-price"><?php echo $product_price; ?></div>
                        <div class="yprint-mini-cart-item-quantity-control">
                            <button class="qty-btn qty-minus" data-action="minus">−</button>
                            <span class="qty-value"><?php echo $product_quantity; ?></span>
                            <input type="number" class="qty-input" value="<?php echo $product_quantity; ?>" min="1">
                            <button class="qty-btn qty-plus" data-action="plus">+</button>
                        </div>
                    </div>
                    <div class="yprint-mini-cart-item-remove">×</div>
                </div>
                <?php
            }
        }
    }
    
    $cart_items_html = ob_get_clean();
    
    wp_send_json(array(
        'success' => true,
        'cart_items_html' => $cart_items_html,
        'cart_count' => WC()->cart->get_cart_contents_count(),
        'cart_subtotal' => WC()->cart->get_cart_subtotal()
    ));
}
add_action('wp_ajax_yprint_refresh_cart_content', 'yprint_refresh_cart_content_callback');
add_action('wp_ajax_nopriv_yprint_refresh_cart_content', 'yprint_refresh_cart_content_callback');



// -----------------------------------------------------------------------------------------------------------------
function yprint_loading_animation() {
    if (is_page('products')) {
        ?>
        <div id="yprint-loading-overlay">
            <div id="yprint-loading-animation">
                <img src="https://yprint.de/wp-content/uploads/2025/02/120225-logo.svg" alt="Loading...">
            </div>
        </div>

        <style>
        #yprint-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #yprint-loading-animation {
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #yprint-loading-animation img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: yprint-glow 2s ease-in-out infinite alternate;
        }

        @keyframes yprint-glow {
            0% {
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
            }
            100% {
                filter: drop-shadow(0 0 20px rgba(255, 255, 255, 1));
            }
        }
        </style>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Animation nach 1 Sekunde ausblenden
            setTimeout(function() {
                document.getElementById('yprint-loading-overlay').style.display = 'none';
            }, 2000);
        });
        </script>
        <?php
    }
}
add_action('wp_footer', 'yprint_loading_animation');
// -----------------------------------------------------------------------------------------------------------------

// === TEIL 1: BENUTZERDEFINIERTE FELDER IN WOOCOMMERCE HINZUFÜGEN ===
function yprint_register_product_custom_fields() {
    // Produkt-Tab hinzufügen
    add_filter('woocommerce_product_data_tabs', 'yprint_add_product_data_tab');
    function yprint_add_product_data_tab($tabs) {
        $tabs['yprint_details'] = array(
            'label'    => __('yprint Zusatzdaten', 'yprint'),
            'target'   => 'yprint_product_data',
            'class'    => array('show_if_simple', 'show_if_variable'),
            'priority' => 21
        );
        return $tabs;
    }

    // Tab-Inhalte hinzufügen
    add_action('woocommerce_product_data_panels', 'yprint_add_product_data_fields');
    function yprint_add_product_data_fields() {
        ?>
        <div id="yprint_product_data" class="panel woocommerce_options_panel">
            <div class="options_group">
                <?php
                // Hersteller
                woocommerce_wp_text_input(array(
                    'id'          => '_yprint_manufacturer',
                    'label'       => __('Hersteller', 'yprint'),
                    'placeholder' => '',
                    'desc_tip'    => 'true',
                    'description' => __('Gib den Hersteller des Produkts an.', 'yprint')
                ));

                // Farben
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_colors',
                    'label'       => __('Verfügbare Farben', 'yprint'),
                    'placeholder' => 'z.B. Schwarz, Weiß, Grau',
                    'desc_tip'    => 'true',
                    'description' => __('Liste der verfügbaren Farben.', 'yprint')
                ));

                // Sizing
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_sizing',
                    'label'       => __('Größeninformationen', 'yprint'),
                    'placeholder' => 'Größentabelle oder Hinweise',
                    'desc_tip'    => 'true',
                    'description' => __('Informationen zur Größenauswahl.', 'yprint')
                ));

                // Note
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_note',
                    'label'       => __('Besondere Hinweise', 'yprint'),
                    'placeholder' => 'Wichtige Hinweise zum Produkt',
                    'desc_tip'    => 'true',
                    'description' => __('Besondere Hinweise zum Produkt.', 'yprint')
                ));

                // Details
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_details',
                    'label'       => __('Produktdetails', 'yprint'),
                    'placeholder' => 'Detaillierte Produktinformationen',
                    'desc_tip'    => 'true',
                    'description' => __('Detaillierte Informationen zum Produkt.', 'yprint')
                ));

                // Features
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_features',
                    'label'       => __('Features', 'yprint'),
                    'placeholder' => 'Produktmerkmale',
                    'desc_tip'    => 'true',
                    'description' => __('Besondere Merkmale des Produkts.', 'yprint')
                ));

                // Care Instructions
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_care',
                    'label'       => __('Pflegehinweise', 'yprint'),
                    'placeholder' => 'Waschanleitung, etc.',
                    'desc_tip'    => 'true',
                    'description' => __('Pflegehinweise für das Produkt.', 'yprint')
                ));

                // Customizations
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_customizations',
                    'label'       => __('Anpassungsmöglichkeiten', 'yprint'),
                    'placeholder' => 'Mögliche individuelle Anpassungen',
                    'desc_tip'    => 'true',
                    'description' => __('Anpassungsmöglichkeiten für das Produkt.', 'yprint')
                ));

                // Fabric
                woocommerce_wp_textarea_input(array(
                    'id'          => '_yprint_fabric',
                    'label'       => __('Material/Stoff', 'yprint'),
                    'placeholder' => 'z.B. 100% Bio-Baumwolle',
                    'desc_tip'    => 'true',
                    'description' => __('Informationen zum Material des Produkts.', 'yprint')
                ));
                ?>
            </div>
        </div>
        <?php
    }

    // Speichern der Felder
    add_action('woocommerce_process_product_meta', 'yprint_save_product_fields');
    function yprint_save_product_fields($post_id) {
        $fields = array(
            '_yprint_manufacturer',
            '_yprint_colors',
            '_yprint_sizing',
            '_yprint_note',
            '_yprint_details',
            '_yprint_features',
            '_yprint_care',
            '_yprint_customizations',
            '_yprint_fabric'
        );

        foreach ($fields as $field) {
            if (isset($_POST[$field])) {
                update_post_meta($post_id, $field, sanitize_textarea_field($_POST[$field]));
            }
        }
    }
}
add_action('init', 'yprint_register_product_custom_fields');

// === TEIL 2: EINZELNE SHORTCODES FÜR JEDES FELD ===
function yprint_register_product_shortcodes() {
    
    // Hilfsfunktion zum Holen des aktuellen Produkts
    function yprint_get_current_product() {
        $product_id = isset($_GET['product_id']) ? intval($_GET['product_id']) : 0;
        if (!$product_id) return false;
        
        $product = wc_get_product($product_id);
        return $product;
    }
    
    // Produkt-Titel
    function yprint_product_title_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-title',
            'tag' => 'h1'
        ), $atts);
        
        return '<' . esc_attr($atts['tag']) . ' class="' . esc_attr($atts['class']) . '">' . 
               esc_html($product->get_name()) . 
               '</' . esc_attr($atts['tag']) . '>';
    }
    add_shortcode('yprint_title', 'yprint_product_title_shortcode');
    
    // Produkt-ID
    function yprint_product_id_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-id',
            'label' => 'Produkt-ID:',
        ), $atts);
        
        return '<div class="' . esc_attr($atts['class']) . '">' . 
               esc_html($atts['label']) . ' ' . esc_html($product->get_id()) . 
               '</div>';
    }
    add_shortcode('yprint_id', 'yprint_product_id_shortcode');
    
    // Produkt-Beschreibung
    function yprint_product_description_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-description',
        ), $atts);
        
        return '<div class="' . esc_attr($atts['class']) . '">' . 
               wpautop($product->get_description()) . 
               '</div>';
    }
    add_shortcode('yprint_description', 'yprint_product_description_shortcode');
    
    // Produkt-Bild
    function yprint_product_image_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-image',
            'size' => 'large'
        ), $atts);
        
        return '<div class="' . esc_attr($atts['class']) . '">' . 
               $product->get_image($atts['size']) . 
               '</div>';
    }
    add_shortcode('yprint_image', 'yprint_product_image_shortcode');
    
    // Produkt-Galerie
    function yprint_product_gallery_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-gallery',
            'thumb_class' => 'yprint-gallery-thumb',
            'size' => 'thumbnail'
        ), $atts);
        
        $attachment_ids = $product->get_gallery_image_ids();
        if (empty($attachment_ids)) return '';
        
        $output = '<div class="' . esc_attr($atts['class']) . '">';
        foreach ($attachment_ids as $attachment_id) {
            $output .= '<div class="' . esc_attr($atts['thumb_class']) . '">';
            $output .= wp_get_attachment_image($attachment_id, $atts['size']);
            $output .= '</div>';
        }
        $output .= '</div>';
        
        return $output;
    }
    add_shortcode('yprint_gallery', 'yprint_product_gallery_shortcode');
    
    // Produkt-Preis
    function yprint_product_price_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-product-price',
        ), $atts);
        
        return '<div class="' . esc_attr($atts['class']) . '">' . 
               $product->get_price_html() . 
               '</div>';
    }
    add_shortcode('yprint_price', 'yprint_product_price_shortcode');
    
    // In den Warenkorb Button
    function yprint_add_to_cart_shortcode($atts) {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-add-to-cart-button',
            'text' => 'In den Warenkorb',
        ), $atts);
        
        return '<a href="' . esc_url($product->add_to_cart_url()) . '" class="' . esc_attr($atts['class']) . '">' . 
               esc_html($atts['text']) . 
               '</a>';
    }
    add_shortcode('yprint_add_to_cart', 'yprint_add_to_cart_shortcode');
    
    // Generische Funktion für benutzerdefinierte Felder
    function yprint_custom_field_shortcode($atts, $content = null, $tag = '') {
        $product = yprint_get_current_product();
        if (!$product) return '';
        
        // Feld-Namen aus dem Shortcode-Tag extrahieren
        $field_name = str_replace('yprint_', '_yprint_', $tag);
        
        $field_value = get_post_meta($product->get_id(), $field_name, true);
        if (empty($field_value)) return '';
        
        $atts = shortcode_atts(array(
            'class' => 'yprint-' . str_replace('_yprint_', '', $field_name),
            'label' => '',
            'tag' => 'div',
        ), $atts);
        
        $output = '<' . esc_attr($atts['tag']) . ' class="' . esc_attr($atts['class']) . '">';
        if (!empty($atts['label'])) {
            $output .= '<span class="yprint-field-label">' . esc_html($atts['label']) . '</span> ';
        }
        $output .= wpautop($field_value);
        $output .= '</' . esc_attr($atts['tag']) . '>';
        
        return $output;
    }
    
    // Benutzerdefinierte Felder als Shortcodes registrieren
    $custom_fields = array(
        'manufacturer', 'colors', 'sizing', 'note', 
        'details', 'features', 'care', 'customizations', 'fabric'
    );
    
    foreach ($custom_fields as $field) {
        add_shortcode('yprint_' . $field, 'yprint_custom_field_shortcode');
    }
}
add_action('init', 'yprint_register_product_shortcodes');

// Benutzerdefinierten REST-Endpunkt für Produktdaten erstellen
function yprint_register_product_endpoint() {
    register_rest_route('yprint/v1', '/product/(?P<id>\d+)', array(
        'methods' => 'GET',
        'callback' => 'yprint_get_product_data',
        'permission_callback' => '__return_true', // Öffentlicher Zugriff
    ));
}
add_action('rest_api_init', 'yprint_register_product_endpoint');

// Callback-Funktion für den Endpunkt
function yprint_get_product_data($request) {
    $product_id = $request['id'];
    $product = wc_get_product($product_id);
    
    if (!$product) {
        return new WP_Error('product_not_found', 'Produkt nicht gefunden', array('status' => 404));
    }
    
    $product_data = array(
        'id' => $product->get_id(),
        'name' => $product->get_name(),
        'description' => $product->get_description(),
        'short_description' => $product->get_short_description(),
        'price' => $product->get_price(),
        'regular_price' => $product->get_regular_price(),
        'sale_price' => $product->get_sale_price(),
        'sku' => $product->get_sku(),
        'stock_status' => $product->get_stock_status(),
        'featured_image' => get_the_post_thumbnail_url($product_id, 'full'),
        
        // Benutzerdefinierte Felder hinzufügen
        'manufacturer' => get_post_meta($product_id, '_yprint_manufacturer', true),
        'colors' => get_post_meta($product_id, '_yprint_colors', true),
        'sizing' => get_post_meta($product_id, '_yprint_sizing', true),
        'details' => get_post_meta($product_id, '_yprint_details', true),
        'features' => get_post_meta($product_id, '_yprint_features', true),
        'care' => get_post_meta($product_id, '_yprint_care', true),
        'fabric' => get_post_meta($product_id, '_yprint_fabric', true),
    );
    
    return rest_ensure_response($product_data);
}

// WP API Nonce für Frontend-Zugriff
function yprint_add_api_nonce() {
    wp_enqueue_script('wp-api');
    wp_localize_script('wp-api', 'wpApiSettings', array(
        'root' => esc_url_raw(rest_url()),
        'nonce' => wp_create_nonce('wp_rest')
    ));
}
add_action('wp_enqueue_scripts', 'yprint_add_api_nonce');

// Rest-API-Authentifizierung für öffentliche Produkt-Abfragen
function yprint_allow_public_product_access($permission) {
    $route = $GLOBALS['wp']->query_vars['rest_route'];
    if (strpos($route, '/wc/v3/products') === 0) {
        return true;
    }
    return $permission;
}
add_filter('rest_authentication_errors', 'yprint_allow_public_product_access');

// Fügen Sie diesen Code in Ihrer theme's functions.php hinzu

// Fügen Sie diesen Code in Ihrer theme's functions.php hinzu

function custom_designer_button_shortcode($atts) {
    // Standardwerte für Attribute festlegen
    $atts = shortcode_atts(array(
        'fallback_id' => '', // Fallback-Artikelnummer
        'label' => 'Design' // Anpassbarer Button-Text
    ), $atts);
    
    // Aktuelles Produkt abrufen
    global $product;
    
    // Artikelnummer (SKU) abrufen
    $template_id = $product ? $product->get_sku() : $atts['fallback_id'];
    
    // Wenn keine Artikelnummer vorhanden ist, Fallback-ID verwenden
    if (empty($template_id)) {
        $template_id = $atts['fallback_id'];
    }
    
    // Fallback, falls immer noch keine ID
    if (empty($template_id)) {
        $template_id = '3657'; // Ihre Standardtemplate-ID
    }
    
    // Button-HTML generieren
    $button_html = sprintf(
        '<a href="%s" class="custom-designer-button" style="display: inline-block; background-color: #0079FF; color: white; padding: 5px 20px; text-decoration: none; border-radius: 15px; font-weight: bold; text-align: center; width: 100%%; box-sizing: border-box;">%s</a>',
        esc_url(add_query_arg('template_id', $template_id, 'http://yprint.de/designer')),
        esc_html($atts['label'])
    );
    
    return $button_html;
}
add_shortcode('designer_button', 'custom_designer_button_shortcode');

// -----------------------------------------------------------------------------------------------------------------
/**
 * Akkordeon Shortcode für YPrint Produktdaten
 */

// Shortcode für Produkt-Akkordeon registrieren
function yprint_product_accordion_shortcode() {
    // Produkt-ID aus den URL-Parametern abrufen
    $product_id = isset($_GET['product_id']) ? intval($_GET['product_id']) : 0;
    
    // Wenn keine Produkt-ID in der URL ist, versuche die aktuelle Seiten-ID
    if (!$product_id) {
        $product_id = get_the_ID();
    }
    
    // Produktdaten abrufen mit den korrekten YPrint-Feldern
    $product_data = [
        'note' => get_post_meta($product_id, '_yprint_note', true),
        'details' => get_post_meta($product_id, '_yprint_details', true),
        'features' => get_post_meta($product_id, '_yprint_features', true),
        'care' => get_post_meta($product_id, '_yprint_care', true),
        'customizations' => get_post_meta($product_id, '_yprint_customizations', true),
        'fabric' => get_post_meta($product_id, '_yprint_fabric', true)
    ];
    
    // CSS für das Akkordeon
    $output = '<style>
        .yprint-accordion {
            border-top: 1px solid #e5e5e5;
            margin-bottom: 20px;
            width: 100%;
        }
        .yprint-accordion-item {
            border-bottom: 1px solid #e5e5e5;
        }
        .yprint-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
        }
        .yprint-accordion-header:hover {
            opacity: 0.8;
        }
        .yprint-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 0 0 0;
        }
        .yprint-accordion-content.active {
            max-height: 1000px;
            padding: 0 0 20px 0;
        }
        .yprint-accordion-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }
        .yprint-accordion-icon.active {
            transform: rotate(45deg);
        }
        .yprint-note {
            margin-bottom: 20px;
        }
        .yprint-note p {
            font-style: italic;
            color: #666;
        }
        .error-message {
            color: #777;
            font-style: italic;
        }
    </style>';
    
    // Note-Bereich mit Besonderen Hinweisen
    $output .= '<div class="yprint-note">
        <h2>Note</h2>
        <div>' . (!empty($product_data['note']) ? wpautop($product_data['note']) : '<p class="error-message">Keine besonderen Hinweise verfügbar.</p>') . '</div>
    </div>';
    
    // Akkordeon-Container
    $output .= '<div class="yprint-accordion">';
    
    // Details Bereich
    $output .= '<div class="yprint-accordion-item">
        <div class="yprint-accordion-header">
            <span>Details</span>
            <span class="yprint-accordion-icon">+</span>
        </div>
        <div class="yprint-accordion-content">' . 
            (!empty($product_data['details']) ? wpautop($product_data['details']) : '<p class="error-message">Keine Detailinformationen verfügbar.</p>') . 
        '</div>
    </div>';
    
    // Features Bereich
    $output .= '<div class="yprint-accordion-item">
        <div class="yprint-accordion-header">
            <span>Features</span>
            <span class="yprint-accordion-icon">+</span>
        </div>
        <div class="yprint-accordion-content">' . 
            (!empty($product_data['features']) ? wpautop($product_data['features']) : '<p class="error-message">Keine Features verfügbar.</p>') . 
        '</div>
    </div>';
    
    // Pflegehinweise (Care Instructions)
    $output .= '<div class="yprint-accordion-item">
        <div class="yprint-accordion-header">
            <span>Care Instructions</span>
            <span class="yprint-accordion-icon">+</span>
        </div>
        <div class="yprint-accordion-content">' . 
            (!empty($product_data['care']) ? wpautop($product_data['care']) : '<p class="error-message">Keine Pflegehinweise verfügbar.</p>') . 
        '</div>
    </div>';
    
    // Anpassungsmöglichkeiten (Customizations)
    $output .= '<div class="yprint-accordion-item">
        <div class="yprint-accordion-header">
            <span>Customizations</span>
            <span class="yprint-accordion-icon">+</span>
        </div>
        <div class="yprint-accordion-content">' . 
            (!empty($product_data['customizations']) ? wpautop($product_data['customizations']) : '<p class="error-message">Keine Anpassungsinformationen verfügbar.</p>') . 
        '</div>
    </div>';
    
    // Material/Stoff (Fabric)
    $output .= '<div class="yprint-accordion-item">
        <div class="yprint-accordion-header">
            <span>Fabric</span>
            <span class="yprint-accordion-icon">+</span>
        </div>
        <div class="yprint-accordion-content">' . 
            (!empty($product_data['fabric']) ? wpautop($product_data['fabric']) : '<p class="error-message">Keine Materialinformationen verfügbar.</p>') . 
        '</div>
    </div>';
    
    $output .= '</div>';
    
    // JavaScript für Akkordeon-Funktionalität
    $output .= '<script>
    document.addEventListener("DOMContentLoaded", function() {
        const accordionHeaders = document.querySelectorAll(".yprint-accordion-header");
        
        accordionHeaders.forEach(header => {
            header.addEventListener("click", function() {
                const content = this.nextElementSibling;
                const icon = this.querySelector(".yprint-accordion-icon");
                
                // Toggle active class
                content.classList.toggle("active");
                icon.classList.toggle("active");
                
                // Close other sections
                const allContents = document.querySelectorAll(".yprint-accordion-content");
                const allIcons = document.querySelectorAll(".yprint-accordion-icon");
                
                allContents.forEach(item => {
                    if (item !== content && item.classList.contains("active")) {
                        item.classList.remove("active");
                    }
                });
                
                allIcons.forEach(item => {
                    if (item !== icon && item.classList.contains("active")) {
                        item.classList.remove("active");
                    }
                });
            });
        });
    });
    </script>';
    
    return $output;
}
add_shortcode('yprint_product_accordion', 'yprint_product_accordion_shortcode');
// -----------------------------------------------------------------------------------------------------------------

/**
 * Scroll-Effekt für Container mit Sticky-Verhalten und Fade-in-Down Effekt
 * Füge diesen Code in deine functions.php ein
 */

// CSS und JavaScript für den Scroll-Effekt hinzufügen
function ypnt_sticky_scroll_effect() {
    // CSS für den Scroll-Effekt
    $css_scroll_effect = '
    .header-container {
        /* Normale Position bis zum Scrollen */
        position: relative;
        z-index: 1000;
        background-color: transparent;
        border: none;
        border-radius: 30px;
    }

    /* Grundstil für sticky */
    .header-container.sticky {
        position: fixed;
        top: 100px;
        border-radius: 30px;
        background-color: transparent;
        border: none;
    }
    
    /* Platzhalter, um Sprünge im Layout zu vermeiden */
    .sticky-placeholder {
        display: none;
    }
    
    .sticky-placeholder.active {
        display: block;
    }
    
    /* Mobile Ausnahme - kein Sticky-Verhalten unter 768px */
    @media (max-width: 768px) {
        .header-container.sticky {
            position: relative;
            top: auto;
        }
        
        .sticky-placeholder {
            display: none !important;
        }
    }';

    // JavaScript für den Scroll-Effekt
    $script_scroll_effect = '
    document.addEventListener("DOMContentLoaded", function() {
        const headerContainer = document.querySelector(".header-container");
        
        if (!headerContainer) {
            return;
        }
        
        // Platzhalter-Element erstellen
        const placeholder = document.createElement("div");
        placeholder.className = "sticky-placeholder";
        headerContainer.parentNode.insertBefore(placeholder, headerContainer);
        
        // Container-Position und Größe speichern
        const headerRect = headerContainer.getBoundingClientRect();
        const headerOffsetTop = headerRect.top + window.scrollY;
        const headerHeight = headerRect.height;
        const headerWidth = headerRect.width;
        const headerLeft = headerRect.left;
        
        // Platzhalter-Größe anpassen
        placeholder.style.height = headerHeight + "px";
        placeholder.style.width = headerWidth + "px";
        
        window.addEventListener("scroll", function() {
            // Prüfen, ob der Container jetzt sticky werden sollte
            const shouldBeSticky = window.scrollY > headerOffsetTop;
            
            if (shouldBeSticky) {
                // Container sticky machen
                headerContainer.classList.add("sticky");
                placeholder.classList.add("active");
                
                // Größe und Position beibehalten
                headerContainer.style.width = headerWidth + "px";
                headerContainer.style.left = headerLeft + "px";
            } else {
                // Sticky-Status aufheben
                headerContainer.classList.remove("sticky");
                placeholder.classList.remove("active");
                
                // Zurücksetzen der Stile
                headerContainer.style.width = "";
                headerContainer.style.left = "";
            }
        });
        
        // Bei Fenstergröße-Änderung die Position und Größe aktualisieren
        window.addEventListener("resize", function() {
            if (headerContainer.classList.contains("sticky")) {
                const newHeaderRect = placeholder.getBoundingClientRect();
                headerContainer.style.width = newHeaderRect.width + "px";
                headerContainer.style.left = newHeaderRect.left + "px";
            }
        });
        
        // Beim Laden der Seite überprüfen
        window.dispatchEvent(new Event("scroll"));
    });';

    // CSS registrieren und einfügen
    wp_register_style('ypnt-sticky-scroll-style', false);
    wp_enqueue_style('ypnt-sticky-scroll-style');
    wp_add_inline_style('ypnt-sticky-scroll-style', $css_scroll_effect);
    
    // JavaScript registrieren und einfügen
    wp_register_script('ypnt-sticky-scroll-script', '', array('jquery'), null, true);
    wp_enqueue_script('ypnt-sticky-scroll-script');
    wp_add_inline_script('ypnt-sticky-scroll-script', $script_scroll_effect);
}

// Hook für das Einfügen der Skripte
add_action('wp_enqueue_scripts', 'ypnt_sticky_scroll_effect');

// -----------------------------------------------------------------------------------------------------------------
/**
 * YPrint Produkt-Weiterleitungs-Funktion
 * Macht Container mit der CSS-Klasse "yprint-product-XXXX" klickbar und
 * leitet zum entsprechenden Produkt weiter.
 */

// JavaScript für DOM-Manipulation und Event-Handling hinzufügen
function yprint_product_redirect_script() {
    ?>
    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Alle Elemente mit Klassen, die mit "yprint-product-" beginnen, finden
        var productElements = document.querySelectorAll('[class*="yprint-product-"]');
        
        productElements.forEach(function(element) {
            // Die Klassen des Elements durchsuchen
            var classes = element.className.split(' ');
            var productId = null;
            
            // Die yprint-product-XXXX Klasse finden und die ID extrahieren
            classes.forEach(function(className) {
                if (className.startsWith('yprint-product-')) {
                    productId = className.replace('yprint-product-', '');
                }
            });
            
            if (productId) {
                // Element klickbar machen
                element.style.cursor = 'pointer';
                
                // Optionale visuelle Hinweise hinzufügen
                element.title = 'Zum Produkt gehen';
                
                // Klick-Event hinzufügen
                element.addEventListener('click', function() {
                    window.location.href = 'https://yprint.de/products/?product_id=' + productId;
                });
            }
        });
    });
    </script>
    <?php
}

// Script im Frontend einbinden
add_action('wp_footer', 'yprint_product_redirect_script');

/**
 * Shortcode, um einen klickbaren Container für ein bestimmtes Produkt zu erstellen
 * Verwendung: [yprint_product id="3799"]Inhalt[/yprint_product]
 */
function yprint_product_shortcode($atts, $content = null) {
    $atts = shortcode_atts(
        array(
            'id' => ''
        ),
        $atts,
        'yprint_product'
    );
    
    $product_id = $atts['id'];
    
    if (empty($product_id)) {
        return $content;
    }
    
    return '<div class="yprint-product-container yprint-product-' . esc_attr($product_id) . '">' . $content . '</div>';
}
add_shortcode('yprint_product', 'yprint_product_shortcode');

// -----------------------------------------------------------------------------------------------------------------

/**
 * Shortcode für einen modernen Produktgallerie-Slider mit vertikalen Thumbnails
 * [yp_gallery_slider]
 */
function yp_gallery_slider_shortcode() {
    ob_start();
    
    // URL-Parameter für die Produkt-ID auslesen
    $product_id = isset($_GET['product_id']) ? intval($_GET['product_id']) : 0;
    
    // Produktdaten und Bilder abrufen
    $gallery_images = array();
    $default_image = 'https://yprint.de/wp-content/uploads/2025/03/front.webp';
    
    if ($product_id > 0) {
        $product = wc_get_product($product_id);
        
        if ($product) {
            // Hauptbild abrufen
            $main_image_id = $product->get_image_id();
            if ($main_image_id) {
                $main_image_url = wp_get_attachment_image_url($main_image_id, 'full');
                if ($main_image_url) {
                    $default_image = $main_image_url;
                    $gallery_images[] = $main_image_url;
                }
            }
            
            // Galerie-Bilder abrufen
            $gallery_ids = $product->get_gallery_image_ids();
            if (!empty($gallery_ids)) {
                foreach ($gallery_ids as $gallery_id) {
                    $gallery_image_url = wp_get_attachment_image_url($gallery_id, 'full');
                    if ($gallery_image_url) {
                        $gallery_images[] = $gallery_image_url;
                    }
                }
            }
        }
    }
    
    // Wenn keine Bilder gefunden wurden, verwenden wir das Standard-Bild
    if (empty($gallery_images)) {
        $gallery_images[] = $default_image;
    }
    
    // Bilder als JSON für JavaScript vorbereiten
    $gallery_images_json = json_encode($gallery_images);
    
    // CSS für den Slider
    ?>
    <style>
        .yprint-gallery-container {
    max-width: 100%;
    margin: 0 auto 30px auto;
    position: relative;
    display: flex;
    flex-direction: row;
    gap: 10px;
}

@media (max-width: 768px) {
    .yprint-gallery-container {
        background-color: white;
        border-radius: 30px;
        border: 1px solid #e0e0e0;
        padding: 15px;
        box-sizing: border-box;
    }
}
        
        .yprint-gallery-slider {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #e0e0e0;
            border: 1px solid #DFDFDF;
        }
        
        .yprint-gallery-slides {
            display: flex;
            transition: transform 0.3s ease;
        }
        
        .yprint-gallery-slide {
            min-width: 100%;
            box-sizing: border-box;
            background: #F6F7FA;
        }
        
        .yprint-gallery-slide img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .yprint-gallery-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 80px;
        }
        
        .yprint-gallery-thumbnail {
            width: 80px;
            height: 80px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            border: 1px solid #DFDFDF;
            overflow: hidden;
            background: #e0e0e0;
        }
        
        .yprint-gallery-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .yprint-gallery-thumbnail.active {
            opacity: 1;
            border: 2px solid #707070;
        }
        
        @media (max-width: 768px) {
            .yprint-gallery-container {
                flex-direction: column;
            }
            
            .yprint-gallery-nav {
                flex-direction: row;
                width: 100%;
                justify-content: center;
            }
            
            .yprint-gallery-thumbnail {
                width: 60px;
                height: 60px;
            }
        }
    </style>
    
    <div class="yprint-gallery-container">
        <div class="yprint-gallery-slider">
            <div class="yprint-gallery-slides" id="yprintGallerySlides">
                <?php foreach ($gallery_images as $index => $image_url): ?>
                <div class="yprint-gallery-slide">
                    <img src="<?php echo esc_url($image_url); ?>" alt="Produktbild <?php echo $index + 1; ?>">
                </div>
                <?php endforeach; ?>
            </div>
        </div>
        <div class="yprint-gallery-nav" id="yprintGalleryNav">
            <?php foreach ($gallery_images as $index => $image_url): ?>
            <div class="yprint-gallery-thumbnail <?php echo $index === 0 ? 'active' : ''; ?>">
                <img src="<?php echo esc_url($image_url); ?>" alt="Thumbnail <?php echo $index + 1; ?>">
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const slidesContainer = document.getElementById('yprintGallerySlides');
        const thumbnails = document.querySelectorAll('.yprint-gallery-thumbnail');
        
        let currentSlide = 0;
        const galleryImages = <?php echo $gallery_images_json; ?>;
        
        function showSlide(index) {
            currentSlide = index;
            slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            // Aktiven Thumbnail markieren
            thumbnails.forEach((thumb, idx) => {
                thumb.classList.toggle('active', idx === currentSlide);
            });
        }
        
        // Event-Listener für Thumbnails hinzufügen
        thumbnails.forEach((thumb, index) => {
            thumb.addEventListener('click', () => {
                showSlide(index);
            });
        });
        
        // Tastaturnavigation hinzufügen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                currentSlide = (currentSlide - 1 + galleryImages.length) % galleryImages.length;
                showSlide(currentSlide);
            } else if (e.key === 'ArrowRight') {
                currentSlide = (currentSlide + 1) % galleryImages.length;
                showSlide(currentSlide);
            }
        });
        
        // Initiale Anzeige
        showSlide(0);
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yp_gallery_slider', 'yp_gallery_slider_shortcode');

// -----------------------------------------------------------------------------------------------------------------

/**
 * YPrint Custom Checkout System - Teil 1: Hauptshortcode
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Hauptshortcode für das gesamte Checkout-Layout
 */
function yprint_checkout_shortcode() {
    if (!function_exists('WC')) {
        return '<div class="yprint-error-message">WooCommerce ist nicht aktiviert.</div>';
    }

   // Überprüfen, ob Warenkorb leer ist
$cart_empty = WC()->cart->is_empty();

    // Checkout-Kommunikationssystem einbinden
    ob_start();
    echo do_shortcode('[yprint_checkout_communication]');
    
    ?>
    <div class="yprint-checkout-container">
        <div class="yprint-back-button-container">
            <a href="javascript:history.back()" class="yprint-back-button">← Zurück</a>
        </div>
        <div class="yprint-checkout-columns">

            <!-- Linke Spalte: Adressen und Zahlungsoptionen -->
            <div class="yprint-checkout-left">
                <div class="yprint-checkout-section">
                    <h2 class="yprint-section-title">Lieferadresse</h2>
                    <?php echo do_shortcode('[yprint_shipping_address]'); ?>
                </div>

                <div class="yprint-checkout-section">
                    <h2 class="yprint-section-title">Zahlungsmethode</h2>
                    <?php echo do_shortcode('[yprint_payment_options]'); ?>
                </div>
            </div>

            <!-- Rechte Spalte: Bestellübersicht und Checkout-Button -->
            <div class="yprint-checkout-right">
                <div class="yprint-checkout-section yprint-order-summary-section">
                    <?php echo do_shortcode('[yprint_order_summary]'); ?>
                </div>

                <div class="yprint-checkout-section">
                    <?php echo do_shortcode('[yprint_coupon_buy]'); ?>
                </div>
                
                <div class="yprint-checkout-section">
                    <?php echo do_shortcode('[yprint_different_billing]'); ?>
                </div>

                <!-- Datenschutz-Checkbox -->
                <div class="yprint-checkout-section yprint-privacy-section">
                    <div class="yprint-checkbox-group">
                        <input type="checkbox" id="privacy_checkbox" name="privacy_checkbox" required>
                        <label for="privacy_checkbox">Ich habe die <a href="https://yprint.de/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und akzeptiere diese.</label>
                    </div>
                    <div id="privacy_error" class="yprint-field-error" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <?php
    
    // Checkout-CSS und JavaScript einbinden
    yprint_checkout_scripts_and_styles();
    
    return ob_get_clean();
}
add_shortcode('yprint_checkout', 'yprint_checkout_shortcode');

/**
 * CSS und JavaScript für den Checkout
 */
function yprint_checkout_scripts_and_styles() {
    ?>
    <style>
    .yprint-checkout-container {
        font-family: 'Roboto', -apple-system, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        justify-content: center;
    }

    .yprint-checkout-columns {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .yprint-checkout-left {
        flex: 1 1 50%;
        min-width: 300px;
    }

    .yprint-checkout-right {
        flex: 1 1 45%;
        min-width: 300px;
    }

    .yprint-checkout-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .yprint-section-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1d1d1f;
    }

    .yprint-checkbox-group {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .yprint-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 3px;
    }

    .yprint-checkbox-group label {
        font-size: 14px;
        line-height: 1.4;
        color: #1d1d1f;
    }

    .yprint-checkbox-group a {
        color: #0079FF;
        text-decoration: none;
    }

    .yprint-checkbox-group a:hover {
        text-decoration: underline;
    }

    .yprint-field-error {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .yprint-empty-cart-message, 
    .yprint-error-message {
        text-align: center;
        padding: 50px 20px;
        font-size: 18px;
    }

    .yprint-empty-cart-message a {
        color: #0079FF;
        text-decoration: none;
    }

    .yprint-validation-feedback {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        display: none;
    }

    .yprint-validation-feedback.error {
        background-color: #fff2f2;
        border: 1px solid #ffcdd2;
        color: #d32f2f;
    }

    .yprint-validation-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
    }

    .yprint-validation-item::before {
        content: "•";
        color: #d32f2f;
    }

    .yprint-back-button-container {
    margin-bottom: 20px;
}

.yprint-back-button {
    display: inline-flex;
    align-items: center;
    color: #0079FF;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s ease;
}

.yprint-back-button:hover {
    color: #0068e1;
}

    @media (max-width: 768px) {
        .yprint-checkout-columns {
            flex-direction: column;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        // Datenschutz-Validierung
        $(document).on('click', '#yprint_checkout_submit', function(e) {
            // Datenschutz-Checkbox prüfen
            if (!$('#privacy_checkbox').is(':checked')) {
                e.preventDefault();
                $('#privacy_error').text('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.').show();
                
                $('html, body').animate({
                    scrollTop: $('.yprint-privacy-section').offset().top - 100
                }, 500);
                
                return false;
            } else {
                $('#privacy_error').hide();
            }
        });
        
        // Fehlermeldung bei Änderung der Checkbox entfernen
        $('#privacy_checkbox').on('change', function() {
            if ($(this).is(':checked')) {
                $('#privacy_error').hide();
            }
        });
    });
    </script>
    <?php
}

/**
 * YPrint Checkout Communication System
 * 
 * System für die Datenkoordination zwischen den Shortcodes im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Checkout-Kommunikationssystem Shortcode
 */
function yprint_checkout_communication_shortcode() {
    ob_start();
    ?>
    <script>
    // YPrint Checkout Communication System
    const YPrintCheckoutSystem = {
        // Zentraler Datenspeicher
        state: {
            shippingAddress: {},
            billingAddress: {},
            differentBilling: { enabled: false },
            differentBillingAddress: {},
            paymentMethod: {},
            couponCode: {}
        },

        // Initialisierung
        init: function() {
            this.initializeState();
            this.setupEventListeners();
        },

        // Initialen State aus WooCommerce laden
        initializeState: function() {
            const user_id = '<?php echo get_current_user_id(); ?>';
            
            // AJAX-Aufruf um initiale Daten zu laden
            jQuery.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_get_checkout_state',
                    user_id: user_id,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: (response) => {
                    if (response.success) {
                        // Stellen sicher, dass different_billing immer als deaktiviert geladen wird
                        const data = {...response.data};
                        if (data.differentBilling) {
                            data.differentBilling.enabled = false;
                        }
                        this.state = {...this.state, ...data};
                        this.updateAllFields();
                        this.notifyStateChange();
                    }
                }
            });
        },

        // Event Listener Setup
        setupEventListeners: function() {
            const $ = jQuery;
            
            // Shipping Address Events
            $(document).on('change', '.yprint-shipping-field', (e) => {
                const field = e.target.name.replace('shipping_', '');
                const value = e.target.value;
                this.updateState('shippingAddress', {
                    [field]: value
                });
            });

            // Different Billing Events
            $(document).on('change', '#different_billing', (e) => {
                this.updateState('differentBilling', {
                    enabled: e.target.checked
                });
            });

            // Different Billing Address Events
            $(document).on('change', '.yprint-billing-field', (e) => {
                const field = e.target.name;
                const value = e.target.value;
                this.updateState('differentBillingAddress', {
                    [field]: value
                });
            });

            // Payment Method Events
            $(document).on('change', '[name="payment_method"]', (e) => {
                this.updateState('paymentMethod', {
                    method: e.target.value,
                    timestamp: Date.now()
                });
            });

            // Coupon Events
            $(document).on('change', '#coupon_code', (e) => {
                this.updateState('couponCode', {
                    code: e.target.value
                });
            });
        },

        // State Updates
        updateState: function(section, data) {
            if (!this.state[section]) {
                this.state[section] = {};
            }
            
            // Aktualisiere den jeweiligen Abschnitt im State
            this.state[section] = {
                ...this.state[section],
                ...data
            };
            
            this.saveState();
            this.notifyStateChange();
        },

        // Speichern des States
        saveState: function() {
            jQuery.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_checkout_state',
                    state: this.state,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: (response) => {
                    if (response.success) {
                        console.log('State saved successfully');
                    }
                }
            });
        },

        // Benachrichtigung über State-Änderungen
        notifyStateChange: function() {
            jQuery(document).trigger('checkoutStateUpdate', [this.state]);
        },

        // Formularvalidierung
        validateForm: function() {
            let isValid = true;
            const errors = [];
            
            // Validiere Lieferadresse
            if (!this.state.shippingAddress || !this.state.shippingAddress.address_1) {
                isValid = false;
                errors.push('Bitte gib eine Lieferadresse an');
            }
            
            // Validiere Zahlungsmethode
            if (!this.state.paymentMethod || !this.state.paymentMethod.method) {
                isValid = false;
                errors.push('Bitte wähle eine Zahlungsmethode aus');
            }

            // Validiere abweichende Rechnungsadresse falls aktiviert
            if (this.state.differentBilling && this.state.differentBilling.enabled) {
                if (!this.state.differentBillingAddress || !this.state.differentBillingAddress.different_billing_address_1) {
                    isValid = false;
                    errors.push('Bitte gib eine abweichende Rechnungsadresse an');
                }
            }
            
            return {
                isValid: isValid,
                errors: errors
            };
        },

        // State abrufen
        getState: function() {
            return this.state;
        },

        // Formulardaten sammeln
        getFormData: function() {
            return {
                shipping_address: this.state.shippingAddress,
                billing_address: this.state.billingAddress,
                different_billing: this.state.differentBilling ? this.state.differentBilling.enabled : false,
                different_billing_address: this.state.differentBillingAddress,
                payment_method: this.state.paymentMethod ? this.state.paymentMethod.method : '',
                coupon_code: this.state.couponCode ? this.state.couponCode.code : ''
            };
        },

        // Alle Felder aktualisieren
        updateAllFields: function() {
            const $ = jQuery;
            
            // Shipping Address Felder
            if (this.state.shippingAddress) {
                Object.entries(this.state.shippingAddress).forEach(([field, value]) => {
                    if (field !== 'slot' && field !== 'address' && field !== 'field') {
                        $(`[name="shipping_${field}"]`).val(value);
                    }
                });
            }

            // Different Billing Checkbox
            if (this.state.differentBilling && this.state.differentBilling.enabled !== undefined) {
                $('#different_billing').prop('checked', this.state.differentBilling.enabled);
                
                // Zeige/verstecke abweichende Adressfelder
                if (this.state.differentBilling.enabled) {
                    $('#different_billing_fields').show();
                } else {
                    $('#different_billing_fields').hide();
                }
            }

            // Different Billing Address Felder
            if (this.state.differentBillingAddress) {
                Object.entries(this.state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }

            // Payment Method
            if (this.state.paymentMethod && this.state.paymentMethod.method) {
                const paymentMethod = this.state.paymentMethod.method;
                $(`[name="payment_method"][value="${paymentMethod}"]`)
                    .prop('checked', true)
                    .closest('.yprint-payment-option')
                    .addClass('selected');
            }

            // Coupon Code
            if (this.state.couponCode && this.state.couponCode.code) {
                $('#coupon_code').val(this.state.couponCode.code);
            }
        },

        // Checkout-Prozess starten
        processCheckout: function() {
        const $ = jQuery;
        const checkoutData = this.getFormData();
        
        // Überprüfen, ob Privatsphäre-Checkbox aktiviert ist
        if (!$('#privacy_checkbox').is(':checked')) {
            $('#privacy_error').text('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.').show();
            
            $('html, body').animate({
                scrollTop: $('.yprint-privacy-section').offset().top - 100
            }, 500);
            
            return;
        }

        // Validierung vor dem Absenden
        const validation = this.validateForm();
        if (!validation.isValid) {
            // Fehler anzeigen
            $('.yprint-validation-feedback')
                .empty()
                .addClass('error');
                
            validation.errors.forEach(error => {
                $('.yprint-validation-feedback').append(
                    $('<div class="yprint-validation-item"></div>').text(error)
                );
            });
            
            $('.yprint-validation-feedback').show();
            
            $('html, body').animate({
                scrollTop: $('.yprint-validation-feedback').offset().top - 100
            }, 500);
            
            return;
        }

        // Loading-State aktivieren
        $('#yprint_checkout_submit').addClass('loading');
        $('.yprint-validation-feedback').hide();
        
        // Debug-Ausgabe der Daten
        console.log('Checkout data being sent:', checkoutData);
        
        // Zahlungsmethode überprüfen für Validierung
        const paymentMethod = checkoutData.payment_method;
        
        // Erst temporäre Bestellung vorbereiten, aber noch nicht finalisieren
        $.ajax({
            type: 'POST',
            url: '<?php echo admin_url("admin-ajax.php"); ?>',
            data: {
                action: 'yprint_prepare_order',
                checkout_data: checkoutData,
                security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
            },
            success: (prepareResponse) => {
                if (prepareResponse.success) {
                    console.log('Order vorbereitet:', prepareResponse.data);
                    
                    // Temporäre Bestellungs-ID speichern
                    const tempOrderId = prepareResponse.data.temp_order_id;
                    
                    // Jetzt Zahlungsprozess beginnen
                    this.processPayment(paymentMethod, checkoutData, tempOrderId, function(paymentResult) {
                        if (paymentResult.success) {
                            // Zahlungsverarbeitung erfolgreich, Bestellung finalisieren
                            $.ajax({
                                type: 'POST',
                                url: '<?php echo admin_url("admin-ajax.php"); ?>',
                                data: {
                                    action: 'yprint_finalize_order',
                                    temp_order_id: tempOrderId,
                                    payment_id: paymentResult.payment_id,
                                    payment_method: paymentMethod,
                                    security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
                                },
                                success: function(response) {
                                    console.log('Finalize response:', response);
                                    
                                    if (response.success) {
                                        // Weiterleitung zur Thank You Seite
                                        window.location.href = response.data.redirect;
                                    } else {
                                        // Fehleranzeige
                                        $('.yprint-validation-feedback')
                                            .empty()
                                            .addClass('error')
                                            .append($('<div class="yprint-validation-item"></div>')
                                            .text(response.data.message || 'Ein Fehler ist aufgetreten beim Finalisieren der Bestellung.'))
                                            .show();
                                        
                                        $('#yprint_checkout_submit').removeClass('loading');
                                        
                                        $('html, body').animate({
                                            scrollTop: $('.yprint-validation-feedback').offset().top - 100
                                        }, 500);
                                    }
                                },
                                error: function(xhr, status, error) {
                                    console.error('AJAX-Fehler:', xhr.responseText, status, error);
                                    
                                    // Fehlerdetails anzeigen wenn vorhanden
                                    let errorMessage = 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.';
                                    try {
                                        const response = JSON.parse(xhr.responseText);
                                        if (response && response.data && response.data.message) {
                                            errorMessage = response.data.message;
                                        }
                                    } catch (e) {
                                        console.error('Fehler beim Parsen der Antwort:', e);
                                    }
                                    
                                    // Allgemeiner Fehler
                                    $('.yprint-validation-feedback')
                                        .empty()
                                        .addClass('error')
                                        .append($('<div class="yprint-validation-item"></div>')
                                        .text(errorMessage))
                                        .show();
                                    
                                    $('#yprint_checkout_submit').removeClass('loading');
                                }
                            });
                        } else {
                            // Zahlungsverifizierung fehlgeschlagen
                            $('.yprint-validation-feedback')
                                .empty()
                                .addClass('error')
                                .append($('<div class="yprint-validation-item"></div>')
                                .text(paymentResult.message || 'Die Zahlung konnte nicht bestätigt werden. Bitte versuchen Sie es erneut oder wählen Sie eine andere Zahlungsmethode.'))
                                .show();
                            
                            $('#yprint_checkout_submit').removeClass('loading');
                            
                            $('html, body').animate({
                                scrollTop: $('.yprint-validation-feedback').offset().top - 100
                            }, 500);
                        }
                    });
                } else {
                    // Fehler bei der Vorbereitung der Bestellung
                    $('.yprint-validation-feedback')
                        .empty()
                        .addClass('error')
                        .append($('<div class="yprint-validation-item"></div>')
                        .text(prepareResponse.data.message || 'Fehler bei der Vorbereitung der Bestellung.'))
                        .show();
                    
                    $('#yprint_checkout_submit').removeClass('loading');
                    
                    $('html, body').animate({
                        scrollTop: $('.yprint-validation-feedback').offset().top - 100
                    }, 500);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX-Fehler:', xhr.responseText, status, error);
                
                // Allgemeiner Fehler
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text('Ein Fehler ist aufgetreten bei der Vorbereitung der Bestellung.'))
                    .show();
                
                $('#yprint_checkout_submit').removeClass('loading');
            }
        });
    },

    // Zahlungsvalidierung
    validatePayment: function(paymentMethod, checkoutData, callback) {
        const $ = jQuery;
        
        // Je nach Zahlungsart verschiedene Validierungen durchführen
        if (paymentMethod.includes('paypal')) {
            // PayPal Validierung mit API
            this.validatePayPalPayment(checkoutData, callback);
        } else if (paymentMethod.includes('stripe') || paymentMethod.includes('apple_pay') || paymentMethod.includes('google_pay') || paymentMethod.includes('credit')) {
            // Stripe Validierung mit API
            this.validateStripePayment(checkoutData, callback);
        } else if (paymentMethod.includes('sepa') || paymentMethod.includes('lastschrift')) {
            // SEPA/Lastschrift Validierung
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_validate_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data.validated) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                },
                error: function() {
                    callback(false);
                }
            });
        } else if (paymentMethod.includes('bacs') || paymentMethod.includes('bank')) {
            // Überweisung benötigt keine Echtzeit-Validierung
            callback(true);
        } else {
            // Standardvalidierung für andere Zahlungsmethoden
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_validate_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success && response.data.validated) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                },
                error: function() {
                    callback(false);
                }
            });
        }
    },
    
    // Zahlungsverarbeitung - neue Methode
    processPayment: function(paymentMethod, checkoutData, tempOrderId, callback) {
        const $ = jQuery;
        
        // Je nach Zahlungsart verschiedene Verarbeitungen durchführen
        if (paymentMethod.includes('paypal')) {
            // PayPal Verarbeitung
            this.processPayPalPayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('stripe') || paymentMethod.includes('apple_pay') || paymentMethod.includes('google_pay') || paymentMethod.includes('credit')) {
            // Stripe Verarbeitung
            this.processStripePayment(checkoutData, tempOrderId, callback);
        } else if (paymentMethod.includes('sepa') || paymentMethod.includes('lastschrift')) {
            // SEPA/Lastschrift Verarbeitung
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url("admin-ajax.php"); ?>',
                data: {
                    action: 'yprint_process_sepa_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        callback({
                            success: true,
                            payment_id: response.data.payment_id || 'sepa_direct'
                        });
                    } else {
                        callback({
                            success: false,
                            message: response.data.message || 'SEPA-Zahlung konnte nicht verarbeitet werden.'
                        });
                    }
                },
                error: function() {
                    callback({
                        success: false,
                        message: 'Fehler bei der SEPA-Zahlungsverarbeitung.'
                    });
                }
            });
        } else if (paymentMethod.includes('bacs') || paymentMethod.includes('bank')) {
            // Überweisung benötigt keine direkte Verarbeitung
            callback({
                success: true,
                payment_id: 'bank_transfer_' + Date.now()
            });
        } else {
            // Standardverarbeitung für andere Zahlungsmethoden
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url("admin-ajax.php"); ?>',
                data: {
                    action: 'yprint_process_standard_payment',
                    payment_method: paymentMethod,
                    checkout_data: checkoutData,
                    temp_order_id: tempOrderId,
                    security: '<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        callback({
                            success: true,
                            payment_id: response.data.payment_id || 'standard_' + Date.now()
                        });
                    } else {
                        callback({
                            success: false,
                            message: response.data.message || 'Zahlung konnte nicht verarbeitet werden.'
                        });
                    }
                },
                error: function() {
                    callback({
                        success: false,
                        message: 'Fehler bei der Zahlungsverarbeitung.'
                    });
                }
            });
        }
    },
    
    // PayPal Zahlungsvalidierung (für alte Funktionalität, wird nicht mehr direkt genutzt)
validatePayPalPayment: function(checkoutData, callback) {
    callback(true); // Nur für Abwärtskompatibilität
},

// PayPal Zahlungsverarbeitung - neue Methode
processPayPalPayment: function(checkoutData, tempOrderId, callback) {
    const $ = jQuery;
    
    // PayPal-Session initialisieren
    $.ajax({
        type: 'POST',
        url: '<?php echo admin_url('admin-ajax.php'); ?>',
        data: {
            action: 'yprint_init_paypal_payment',
            checkout_data: checkoutData,
            temp_order_id: tempOrderId,
            security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
        },
        success: function(response) {
            if (response.success && response.data.paypal_order_id) {
                // PayPal-Zahlung initiiert, jetzt PayPal-Modal öffnen
                const paypalOrderId = response.data.paypal_order_id;
                
                // PayPal Modal öffnen mit zugewiesener Order ID
                paypal.Buttons({
                    fundingSource: paypal.FUNDING.PAYPAL,
                    createOrder: function() {
                        return paypalOrderId; // Wir geben die bereits erstellte Order ID zurück
                    },
                    onApprove: function(data, actions) {
                        // Zahlung wurde von Benutzer genehmigt, abschließen
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('success')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('PayPal-Zahlung wird verarbeitet...'))
                            .show();
                            
                        // Zahlung bestätigen
                        $.ajax({
                            type: 'POST',
                            url: '<?php echo admin_url('admin-ajax.php'); ?>',
                            data: {
                                action: 'yprint_capture_checkout_paypal_payment',
                                paypal_order_id: paypalOrderId,
                                temp_order_id: tempOrderId,
                                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                            },
                            success: function(captureResponse) {
                                if (captureResponse.success) {
                                    // PayPal-Modal schließen
                                    $('#yprint-paypal-modal').hide();
                                    
                                    callback({
                                        success: true,
                                        payment_id: captureResponse.data.transaction_id || paypalOrderId
                                    });
                                } else {
                                    $('.yprint-validation-feedback')
                                        .empty()
                                        .addClass('error')
                                        .append($('<div class="yprint-validation-item"></div>')
                                        .text(captureResponse.data.message || 'Fehler bei der PayPal-Zahlung'))
                                        .show();
                                        
                                    callback({
                                        success: false,
                                        message: captureResponse.data.message || 'Fehler bei der PayPal-Zahlung'
                                    });
                                }
                            },
                            error: function() {
                                $('.yprint-validation-feedback')
                                    .empty()
                                    .addClass('error')
                                    .append($('<div class="yprint-validation-item"></div>')
                                    .text('Fehler bei der PayPal-Zahlungsverarbeitung'))
                                    .show();
                                    
                                callback({
                                    success: false,
                                    message: 'Fehler bei der PayPal-Zahlungsverarbeitung'
                                });
                            }
                        });
                    },
                    onCancel: function() {
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('error')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('PayPal-Zahlung wurde abgebrochen'))
                            .show();
                            
                        callback({
                            success: false,
                            message: 'PayPal-Zahlung wurde abgebrochen'
                        });
                    },
                    onError: function(err) {
                        $('.yprint-validation-feedback')
                            .empty()
                            .addClass('error')
                            .append($('<div class="yprint-validation-item"></div>')
                            .text('Fehler bei der PayPal-Zahlung: ' + err))
                            .show();
                            
                        callback({
                            success: false,
                            message: 'Fehler bei der PayPal-Zahlung: ' + err
                        });
                    }
                }).render('#paypal-button-container');
                
                // PayPal-Modal anzeigen
                $('#yprint-paypal-modal').show();
            } else {
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text(response.data.message || 'Fehler bei der Initialisierung der PayPal-Zahlung'))
                    .show();
                    
                callback({
                    success: false,
                    message: response.data.message || 'Fehler bei der Initialisierung der PayPal-Zahlung'
                });
            }
        },
        error: function() {
            $('.yprint-validation-feedback')
                .empty()
                .addClass('error')
                .append($('<div class="yprint-validation-item"></div>')
                .text('Fehler bei der Verbindung mit dem Zahlungsserver'))
                .show();
                
            callback({
                success: false,
                message: 'Fehler bei der Verbindung mit dem Zahlungsserver'
            });
        }
    });
},
    
    // Stripe Zahlungsvalidierung (für alte Funktionalität, wird nicht mehr direkt genutzt)
    validateStripePayment: function(checkoutData, callback) {
        callback(true); // Nur für Abwärtskompatibilität
    },
    
    // Stripe Zahlungsverarbeitung - neue Methode
     // Stripe Zahlungsverarbeitung - neue Methode
    processStripePayment: function(checkoutData, tempOrderId, callback) {
        const $ = jQuery;
        
        // Stripe-Session initialisieren
        $.ajax({
            type: 'POST',
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            data: {
                action: 'yprint_init_stripe_payment',
                checkout_data: checkoutData,
                temp_order_id: tempOrderId,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                if (response.success && response.data.client_secret) {
                    // Stripe Session initialisiert
                    const clientSecret = response.data.client_secret;
                    const paymentIntentId = response.data.payment_intent_id;
                    
                    // Stripe Elements anzeigen
                    $('#yprint-stripe-modal').show();
                    
                    // Stripe Elements initialisieren, falls noch nicht geschehen
                    if (!window.stripeElements) {
                        const stripe = Stripe('<?php echo get_option('yprint_stripe_public_key', 'pk_live_51QomI4Efl8wKMoZvo59c44NsSuDkXqUtgvqg5qpTU5D7JmJf5XGfM8wNli25KpAAhrbPf2O0gjXNg3hWCtxpyG9G00Dxkv5oxL'); ?>');
                        const elements = stripe.elements({
                            clientSecret: clientSecret,
                            appearance: {
                                theme: 'stripe',
                                variables: {
                                    colorPrimary: '#0079FF',
                                    colorBackground: '#ffffff',
                                    colorText: '#1d1d1f',
                                    colorDanger: '#dc3545',
                                    fontFamily: 'Roboto, sans-serif',
                                    borderRadius: '4px'
                                }
                            }
                        });
                        
                        // Payment Element erstellen und mounten
                        const paymentElement = elements.create('payment');
                        paymentElement.mount('#yprint-stripe-payment-element');
                        
                        // Stripe-Formular abschicken
                        document.getElementById('yprint-stripe-payment-form').addEventListener('submit', function(event) {
                            event.preventDefault();
                            
                            // Bestätigen-Button deaktivieren und Ladeanimation anzeigen
                            $('#yprint-stripe-submit').prop('disabled', true).addClass('loading');
                            
                            stripe.confirmPayment({
                                elements,
                                confirmParams: {
                                    return_url: '<?php echo home_url('/stripe-return'); ?>',
                                },
                                redirect: 'if_required'
                            }).then(function(result) {
                                if (result.error) {
                                    // Fehler anzeigen
                                    $('.yprint-stripe-error-message').text(result.error.message).show();
                                    $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                    
                                    callback({
                                        success: false,
                                        message: result.error.message
                                    });
                                } else {
                                    // Zahlung erfolgreich, Bestellung bestätigen
                                    $.ajax({
                                        type: 'POST',
                                        url: '<?php echo admin_url('admin-ajax.php'); ?>',
                                        data: {
                                            action: 'yprint_confirm_stripe_payment',
                                            payment_intent: result.paymentIntent.id,
                                            temp_order_id: tempOrderId,
                                            security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                                        },
                                        success: function(confirmResponse) {
                                            if (confirmResponse.success) {
                                                $('#yprint-stripe-modal').hide();
                                                
                                                callback({
                                                    success: true,
                                                    payment_id: result.paymentIntent.id
                                                });
                                            } else {
                                                $('.yprint-stripe-error-message').text(confirmResponse.data.message || 'Fehler bei der Zahlungsbestätigung').show();
                                                $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                                
                                                callback({
                                                    success: false,
                                                    message: confirmResponse.data.message || 'Fehler bei der Zahlungsbestätigung'
                                                });
                                            }
                                        },
                                        error: function() {
                                            $('.yprint-stripe-error-message').text('Verbindungsfehler bei der Zahlungsbestätigung').show();
                                            $('#yprint-stripe-submit').prop('disabled', false).removeClass('loading');
                                            
                                            callback({
                                                success: false,
                                                message: 'Verbindungsfehler bei der Zahlungsbestätigung'
                                            });
                                        }
                                    });
                                }
                            });
                        });
                        
                        // Schließen-Button
                        $('#yprint-stripe-modal-close').on('click', function() {
                            $('#yprint-stripe-modal').hide();
                            
                            callback({
                                success: false,
                                message: 'Zahlungsvorgang abgebrochen'
                            });
                        });
                        
                        // Speichern für späteren Zugriff
                        window.stripeElements = {
                            stripe: stripe,
                            elements: elements
                        };
                    } else {
                        // Elements bereits initialisiert, aktualisieren
                        window.stripeElements.elements.update({
                            clientSecret: clientSecret
                        });
                    }
                } else {
                    $('.yprint-validation-feedback')
                        .empty()
                        .addClass('error')
                        .append($('<div class="yprint-validation-item"></div>')
                        .text(response.data.message || 'Fehler bei der Initialisierung der Stripe-Zahlung'))
                        .show();
                        
                    callback({
                        success: false,
                        message: response.data.message || 'Fehler bei der Initialisierung der Stripe-Zahlung'
                    });
                }
            },
            error: function() {
                $('.yprint-validation-feedback')
                    .empty()
                    .addClass('error')
                    .append($('<div class="yprint-validation-item"></div>')
                    .text('Fehler bei der Verbindung mit dem Zahlungsserver'))
                    .show();
                    
                callback({
                    success: false,
                    message: 'Fehler bei der Verbindung mit dem Zahlungsserver'
                });
            }
        });
    }

    // System initialisieren
    jQuery(document).ready(function() {
        YPrintCheckoutSystem.init();
    });
    </script>
    
    <!-- Validierungsfeedback Element -->
    <div class="yprint-validation-feedback" style="display: none;"></div>
    
    <!-- PayPal Modal -->
    <div id="yprint-paypal-modal" class="yprint-payment-modal" style="display: none;">
        <div class="yprint-modal-content">
            <div class="yprint-modal-header">
                <h3>PayPal Zahlung</h3>
                <span class="yprint-modal-close" id="yprint-paypal-modal-close">&times;</span>
            </div>
            <div class="yprint-modal-body">
                <p>Bitte schließen Sie Ihre Zahlung mit PayPal ab:</p>
                <div id="paypal-button-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Stripe Modal -->
    <div id="yprint-stripe-modal" class="yprint-payment-modal" style="display: none;">
        <div class="yprint-modal-content">
            <div class="yprint-modal-header">
                <h3>Kreditkartenzahlung</h3>
                <span class="yprint-modal-close" id="yprint-stripe-modal-close">&times;</span>
            </div>
            <div class="yprint-modal-body">
                <form id="yprint-stripe-payment-form">
                    <div id="yprint-stripe-payment-element"></div>
                    <div class="yprint-stripe-error-message" style="display: none;"></div>
                    <button id="yprint-stripe-submit" type="submit">
                        <span class="yprint-button-text">Zahlung bestätigen</span>
                        <div class="yprint-button-loader" style="display: none;">
                            <div class="yprint-loader-spinner"></div>
                        </div>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-payment-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto;
    }
    
    .yprint-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 0;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    
    .yprint-modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .yprint-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #1d1d1f;
    }
    
    .yprint-modal-close {
        color: #aaa;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .yprint-modal-close:hover {
        color: #555;
    }
    
    .yprint-modal-body {
        padding: 20px;
    }
    
    #yprint-stripe-payment-form {
        width: 100%;
    }
    
    #yprint-stripe-payment-element {
        margin-bottom: 20px;
    }
    
    .yprint-stripe-error-message {
        color: #dc3545;
        margin-bottom: 15px;
        padding: 8px 12px;
        background-color: #f8d7da;
        border-radius: 4px;
    }
    
    #yprint-stripe-submit {
        width: 100%;
        padding: 12px;
        background-color: #0079FF;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
    }
    
    #yprint-stripe-submit:hover {
        background-color: #0068e1;
    }
    
    #yprint-stripe-submit:disabled {
        background-color: #a0a0a0;
        cursor: not-allowed;
    }
    
    #yprint-stripe-submit.loading .yprint-button-text {
        visibility: hidden;
    }
    
    #yprint-stripe-submit.loading .yprint-button-loader {
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    #paypal-button-container {
        width: 100%;
        min-height: 60px;
        margin-top: 20px;
    }
    </style>
    
    <!-- PayPal SDK einbinden -->
    <script src="https://www.paypal.com/sdk/js?client-id=<?php echo get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB'); ?>&currency=EUR&intent=capture"></script>
    
    <!-- Stripe JS einbinden -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
    jQuery(document).ready(function($) {
        // PayPal Modal schließen
        $('#yprint-paypal-modal-close').on('click', function() {
            $('#yprint-paypal-modal').hide();
        });
        
        // Schließen bei Klick außerhalb des Modals
        $(window).on('click', function(event) {
            if ($(event.target).hasClass('yprint-payment-modal')) {
                $('.yprint-payment-modal').hide();
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_checkout_communication', 'yprint_checkout_communication_shortcode');

/**
 * YPrint Checkout AJAX-Handler
 * 
 * Handler für AJAX-Anfragen des Checkout-Systems
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * AJAX-Handler für initiale Checkout-Daten
 */
function yprint_get_checkout_state() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = isset($_POST['user_id']) ? intval($_POST['user_id']) : 0;
    
    if (function_exists('WC')) {
        // Kundendaten abrufen
        if ($user_id) {
            $customer = new WC_Customer($user_id);
            
            // Shipping Address
            $shipping = array(
                'first_name' => $customer->get_shipping_first_name(),
                'last_name' => $customer->get_shipping_last_name(),
                'address_1' => $customer->get_shipping_address_1(),
                'address_2' => $customer->get_shipping_address_2(),
                'postcode' => $customer->get_shipping_postcode(),
                'city' => $customer->get_shipping_city(),
                'country' => $customer->get_shipping_country() ?: 'DE'
            );
            
            // Billing Address
            $billing = array(
                'first_name' => $customer->get_billing_first_name(),
                'last_name' => $customer->get_billing_last_name(),
                'email' => $customer->get_billing_email(),
                'address_1' => $customer->get_billing_address_1(),
                'address_2' => $customer->get_billing_address_2(),
                'postcode' => $customer->get_billing_postcode(),
                'city' => $customer->get_billing_city(),
                'country' => $customer->get_billing_country() ?: 'DE'
            );
            
            // State zusammenbauen
            $state = array(
                'shippingAddress' => $shipping,
                'billingAddress' => $billing,
                'differentBilling' => array(
                    'enabled' => get_user_meta($user_id, 'different_billing_enabled', true) ?: false
                ),
                'paymentMethod' => array(
                    'method' => WC()->session ? WC()->session->get('chosen_payment_method') : ''
                ),
                'couponCode' => array(
                    'code' => ''
                )
            );
        } else {
            // Fallback für nicht eingeloggte Benutzer
            $state = array(
                'shippingAddress' => array('country' => 'DE'),
                'billingAddress' => array('country' => 'DE'),
                'differentBilling' => array('enabled' => false),
                'paymentMethod' => array('method' => ''),
                'couponCode' => array('code' => '')
            );
        }
        
        // Session-Daten überschreiben falls vorhanden
        if (WC()->session) {
            $session_state = WC()->session->get('yprint_checkout_state');
            if ($session_state) {
                $state = wp_parse_args($session_state, $state);
            }
        }
        
        wp_send_json_success($state);
    } else {
        wp_send_json_error('WooCommerce ist nicht aktiviert');
    }
}
add_action('wp_ajax_yprint_get_checkout_state', 'yprint_get_checkout_state');
add_action('wp_ajax_nopriv_yprint_get_checkout_state', 'yprint_get_checkout_state');

/**
 * AJAX-Handler für State-Speicherung
 */
function yprint_save_checkout_state() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (isset($_POST['state'])) {
        $state = $_POST['state'];
        $user_id = get_current_user_id();
        
        // State in user_meta speichern falls Benutzer eingeloggt ist
        if ($user_id) {
            update_user_meta($user_id, 'yprint_checkout_state', $state);
        }
        
        // State in WooCommerce Session speichern
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_checkout_state', $state);
        }
        
        wp_send_json_success();
    } else {
        wp_send_json_error('Keine Daten zum Speichern vorhanden');
    }
}
add_action('wp_ajax_yprint_save_checkout_state', 'yprint_save_checkout_state');
add_action('wp_ajax_nopriv_yprint_save_checkout_state', 'yprint_save_checkout_state');

/**
 * AJAX-Handler für Checkout-Prozess
 */
function yprint_process_checkout() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $payment_verified = isset($_POST['payment_verified']) && $_POST['payment_verified'] === 'true';
    
    // Validierung der Daten
    $errors = array();
    
    // Lieferadresse prüfen
    if (empty($checkout_data['shipping_address']) || empty($checkout_data['shipping_address']['address_1'])) {
        $errors[] = 'Bitte gib eine Lieferadresse an';
    }
    
    // Zahlungsmethode prüfen
    if (empty($checkout_data['payment_method'])) {
        $errors[] = 'Bitte wähle eine Zahlungsmethode aus';
    }
    
    // Abweichende Rechnungsadresse prüfen wenn aktiviert
$different_billing_enabled = isset($checkout_data['different_billing']) && 
($checkout_data['different_billing'] === true || 
 $checkout_data['different_billing'] === 'true' || 
 $checkout_data['different_billing'] === 1 || 
 $checkout_data['different_billing'] === '1');

error_log('Different billing value: ' . print_r($checkout_data['different_billing'], true));
error_log('Different billing enabled: ' . ($different_billing_enabled ? 'true' : 'false'));

if ($different_billing_enabled) {
$has_different_billing_address = !empty($checkout_data['different_billing_address']) && 
        !empty($checkout_data['different_billing_address']['different_billing_address_1']);
        
if (!$has_different_billing_address) {
$errors[] = 'Bitte gib eine abweichende Rechnungsadresse an';
}
}
    
    // Bei Fehlern abbrechen
    if (!empty($errors)) {
        wp_send_json_error(array(
            'message' => implode(', ', $errors)
        ));
        return;
    }

    try {
        // Daten in WooCommerce Session speichern
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_checkout_data', $checkout_data);
            
            // Zahlungsmethode in WooCommerce Session speichern
            if (!empty($checkout_data['payment_method'])) {
                WC()->session->set('chosen_payment_method', $checkout_data['payment_method']);
            }
            
            // Gutscheincode anwenden falls vorhanden
            if (!empty($checkout_data['coupon_code'])) {
                $coupon_code = sanitize_text_field($checkout_data['coupon_code']);
                if (!WC()->cart->has_discount($coupon_code)) {
                    WC()->cart->apply_coupon($coupon_code);
                }
            }
            
            // Kundendaten speichern, wenn angemeldet
            $user_id = get_current_user_id();
            if ($user_id > 0 && !empty($checkout_data['shipping_address'])) {
                foreach ($checkout_data['shipping_address'] as $key => $value) {
                    if ($key !== 'slot' && $key !== 'timestamp') {
                        update_user_meta($user_id, 'shipping_' . $key, sanitize_text_field($value));
                    }
                }
            }
            
            // Bestellung erstellen
$order_id = create_woocommerce_order($checkout_data);

if ($order_id) {
    // Zahlungsstatus speichern
    update_post_meta($order_id, '_payment_verified', $payment_verified);

    // Zahlungsart speichern
    if (!empty($checkout_data['payment_method'])) {
        update_post_meta($order_id, '_payment_method', sanitize_text_field($checkout_data['payment_method']));
    }
    
    // Zur individuellen Thank You Page weiterleiten
    $redirect_url = 'https://yprint.de/thank-you/';
    
    // Warenkorb leeren
    WC()->cart->empty_cart();
    
    wp_send_json_success(array(
        'redirect' => $redirect_url
    ));
} else {
    wp_send_json_error(array(
        'message' => 'Die Bestellung konnte nicht erstellt werden.'
    ));
}

        } else {
            throw new Exception('WooCommerce Session ist nicht verfügbar');
        }
    } catch (Exception $e) {
        error_log('YPrint Checkout Error: ' . $e->getMessage());
        wp_send_json_error(array(
            'message' => 'Ein technischer Fehler ist aufgetreten: ' . $e->getMessage()
        ));
    }
}

add_action('wp_ajax_yprint_process_checkout', 'yprint_process_checkout');
add_action('wp_ajax_nopriv_yprint_process_checkout', 'yprint_process_checkout');

/**
 * AJAX-Handler für Zahlungsvalidierung (allgemein)
 */
function yprint_validate_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_method']) || empty($_POST['payment_method'])) {
        wp_send_json_error(array(
            'message' => 'Keine Zahlungsmethode angegeben'
        ));
        return;
    }
    
    $payment_method = sanitize_text_field($_POST['payment_method']);
    $checkout_data = isset($_POST['checkout_data']) ? $_POST['checkout_data'] : array();
    
    // Zahlungsabwicklung je nach Zahlungsmethode (für Methoden ohne API-Integration)
    if (strpos($payment_method, 'sepa') !== false || strpos($payment_method, 'lastschrift') !== false) {
        // SEPA/Lastschrift Validierung - hier würde die echte Integration erfolgen
        $validated = true; // Für Testzwecke
    } else {
        // Standard-Validierung für andere Zahlungsmethoden
        $validated = true; // Für Testzwecke
    }
    
    if ($validated) {
        wp_send_json_success(array(
            'validated' => true,
            'message' => 'Zahlung erfolgreich validiert'
        ));
    } else {
        wp_send_json_error(array(
            'validated' => false,
            'message' => 'Zahlung konnte nicht validiert werden'
        ));
    }
}
add_action('wp_ajax_yprint_validate_payment', 'yprint_validate_payment');
add_action('wp_ajax_nopriv_yprint_validate_payment', 'yprint_validate_payment');

/**
 * AJAX-Handler zur Initialisierung einer PayPal-Zahlung
 */
function yprint_init_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    
    try {
        // Temporäre Bestellung erstellen
        $temp_order_id = yprint_create_temp_order($checkout_data);
        
        if (!$temp_order_id) {
            throw new Exception('Fehler beim Erstellen der temporären Bestellung');
        }
        
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // WooCommerce Order abrufen
        $order = wc_get_order($temp_order_id);
        
        // Order-Daten für PayPal vorbereiten
        $request = new \PayPalCheckoutSdk\Orders\OrdersCreateRequest();
        $request->prefer('return=representation');
        
        // Währung abrufen
        $currency = get_woocommerce_currency();
        $request->body = [
            'intent' => 'CAPTURE',
            'purchase_units' => [
                [
                    'reference_id' => $temp_order_id,
                    'description' => 'Bestellung bei YPrint',
                    'amount' => [
                        'currency_code' => $currency,
                        'value' => number_format($order->get_total(), 2, '.', ''),
                        'breakdown' => [
                            'item_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_subtotal(), 2, '.', '')
                            ],
                            'shipping' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_shipping_total(), 2, '.', '')
                            ],
                            'tax_total' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_total_tax(), 2, '.', '')
                            ],
                            'discount' => [
                                'currency_code' => $currency,
                                'value' => number_format($order->get_discount_total(), 2, '.', '')
                            ]
                        ]
                    ]
                ]
            ],
            'application_context' => [
                'brand_name' => 'YPrint',
                'user_action' => 'PAY_NOW',
                'return_url' => home_url('/paypal-return'),
                'cancel_url' => home_url('/checkout')
            ]
        ];
        
        // PayPal Order erstellen
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201) {
            // Order ID in Meta speichern
            update_post_meta($temp_order_id, '_paypal_order_id', $response->result->id);
            
            wp_send_json_success(array(
                'paypal_order_id' => $response->result->id,
                'temp_order_id' => $temp_order_id
            ));
        } else {
            throw new Exception('Fehler bei der Kommunikation mit PayPal');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der PayPal-Initialisierung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_init_paypal_payment', 'yprint_init_paypal_payment');
add_action('wp_ajax_nopriv_yprint_init_paypal_payment', 'yprint_init_paypal_payment');

/**
 * AJAX-Handler zur Erfassung einer PayPal-Zahlung
 */
function yprint_capture_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // Zahlung erfassen
        $request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201 || $response->statusCode === 200) {
            // Bestellstatus aktualisieren
            $order = wc_get_order($temp_order_id);
            
            if ($order) {
                // Bestellstatus auf "processing" setzen
                $order->update_status('processing', 'Zahlung mit PayPal erfolgreich erhalten.');
                
                // PayPal-Transaktions-ID speichern
                if (isset($response->result->purchase_units[0]->payments->captures[0]->id)) {
                    $transaction_id = $response->result->purchase_units[0]->payments->captures[0]->id;
                    $order->set_transaction_id($transaction_id);
                    $order->add_order_note("PayPal Transaktion ID: " . $transaction_id);
                }
                
                $order->save();
                
                // Warenkorb leeren
                WC()->cart->empty_cart();
                
                wp_send_json_success(array(
                    'message' => 'Zahlung erfolgreich erfasst',
                    'order_id' => $temp_order_id,
                    'redirect' => $order->get_checkout_order_received_url()
                ));
            } else {
                throw new Exception('Bestellung konnte nicht gefunden werden');
            }
        } else {
            throw new Exception('Fehler bei der Zahlungserfassung');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Capture Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungserfassung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_capture_paypal_payment', 'yprint_capture_paypal_payment');
add_action('wp_ajax_nopriv_yprint_capture_paypal_payment', 'yprint_capture_paypal_payment');

// Die yprint_init_stripe_payment-Funktion wurde entfernt und in eine überarbeitete Version
// an einer anderen Stelle im Code zusammengeführt, um doppelte Funktionsdeklarationen zu vermeiden.
// Die AJAX-Handler bleiben erhalten und verweisen nun auf die konsolidierte Funktion.
add_action('wp_ajax_yprint_init_stripe_payment', 'yprint_init_stripe_payment');
add_action('wp_ajax_nopriv_yprint_init_stripe_payment', 'yprint_init_stripe_payment');

/**
 * AJAX-Handler zur Bestätigung einer Stripe-Zahlung
 */
function yprint_confirm_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_intent']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $payment_intent_id = sanitize_text_field($_POST['payment_intent']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Payment Intent Status prüfen
        $response = \WC_Stripe_API::retrieve('payment_intents/' . $payment_intent_id);
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        // Prüfen, ob Payment Intent zum Order passt
        $stored_payment_intent = get_post_meta($temp_order_id, '_stripe_payment_intent', true);
        
        if ($stored_payment_intent !== $payment_intent_id) {
            throw new Exception('Payment Intent stimmt nicht mit Bestellung überein');
        }
        
        // Prüfen, ob Zahlung erfolgreich war
        if ($response->status !== 'succeeded') {
            throw new Exception('Zahlung wurde nicht erfolgreich abgeschlossen (Status: ' . $response->status . ')');
        }
        
        // Charge ID extrahieren
        $charge_id = isset($response->charges->data[0]->id) ? $response->charges->data[0]->id : $payment_intent_id;
        
        // Status und Charge ID in Order Meta speichern
        update_post_meta($temp_order_id, '_stripe_payment_status', 'COMPLETED');
        update_post_meta($temp_order_id, '_stripe_charge_id', $charge_id);
        
        // Bestellstatus aktualisieren
        $order = wc_get_order($temp_order_id);
        
        if ($order) {
            // Bestellstatus auf "processing" setzen
            $order->update_status('processing', 'Zahlung mit Stripe erfolgreich erhalten.');
            
            // Stripe-Transaktions-ID speichern
            $order->set_transaction_id($charge_id);
            $order->add_order_note("Stripe Zahlung erfolgreich (ID: " . $charge_id . ")");
            
            $order->save();
            
            // Warenkorb leeren
            WC()->cart->empty_cart();
            
            wp_send_json_success(array(
                'message' => 'Zahlung erfolgreich bestätigt',
                'order_id' => $temp_order_id,
                'charge_id' => $charge_id,
                'redirect' => $order->get_checkout_order_received_url()
            ));
        } else {
            // Hier nur ein Erfolg mit Charge-ID zurückgeben, 
            // für den Fall dass die Bestellung später finalisiert wird
            wp_send_json_success(array(
                'message' => 'Zahlung erfolgreich bestätigt',
                'charge_id' => $charge_id
            ));
        }
    } catch (Exception $e) {
        error_log('YPrint Stripe Confirm Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungsbestätigung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_confirm_stripe_payment', 'yprint_confirm_stripe_payment');
add_action('wp_ajax_nopriv_yprint_confirm_stripe_payment', 'yprint_confirm_stripe_payment');

/**
 * Hilfsfunktion: Temporäre WooCommerce-Bestellung erstellen
 */
 

/**
 * Hilfsfunktion: Zahlungsmethoden-Titel abrufen
 */
function yprint_get_payment_method_title($payment_method) {
    $payment_gateways = WC()->payment_gateways()->payment_gateways();
    
    if (isset($payment_gateways[$payment_method])) {
        return $payment_gateways[$payment_method]->get_title();
    }
    
    // Fallback-Titel
    if (strpos($payment_method, 'paypal') !== false) {
        return 'PayPal';
    } elseif (strpos($payment_method, 'stripe') !== false) {
        return 'Kreditkarte (Stripe)';
    } elseif (strpos($payment_method, 'credit') !== false) {
        return 'Kreditkarte';
    } elseif (strpos($payment_method, 'bacs') !== false) {
        return 'Überweisung';
    } elseif (strpos($payment_method, 'sepa') !== false) {
        return 'SEPA-Lastschrift';
    }
    
    return 'Unbekannte Zahlungsmethode';
}

/**
 * AJAX-Handler für Zahlungsmethoden-Updates
 */
function yprint_update_payment_method() {
    if (!isset($_POST['payment_method'])) {
        wp_send_json_error('Keine Zahlungsmethode angegeben');
        return;
    }

    $payment_method = sanitize_text_field($_POST['payment_method']);
    
    // WooCommerce Session aktualisieren
    if (function_exists('WC') && WC()->session) {
        WC()->session->set('chosen_payment_method', $payment_method);
    }
    
    wp_send_json_success();
}
add_action('wp_ajax_yprint_update_payment_method', 'yprint_update_payment_method');
add_action('wp_ajax_nopriv_yprint_update_payment_method', 'yprint_update_payment_method');

/**
 * YPrint Shipping Address Shortcode
 * 
 * Shortcode für die Lieferadresse im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für die Lieferadresse
 */
function yprint_shipping_address_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    $user_id = get_current_user_id();
    
    // Primäre Adresse abrufen
    $customer = new WC_Customer($user_id);
    $primary_address = [
        'first_name' => $customer->get_shipping_first_name(),
        'last_name' => $customer->get_shipping_last_name(),
        'address_1' => $customer->get_shipping_address_1(),
        'address_2' => $customer->get_shipping_address_2(),
        'postcode' => $customer->get_shipping_postcode(),
        'city' => $customer->get_shipping_city(),
        'country' => $customer->get_shipping_country()
    ];

    // Zusätzliche Adressen abrufen
    $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: [];
    
    // Aktuelle ausgewählte Adresse
    $current_slot = WC()->session ? WC()->session->get('yprint_selected_shipping_slot') : 'primary';
    if (!$current_slot) {
        $current_slot = 'primary';
    }

    ob_start();
    ?>
    <div class="yprint-shipping-address">
        <div class="yprint-address-selector">
            <h3>Lieferadresse auswählen</h3>
            <div class="yprint-address-slots">
                <!-- Primäre Adresse -->
                <div class="yprint-address-slot <?php echo ($current_slot === 'primary') ? 'active' : ''; ?>" 
                     data-slot="primary">
                    <span class="yprint-slot-title">Meine Lieferanschrift</span>
                    <?php if (!empty($primary_address['address_1'])): ?>
                    <span class="yprint-slot-preview">
                        <?php echo esc_html($primary_address['address_1'] . ', ' . $primary_address['postcode'] . ' ' . $primary_address['city']); ?>
                    </span>
                    <?php endif; ?>
                </div>

                <!-- Zusätzliche Adressen -->
                <?php foreach ($secondary_addresses as $index => $address): ?>
                    <div class="yprint-address-slot <?php echo ($current_slot === 'secondary_' . $index) ? 'active' : ''; ?>" 
                         data-slot="secondary_<?php echo $index; ?>">
                        <span class="yprint-slot-title">Lieferanschrift <?php echo ($index + 2); ?></span>
                        <?php if (!empty($address['address_1'])): ?>
                        <span class="yprint-slot-preview">
                            <?php echo esc_html($address['address_1'] . ', ' . $address['postcode'] . ' ' . $address['city']); ?>
                        </span>
                        <?php endif; ?>
                    </div>
                <?php endforeach; ?>

                <!-- Neue Adresse Button -->
                <?php if (count($secondary_addresses) < 2): ?>
                    <div class="yprint-address-slot yprint-new-slot" data-slot="new">
                        <span class="yprint-slot-title">+ Neue Lieferanschrift</span>
                    </div>
                <?php endif; ?>
            </div>
        </div>

        <div class="yprint-form-section">
            <input type="hidden" name="current_address_slot" id="current_address_slot" value="<?php echo esc_attr($current_slot); ?>">
            
            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_first_name" 
                       class="yprint-shipping-field"
                       placeholder="Vorname"
                       required>
                
                <input type="text" 
                       name="shipping_last_name" 
                       class="yprint-shipping-field"
                       placeholder="Name"
                       required>
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_address_1" 
                       class="yprint-shipping-field"
                       placeholder="Straße"
                       required>
                
                <input type="text" 
                       name="shipping_address_2" 
                       class="yprint-shipping-field"
                       placeholder="Hausnummer"
                       required>
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="shipping_postcode" 
                       class="yprint-shipping-field"
                       placeholder="PLZ"
                       required>
                
                <input type="text" 
                       name="shipping_city" 
                       class="yprint-shipping-field"
                       placeholder="Ort"
                       required>
            </div>

            <div class="yprint-form-row">
                <select name="shipping_country" class="yprint-shipping-field" required>
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_shipping_countries();
                    $default_country = $primary_address['country'] ?: $countries_obj->get_base_country();
                    
                    foreach ($countries as $code => $name) {
                        echo '<option value="' . esc_attr($code) . '" ' . 
                             selected($default_country, $code, false) . '>' . 
                             esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-shipping-address {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-address-selector {
        margin-bottom: 30px;
    }

    .yprint-address-selector h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
    }

    .yprint-address-slots {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .yprint-address-slot {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #333;
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
    }

    .yprint-slot-title {
        font-weight: 500;
        margin-bottom: 5px;
    }

    .yprint-slot-preview {
        font-size: 0.9em;
        color: #666;
    }

    .yprint-address-slot:hover {
        border-color: #2997FF;
        color: #2997FF;
    }

    .yprint-address-slot.active {
        border-color: #2997FF;
        background: #f0f6ff;
    }

    .yprint-new-slot {
        border-style: dashed;
        color: #2997FF;
        justify-content: center;
        align-items: center;
    }

    .yprint-form-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .yprint-form-row {
        display: flex;
        gap: 15px;
    }

    .yprint-form-row input,
    .yprint-form-row select {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1rem;
        background-color: #FFF;
        transition: all 0.3s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .yprint-form-row select {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px;
        cursor: pointer;
    }

    .yprint-form-row input:focus,
    .yprint-form-row select:focus {
        border-color: #2997FF;
        box-shadow: 0 0 0 2px rgba(41, 151, 255, 0.1);
        outline: none;
    }

    .yprint-form-row input:hover,
    .yprint-form-row select:hover {
        border-color: #aaa;
    }

    .yprint-form-row select::-ms-expand {
        display: none;
    }

    .yprint-form-row input.error {
        border-color: #dc3545;
    }

    @media (max-width: 600px) {
        .yprint-form-row {
            flex-direction: column;
        }
        
        .yprint-settings-content {
            padding: 15px 0;
        }

        .yprint-address-slot {
            min-width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const primaryAddress = <?php echo json_encode($primary_address); ?>;
        const secondaryAddresses = <?php echo json_encode($secondary_addresses); ?>;
        let currentSlot = '<?php echo esc_js($current_slot); ?>';

        // Adressdaten laden
        function loadAddressData(slot) {
            let addressData;
            
            if (slot === 'primary') {
                addressData = primaryAddress;
            } else if (slot === 'new') {
                $('.yprint-shipping-field').val('');
                return;
            } else {
                const index = slot.replace('secondary_', '');
                addressData = secondaryAddresses[index] || {};
            }

            // Felder füllen
            Object.entries(addressData).forEach(([key, value]) => {
                $(`[name="shipping_${key}"]`).val(value);
            });

            // YPrintCheckoutSystem aktualisieren
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('shippingAddress', {
                    slot: slot,
                    ...addressData
                });
            }
        }
        // Initiale Adresse laden
        loadAddressData(currentSlot);

        // Adress-Slot Auswahl
        $('.yprint-address-slot').click(function() {
            const slot = $(this).data('slot');
            
            $('.yprint-address-slot').removeClass('active');
            $(this).addClass('active');
            
            currentSlot = slot;
            $('#current_address_slot').val(slot);
            
            loadAddressData(slot);

            // Session aktualisieren
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_update_shipping_slot',
                    slot: slot,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        });

        // Feldänderungen
        $('.yprint-shipping-field').on('change input', function() {
            const field = $(this).attr('name').replace('shipping_', '');
            const value = $(this).val();

            // YPrintCheckoutSystem aktualisieren
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('shippingAddress', {
                    [field]: value
                });
            }

            // Automatisches Speichern
            saveAddress();
        });

        // Adresse speichern
        function saveAddress() {
            const addressData = {};
            $('.yprint-shipping-field').each(function() {
                const field = $(this).attr('name').replace('shipping_', '');
                addressData[field] = $(this).val();
            });

            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_shipping_address',
                    slot: currentSlot,
                    address: addressData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        // Adressvorschau aktualisieren
                        updateAddressPreview(currentSlot, addressData);
                    }
                }
            });
        }

        // Adressvorschau aktualisieren
        function updateAddressPreview(slot, address) {
            const $slot = $(`.yprint-address-slot[data-slot="${slot}"]`);
            const preview = `${address.address_1}, ${address.postcode} ${address.city}`;
            
            let $preview = $slot.find('.yprint-slot-preview');
            if (!$preview.length) {
                $preview = $('<span class="yprint-slot-preview"></span>').appendTo($slot);
            }
            $preview.text(preview);
        }

        // Auf State-Updates reagieren
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state.shippingAddress && state.shippingAddress.slot === currentSlot) {
                const address = state.shippingAddress;
                if (address) {
                    Object.entries(address).forEach(([field, value]) => {
                        if (field !== 'slot' && field !== 'timestamp') {
                            $(`[name="shipping_${field}"]`).val(value);
                        }
                    });
                }
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_shipping_address', 'yprint_shipping_address_shortcode');

// AJAX Handler für Slot-Updates
function yprint_update_shipping_slot() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (isset($_POST['slot'])) {
        $slot = sanitize_text_field($_POST['slot']);
        
        if (function_exists('WC') && WC()->session) {
            WC()->session->set('yprint_selected_shipping_slot', $slot);
        }
        
        wp_send_json_success();
    }
    
    wp_send_json_error('Kein Slot angegeben');
}
add_action('wp_ajax_yprint_update_shipping_slot', 'yprint_update_shipping_slot');
add_action('wp_ajax_nopriv_yprint_update_shipping_slot', 'yprint_update_shipping_slot');

// AJAX Handler für Adress-Speicherung
function yprint_save_shipping_address() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $slot = isset($_POST['slot']) ? sanitize_text_field($_POST['slot']) : '';
    $address = isset($_POST['address']) ? $_POST['address'] : array();

    if (empty($slot) || empty($address)) {
        wp_send_json_error('Ungültige Daten');
        return;
    }

    if ($slot === 'primary') {
        // Primäre Adresse aktualisieren
        foreach ($address as $key => $value) {
            update_user_meta($user_id, "shipping_{$key}", sanitize_text_field($value));
        }
    } else if (strpos($slot, 'secondary_') === 0) {
        // Zusätzliche Adresse speichern
        $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: array();
        $index = intval(str_replace('secondary_', '', $slot));
        $secondary_addresses[$index] = array_map('sanitize_text_field', $address);
        update_user_meta($user_id, 'yprint_additional_shipping_addresses', $secondary_addresses);
    } else if ($slot === 'new') {
        // Neue Adresse erstellen
        $secondary_addresses = get_user_meta($user_id, 'yprint_additional_shipping_addresses', true) ?: array();
        $secondary_addresses[] = array_map('sanitize_text_field', $address);
        update_user_meta($user_id, 'yprint_additional_shipping_addresses', $secondary_addresses);
    }

    wp_send_json_success();
}
add_action('wp_ajax_yprint_save_shipping_address', 'yprint_save_shipping_address');
add_action('wp_ajax_nopriv_yprint_save_shipping_address', 'yprint_save_shipping_address');

/**
 * YPrint Payment Options Shortcode
 * 
 * Shortcode für die Zahlungsmethoden im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

function yprint_payment_options_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    $available_gateways = WC()->payment_gateways()->get_available_payment_gateways();
    $chosen_payment_method = WC()->session ? WC()->session->get('chosen_payment_method') : '';

    ob_start();
    ?>
    <div class="yprint-payment-options">
        <div class="yprint-payment-grid">
            <?php if (!empty($available_gateways)) : ?>
                <?php foreach ($available_gateways as $gateway) : ?>
                    <div class="yprint-payment-option <?php echo ($chosen_payment_method == $gateway->id) ? 'selected' : ''; ?>" data-payment-id="<?php echo $gateway->id; ?>">
                        <input 
                            type="radio" 
                            id="payment_method_<?php echo $gateway->id; ?>" 
                            name="payment_method" 
                            value="<?php echo $gateway->id; ?>"
                            <?php checked($chosen_payment_method, $gateway->id); ?>
                            class="yprint-hidden-radio"
                            required
                        >
                        <label for="payment_method_<?php echo $gateway->id; ?>" class="yprint-payment-label">
                            <?php
                            $icon_class = '';
                            if (strpos($gateway->id, 'paypal') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-paypal';
                            } elseif (strpos($gateway->id, 'stripe') !== false || strpos($gateway->id, 'credit') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-card';
                            } elseif (strpos($gateway->id, 'bacs') !== false || strpos($gateway->id, 'bank') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-bank';
                            } elseif (strpos($gateway->id, 'cod') !== false || strpos($gateway->id, 'cash') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-cash';
                            } elseif (strpos($gateway->id, 'klarna') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-klarna';
                            } elseif (strpos($gateway->id, 'sofort') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-sofort';
                            } elseif (strpos($gateway->id, 'sepa') !== false) {
                                $icon_class = 'yprint-payment-icon yprint-icon-sepa';
                            } else {
                                $icon_class = 'yprint-payment-icon yprint-icon-default';
                            }
                            ?>
                            <div class="<?php echo $icon_class; ?>"></div>
                            <span class="yprint-payment-title"><?php echo $gateway->get_title(); ?></span>
                            <?php if ($gateway->has_fields() || $gateway->get_description()) : ?>
                                <div class="yprint-payment-description">
                                    <?php echo $gateway->get_description(); ?>
                                </div>
                            <?php endif; ?>
                        </label>
                    </div>
                <?php endforeach; ?>
            <?php else : ?>
                <p class="yprint-no-payment-methods">Keine Zahlungsmethoden verfügbar.</p>
            <?php endif; ?>
        </div>
    </div>

    <style>
    .yprint-payment-options {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-payment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
    }

    .yprint-payment-option {
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
    }

    .yprint-payment-option:hover {
        border-color: #2997FF;
    }

    .yprint-payment-option.selected {
        border-color: #2997FF;
        background-color: #f0f6ff;
    }

    .yprint-hidden-radio {
        position: absolute;
        opacity: 0;
        height: 0;
        width: 0;
    }

    .yprint-payment-label {
        display: block;
        padding: 15px;
        cursor: pointer;
        width: 100%;
        height: 100%;
    }

    .yprint-payment-icon {
        width: 40px;
        height: 40px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-bottom: 10px;
    }

    .yprint-icon-paypal {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%230070E0" d="M19.2,5.4c-0.5-0.5-1.1-1-1.8-1.2C16.5,4,15.6,3.9,14.7,3.9H9.6c-0.5,0-0.9,0.3-1,0.8L6.3,16c-0.1,0.3,0.2,0.6,0.5,0.6h3.5l0.3-1.7v0.1c0.1-0.5,0.5-0.8,1-0.8h2.1c3,0,5.3-1.2,6-4.5c0-0.1,0-0.2,0.1-0.3c0.2-1.3,0-2.2-0.6-3"></path><path fill="%231F264F" d="M9.3,7.9c0.1-0.4,0.3-0.7,0.6-0.9C10.1,6.9,10.4,6.8,10.7,6.8l4.3,0c0.5,0,1,0.1,1.4,0.2c0.1,0,0.2,0.1,0.3,0.1c0.1,0,0.2,0.1,0.3,0.1c0.1,0,0.2,0.1,0.2,0.1c0.1,0,0.2,0.1,0.2,0.1c0.3,0.1,0.5,0.3,0.7,0.5c0.5-2.9-0.02-4.9-1.7-6.7C14.9-0.3,12.2,0,10,0H3.6C3,0,2.5,0.4,2.4,1L0,17.2c-0.1,0.5,0.3,1,0.8,1h6l1.5-9.3L9.3,7.9z"></path></svg>');
    }

    .yprint-icon-card {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4V12h16V18z M20,8H4V6h16V8z"></path><path fill="%231F264F" d="M6,14h4v2H6V14z M12,14h6v2h-6V14z"></path></svg>');
    }

    .yprint-icon-bank {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M12,3L2,8v2h20V8L12,3z M4,12h4v6H4V12z M10,12h4v6h-4V12z M16,12h4v6h-4V12z M2,20v2h20v-2H2z"></path></svg>');
    }

    .yprint-icon-cash {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M11,8v3H9v2h2v2H9v2h2v3h2v-3h2v-2h-2v-2h2v-2h-2V8H11z M21,4H3C1.9,4,1,4.9,1,6v12c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V6C23,4.9,22.1,4,21,4z M21,18H3V6h18V18z"></path></svg>');
    }

    .yprint-icon-klarna {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%23FFB3C7" d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M12,20c-4.4,0-8-3.6-8-8s3.6-8,8-8s8,3.6,8,8S16.4,20,12,20z"></path><path fill="%23FFB3C7" d="M12,6c-1.1,0-2,0.9-2,2v8c0,1.1,0.9,2,2,2s2-0.9,2-2V8C14,6.9,13.1,6,12,6z"></path></svg>');
    }

    .yprint-icon-sofort {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%23EB6F93" d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M15.5,15.5h-7v-7h7V15.5z"></path><path fill="%23EB6F93" d="M10.5,10.5h3v3h-3V10.5z"></path></svg>');
    }

    .yprint-icon-sepa {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M4,4h16c1.1,0,2,0.9,2,2v12c0,1.1-0.9,2-2,2H4c-1.1,0-2-0.9-2-2V6C2,4.9,2.9,4,4,4z M4,6v12h16V6H4z"></path><path fill="%231F264F" d="M6,10h12v2H6V10z M6,14h8v2H6V14z"></path></svg>');
    }

    .yprint-icon-default {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="40" height="40"><path fill="%231F264F" d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M20,18H4V6h16V18z"></path><path fill="%231F264F" d="M13,15h4v2h-4V15z M11,11H7v2h4V11z M15,11h2v2h-2V11z"></path></svg>');
    }

    .yprint-payment-title {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1rem;
    }

    .yprint-payment-description {
        font-size: 0.85rem;
        color: #666;
        margin-top: 8px;
        display: none;
    }

    .yprint-payment-option.selected .yprint-payment-description {
        display: block;
    }

    .yprint-payment-option.error {
        animation: yprint-shake 0.5s;
        border-color: #dc3545;
    }

    @keyframes yprint-shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .yprint-no-payment-methods {
        text-align: center;
        color: #dc3545;
        padding: 20px;
        border: 1px solid #dc3545;
        border-radius: 4px;
        grid-column: 1 / -1;
    }

    @media (max-width: 600px) {
        .yprint-payment-grid {
            grid-template-columns: 1fr;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const $paymentOptions = $('.yprint-payment-option');
        const $paymentInputs = $('input[name="payment_method"]');
        
        // Initial State setzen
        const initialPayment = $('input[name="payment_method"]:checked').val();
        if (initialPayment) {
            // YPrintCheckoutSystem aktualisieren wenn verfügbar
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('paymentMethod', {
                    method: initialPayment,
                    timestamp: Date.now()
                });
            }
        }

        // Zahlungsmethode ändern
$paymentInputs.on('change', function() {
    const $selectedOption = $(this).closest('.yprint-payment-option');
    
    // UI Update
    $paymentOptions.removeClass('selected');
    $selectedOption.addClass('selected');
    
    // Fehlerklasse entfernen
    $paymentOptions.removeClass('error');
    
    // YPrintCheckoutSystem aktualisieren wenn verfügbar
    if (typeof YPrintCheckoutSystem !== 'undefined') {
        YPrintCheckoutSystem.updateState('paymentMethod', {
            method: this.value,
            timestamp: Date.now()
        });
    }

    // WooCommerce Integration - Standard-Event trigger
    $(document.body).trigger('payment_method_selected');
    
    // Die Standard-WooCommerce Zahlungsmethode aktualisieren
    $('input[name="payment_method"][value="' + this.value + '"]').prop('checked', true).trigger('click');
});
        // WooCommerce Payment Update
        function updateWooCommercePayment(method) {
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_update_payment_method',
                    payment_method: method,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        $(document.body).trigger('payment_method_selected');
                    }
                }
            });
        }

        // Auf State-Updates reagieren wenn YPrintCheckoutSystem verfügbar
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.paymentMethod && state.paymentMethod.method) {
                const $radio = $(`input[value="${state.paymentMethod.method}"]`);
                if (!$radio.is(':checked')) {
                    $radio.prop('checked', true).trigger('change');
                }
            }
        });

        // Fehlerbehandlung
        $(document).on('checkout_error', function() {
            if (!$paymentInputs.filter(':checked').length) {
                $paymentOptions.addClass('error');
                $('html, body').animate({
                    scrollTop: $('.yprint-payment-options').offset().top - 100
                }, 500);
            }
        });

        // Validierung vor Submit
        $(document).on('checkout_place_order', function() {
            if (!$paymentInputs.filter(':checked').length) {
                $paymentOptions.addClass('error');
                return false;
            }
            return true;
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_payment_options', 'yprint_payment_options_shortcode');

/**
 * YPrint Different Billing Shortcode
 * 
 * Shortcode für die abweichende Rechnungsadresse im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für abweichende Rechnungsadresse
 */
function yprint_different_billing_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    // Aktuelle Benutzerdaten abrufen
    $user_id = get_current_user_id();
    
    // WooCommerce Billing Felder abrufen
    $different_billing_first_name = get_user_meta($user_id, 'billing_first_name', true);
    $different_billing_last_name = get_user_meta($user_id, 'billing_last_name', true);
    $different_billing_email = get_user_meta($user_id, 'billing_email', true);
    $different_billing_address_1 = get_user_meta($user_id, 'billing_address_1', true);
    $different_billing_address_2 = get_user_meta($user_id, 'billing_address_2', true);
    $different_billing_postcode = get_user_meta($user_id, 'billing_postcode', true);
    $different_billing_city = get_user_meta($user_id, 'billing_city', true);
    $different_billing_country = get_user_meta($user_id, 'billing_country', true);
    $different_billing_enabled = false; // Immer als deaktiviert starten

    ob_start();
    ?>
    <div class="yprint-different-billing">
        <div class="yprint-checkbox-group">
            <input type="checkbox" 
                   id="different_billing" 
                   name="different_billing" 
                   class="yprint-billing-toggle"
                   <?php checked($different_billing_enabled, true); ?> />
            <label for="different_billing">Abweichende Rechnungsadresse</label>
        </div>
        
        <div id="different_billing_fields" class="yprint-conditional-fields" style="display: <?php echo $different_billing_enabled ? 'block' : 'none'; ?>;">
            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_first_name" 
                       placeholder="Vorname" 
                       value="<?php echo esc_attr($different_billing_first_name); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_last_name" 
                       placeholder="Name" 
                       value="<?php echo esc_attr($different_billing_last_name); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="email" 
                       name="different_billing_email" 
                       placeholder="E-Mail" 
                       value="<?php echo esc_attr($different_billing_email); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_address_1" 
                       placeholder="Straße" 
                       value="<?php echo esc_attr($different_billing_address_1); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_address_2" 
                       placeholder="Hausnummer" 
                       value="<?php echo esc_attr($different_billing_address_2); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <input type="text" 
                       name="different_billing_postcode" 
                       placeholder="PLZ" 
                       value="<?php echo esc_attr($different_billing_postcode); ?>" 
                       class="yprint-billing-field" />
                
                <input type="text" 
                       name="different_billing_city" 
                       placeholder="Ort" 
                       value="<?php echo esc_attr($different_billing_city); ?>" 
                       class="yprint-billing-field" />
            </div>

            <div class="yprint-form-row">
                <select name="different_billing_country" class="yprint-billing-field">
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_countries();
                    $default_country = $different_billing_country ?: $countries_obj->get_base_country();
                    
                    foreach ($countries as $code => $name) {
                        echo '<option value="' . esc_attr($code) . '" ' . 
                             selected($default_country, $code, false) . '>' . 
                             esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
        </div>
    </div>
    
    <style>
    .yprint-different-billing {
        width: 100%;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        color: #1d1d1f;
        cursor: pointer;
    }

    .yprint-checkbox-group a {
        color: #2997FF;
        text-decoration: none;
    }

    .yprint-checkbox-group a:hover {
        text-decoration: underline;
    }

    .yprint-checkbox-group input[type="checkbox"] {
        margin-right: 10px;
    }

    .yprint-conditional-fields {
        margin-top: 15px;
    }

    .yprint-form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .yprint-form-row input,
    .yprint-form-row select {
        flex: 1;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-family: 'Roboto', sans-serif;
    }

    .yprint-form-row input:focus,
    .yprint-form-row select:focus {
        border-color: #2997FF;
        outline: none;
    }

    @media (max-width: 600px) {
        .yprint-form-row {
            flex-direction: column;
        }
        
        .yprint-form-row input,
        .yprint-form-row select {
            width: 100%;
        }
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const checkbox = $('#different_billing');
        const fieldsContainer = $('#different_billing_fields');
        const hasExistingData = <?php echo !empty($different_billing_first_name) || 
                                         !empty($different_billing_last_name) || 
                                         !empty($different_billing_email) ? 'true' : 'false'; ?>;
        
        // Force unchecked state
        checkbox.prop('checked', false);
        fieldsContainer.hide();

        // Toggle Felder
        checkbox.change(function() {
            if (this.checked) {
                fieldsContainer.slideDown(300);
            } else {
                fieldsContainer.slideUp(300);
            }

            // Update YPrintCheckoutSystem
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('differentBilling', {
                    enabled: this.checked
                });
            }
            
            // Metadaten aktualisieren
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_update_different_billing_enabled',
                    enabled: this.checked ? 1 : 0,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        });

        // Feldänderungen
        $('.yprint-billing-field').on('change', function() {
            // Update YPrintCheckoutSystem
            if (typeof YPrintCheckoutSystem !== 'undefined') {
                YPrintCheckoutSystem.updateState('differentBillingAddress', {
                    [this.name]: this.value
                });
            }
            
            // Metadaten aktualisieren
            saveBillingAddress();
        });

        // Adresse speichern
        function saveBillingAddress() {
            const addressData = {};
            $('.yprint-billing-field').each(function() {
                addressData[$(this).attr('name')] = $(this).val();
            });
            
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'yprint_save_different_billing_address',
                    address: addressData,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                }
            });
        }

        // Auf State-Updates reagieren
        $(document).on('checkoutStateUpdate', function(e, state) {
            if (state && state.differentBillingAddress) {
                Object.entries(state.differentBillingAddress).forEach(([field, value]) => {
                    $(`[name="${field}"]`).val(value);
                });
            }
            
            // Wir ignorieren den State für die Checkbox und behalten den initialen Zustand bei
            // Immer deaktiviert bleiben, es sei denn, der Benutzer aktiviert es manuell
        });
    });
    </script>

    <?php
    return ob_get_clean();
}
add_shortcode('yprint_different_billing', 'yprint_different_billing_shortcode');

// AJAX Handler für Different Billing Toggle
function yprint_update_different_billing_enabled() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $enabled = isset($_POST['enabled']) ? (bool)$_POST['enabled'] : false;
    
    update_user_meta($user_id, 'different_billing_enabled', $enabled);
    wp_send_json_success();
}
add_action('wp_ajax_yprint_update_different_billing_enabled', 'yprint_update_different_billing_enabled');
add_action('wp_ajax_nopriv_yprint_update_different_billing_enabled', 'yprint_update_different_billing_enabled');

// AJAX Handler für Different Billing Adresse
function yprint_save_different_billing_address() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    $user_id = get_current_user_id();
    $address = isset($_POST['address']) ? $_POST['address'] : array();
    
    if ($address) {
        foreach ($address as $key => $value) {
            // Konvertieren von different_billing_* zu billing_*
            $meta_key = str_replace('different_billing_', 'billing_', $key);
            update_user_meta($user_id, $meta_key, sanitize_text_field($value));
        }
    }
    
    wp_send_json_success();
}
add_action('wp_ajax_yprint_save_different_billing_address', 'yprint_save_different_billing_address');
add_action('wp_ajax_nopriv_yprint_save_different_billing_address', 'yprint_save_different_billing_address');



/**
 * YPrint Order Summary Shortcode
 * 
 * Shortcode für die Bestellübersicht im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für die Bestellübersicht
 */
function yprint_order_summary_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    ob_start();
    ?>
    <div class="yprint-order-summary" id="yprint-order-summary">
        <h3 class="yprint-summary-title">Warenkorb</h3>
        
        <?php 
        foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
            $_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
            
            $thumbnail = $_product->get_image('thumbnail', array('class' => 'yprint-item-image'));
            $product_name = apply_filters('woocommerce_cart_item_name', $_product->get_name(), $cart_item, $cart_item_key);
            $price = $cart_item['line_total'];
            $product_id = $_product->get_id();
            ?>
            <div class="yprint-order-item" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>" data-product-id="<?php echo esc_attr($product_id); ?>">
                <?php echo $thumbnail; ?>
                <div class="yprint-item-details">
                    <span class="yprint-item-title"><?php echo $product_name; ?></span>
                    <div class="yprint-item-quantity-wrapper">
        <button class="yprint-item-quantity-btn yprint-item-quantity-minus" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">−</button>
        <span class="yprint-item-quantity-value"><?php echo esc_attr($cart_item['quantity']); ?></span>
        <input type="number" class="yprint-item-quantity-input" value="<?php echo esc_attr($cart_item['quantity']); ?>" min="1" style="display: none;">
        <button class="yprint-item-quantity-btn yprint-item-quantity-plus" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">+</button>
    </div>
                </div>
                <div class="yprint-item-remove" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">×</div>
                <span class="yprint-item-total"><?php echo wc_price($price); ?></span>
            </div>
            <?php 
        } 
        ?>

        <div class="yprint-summary-totals">
        <div class="yprint-subtotal">
            <span>Zwischensumme</span>
            <span><?php echo WC()->cart->get_cart_subtotal(); ?></span>
        </div>
        <div class="yprint-shipping">
            <span>Versand</span>
            <span><?php echo WC()->cart->get_cart_shipping_total(); ?></span>
        </div>
        <?php if (WC()->cart->get_discount_total() > 0) : ?>
        <div class="yprint-discount">
            <span>Rabatt</span>
            <span>-<?php echo wc_price(WC()->cart->get_discount_total()); ?></span>
        </div>
        <?php endif; ?>
        <div class="yprint-total">
            <span>Gesamtsumme</span>
            <span><?php echo WC()->cart->get_total(); ?></span>
        </div>
    </div>
</div>

<style>
.yprint-order-summary {
    width: 100%;
    font-family: 'Roboto', sans-serif;
    position: relative;
}

.yprint-summary-title {
    text-transform: none;
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #1d1d1f;
}

.yprint-order-item {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f5f5f7;
    position: relative;
}

.yprint-item-image {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 4px;
}

.yprint-item-details {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

.yprint-item-title {
    font-weight: 500;
    margin-bottom: 8px;
    color: #1d1d1f;
}

.yprint-item-quantity-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.yprint-item-quantity-value {
    min-width: 24px;
    text-align: center;
    color: #0079FF;
    font-weight: 600;
    cursor: pointer;
}

.yprint-item-quantity-input {
    width: 30px;
    padding: 0;
    text-align: center;
    border: 1px solid #ddd;
    color: #0079FF;
    font-weight: 600;
}

.yprint-item-quantity-input::-webkit-outer-spin-button,
.yprint-item-quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.yprint-item-quantity-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    color: #1d1d1f;
    padding: 0;
}

.yprint-item-quantity-btn:hover {
    background: transparent;
}

.yprint-item-remove {
    cursor: pointer;
    color: #999;
    font-size: 18px;
    line-height: 1;
    padding: 0 5px;
    position: absolute;
    right: 0;
    top: 0;
}

.yprint-item-remove:hover {
    color: #0079FF;
}

.yprint-item-price {
    display: none;
}

.yprint-item-total {
    font-weight: 600;
    color: #0079FF;
}

.yprint-summary-totals {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #f5f5f7;
}

.yprint-subtotal, 
.yprint-shipping,
.yprint-discount,
.yprint-total {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.yprint-subtotal span, 
.yprint-shipping span,
.yprint-discount span {
    color: #6e6e73;
}

.yprint-total {
    font-weight: 600;
    border-top: 1px solid #f5f5f7;
    padding-top: 12px;
    margin-top: 12px;
}

.yprint-total span {
    color: #1d1d1f;
}

.yprint-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.yprint-loading-overlay.active {
    opacity: 1;
    visibility: visible;
}
</style>

<script>
jQuery(document).ready(function($) {
    // Variable um zu verfolgen, ob ein Eingabefeld aktiv ist
    var isEditing = false;
    var $orderSummary = $('#yprint-order-summary');
    
    // Overlay zum Order Summary hinzufügen, falls noch nicht vorhanden
    if ($orderSummary.find('.yprint-loading-overlay').length === 0) {
        $orderSummary.prepend('<div class="yprint-loading-overlay"><img src="https://yprint.de/wp-content/uploads/2025/02/120225-logo.svg" alt="Loading..."></div>');
    }
    
    // PLUS/MINUS BUTTONS
    $orderSummary.on('click', '.yprint-item-quantity-btn', function() {
        if (isEditing) return; // Ignorieren, wenn Eingabe aktiv
        
        var $btn = $(this);
        var $item = $btn.closest('.yprint-order-item');
        var $qtyValue = $item.find('.yprint-item-quantity-value');
        var cartItemKey = $item.data('cart-item-key');
        var currentQty = parseInt($qtyValue.text());
        var newQty = $btn.hasClass('yprint-item-quantity-minus') ? 
                     Math.max(1, currentQty - 1) : 
                     currentQty + 1;
        
        // Menge sofort aktualisieren
        $qtyValue.text(newQty);
        
        // AJAX-Update der Menge
        updateQuantity(cartItemKey, newQty);
    });
    
    // DIREKTEINGABE DER MENGE
    // Klick auf Menge (zum Bearbeiten)
    $orderSummary.on('click', '.yprint-item-quantity-value', function() {
        if (isEditing) return; // Bereits im Bearbeitungsmodus
        
        isEditing = true;
        var $value = $(this);
        var $input = $value.siblings('.yprint-item-quantity-input');
        
        // Eingabefeld vorbereiten und anzeigen
        $input.val($value.text());
        $value.hide();
        $input.show().focus().select();
    });
    
    // Eingabefeld verlassen
    $orderSummary.on('blur', '.yprint-item-quantity-input', function() {
        var $input = $(this);
        var $item = $input.closest('.yprint-order-item');
        var $value = $item.find('.yprint-item-quantity-value');
        var cartItemKey = $item.data('cart-item-key');
        var oldQty = parseInt($value.text());
        var newQty = parseInt($input.val());
        
        // Gültigen Wert sicherstellen
        if (isNaN(newQty) || newQty < 1) newQty = 1;
        
        // UI zurücksetzen
        $input.hide();
        $value.show();
        
        // Bearbeitungsmodus beenden
        isEditing = false;
        
        // Nur bei Änderung aktualisieren
        if (newQty !== oldQty) {
            $value.text(newQty);
            updateQuantity(cartItemKey, newQty);
        }
    });
    
    // Enter-Taste im Eingabefeld
    $orderSummary.on('keypress', '.yprint-item-quantity-input', function(e) {
        if (e.which === 13) { // Enter
            e.preventDefault();
            $(this).blur();
        }
    });
    
    // Klick außerhalb schließt Eingabefeld
    $(document).on('mousedown', function(e) {
        if (isEditing) {
            var $target = $(e);
            if (!$target.is('.yprint-item-quantity-input') && !$target.is('.yprint-item-quantity-value')) {
                $orderSummary.find('.yprint-item-quantity-input:visible').blur();
            }
        }
    });
    
    // ENTFERNEN-BUTTON
    $orderSummary.on('click', '.yprint-item-remove', function() {
        var $item = $(this).closest('.yprint-order-item');
        var cartItemKey = $item.data('cart-item-key');
        
        // Overlay aktivieren
        $orderSummary.find('.yprint-loading-overlay').addClass('active');
        
        $.ajax({
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            type: 'POST',
            data: {
                action: 'yprint_remove_from_cart',
                cart_item_key: cartItemKey,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                // Nach Erfolg Seite neu laden
                if (response.cart_count !== undefined) {
                    location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error('Fehler beim Entfernen:', status, error);
                $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                alert('Ein Fehler ist aufgetreten.');
            }
        });
    });
    
    // Funktion zum Aktualisieren der Menge
    function updateQuantity(cartItemKey, quantity) {
        // Overlay aktivieren
        $orderSummary.find('.yprint-loading-overlay').addClass('active');
        
        $.ajax({
            url: '<?php echo admin_url('admin-ajax.php'); ?>',
            type: 'POST',
            data: {
                action: 'yprint_update_cart_quantity',
                cart_item_key: cartItemKey,
                quantity: quantity,
                security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
            },
            success: function(response) {
                if (response.success || response.cart_subtotal !== undefined) {
                    location.reload();
                } else {
                    $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                    alert(response.data || 'Ein Fehler ist aufgetreten.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Fehler beim Aktualisieren:', status, error);
                $orderSummary.find('.yprint-loading-overlay').removeClass('active');
                alert('Ein Fehler ist aufgetreten.');
            }
        });
    }
});
</script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_order_summary', 'yprint_order_summary_shortcode');

/**
 * YPrint Coupon and Buy Shortcode
 * 
 * Shortcode für das Gutschein-Feld und den Kaufen-Button im Checkout
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode für Gutschein-Feld und Kaufen-Button
 */
function yprint_coupon_buy_shortcode() {
    if (!function_exists('WC')) {
        return 'WooCommerce ist nicht aktiviert.';
    }

    // Hole gespeicherten Gutscheincode
    $saved_coupon = WC()->session ? WC()->session->get('applied_coupon') : '';

    ob_start();
    ?>
    <div class="yprint-coupon-buy-section">
        <div class="yprint-coupon-form">
            <div class="yprint-coupon-input-wrapper">
                <input 
                    type="text" 
                    name="coupon_code" 
                    class="yprint-coupon-input" 
                    placeholder="Gutschein-Code eingeben" 
                    id="coupon_code" 
                    value="<?php echo esc_attr($saved_coupon); ?>" 
                />
                <button 
                    type="button"
                    class="yprint-coupon-button" 
                    id="apply_coupon"
                >
                    Anwenden
                </button>
            </div>
            <div class="yprint-coupon-message" style="display: none;"></div>
        </div>

        <button 
            type="button"
            id="yprint_checkout_submit"
            class="yprint-buy-button"
        >
            <span class="yprint-button-text">Jetzt kaufen</span>
            <div class="yprint-button-loader" style="display: none;">
                <div class="yprint-loader-spinner"></div>
            </div>
        </button>

        <!-- Validierungsfeedback -->
        <div class="yprint-validation-feedback" style="display: none;"></div>
    </div>

    <style>
    .yprint-coupon-buy-section {
        margin-top: 20px;
    }

    .yprint-coupon-form {
        margin-bottom: 20px;
    }

    .yprint-coupon-input-wrapper {
        display: flex;
        gap: 10px;
    }

    .yprint-coupon-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1rem;
    }

    .yprint-coupon-input:focus {
        border-color: #2997FF;
        outline: none;
    }

    .yprint-coupon-button {
        padding: 0 20px;
        background-color: #f5f5f7;
        color: #1d1d1f;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s ease;
    }

    .yprint-coupon-button:hover {
        background-color: #e0e0e0;
    }

    .yprint-buy-button {
        width: 100%;
        padding: 15px;
        background-color: #0079FF;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
        position: relative;
    }

    .yprint-buy-button:disabled {
    background-color: #a0a0a0;
    cursor: not-allowed;
    opacity: 0.6;
}

    .yprint-buy-button:hover {
        background-color: #0068e1;
    }

    .yprint-button-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .yprint-loader-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: yprint-spin 0.8s linear infinite;
    }

    @keyframes yprint-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .yprint-buy-button.loading .yprint-button-text {
        visibility: hidden;
    }

    .yprint-buy-button.loading .yprint-button-loader {
        display: block;
    }

    .yprint-coupon-message {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .yprint-coupon-message.success {
        background-color: #d4edda;
        color: #155724;
    }

    .yprint-coupon-message.error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .yprint-validation-feedback {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .yprint-validation-feedback.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .yprint-validation-item {
        margin: 5px 0;
    }
    </style>

    <script>
    jQuery(document).ready(function($) {
        const $buyButton = $('#yprint_checkout_submit');
        const $couponButton = $('#apply_coupon');
        const $couponInput = $('#coupon_code');
        const $couponMessage = $('.yprint-coupon-message');
        const $validationFeedback = $('.yprint-validation-feedback');
        
        // Bei Seitenladung Warenkorb-Status prüfen
        function checkCartStatus() {
            const cartIsEmpty = <?php echo WC()->cart->is_empty() ? 'true' : 'false'; ?>;
            $buyButton.prop('disabled', cartIsEmpty);
        }

        checkCartStatus();

        // Gutschein anwenden
        $couponButton.on('click', function() {
            const couponCode = $couponInput.val().trim();
            
            if (!couponCode) {
                showCouponMessage('Bitte gib einen Gutschein-Code ein.', 'error');
                return;
            }
            
            // Button deaktivieren während der Anfrage
            $couponButton.prop('disabled', true);
            
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'yprint_apply_coupon',
                    coupon_code: couponCode,
                    security: '<?php echo wp_create_nonce('yprint-checkout-nonce'); ?>'
                },
                success: function(response) {
                    $couponButton.prop('disabled', false);
                    
                    if (response.success) {
                        showCouponMessage('Gutschein wurde erfolgreich angewendet.', 'success');
                        
                        // YPrintCheckoutSystem aktualisieren
                        if (typeof YPrintCheckoutSystem !== 'undefined') {
                            YPrintCheckoutSystem.updateState('couponCode', {
                                code: couponCode
                            });
                        }
                        
                        // Seite neuladen um Preise zu aktualisieren
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showCouponMessage(response.data || 'Gutschein konnte nicht angewendet werden.', 'error');
                    }
                },
                error: function() {
                    $couponButton.prop('disabled', false);
                    showCouponMessage('Ein Fehler ist aufgetreten. Bitte versuche es erneut.', 'error');
                }
            });
        });

        // Gutschein-Nachricht anzeigen
        function showCouponMessage(text, type) {
            $couponMessage
                .text(text)
                .removeClass('success error')
                .addClass(type)
                .fadeIn();
            
            // Nach 3 Sekunden ausblenden
            setTimeout(function() {
                $couponMessage.fadeOut();
            }, 3000);
        }

        // Checkout Submit
        $buyButton.on('click', function(e) {
            // Prüfen, ob Warenkorb leer ist
            if (<?php echo WC()->cart->is_empty() ? 'true' : 'false'; ?>) {
                return false;
            }
            
            e.preventDefault();
            
            // Button Loading State
            $buyButton.addClass('loading');
            $validationFeedback.hide();
    
    // Checkout Validierung durchführen
    if (typeof YPrintCheckoutSystem !== 'undefined') {
        const validationResult = YPrintCheckoutSystem.validateForm();
        
        if (validationResult.isValid) {
            // Checkout Prozess starten
            YPrintCheckoutSystem.processCheckout();
        } else {
            // Fehler anzeigen
            showValidationErrors(validationResult.errors);
            $buyButton.removeClass('loading');
        }
    } else {
        // Fallback wenn YPrintCheckoutSystem nicht verfügbar ist
        $validationFeedback
            .empty()
            .addClass('error')
            .append($('<div class="yprint-validation-item"></div>').text('Das Checkout-System konnte nicht geladen werden.'))
            .show();
        
        $buyButton.removeClass('loading');
    }
});

        // Validierungsfehler anzeigen
        function showValidationErrors(errors) {
            $validationFeedback.empty().addClass('error');
            
            errors.forEach(error => {
                $validationFeedback.append(
                    $('<div class="yprint-validation-item"></div>').text(error)
                );
            });

            $validationFeedback.show();

            // Scroll zu den Fehlern
            $('html, body').animate({
                scrollTop: $validationFeedback.offset().top - 100
            }, 500);
        }
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_coupon_buy', 'yprint_coupon_buy_shortcode');

// AJAX Handler für Gutscheine
function yprint_apply_coupon() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['coupon_code']) || empty($_POST['coupon_code'])) {
        wp_send_json_error('Kein Gutschein-Code angegeben');
        return;
    }
    
    $coupon_code = sanitize_text_field($_POST['coupon_code']);
    
    if (function_exists('WC') && WC()->cart) {
        // Prüfen ob Gutschein bereits angewendet wurde
        if (WC()->cart->has_discount($coupon_code)) {
            wp_send_json_error('Dieser Gutschein wurde bereits angewendet');
            return;
        }
        
        // Gutschein anwenden
        $result = WC()->cart->apply_coupon($coupon_code);
        
        if ($result) {
            wp_send_json_success('Gutschein erfolgreich angewendet');
        } else {
            wp_send_json_error('Der Gutschein konnte nicht angewendet werden');
        }
    } else {
        wp_send_json_error('WooCommerce ist nicht aktiviert');
    }
}
add_action('wp_ajax_yprint_apply_coupon', 'yprint_apply_coupon');
add_action('wp_ajax_nopriv_yprint_apply_coupon', 'yprint_apply_coupon');

/**
 * YPrint Checkout WooCommerce Integration
 * 
 * Integration des benutzerdefinierten Checkouts mit WooCommerce
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Filter zur Übernahme der Daten aus dem benutzerdefinierten Checkout in den normalen WooCommerce-Checkout
 */
add_filter('woocommerce_checkout_posted_data', function($data) {
    // Checkout-Daten aus der Session abrufen
    $checkout_data = WC()->session ? WC()->session->get('yprint_checkout_data') : null;
    
    if ($checkout_data) {
        // Shipping-Daten übernehmen
        if (isset($checkout_data['shipping_address'])) {
            foreach ($checkout_data['shipping_address'] as $key => $value) {
                if ($key !== 'slot' && $key !== 'timestamp') {
                    $data['shipping_' . $key] = $value;
                }
            }
        }
        
        // Billing-Daten übernehmen wenn Different Billing aktiviert ist
        if (isset($checkout_data['different_billing']) && $checkout_data['different_billing']) {
            if (isset($checkout_data['different_billing_address'])) {
                foreach ($checkout_data['different_billing_address'] as $key => $value) {
                    // Konvertieren von different_billing_* zu billing_*
                    $billing_key = str_replace('different_billing_', 'billing_', $key);
                    $data[$billing_key] = $value;
                }
            }
        } else {
            // Wenn keine abweichende Rechnungsadresse, dann Lieferadresse für Rechnungsadresse verwenden
            if (isset($checkout_data['shipping_address'])) {
                foreach ($checkout_data['shipping_address'] as $key => $value) {
                    if ($key !== 'slot' && $key !== 'timestamp') {
                        $data['billing_' . $key] = $value;
                    }
                }
            }
        }
        
        // Zahlungsart übernehmen
        if (isset($checkout_data['payment_method']) && !empty($checkout_data['payment_method'])) {
            $data['payment_method'] = $checkout_data['payment_method'];
        }
    }
    
    return $data;
});

/**
 * Checkout Validierung erweitern
 */

add_action('woocommerce_checkout_process', function() {
    // Datenschutz-Checkbox prüfen
    if (!isset($_POST['privacy_checkbox']) || $_POST['privacy_checkbox'] !== 'on') {
        wc_add_notice('Bitte akzeptiere die Datenschutzerklärung, um fortzufahren.', 'error');
    }

    // Zahlungsmethode prüfen
    if (!isset($_POST['payment_method']) || empty($_POST['payment_method'])) {
        wc_add_notice('Bitte wähle eine Zahlungsmethode aus.', 'error');
    }

    // Lieferadresse prüfen
    $shipping_fields = array(
        'shipping_first_name' => 'Vorname',
        'shipping_last_name' => 'Nachname',
        'shipping_address_1' => 'Straße',
        'shipping_postcode' => 'PLZ',
        'shipping_city' => 'Ort',
        'shipping_country' => 'Land'
    );

    foreach ($shipping_fields as $field => $label) {
        if (!isset($_POST[$field]) || empty($_POST[$field])) {
            wc_add_notice(sprintf('Bitte gib %s für die Lieferadresse an.', $label), 'error');
        }
    }

    // Abweichende Rechnungsadresse prüfen wenn aktiviert
    if (isset($_POST['different_billing']) && $_POST['different_billing'] === 'on') {
        $billing_fields = array(
            'billing_first_name' => 'Vorname',
            'billing_last_name' => 'Nachname',
            'billing_address_1' => 'Straße',
            'billing_postcode' => 'PLZ',
            'billing_city' => 'Ort',
            'billing_country' => 'Land'
        );

        foreach ($billing_fields as $field => $label) {
            if (!isset($_POST[$field]) || empty($_POST[$field])) {
                wc_add_notice(sprintf('Bitte gib %s für die Rechnungsadresse an.', $label), 'error');
            }
        }
    }
});

/**
 * YPrint Checkout Shortcodes registrieren
 */
function register_yprint_checkout_shortcodes() {
    add_shortcode('yprint_checkout', 'yprint_checkout_shortcode');
    add_shortcode('yprint_checkout_communication', 'yprint_checkout_communication_shortcode');
    add_shortcode('yprint_shipping_address', 'yprint_shipping_address_shortcode');
    add_shortcode('yprint_payment_options', 'yprint_payment_options_shortcode');
    add_shortcode('yprint_different_billing', 'yprint_different_billing_shortcode');
    add_shortcode('yprint_order_summary', 'yprint_order_summary_shortcode');
    add_shortcode('yprint_coupon_buy', 'yprint_coupon_buy_shortcode');
}
add_action('init', 'register_yprint_checkout_shortcodes');

/**
 * Thankyou Redirect Shortcode
 * Zeigt eine Ladeanimation und leitet nach 5 Sekunden weiter
 */
function thankyou_redirect_shortcode() {
    ob_start();
    ?>
    <div class="thankyou-redirect-container">
        <div class="loader-animation">
            <div class="spinner"></div>
        </div>
        <div class="redirect-message">
            <h2>Vielen Dank für deinen Einkauf!</h2>
            <p>Du wirst in wenigen Sekunden weitergeleitet...</p>
        </div>
    </div>
    
    <style>
        .thankyou-redirect-container {
            text-align: center;
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        .loader-animation {
            margin-bottom: 30px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 121, 255, 0.2);
            border-radius: 50%;
            border-top-color: #0079FF;
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .redirect-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #1d1d1f;
        }
        
        .redirect-message p {
            font-size: 16px;
            color: #6e6e73;
        }
    </style>
    
    <script>
        // Führe diese Funktion aus, sobald die Seite geladen ist
        (function() {
            // Setze den Timer für die Weiterleitung
            setTimeout(function() {
                window.location.href = 'https://yprint.de/basics/';
            }, 5000); // 5000 Millisekunden = 5 Sekunden
        })();
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('thankyou_redirect', 'thankyou_redirect_shortcode');

/**
 * Passt die Bestellbestätigungsseite an und ersetzt sie mit unserem benutzerdefinierten Redirect
 */
function customize_order_received_page($title, $id) {
    // Prüfen, ob es sich um die Order-Received-Seite handelt
    if (is_wc_endpoint_url('order-received') && $id == wc_get_page_id('checkout')) {
        // Mache den normalen Titel unsichtbar
        add_filter('the_content', 'replace_thankyou_content', 1);
        return '';
    }
    return $title;
}
add_filter('the_title', 'customize_order_received_page', 10, 2);

/**
 * Ersetzt den Inhalt der Bestellbestätigungsseite
 */
function replace_thankyou_content($content) {
    // Nur auf der Order-Received-Seite
    if (is_wc_endpoint_url('order-received')) {
        // Ersetze den Inhalt mit unserem Shortcode
        return do_shortcode('[thankyou_redirect]');
    }
    return $content;
}

/**
 * Entferne das standardmäßige WooCommerce Dankeschön-Template
 */
function remove_woocommerce_order_details_table() {
    if (is_wc_endpoint_url('order-received')) {
        remove_action('woocommerce_thankyou', 'woocommerce_order_details_table', 10);
        
        // Verhindere auch alle anderen WooCommerce-Ausgaben
        remove_all_actions('woocommerce_thankyou');
        remove_all_actions('woocommerce_order_details_before_order_table');
        remove_all_actions('woocommerce_order_details_after_order_table');
        remove_all_actions('woocommerce_order_details_before_customer_details');
        remove_all_actions('woocommerce_order_details_after_customer_details');
    }
}
add_action('template_redirect', 'remove_woocommerce_order_details_table');

/**
 * PayPal Webhook-Handler
 */
function yprint_paypal_webhook_handler() {
    // Webhook-Verarbeitung
    $payload = file_get_contents('php://input');
    $headers = getallheaders();
    
    // Nur an der PayPal Webhook-URL aktivieren
    if (!isset($_GET['yprint-paypal-webhook'])) {
        return;
    }
    
    // Debug-Log für Webhook-Anfragen
    error_log('PayPal Webhook received: ' . $payload);
    
    // JSON Payload verarbeiten
    $event_json = json_decode($payload);
    
    if (!$event_json || !isset($event_json->event_type)) {
        error_log('PayPal Webhook error: Invalid payload');
        status_header(400);
        exit('Invalid payload');
    }
    
    error_log('PayPal Webhook event type: ' . $event_json->event_type);
    
    // Event-Typ verarbeiten
    switch ($event_json->event_type) {
        case 'PAYMENT.CAPTURE.COMPLETED':
            // Zahlung abgeschlossen
            process_paypal_payment_completed($event_json);
            break;
            
        case 'PAYMENT.CAPTURE.DENIED':
        case 'PAYMENT.CAPTURE.REFUNDED':
        case 'PAYMENT.CAPTURE.REVERSED':
            // Zahlung abgelehnt/zurückerstattet/storniert
            process_paypal_payment_failed($event_json);
            break;
            
        case 'CHECKOUT.ORDER.APPROVED':
            // Bestellung genehmigt
            process_paypal_order_approved($event_json);
            break;
            
        case 'CHECKOUT.ORDER.COMPLETED':
            // Bestellung abgeschlossen
            process_paypal_order_completed($event_json);
            break;
            
        case 'CHECKOUT.ORDER.DECLINED':
            // Bestellung abgelehnt
            process_paypal_order_declined($event_json);
            break;
    }
    
    status_header(200);
    exit('Webhook processed');
}
add_action('init', 'yprint_paypal_webhook_handler');

/**
 * PayPal erfolgreiche Zahlung verarbeiten
 */
function process_paypal_payment_completed($event_json) {
    error_log('Processing PayPal payment completed');
    
    if (isset($event_json->resource->id) && isset($event_json->resource->supplementary_data->related_ids->order_id)) {
        $transaction_id = $event_json->resource->id;
        $paypal_order_id = $event_json->resource->supplementary_data->related_ids->order_id;
        
        error_log('PayPal payment completed - Transaction ID: ' . $transaction_id . ', Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Bestellung bereits bezahlt wurde
        if ($order->is_paid()) {
            error_log('Order already paid: ' . $order->get_id());
            return;
        }
        
        // Bestellung als bezahlt markieren
        $order->payment_complete($transaction_id);
        $order->add_order_note('Zahlung via PayPal Webhook bestätigt (Transaktion ID: ' . $transaction_id . ')');
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as paid');
    } else {
        error_log('PayPal webhook missing required fields for payment completed');
    }
}

/**
 * PayPal fehlgeschlagene Zahlung verarbeiten
 */
function process_paypal_payment_failed($event_json) {
    error_log('Processing PayPal payment failed');
    
    if (isset($event_json->resource->supplementary_data->related_ids->order_id)) {
        $paypal_order_id = $event_json->resource->supplementary_data->related_ids->order_id;
        
        error_log('PayPal payment failed - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Bestellung als fehlgeschlagen markieren
        $order->update_status('failed', 'PayPal-Zahlung fehlgeschlagen: ' . $event_json->event_type);
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as failed');
    } else {
        error_log('PayPal webhook missing required fields for payment failed');
    }
}

/**
 * PayPal Bestellung genehmigt verarbeiten
 */
function process_paypal_order_approved($event_json) {
    error_log('Processing PayPal order approved');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order approved - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Status auf "on-hold" setzen, da die Zahlung zwar genehmigt, aber noch nicht abgeschlossen ist
        if ($order->get_status() === 'pending') {
            $order->update_status('on-hold', 'PayPal-Bestellung genehmigt, warte auf Zahlungsabschluss');
            $order->save();
            error_log('Order ' . $order->get_id() . ' marked as on-hold');
        }
    } else {
        error_log('PayPal webhook missing required fields for order approved');
    }
}

/**
 * PayPal Bestellung abgeschlossen verarbeiten
 */
function process_paypal_order_completed($event_json) {
    error_log('Processing PayPal order completed');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order completed - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Bestellung bereits bezahlt wurde
        if (!$order->is_paid()) {
            // Bestellung als bezahlt markieren, falls noch keine Zahlung eingegangen ist
            $order->payment_complete($paypal_order_id);
            $order->add_order_note('Zahlung via PayPal Webhook bestätigt (Order ID: ' . $paypal_order_id . ')');
            $order->save();
            error_log('Order ' . $order->get_id() . ' marked as paid');
        }
    } else {
        error_log('PayPal webhook missing required fields for order completed');
    }
}

/**
 * PayPal Bestellung abgelehnt verarbeiten
 */
function process_paypal_order_declined($event_json) {
    error_log('Processing PayPal order declined');
    
    if (isset($event_json->resource->id)) {
        $paypal_order_id = $event_json->resource->id;
        
        error_log('PayPal order declined - Order ID: ' . $paypal_order_id);
        
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            error_log('No WooCommerce order found for PayPal order ID: ' . $paypal_order_id);
            return;
        }
        
        $order = $orders[0];
        
        // Bestellung als fehlgeschlagen markieren
        $order->update_status('failed', 'PayPal-Bestellung abgelehnt');
        $order->save();
        
        error_log('Order ' . $order->get_id() . ' marked as failed');
    } else {
        error_log('PayPal webhook missing required fields for order declined');
    }
}

/**
 * Stripe Webhook-Handler
 */
function yprint_stripe_webhook_handler() {
    // Webhook-Verarbeitung
    $payload = file_get_contents('php://input');
    $headers = getallheaders();
    
    // Nur an der Stripe Webhook-URL aktivieren
    if (!isset($_GET['yprint-stripe-webhook'])) {
        return;
    }
    
    // Debug-Log für Webhook-Anfragen
    error_log('Stripe Webhook received: ' . $payload);
    
    // Webhook-Signatur prüfen
    $webhook_secret = get_option('yprint_stripe_webhook_secret', '');
    $signature = isset($headers['Stripe-Signature']) ? $headers['Stripe-Signature'] : '';
    
    if (empty($webhook_secret) || empty($signature)) {
        error_log('Stripe Webhook error: Invalid webhook configuration - missing secret or signature');
        status_header(400);
        exit('Invalid webhook configuration');
    }
    
    try {
        // Stripe-Bibliothek laden
        if (!class_exists('Stripe\Stripe')) {
            require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
            require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/vendor/autoload.php';
        }
        
        // Event verifizieren
        $event = \Stripe\Webhook::constructEvent(
            $payload, $signature, $webhook_secret
        );
        
        error_log('Stripe Webhook event verified: ' . $event->type);
    } catch (\Exception $e) {
        error_log('Stripe Webhook error: ' . $e->getMessage());
        status_header(400);
        exit('Webhook Error: ' . $e->getMessage());
    }
    
    // Event-Typ verarbeiten
    switch ($event->type) {
        case 'payment_intent.succeeded':
            // Zahlung erfolgreich
            process_stripe_payment_succeeded($event->data->object);
            break;
            
        case 'payment_intent.payment_failed':
            // Zahlung fehlgeschlagen
            process_stripe_payment_failed($event->data->object);
            break;
            
        case 'charge.refunded':
            // Zahlung zurückerstattet
            process_stripe_refund($event->data->object);
            break;
        
        default:
            error_log('Stripe Webhook: Unhandled event type: ' . $event->type);
            break;
    }
    
    status_header(200);
    exit('Webhook processed');
}
add_action('init', 'yprint_stripe_webhook_handler');

/**
 * Stripe erfolgreiche Zahlung verarbeiten
 */
function process_stripe_payment_succeeded($payment_intent) {
    error_log('Processing Stripe payment succeeded');
    
    if (!isset($payment_intent->id)) {
        error_log('Stripe payment intent ID missing');
        return;
    }
    
    $payment_intent_id = $payment_intent->id;
    error_log('Stripe payment succeeded - Payment Intent ID: ' . $payment_intent_id);
    
    // Order ID aus Stripe Payment Intent ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_stripe_payment_intent',
        'meta_value' => $payment_intent_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe payment intent ID: ' . $payment_intent_id);
        
        // Versuche über Metadaten zu finden, wenn vorhanden
        if (isset($payment_intent->metadata->order_id)) {
            $order_id = $payment_intent->metadata->order_id;
            error_log('Trying to find order by ID from metadata: ' . $order_id);
            $order = wc_get_order($order_id);
            
            if ($order) {
                $orders = array($order);
                error_log('Order found by ID from metadata');
            } else {
                error_log('Order not found by ID from metadata');
                return;
            }
        } else {
            error_log('No order ID in metadata');
            return;
        }
    }
    
    $order = $orders[0];
    error_log('Order found: ' . $order->get_id());
    
    // Prüfen, ob Bestellung bereits bezahlt wurde
    if ($order->is_paid()) {
        error_log('Order already paid: ' . $order->get_id());
        return;
    }
    
    // Bestellung als bezahlt markieren
    $charge_id = isset($payment_intent->latest_charge) ? $payment_intent->latest_charge : $payment_intent_id;
    $order->payment_complete($charge_id);
    $order->add_order_note('Zahlung via Stripe Webhook bestätigt (Charge ID: ' . $charge_id . ')');
    
    // Speichere Payment Intent ID, falls noch nicht gespeichert
    if (!get_post_meta($order->get_id(), '_stripe_payment_intent', true)) {
        update_post_meta($order->get_id(), '_stripe_payment_intent', $payment_intent_id);
    }
    
    $order->save();
    error_log('Order ' . $order->get_id() . ' marked as paid');
}

/**
 * Stripe fehlgeschlagene Zahlung verarbeiten
 */
function process_stripe_payment_failed($payment_intent) {
    error_log('Processing Stripe payment failed');
    
    if (!isset($payment_intent->id)) {
        error_log('Stripe payment intent ID missing');
        return;
    }
    
    $payment_intent_id = $payment_intent->id;
    error_log('Stripe payment failed - Payment Intent ID: ' . $payment_intent_id);
    
    // Order ID aus Stripe Payment Intent ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_stripe_payment_intent',
        'meta_value' => $payment_intent_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe payment intent ID: ' . $payment_intent_id);
        
        // Versuche über Metadaten zu finden, wenn vorhanden
        if (isset($payment_intent->metadata->order_id)) {
            $order_id = $payment_intent->metadata->order_id;
            error_log('Trying to find order by ID from metadata: ' . $order_id);
            $order = wc_get_order($order_id);
            
            if ($order) {
                $orders = array($order);
                error_log('Order found by ID from metadata');
            } else {
                error_log('Order not found by ID from metadata');
                return;
            }
        } else {
            error_log('No order ID in metadata');
            return;
        }
    }
    
    $order = $orders[0];
    
    // Fehlermeldung extrahieren
    $error_message = 'Zahlung fehlgeschlagen';
    
    if (isset($payment_intent->last_payment_error->message)) {
        $error_message = $payment_intent->last_payment_error->message;
    }
    
    error_log('Payment error message: ' . $error_message);
    
    // Bestellung als fehlgeschlagen markieren
    $order->update_status('failed', 'Stripe-Zahlung fehlgeschlagen: ' . $error_message);
    $order->save();
    error_log('Order ' . $order->get_id() . ' marked as failed');
}

/**
 * Stripe Rückerstattung verarbeiten
 */
function process_stripe_refund($charge) {
    error_log('Processing Stripe refund');
    
    if (!isset($charge->id)) {
        error_log('Stripe charge ID missing');
        return;
    }
    
    $charge_id = $charge->id;
    error_log('Stripe refund - Charge ID: ' . $charge_id);
    
    // Order ID aus Stripe Charge ID finden
    $orders = wc_get_orders(array(
        'meta_key' => '_transaction_id',
        'meta_value' => $charge_id,
        'limit' => 1
    ));
    
    if (empty($orders)) {
        error_log('No WooCommerce order found for Stripe charge ID: ' . $charge_id);
        
        // Alternative Suche nach Payment Intent ID
        if (isset($charge->payment_intent)) {
            error_log('Trying to find order by payment intent: ' . $charge->payment_intent);
            $orders = wc_get_orders(array(
                'meta_key' => '_stripe_payment_intent',
                'meta_value' => $charge->payment_intent,
                'limit' => 1
            ));
            
            if (empty($orders)) {
                error_log('No order found by payment intent either');
                return;
            }
        } else {
            return;
        }
    }
    
    $order = $orders[0];
    error_log('Order found: ' . $order->get_id());
    
    // Prüfen ob vollständige oder teilweise Rückerstattung
    $refunded_amount = $charge->amount_refunded;
    $total_amount = $charge->amount;
    
    error_log(sprintf('Refund amount: %s of %s', $refunded_amount, $total_amount));
    
    if ($refunded_amount === $total_amount) {
        // Vollständige Rückerstattung
        $order->update_status('refunded', 'Stripe Zahlung vollständig zurückerstattet.');
        error_log('Order fully refunded');
    } else {
        // Teilweise Rückerstattung
        $refund_note = sprintf(
            'Stripe Zahlung teilweise zurückerstattet: %s von %s',
            wc_price($refunded_amount / 100),
            wc_price($total_amount / 100)
        );
        $order->add_order_note($refund_note);
        error_log('Order partially refunded: ' . $refund_note);
        
        // WooCommerce Refund erstellen
        $refund_amount = wc_format_decimal($refunded_amount / 100);
        wc_create_refund(array(
            'order_id' => $order->get_id(),
            'amount' => $refund_amount,
            'reason' => 'Stripe Teilrückerstattung (Webhook)'
        ));
    }
    
    $order->save();
}

/**
 * Einstellungsseite für die Zahlungsintegration hinzufügen
 */
function yprint_payment_settings_menu() {
    add_options_page(
        'YPrint Zahlungseinstellungen',
        'YPrint Zahlungen',
        'manage_options',
        'yprint-payment-settings',
        'yprint_payment_settings_page'
    );
}
add_action('admin_menu', 'yprint_payment_settings_menu');

/**
 * Zahlungseinstellungen-Seite rendern
 */
function yprint_payment_settings_page() {
    // Einstellungen speichern
    if (isset($_POST['yprint_payment_settings_nonce']) && wp_verify_nonce($_POST['yprint_payment_settings_nonce'], 'yprint_payment_settings')) {
        // PayPal Einstellungen
        if (isset($_POST['yprint_paypal_client_id'])) {
            update_option('yprint_paypal_client_id', sanitize_text_field($_POST['yprint_paypal_client_id']));
        }
        
        if (isset($_POST['yprint_paypal_secret_key'])) {
            update_option('yprint_paypal_secret_key', sanitize_text_field($_POST['yprint_paypal_secret_key']));
        }
        
        if (isset($_POST['yprint_paypal_webhook_id'])) {
            update_option('yprint_paypal_webhook_id', sanitize_text_field($_POST['yprint_paypal_webhook_id']));
        }
        
        // Stripe Einstellungen
        if (isset($_POST['yprint_stripe_public_key'])) {
            update_option('yprint_stripe_public_key', sanitize_text_field($_POST['yprint_stripe_public_key']));
        }
        
        if (isset($_POST['yprint_stripe_secret_key'])) {
            update_option('yprint_stripe_secret_key', sanitize_text_field($_POST['yprint_stripe_secret_key']));
        }
        
        if (isset($_POST['yprint_stripe_webhook_secret'])) {
            update_option('yprint_stripe_webhook_secret', sanitize_text_field($_POST['yprint_stripe_webhook_secret']));
        }
        
        echo '<div class="updated"><p>Einstellungen gespeichert.</p></div>';
    }
    
// Aktuelle Werte abrufen
$paypal_client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
$paypal_secret_key = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
$paypal_webhook_id = get_option('yprint_paypal_webhook_id', '1AP621966T021942C');

$stripe_public_key = get_option('yprint_stripe_public_key', 'pk_live_51QomI4Efl8wKMoZvo59c44NsSuDkXqUtgvqg5qpTU5D7JmJf5XGfM8wNli25KpAAhrbPf2O0gjXNg3hWCtxpyG9G00Dxkv5oxL');
$stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
$stripe_webhook_secret = get_option('yprint_stripe_webhook_secret', 'whsec_vkmfKrTYzIgzgdxDLDRlp3qAryBSowFw');

// Webhook-URLs
$paypal_webhook_url = add_query_arg('yprint-paypal-webhook', '1', home_url('/'));
$stripe_webhook_url = add_query_arg('yprint-stripe-webhook', '1', home_url('/'));
    
    ?>
    <div class="wrap">
        <h1>YPrint Zahlungseinstellungen</h1>
        
        <form method="post" action="">
            <?php wp_nonce_field('yprint_payment_settings', 'yprint_payment_settings_nonce'); ?>
            
            <h2>PayPal Einstellungen</h2>
            <table class="form-table">
                <tr>
                    <th scope="row"><label for="yprint_paypal_client_id">Client ID</label></th>
                    <td>
                        <input type="text" id="yprint_paypal_client_id" name="yprint_paypal_client_id" 
                               value="<?php echo esc_attr($paypal_client_id); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_paypal_secret_key">Secret Key</label></th>
                    <td>
                        <input type="password" id="yprint_paypal_secret_key" name="yprint_paypal_secret_key" 
                               value="<?php echo esc_attr($paypal_secret_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_paypal_webhook_id">Webhook ID</label></th>
                    <td>
                        <input type="text" id="yprint_paypal_webhook_id" name="yprint_paypal_webhook_id" 
                               value="<?php echo esc_attr($paypal_webhook_id); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row">Webhook URL (für PayPal)</th>
                    <td>
                        <code><?php echo esc_url($paypal_webhook_url); ?></code>
                        <p class="description">Diese URL im PayPal Developer Dashboard als Webhook-URL eintragen.</p>
                    </td>
                </tr>
            </table>
            
            <h2>Stripe Einstellungen</h2>
            <table class="form-table">
                <tr>
                    <th scope="row"><label for="yprint_stripe_public_key">Public Key</label></th>
                    <td>
                        <input type="text" id="yprint_stripe_public_key" name="yprint_stripe_public_key" 
                               value="<?php echo esc_attr($stripe_public_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_stripe_secret_key">Secret Key</label></th>
                    <td>
                        <input type="password" id="yprint_stripe_secret_key" name="yprint_stripe_secret_key" 
                               value="<?php echo esc_attr($stripe_secret_key); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="yprint_stripe_webhook_secret">Webhook Secret</label></th>
                    <td>
                        <input type="password" id="yprint_stripe_webhook_secret" name="yprint_stripe_webhook_secret" 
                               value="<?php echo esc_attr($stripe_webhook_secret); ?>" class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th scope="row">Webhook URL (für Stripe)</th>
                    <td>
                        <code><?php echo esc_url($stripe_webhook_url); ?></code>
                        <p class="description">Diese URL im Stripe Dashboard als Webhook-URL eintragen.</p>
                    </td>
                </tr>
            </table>
            
            <p class="submit">
                <input type="submit" name="submit" id="submit" class="button button-primary" value="Einstellungen speichern">
            </p>
        </form>
    </div>
    <?php
}

/**
 * Erstelle Rückgabeseiten für Zahlungsprozesse
 */
function yprint_payment_return_endpoints() {
    // PayPal Rückgabeseite
    add_rewrite_rule(
        '^paypal-return/?$',
        'index.php?paypal_return=1',
        'top'
    );
    
    // Stripe Rückgabeseite
    add_rewrite_rule(
        '^stripe-return/?$',
        'index.php?stripe_return=1',
        'top'
    );
    
    // Query-Vars hinzufügen
    add_filter('query_vars', function($vars) {
        $vars[] = 'paypal_return';
        $vars[] = 'stripe_return';
        return $vars;
    });
    
    // Template für Rückgabeseiten laden
    add_action('template_redirect', function() {
        global $wp_query;
        
        if (isset($wp_query->query_vars['paypal_return']) && $wp_query->query_vars['paypal_return']) {
            include(dirname(__FILE__) . '/templates/paypal-return.php');
            exit;
        }
        
        if (isset($wp_query->query_vars['stripe_return']) && $wp_query->query_vars['stripe_return']) {
            include(dirname(__FILE__) . '/templates/stripe-return.php');
            exit;
        }
    });
}
add_action('init', 'yprint_payment_return_endpoints');

/**
 * Stelle sicher, dass die Rückgabeseiten-Templates existieren
 */
function yprint_create_payment_return_templates() {
    // PayPal-Rückgabeseite
    $paypal_template_path = dirname(__FILE__) . '/templates/paypal-return.php';
    if (!file_exists($paypal_template_path)) {
        // Ordner erstellen, falls nicht vorhanden
        if (!file_exists(dirname(__FILE__) . '/templates')) {
            mkdir(dirname(__FILE__) . '/templates', 0755, true);
        }
        
        // Template-Datei erstellen
        $paypal_template_content = '<?php
// Verhindere direkten Zugriff
if (!defined("ABSPATH")) exit;

// Order ID aus der Session abrufen
$order_id = WC()->session ? WC()->session->get("yprint_last_order_id") : 0;

// PayPal-Order ID aus URL abrufen
$paypal_order_id = isset($_GET["token"]) ? sanitize_text_field($_GET["token"]) : "";

// Prüfen, ob Benutzer abgebrochen hat
$canceled = isset($_GET["cancel"]) && $_GET["cancel"] === "true";

get_header();
?>

<div class="yprint-payment-return-container">
    <?php if ($canceled): ?>
        <div class="yprint-payment-message yprint-payment-error">
            <h2>Zahlung abgebrochen</h2>
            <p>Die PayPal-Zahlung wurde abgebrochen. Bitte versuchen Sie es erneut oder wählen Sie eine andere Zahlungsmethode.</p>
            <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
        </div>
    <?php else: ?>
        <div class="yprint-payment-message yprint-payment-success">
            <h2>Zahlung wird verarbeitet</h2>
            <p>Ihre PayPal-Zahlung wird verarbeitet. Bitte warten Sie einen Moment...</p>
            <div class="yprint-loader"></div>
        </div>
    <?php endif; ?>
</div>

<style>
.yprint-payment-return-container {
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    text-align: center;
}

.yprint-payment-message {
    padding: 30px;
    border-radius: 8px;
}

.yprint-payment-success {
    background-color: #f0f9ff;
    border: 1px solid #d1e7f7;
}

.yprint-payment-error {
    background-color: #fff2f2;
    border: 1px solid #ffcdd2;
}

.yprint-loader {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0079FF;
    border-radius: 50%;
    animation: yprint-spin 1s linear infinite;
    margin-top: 20px;
}

@keyframes yprint-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.yprint-return-button {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #0079FF;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}

.yprint-return-button:hover {
    background-color: #0068e1;
    color: white;
}
</style>

<script>
jQuery(document).ready(function($) {
    <?php if (!$canceled && !empty($paypal_order_id)): ?>
    // PayPal-Zahlung bestätigen
    $.ajax({
        type: "POST",
        url: "<?php echo admin_url("admin-ajax.php"); ?>",
        data: {
            action: "yprint_verify_paypal_return",
            paypal_order_id: "<?php echo esc_js($paypal_order_id); ?>",
            security: "<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>"
        },
        success: function(response) {
            if (response.success && response.data.redirect) {
                window.location.href = response.data.redirect;
            } else {
                // Fehler anzeigen
                $(".yprint-payment-message")
                    .removeClass("yprint-payment-success")
                    .addClass("yprint-payment-error")
                    .html(`
                        <h2>Fehler bei der Zahlung</h2>
                        <p>${response.data.message || "Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten."}</p>
                        <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                    `);
            }
        },
        error: function() {
            // Allgemeiner Fehler
            $(".yprint-payment-message")
                .removeClass("yprint-payment-success")
                .addClass("yprint-payment-error")
                .html(`
                    <h2>Fehler bei der Zahlung</h2>
                    <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
                    <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                `);
        }
    });
    <?php endif; ?>
});
</script>

<?php get_footer(); ?>';
        
        file_put_contents($paypal_template_path, $paypal_template_content);
    }
    
    // Stripe-Rückgabeseite
    $stripe_template_path = dirname(__FILE__) . '/templates/stripe-return.php';
    if (!file_exists($stripe_template_path)) {
        // Template-Datei erstellen
        $stripe_template_content = '<?php
// Verhindere direkten Zugriff
if (!defined("ABSPATH")) exit;

// Stripe-Parameter aus URL abrufen
$payment_intent = isset($_GET["payment_intent"]) ? sanitize_text_field($_GET["payment_intent"]) : "";
$payment_intent_client_secret = isset($_GET["payment_intent_client_secret"]) ? sanitize_text_field($_GET["payment_intent_client_secret"]) : "";
$redirect_status = isset($_GET["redirect_status"]) ? sanitize_text_field($_GET["redirect_status"]) : "";

get_header();
?>

<div class="yprint-payment-return-container">
    <div class="yprint-payment-message <?php echo $redirect_status === "succeeded" ? "yprint-payment-success" : "yprint-payment-error"; ?>">
        <?php if ($redirect_status === "succeeded"): ?>
            <h2>Zahlung erfolgreich</h2>
            <p>Ihre Zahlung wurde erfolgreich verarbeitet. Sie werden in Kürze weitergeleitet...</p>
            <div class="yprint-loader"></div>
        <?php else: ?>
            <h2>Zahlung nicht abgeschlossen</h2>
            <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
            <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
        <?php endif; ?>
    </div>
</div>

<style>
.yprint-payment-return-container {
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    text-align: center;
}

.yprint-payment-message {
    padding: 30px;
    border-radius: 8px;
}

.yprint-payment-success {
    background-color: #f0f9ff;
    border: 1px solid #d1e7f7;
}

.yprint-payment-error {
    background-color: #fff2f2;
    border: 1px solid #ffcdd2;
}

.yprint-loader {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0079FF;
    border-radius: 50%;
    animation: yprint-spin 1s linear infinite;
    margin-top: 20px;
}

@keyframes yprint-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.yprint-return-button {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #0079FF;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}

.yprint-return-button:hover {
    background-color: #0068e1;
    color: white;
}
</style>

<script>
jQuery(document).ready(function($) {
    <?php if ($redirect_status === "succeeded" && !empty($payment_intent)): ?>
    // Stripe-Zahlung bestätigen
    $.ajax({
        type: "POST",
        url: "<?php echo admin_url("admin-ajax.php"); ?>",
        data: {
            action: "yprint_verify_stripe_return",
            payment_intent: "<?php echo esc_js($payment_intent); ?>",
            client_secret: "<?php echo esc_js($payment_intent_client_secret); ?>",
            security: "<?php echo wp_create_nonce("yprint-checkout-nonce"); ?>"
        },
        success: function(response) {
            if (response.success && response.data.redirect) {
                window.location.href = response.data.redirect;
            } else {
                // Fehler anzeigen
                $(".yprint-payment-message")
                    .removeClass("yprint-payment-success")
                    .addClass("yprint-payment-error")
                    .html(`
                        <h2>Fehler bei der Zahlung</h2>
                        <p>${response.data.message || "Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten."}</p>
                        <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                    `);
            }
        },
        error: function() {
            // Allgemeiner Fehler
            $(".yprint-payment-message")
                .removeClass("yprint-payment-success")
                .addClass("yprint-payment-error")
                .html(`
                    <h2>Fehler bei der Zahlung</h2>
                    <p>Bei der Verarbeitung Ihrer Zahlung ist ein Fehler aufgetreten.</p>
                    <a href="<?php echo esc_url(wc_get_checkout_url()); ?>" class="yprint-return-button">Zurück zum Checkout</a>
                `);
        }
    });
    <?php endif; ?>
});
</script>

<?php get_footer(); ?>';
        
        file_put_contents($stripe_template_path, $stripe_template_content);
    }
}
add_action('init', 'yprint_create_payment_return_templates');

/**
 * AJAX-Handler für die Überprüfung von PayPal-Rückgaben
 */
function yprint_verify_paypal_return() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || empty($_POST['paypal_order_id'])) {
        wp_send_json_error(array(
            'message' => 'PayPal Order ID fehlt'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    
    try {
        // Order ID aus PayPal-Order ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_paypal_order_id',
            'meta_value' => $paypal_order_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            throw new Exception('Keine zugehörige Bestellung gefunden');
        }
        
        $order = $orders[0];
        
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // PayPal Order Status abrufen
        $request = new \PayPalCheckoutSdk\Orders\OrdersGetRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 200) {
            $paypal_status = $response->result->status;
            
            if ($paypal_status === 'COMPLETED' || $paypal_status === 'APPROVED') {
                // Bei APPROVED versuchen, die Zahlung zu erfassen
                if ($paypal_status === 'APPROVED') {
                    $capture_request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
                    $capture_response = $provider->execute($capture_request);
                    
                    if ($capture_response->statusCode !== 201) {
                        throw new Exception('Fehler bei der Zahlungserfassung');
                    }
                    
                    // Transaktions-ID extrahieren
                    $transaction_id = isset($capture_response->result->purchase_units[0]->payments->captures[0]->id)
                        ? $capture_response->result->purchase_units[0]->payments->captures[0]->id
                        : '';
                } else {
                    // Bei COMPLETED die Transaktions-ID aus der Antwort extrahieren
                    $transaction_id = isset($response->result->purchase_units[0]->payments->captures[0]->id)
                        ? $response->result->purchase_units[0]->payments->captures[0]->id
                        : '';
                }
                
                // Bestellung aktualisieren
                if (!$order->is_paid()) {
                    $order->payment_complete($transaction_id);
                    $order->add_order_note('PayPal-Zahlung abgeschlossen (Transaktion ID: ' . $transaction_id . ')');
                    $order->save();
                }
                
                // Warenkorb leeren
                WC()->cart->empty_cart();
                
                wp_send_json_success(array(
                    'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
                ));
            } else {
                throw new Exception('PayPal-Status ist nicht COMPLETED oder APPROVED: ' . $paypal_status);
            }
        } else {
            throw new Exception('Fehler beim Abrufen des PayPal-Status');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Verify Return Error: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Verarbeitung der PayPal-Zahlung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_verify_paypal_return', 'yprint_verify_paypal_return');
add_action('wp_ajax_nopriv_yprint_verify_paypal_return', 'yprint_verify_paypal_return');

/**
 * AJAX-Handler für die Überprüfung von Stripe-Rückgaben
 */
function yprint_verify_stripe_return() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['payment_intent']) || empty($_POST['payment_intent'])) {
        wp_send_json_error(array(
            'message' => 'Payment Intent ID fehlt'
        ));
        return;
    }
    
    $payment_intent_id = sanitize_text_field($_POST['payment_intent']);
    
    try {
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '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');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Payment Intent Status prüfen
        $response = \WC_Stripe_API::retrieve('payment_intents/' . $payment_intent_id);
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        // Order ID aus Stripe Payment Intent ID finden
        $orders = wc_get_orders(array(
            'meta_key' => '_stripe_payment_intent',
            'meta_value' => $payment_intent_id,
            'limit' => 1
        ));
        
        if (empty($orders)) {
            throw new Exception('Keine zugehörige Bestellung gefunden');
        }
        
        $order = $orders[0];
        
        // Prüfen, ob Zahlung erfolgreich war
        if ($response->status !== 'succeeded') {
            throw new Exception('Zahlung wurde nicht erfolgreich abgeschlossen (Status: ' . $response->status . ')');
        }
        
        // Bestellung aktualisieren
        if (!$order->is_paid()) {
            // Charge ID extrahieren
            $charge_id = isset($response->charges->data[0]->id) ? $response->charges->data[0]->id : $payment_intent_id;
            
            $order->payment_complete($charge_id);
            $order->add_order_note('Stripe-Zahlung abgeschlossen (Charge ID: ' . $charge_id . ')');
            $order->save();
        }
        
        // Warenkorb leeren
        WC()->cart->empty_cart();
        
        wp_send_json_success(array(
            'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Verify Return Error: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Verarbeitung der Stripe-Zahlung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_verify_stripe_return', 'yprint_verify_stripe_return');
add_action('wp_ajax_nopriv_yprint_verify_stripe_return', 'yprint_verify_stripe_return');

/**
 * WordPress und WooCommerce Hooks beim Aktivieren aktualisieren
 */
function yprint_payment_activation() {
    // Rewrite-Regeln aktualisieren
    flush_rewrite_rules();
    
    // Prüfen, ob erforderliche Plugins aktiviert sind
    if (!is_plugin_active('woocommerce/woocommerce.php')) {
        deactivate_plugins(plugin_basename(__FILE__));
        wp_die('Dieses Plugin benötigt WooCommerce, um zu funktionieren. Bitte installieren und aktivieren Sie WooCommerce zuerst.');
    }
    
    // Erstellen und überprüfen Sie die Webhook-Ordner und Templates
    yprint_create_payment_return_templates();
}
register_activation_hook(__FILE__, 'yprint_payment_activation');

/**
 * AJAX-Handler für die Vorbereitung einer Bestellung
 */
function yprint_prepare_order() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    
    // Temporäre Bestellung erstellen (aber noch nicht finalisieren)
    try {
        $temp_order_id = yprint_create_temp_order($checkout_data, 'pending');
        
        if ($temp_order_id) {
            // Order ID in Session speichern
            if (function_exists('WC') && WC()->session) {
                WC()->session->set('yprint_temp_order_id', $temp_order_id);
            }
            
            wp_send_json_success(array(
                'temp_order_id' => $temp_order_id,
                'message' => 'Bestellung vorbereitet'
            ));
        } else {
            wp_send_json_error(array(
                'message' => 'Fehler bei der Vorbereitung der Bestellung'
            ));
        }
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_prepare_order', 'yprint_prepare_order');
add_action('wp_ajax_nopriv_yprint_prepare_order', 'yprint_prepare_order');

/**
 * AJAX-Handler für die Finalisierung einer Bestellung nach erfolgreicher Zahlung
 */
function yprint_finalize_order() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['temp_order_id']) || empty($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Keine Bestellungs-ID angegeben'
        ));
        return;
    }
    
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_id = isset($_POST['payment_id']) ? sanitize_text_field($_POST['payment_id']) : '';
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    // Bestellung abrufen
    $order = wc_get_order($temp_order_id);
    
    if (!$order) {
        wp_send_json_error(array(
            'message' => 'Bestellung konnte nicht gefunden werden'
        ));
        return;
    }
    
    try {
        // Zahlungsinformationen speichern
        if (!empty($payment_id)) {
            $order->set_transaction_id($payment_id);
            update_post_meta($temp_order_id, '_payment_transaction_id', $payment_id);
        }
        
        if (!empty($payment_method)) {
            update_post_meta($temp_order_id, '_payment_method', $payment_method);
            $order->set_payment_method($payment_method);
            $order->set_payment_method_title(yprint_get_payment_method_title($payment_method));
        }
        
        // Bestellung als bezahlt markieren, außer bei Überweisung
        if (strpos($payment_method, 'bacs') !== false || strpos($payment_method, 'bank') !== false) {
            // Bei Überweisung: Status auf "on-hold" setzen
            $order->update_status('on-hold', __('Warte auf Zahlungseingang via Überweisung.', 'yprint'));
        } else {
            // Bei anderen Zahlungsmethoden: als bezahlt markieren
            $order->payment_complete($payment_id);
        }
        
        // Notiz hinzufügen
        $order->add_order_note(__('Zahlung erfolgreich verarbeitet.', 'yprint'));
        
        // Kundendaten speichern, wenn angemeldet
        $user_id = get_current_user_id();
        if ($user_id > 0) {
            $order->set_customer_id($user_id);
        }
        
        // Bestellung speichern
        $order->save();
        
        // Warenkorb leeren
        WC()->cart->empty_cart();
        
        // Erfolg melden
        wp_send_json_success(array(
            'order_id' => $temp_order_id,
            'redirect' => 'https://yprint.de/thank-you/' // Oder $order->get_checkout_order_received_url()
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der Finalisierung der Bestellung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_finalize_order', 'yprint_finalize_order');
add_action('wp_ajax_nopriv_yprint_finalize_order', 'yprint_finalize_order');

/**
 * Modifizierte PayPal Initialisierung
 */
 

 /**
 * Modifizierte PayPal Payment Capture für Checkout
 */
function yprint_capture_checkout_paypal_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['paypal_order_id']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Zahlungsinformationen'
        ));
        return;
    }
    
    $paypal_order_id = sanitize_text_field($_POST['paypal_order_id']);
    $temp_order_id = intval($_POST['temp_order_id']);
    
    try {
        // PayPal-Client initialisieren
        require_once ABSPATH . 'wp-content/plugins/woocommerce-paypal-payments/vendor/autoload.php';
        
        $client_id = get_option('yprint_paypal_client_id', 'AWKnm3nbPgIo3KXZbs-vjQPjSWOYy6LiFGQ6zn_nJ7XlW9LldJ8OjKuxbbLzK7UTE2xETV9sz43qzhpB');
        $client_secret = get_option('yprint_paypal_secret_key', 'EDZRCOs170tjF5v2CFfw7giWsnTvjgLSbodtsgbAXee13AdigXiZPqF_0HU8BqlRnJVAigVtgKke8mY9');
        
        $environment = 'production'; // oder 'sandbox' für Testumgebung
        
        // PayPal SDK initialisieren
        $provider = new \PayPalCheckoutSdk\Core\PayPalHttpClient(
            $environment === 'production'
                ? new \PayPalCheckoutSdk\Core\ProductionEnvironment($client_id, $client_secret)
                : new \PayPalCheckoutSdk\Core\SandboxEnvironment($client_id, $client_secret)
        );
        
        // Zahlung erfassen
        $request = new \PayPalCheckoutSdk\Orders\OrdersCaptureRequest($paypal_order_id);
        $response = $provider->execute($request);
        
        if ($response->statusCode === 201 || $response->statusCode === 200) {
            // Transaktions-ID extrahieren
            $transaction_id = isset($response->result->purchase_units[0]->payments->captures[0]->id)
                ? $response->result->purchase_units[0]->payments->captures[0]->id
                : $paypal_order_id;
            
            // Status und Transaktions-ID in Order Meta speichern
            update_post_meta($temp_order_id, '_paypal_payment_status', 'COMPLETED');
            update_post_meta($temp_order_id, '_paypal_transaction_id', $transaction_id);
            
            wp_send_json_success(array(
                'message' => 'Zahlung erfolgreich erfasst',
                'transaction_id' => $transaction_id
            ));
        } else {
            throw new Exception('Fehler bei der Zahlungserfassung');
        }
    } catch (Exception $e) {
        error_log('YPrint PayPal Capture Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungserfassung: ' . $e->getMessage()
        ));
    }
}

/**
 * Modifizierte Stripe Initialisierung
 */
function yprint_init_stripe_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || empty($_POST['checkout_data'])) {
        wp_send_json_error(array(
            'message' => 'Keine Checkout-Daten vorhanden'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = isset($_POST['temp_order_id']) ? intval($_POST['temp_order_id']) : 0;
    
    try {
        // Prüfen, ob wir eine vorbereitete Bestellung haben
        if (!$temp_order_id) {
            wp_send_json_error(array(
                'message' => 'Keine temporäre Bestellungs-ID vorhanden'
            ));
            return;
        }
        
        // Bestellung abrufen
        $order = wc_get_order($temp_order_id);
        
        if (!$order) {
            wp_send_json_error(array(
                'message' => 'Bestellung konnte nicht gefunden werden'
            ));
            return;
        }
        
        // Stripe-API einbinden
        require_once ABSPATH . 'wp-content/plugins/woocommerce-gateway-stripe/includes/class-wc-stripe-api.php';
        
        $stripe_secret_key = get_option('yprint_stripe_secret_key', '');
        
        // API-Key setzen
        \WC_Stripe_API::set_secret_key($stripe_secret_key);
        
        // Kundenadresse
        $customer_info = array(
            'address' => array(
                'line1' => $order->get_billing_address_1(),
                'line2' => $order->get_billing_address_2(),
                'city' => $order->get_billing_city(),
                'postal_code' => $order->get_billing_postcode(),
                'country' => $order->get_billing_country()
            ),
            'email' => $order->get_billing_email(),
            'name' => $order->get_formatted_billing_full_name(),
            'phone' => $order->get_billing_phone()
        );
        
        // Währung abrufen
        $currency = strtolower(get_woocommerce_currency());
        
        // Betrag in Cents/Kleinsten Einheiten
        $amount = intval($order->get_total() * 100);
        
        // Stripe Payment Intent erstellen
        $payment_intent_args = array(
            'amount' => $amount,
            'currency' => $currency,
            'payment_method_types' => ['card'],
            'description' => 'Bestellung #' . $order->get_order_number() . ' auf YPrint',
            'metadata' => array(
                'order_id' => $temp_order_id,
                'customer_name' => $customer_info['name'],
                'customer_email' => $customer_info['email']
            ),
            'receipt_email' => $customer_info['email']
        );
        
        // Stripe API aufrufen
        $response = \WC_Stripe_API::request($payment_intent_args, 'payment_intents');
        
        if (!empty($response->error)) {
            throw new Exception($response->error->message);
        }
        
        if (empty($response->id) || empty($response->client_secret)) {
            throw new Exception('Ungültige Antwort von Stripe');
        }
        
        // Payment Intent ID in Order Meta speichern
        update_post_meta($temp_order_id, '_stripe_payment_intent', $response->id);
        
        wp_send_json_success(array(
            'client_secret' => $response->client_secret,
            'payment_intent_id' => $response->id,
            'temp_order_id' => $temp_order_id
        ));
    } catch (Exception $e) {
        error_log('YPrint Stripe Fehler: ' . $e->getMessage());
        
        wp_send_json_error(array(
            'message' => 'Fehler bei der Stripe-Initialisierung: ' . $e->getMessage()
        ));
    }
}

 

/**
 * AJAX-Handler für SEPA-Zahlungsverarbeitung
 */
function yprint_process_sepa_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Daten'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    try {
        // Hier würde die echte SEPA-Verarbeitung stattfinden
        // Für dieses Beispiel generieren wir nur eine eindeutige ID
        $payment_id = 'sepa_' . time() . '_' . rand(1000, 9999);
        
        // Zahlungsdaten in Order Meta speichern
        update_post_meta($temp_order_id, '_sepa_payment_id', $payment_id);
        update_post_meta($temp_order_id, '_payment_method', $payment_method);
        
        wp_send_json_success(array(
            'payment_id' => $payment_id,
            'message' => 'SEPA-Zahlung erfolgreich verarbeitet'
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der SEPA-Zahlungsverarbeitung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_process_sepa_payment', 'yprint_process_sepa_payment');
add_action('wp_ajax_nopriv_yprint_process_sepa_payment', 'yprint_process_sepa_payment');

/**
 * AJAX-Handler für Standard-Zahlungsverarbeitung
 */
function yprint_process_standard_payment() {
    check_ajax_referer('yprint-checkout-nonce', 'security');
    
    if (!isset($_POST['checkout_data']) || !isset($_POST['temp_order_id'])) {
        wp_send_json_error(array(
            'message' => 'Fehlende Daten'
        ));
        return;
    }
    
    $checkout_data = $_POST['checkout_data'];
    $temp_order_id = intval($_POST['temp_order_id']);
    $payment_method = isset($_POST['payment_method']) ? sanitize_text_field($_POST['payment_method']) : '';
    
    try {
        // Hier würde die echte Zahlungsverarbeitung stattfinden
        // Für dieses Beispiel generieren wir nur eine eindeutige ID
        $payment_id = 'standard_' . time() . '_' . rand(1000, 9999);
        
        // Zahlungsdaten in Order Meta speichern
        update_post_meta($temp_order_id, '_standard_payment_id', $payment_id);
        update_post_meta($temp_order_id, '_payment_method', $payment_method);
        
        wp_send_json_success(array(
            'payment_id' => $payment_id,
            'message' => 'Zahlung erfolgreich verarbeitet'
        ));
    } catch (Exception $e) {
        wp_send_json_error(array(
            'message' => 'Fehler bei der Zahlungsverarbeitung: ' . $e->getMessage()
        ));
    }
}
add_action('wp_ajax_yprint_process_standard_payment', 'yprint_process_standard_payment');
add_action('wp_ajax_nopriv_yprint_process_standard_payment', 'yprint_process_standard_payment');

// AJAX-Handler für die umbenannte Funktion registrieren
add_action('wp_ajax_yprint_capture_checkout_paypal_payment', 'yprint_capture_checkout_paypal_payment');
add_action('wp_ajax_nopriv_yprint_capture_checkout_paypal_payment', 'yprint_capture_checkout_paypal_payment');

/**
 * Modifizierte Funktion zum Erstellen einer temporären WooCommerce-Bestellung
 */
function yprint_create_temp_order($checkout_data, $status = 'pending') {
    try {
        // Neues WooCommerce Order-Objekt erstellen
        $order = wc_create_order();
        
        // Benutzer zuweisen, falls angemeldet
        $user_id = get_current_user_id();
        if ($user_id > 0) {
            $order->set_customer_id($user_id);
        }
        
        // Warenkorb-Produkte zur Bestellung hinzufügen
        foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
            $product = $cart_item['data'];
            $quantity = $cart_item['quantity'];
            
            // Produkt zur Bestellung hinzufügen
            $order->add_product($product, $quantity);
        }
        
        // Shipping-Methode hinzufügen
        if (WC()->session && WC()->session->get('chosen_shipping_methods')) {
            $chosen_shipping_methods = WC()->session->get('chosen_shipping_methods');
            $shipping_rate = new WC_Shipping_Rate('flat_rate', 'Versand', WC()->cart->get_shipping_total(), array(), 'flat_rate');
            $order->add_shipping($shipping_rate);
        }
        
        // Adressen setzen
        if (isset($checkout_data['shipping_address'])) {
            $order->set_shipping_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_shipping_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_shipping_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_shipping_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_shipping_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_shipping_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_shipping_country($checkout_data['shipping_address']['country'] ?? 'DE');
        }
        
        // Billing-Adresse setzen (entweder von different_billing oder von shipping kopieren)
        if (isset($checkout_data['different_billing']) && ($checkout_data['different_billing'] === true || $checkout_data['different_billing'] === 'true' || $checkout_data['different_billing'] === 1 || $checkout_data['different_billing'] === '1') && isset($checkout_data['different_billing_address'])) {
            $order->set_billing_first_name($checkout_data['different_billing_address']['different_billing_first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['different_billing_address']['different_billing_last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['different_billing_address']['different_billing_address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['different_billing_address']['different_billing_address_2'] ?? '');
            $order->set_billing_city($checkout_data['different_billing_address']['different_billing_city'] ?? '');
            $order->set_billing_postcode($checkout_data['different_billing_address']['different_billing_postcode'] ?? '');
            $order->set_billing_country($checkout_data['different_billing_address']['different_billing_country'] ?? 'DE');
            $order->set_billing_email($checkout_data['different_billing_address']['different_billing_email'] ?? '');
        } else if (isset($checkout_data['shipping_address'])) {
            $order->set_billing_first_name($checkout_data['shipping_address']['first_name'] ?? '');
            $order->set_billing_last_name($checkout_data['shipping_address']['last_name'] ?? '');
            $order->set_billing_address_1($checkout_data['shipping_address']['address_1'] ?? '');
            $order->set_billing_address_2($checkout_data['shipping_address']['address_2'] ?? '');
            $order->set_billing_city($checkout_data['shipping_address']['city'] ?? '');
            $order->set_billing_postcode($checkout_data['shipping_address']['postcode'] ?? '');
            $order->set_billing_country($checkout_data['shipping_address']['country'] ?? 'DE');
            
            // E-Mail-Adresse aus Benutzeraccount oder Session
            if ($user_id > 0) {
                $user = get_userdata($user_id);
                $order->set_billing_email($user->user_email);
            } else if (WC()->session && WC()->session->get('customer') && WC()->session->get('customer')['email']) {
                $order->set_billing_email(WC()->session->get('customer')['email']);
            }
        }
        
        // Zahlungsmethode setzen
        if (isset($checkout_data['payment_method'])) {
            $order->set_payment_method($checkout_data['payment_method']);
            $order->set_payment_method_title(yprint_get_payment_method_title($checkout_data['payment_method']));
        }
        
        // Gutschein anwenden, falls vorhanden
        if (isset($checkout_data['coupon_code']) && !empty($checkout_data['coupon_code'])) {
            $coupon_code = sanitize_text_field($checkout_data['coupon_code']);
            $coupon = new WC_Coupon($coupon_code);
            
            if ($coupon->is_valid()) {
                $order->apply_coupon($coupon_code);
            }
        }
        
        // Bestellung speichern mit dem gewünschten Status
        $order->calculate_totals();
        $order->update_status($status, 'Temporäre Bestellung erstellt für Zahlungsverarbeitung.');
        
        // Meta-Tag hinzufügen, um temporäre Bestellungen zu kennzeichnen
        update_post_meta($order->get_id(), '_yprint_temp_order', 'yes');
        
        // Bestellungs-ID zurückgeben
        return $order->get_id();
    } catch (Exception $e) {
        error_log('YPrint Checkout - Fehler bei temporärer Bestellerstellung: ' . $e->getMessage());
        return false;
    }
}

// -----------------------------------------------------------------------------------------------------------------

/**
 * YPrint Einheitliches Benutzerprofil-System
 * 
 * Vereint Personal, Billing und Shipping Settings in einem modularen System
 * mit konsistenter UI und synchronisierten Daten.
 */

// Verhindern direkter Aufrufe
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Hauptshortcode für die gesamte Einstellungsseite
 */
function yprint_user_settings_shortcode() {
    ob_start();
    
    // Aktuelle Ansicht ermitteln (Standard: 'personal')
    $current_tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'personal';
    
    // Nachricht verarbeiten, wenn vorhanden
    $message = isset($_GET['message']) ? sanitize_text_field($_GET['message']) : '';
    $message_type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : 'info';
    
    if ($message) {
        echo '<div class="yprint-message yprint-message-' . esc_attr($message_type) . '">';
        echo esc_html($message);
        echo '</div>';
    }
    
    // Tabs definieren
    $tabs = array(
        'personal' => 'Persönliche Daten',
        'billing' => 'Rechnungsdaten',
        'shipping' => 'Lieferadresse',
    );
    
    // Desktop Tabs-Navigation anzeigen
echo '<div class="yprint-settings-tabs">';
foreach ($tabs as $tab_id => $tab_name) {
    $active_class = ($current_tab === $tab_id) ? ' active' : '';
    echo '<a href="?tab=' . esc_attr($tab_id) . '" class="yprint-tab' . esc_attr($active_class) . '">' . esc_html($tab_name) . '</a>';
}
echo '</div>';

// Mobile Dropdown-Navigation anzeigen
echo '<div class="yprint-mobile-tabs">';
echo '<select class="yprint-mobile-select" id="yprint-mobile-tab-select">';
foreach ($tabs as $tab_id => $tab_name) {
    $selected = ($current_tab === $tab_id) ? ' selected' : '';
    echo '<option value="' . esc_attr($tab_id) . '"' . $selected . '>' . esc_html($tab_name) . '</option>';
}
echo '</select>';
echo '</div>';

// JavaScript für Tab-Navigation
echo '<script>
jQuery(document).ready(function($) {
    // Mobile Tab Selection Handler
    $("#yprint-mobile-tab-select").on("change", function() {
        var selectedTab = $(this).val();
        window.location.href = window.location.pathname + "?tab=" + selectedTab;
    });
    
    // URL-Parameter auslesen und Tab entsprechend setzen
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
    
    var tabParam = getParameterByName("tab");
    if (tabParam) {
        // Desktop-Tabs
        $(".yprint-tab").removeClass("active");
        $(".yprint-tab[href=\"?tab=" + tabParam + "\"]").addClass("active");
        
        // Mobile-Dropdown
        $("#yprint-mobile-tab-select").val(tabParam);
    }
});
</script>';
    
    // Inhalt des aktiven Tabs anzeigen
    echo '<div class="yprint-settings-content">';
    
    // Jeweils passenden Shortcode einfügen
    switch ($current_tab) {
        case 'personal':
            echo do_shortcode('[yprint_personal_settings]');
            break;
        case 'billing':
            echo do_shortcode('[yprint_billing_settings]');
            break;
        case 'shipping':
            echo do_shortcode('[yprint_shipping_settings]');
            break;
    }
    
    echo '</div>';
    
    // CSS einbinden
    echo yprint_settings_styles();
    
    return ob_get_clean();
}
add_shortcode('yprint_user_settings', 'yprint_user_settings_shortcode');

/**
 * Gemeinsame Styles für alle Einstellungs-Tabs
 */
function yprint_settings_styles() {
    ob_start();
    ?>
    <style>
        /* Gemeinsame Styles für Einstellungsseiten */
        .yprint-settings-page {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 0;
        }
        
        .yprint-settings-tabs {
    display: flex;
    border-bottom: 1px solid #eaeaea;
    margin-bottom: 30px;
}

.yprint-tab {
    padding: 12px 20px;
    color: #1d1d1f;
    text-decoration: none;
    font-weight: 500;
    position: relative;
    transition: color 0.2s ease;
    margin-right: 10px;
}

.yprint-tab:hover {
    color: #2997FF;
}

.yprint-tab.active {
    color: #2997FF;
}

.yprint-tab.active:after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #2997FF;
}

.yprint-mobile-tabs {
    display: none;
    margin-bottom: 30px;
}

.yprint-mobile-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #DFDFDF;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #FFF;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }

.yprint-mobile-select:focus {
    border-color: #2997FF;
    box-shadow: 0 0 0 2px rgba(41, 151, 255, 0.1);
    outline: none;
}
        
        .yprint-settings-content {
            padding: 30px 0;
        }
        
        .yprint-settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .yprint-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .yprint-form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .yprint-form-row > div {
            flex: 1;
        }
        
        .yprint-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.95rem;
        }
        
        @media (max-width: 768px) {
    .yprint-form-input,
    .yprint-form-select,
    .yprint-mobile-select {
        border-color: #DFDFDF !important;
    }
    
    .yprint-form-row {
        flex-direction: column;
    }
    
    .yprint-settings-content {
        padding: 15px;
    }
    
    .yprint-settings-tabs {
        display: none;
    }
    
    .yprint-mobile-tabs {
        display: block;
    }
}

        .yprint-form-input,
        .yprint-form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #DFDFDF;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #FFF;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .yprint-form-select {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 40px;
        }
        
        .yprint-form-input:focus,
        .yprint-form-select:focus {
            border-color: #2997FF;
            box-shadow: 0 0 0 2px rgba(41, 151, 255, 0.1);
            outline: none;
        }
        
        .yprint-form-input:hover,
        .yprint-form-select:hover {
            border-color: #DFDFDF;
        }
        
        .yprint-checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .yprint-checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .yprint-checkbox-group label {
            line-height: 1.4;
            color: #1d1d1f;
        }
        
        .yprint-conditional-fields {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f5f5f7;
        }
        
        .yprint-button {
            background-color: transparent;
            color: #2997FF;
            padding: 12px 24px;
            border: 1px solid #2997FF;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-align: center;
            display: inline-block;
        }
        
        .yprint-button:hover {
            background-color: #2997FF;
            color: #FFF;
        }
        
        .yprint-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .yprint-message-success {
            background-color: #E8F5E9;
            border-left: 4px solid #4CAF50;
            color: #2E7D32;
        }
        
        .yprint-message-error {
            background-color: #FFEBEE;
            border-left: 4px solid #F44336;
            color: #C62828;
        }
        
        .yprint-message-info {
            background-color: #E3F2FD;
            border-left: 4px solid #2196F3;
            color: #1565C0;
        }
        
        /* Address Autocomplete Styling */
        .yprint-address-search {
            position: relative;
        }
        
        .yprint-address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #D1D1D6;
            border-radius: 6px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .yprint-address-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f7;
        }
        
        .yprint-address-suggestion:last-child {
            border-bottom: none;
        }
        
        .yprint-address-suggestion:hover {
            background-color: #f8f9fa;
        }
        
        .yprint-suggestion-main {
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .yprint-suggestion-secondary {
            font-size: 0.85rem;
            color: #6e6e73;
        }
        
        .yprint-loader {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #2997FF;
            width: 20px;
            height: 20px;
            animation: yprint-spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        
        @keyframes yprint-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
    .yprint-form-row {
        flex-direction: column;
    }
    
    .yprint-settings-content {
    padding: 30px 0;
    }
    
    .yprint-settings-tabs {
        display: none;
    }
    
    .yprint-mobile-tabs {
        display: block;
    }
    @media (max-width: 768px) {
    .yprint-settings-content {
        padding-top: 0;
    }
}
}
    </style>
    <?php
    return ob_get_clean();
}

/**
 * Persönliche Einstellungen Shortcode 
 */
function yprint_personal_settings_shortcode() {
    ob_start();
    global $wpdb;
    $user_id = get_current_user_id();
    $current_user = wp_get_current_user();
    $message = '';
    $message_type = '';
    
    // Daten aus der Datenbank abrufen
    $user_data = $wpdb->get_row(
        $wpdb->prepare(
            "SELECT * FROM personal_data WHERE user_id = %d",
            $user_id
        ),
        ARRAY_A
    );

    // Standardwerte festlegen
    $first_name = isset($user_data['first_name']) ? esc_attr($user_data['first_name']) : '';
    $last_name = isset($user_data['last_name']) ? esc_attr($user_data['last_name']) : '';
    $birthdate = isset($user_data['birthdate']) ? esc_attr($user_data['birthdate']) : '';
    $current_email = $current_user->user_email;

    // Formular-Verarbeitung
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['personal_settings_nonce']) && 
        wp_verify_nonce($_POST['personal_settings_nonce'], 'save_personal_settings')) {
        
        $email_changed = false;
        $needs_logout = false;
        
        // E-Mail-Änderung verarbeiten
        if (isset($_POST['email']) && !empty($_POST['email'])) {
            $new_email = sanitize_email($_POST['email']);
            
            if ($new_email !== $current_email) {
                // Prüfen, ob die E-Mail bereits existiert
                if (email_exists($new_email)) {
                    $message = 'Diese E-Mail-Adresse wird bereits verwendet.';
                    $message_type = 'error';
                } else {
                    $email_update = wp_update_user([
                        'ID' => $user_id,
                        'user_email' => $new_email
                    ]);
                    
                    if (!is_wp_error($email_update)) {
                        // E-Mail-Verifizierung zurücksetzen
                        $wpdb->query($wpdb->prepare(
                            "UPDATE wp_email_verifications 
                            SET email_verified = 0, 
                                updated_at = NOW() 
                            WHERE user_id = %d",
                            $user_id
                        ));
                        
                        $email_changed = true;
                        $needs_logout = true;
                    } else {
                        $message = 'Fehler beim Ändern der E-Mail-Adresse.';
                        $message_type = 'error';
                    }
                }
            }
        }

        // Persönliche Daten verarbeiten
        $fields_to_update = [];
        
        if (isset($_POST['first_name']) && !empty($_POST['first_name'])) {
            $fields_to_update['first_name'] = sanitize_text_field($_POST['first_name']);
            
            // Auch WooCommerce Billing/Shipping First Name aktualisieren
            update_user_meta($user_id, 'billing_first_name', $fields_to_update['first_name']);
            update_user_meta($user_id, 'shipping_first_name', $fields_to_update['first_name']);
        }
        
        if (isset($_POST['last_name']) && !empty($_POST['last_name'])) {
            $fields_to_update['last_name'] = sanitize_text_field($_POST['last_name']);
            
            // Auch WooCommerce Billing/Shipping Last Name aktualisieren
            update_user_meta($user_id, 'billing_last_name', $fields_to_update['last_name']);
            update_user_meta($user_id, 'shipping_last_name', $fields_to_update['last_name']);
        }
        
        if (isset($_POST['birthdate']) && !empty($_POST['birthdate'])) {
            $fields_to_update['birthdate'] = sanitize_text_field($_POST['birthdate']);
        }

        if (!empty($fields_to_update)) {
            if ($user_data) {
                $update_result = $wpdb->update(
                    'personal_data',
                    $fields_to_update,
                    ['user_id' => $user_id]
                );
            } else {
                $fields_to_update['user_id'] = $user_id;
                $update_result = $wpdb->insert('personal_data', $fields_to_update);
            }
            
            $message = 'Deine persönlichen Daten wurden erfolgreich gespeichert.';
            $message_type = 'success';
        }
        
        // Wenn E-Mail geändert, Logout-Overlay anzeigen
        if ($needs_logout && $email_changed) {
            ?>
            <div id="emailChangeOverlay" class="yprint-overlay">
                <div class="yprint-overlay-content">
                    <h3>E-Mail-Adresse wird geändert</h3>
                    <div class="yprint-loader" style="display: block;"></div>
                    <p>Sie werden nun ausgeloggt und zum Login weitergeleitet.</p>
                    <p>Bitte loggen Sie sich mit Ihrer neuen E-Mail-Adresse ein.</p>
                </div>
            </div>
            
            <script>
            jQuery(document).ready(function($) {
                // Force logout und Weiterleitung
                function forceLogoutAndRedirect() {
                    // Overlay anzeigen
                    $('#emailChangeOverlay').css('display', 'flex');
                    
                    // Forced Logout via AJAX
                    $.ajax({
                        url: '<?php echo admin_url('admin-ajax.php'); ?>',
                        type: 'POST',
                        data: {
                            action: 'custom_force_logout',
                            security: '<?php echo wp_create_nonce('force_logout_nonce'); ?>'
                        },
                        success: function() {
                            // Nach kurzer Verzögerung weiterleiten
                            setTimeout(function() {
                                window.location.href = 'https://yprint.de/login';
                            }, 2000);
                        },
                        error: function() {
                            // Bei AJAX-Fehler trotzdem weiterleiten
                            window.location.href = 'https://yprint.de/login';
                        }
                    });
                }
                
                // Logout-Funktion aufrufen
                forceLogoutAndRedirect();
            });
            </script>
            <?php
        }
    }
    
    // Formular ausgeben
    ?>
    <div class="yprint-settings-page">
        
        <?php if ($message): ?>
        <div class="yprint-message yprint-message-<?php echo esc_attr($message_type); ?>">
            <?php echo esc_html($message); ?>
        </div>
        <?php endif; ?>
        
        <form method="POST" class="yprint-settings-form" id="personal-settings-form">
            <?php wp_nonce_field('save_personal_settings', 'personal_settings_nonce'); ?>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="first_name" class="yprint-form-label">Vorname</label>
                    <input type="text" 
                           id="first_name" 
                           name="first_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($first_name); ?>" 
                           placeholder="Vorname">
                </div>
                
                <div class="yprint-form-group">
                    <label for="last_name" class="yprint-form-label">Nachname</label>
                    <input type="text" 
                           id="last_name" 
                           name="last_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($last_name); ?>" 
                           placeholder="Nachname">
                </div>
            </div>
            
            <div class="yprint-form-group">
                <label for="birthdate" class="yprint-form-label">Geburtsdatum</label>
                <input type="date" 
                       id="birthdate" 
                       name="birthdate" 
                       class="yprint-form-input" 
                       value="<?php echo esc_attr($birthdate); ?>">
            </div>
            
            <div class="yprint-form-group">
                <label for="email" class="yprint-form-label">E-Mail-Adresse</label>
                <input type="email" 
                       id="email" 
                       name="email" 
                       class="yprint-form-input" 
                       value="<?php echo esc_attr($current_email); ?>" 
                       placeholder="E-Mail-Adresse">
                <div class="yprint-field-hint" id="email-change-warning" style="display: none; margin-top: 8px; color: #2997FF; font-size: 0.9rem;">
                    Wenn du deine E-Mail-Adresse änderst, wirst du ausgeloggt und musst dich mit der neuen Adresse wieder einloggen.
                </div>
            </div>
            
            <div>
                <button type="submit" class="yprint-button">Speichern</button>
            </div>
        </form>
    </div>
    
    <script>
    jQuery(document).ready(function($) {
        var originalEmail = '<?php echo esc_js($current_email); ?>';
        var emailInput = $('#email');
        var emailWarning = $('#email-change-warning');
        
        // Warnung anzeigen, wenn E-Mail geändert wird
        emailInput.on('input', function() {
            if ($(this).val() !== originalEmail) {
                emailWarning.slideDown();
            } else {
                emailWarning.slideUp();
            }
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_personal_settings', 'yprint_personal_settings_shortcode');

/**
 * Rechnungsdaten Shortcode
 */
function yprint_billing_settings_shortcode() {
    ob_start();
    
    // Aktuelle Benutzerdaten abrufen
    $user_id = get_current_user_id();
    $message = '';
    $message_type = '';
    
    // WooCommerce Billing Felder abrufen
    $billing_first_name = get_user_meta($user_id, 'billing_first_name', true);
    $billing_last_name = get_user_meta($user_id, 'billing_last_name', true);
    $billing_company = get_user_meta($user_id, 'billing_company', true);
    $billing_vat = get_user_meta($user_id, 'billing_vat', true);
    $billing_address_1 = get_user_meta($user_id, 'billing_address_1', true);
    $billing_address_2 = get_user_meta($user_id, 'billing_address_2', true);
    $billing_postcode = get_user_meta($user_id, 'billing_postcode', true);
    $billing_city = get_user_meta($user_id, 'billing_city', true);
    $billing_country = get_user_meta($user_id, 'billing_country', true) ?: 'DE';
    $alt_billing_email = get_user_meta($user_id, 'alt_billing_email', true);
    $is_company = get_user_meta($user_id, 'is_company', true);

    // Formular-Verarbeitung
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['billing_settings_nonce']) && 
        wp_verify_nonce($_POST['billing_settings_nonce'], 'save_billing_settings')) {
        
        $updated = false;
        $email_changed = false;
        
        // Standardfelder aktualisieren
        $fields_to_update = [
            'billing_first_name' => isset($_POST['billing_first_name']) ? sanitize_text_field($_POST['billing_first_name']) : '',
            'billing_last_name' => isset($_POST['billing_last_name']) ? sanitize_text_field($_POST['billing_last_name']) : '',
            'billing_address_1' => isset($_POST['billing_address_1']) ? sanitize_text_field($_POST['billing_address_1']) : '',
            'billing_address_2' => isset($_POST['billing_address_2']) ? sanitize_text_field($_POST['billing_address_2']) : '',
            'billing_postcode' => isset($_POST['billing_postcode']) ? sanitize_text_field($_POST['billing_postcode']) : '',
            'billing_city' => isset($_POST['billing_city']) ? sanitize_text_field($_POST['billing_city']) : '',
            'billing_country' => isset($_POST['billing_country']) ? sanitize_text_field($_POST['billing_country']) : 'DE',
        ];

        // Unternehmensdaten aktualisieren
        $is_company = isset($_POST['is_company']);
        update_user_meta($user_id, 'is_company', $is_company);
        
        if ($is_company) {
            $fields_to_update['billing_company'] = isset($_POST['billing_company']) ? sanitize_text_field($_POST['billing_company']) : '';
            $fields_to_update['billing_vat'] = isset($_POST['billing_vat']) ? sanitize_text_field($_POST['billing_vat']) : '';
        }

        // Alternative Rechnungs-E-Mail
        if (isset($_POST['different_billing_email']) && $_POST['different_billing_email'] === 'on') {
            if (isset($_POST['alt_billing_email']) && !empty($_POST['alt_billing_email'])) {
                $new_billing_email = sanitize_email($_POST['alt_billing_email']);
                $old_billing_email = get_user_meta($user_id, 'alt_billing_email', true);
                
                if ($new_billing_email !== $old_billing_email) {
                    // Verifizierungs-Token generieren
                    $verification_token = wp_generate_password(32, false);
                    update_user_meta($user_id, 'billing_email_verification_token', $verification_token);
                    
                    // E-Mail an neue Rechnungs-E-Mail senden
$verification_link = add_query_arg(
    array(
        'action' => 'reject_billing_email',
        'token' => $verification_token,
        'user_id' => $user_id
    ),
    home_url()
);

$user = get_userdata($user_id);
$message_content = sprintf(
    'Die E-Mail-Adresse %s wurde als Empfänger für Rechnungen von %s bei YPrint eingetragen.<br><br>
    Falls Sie diese Änderung nicht veranlasst haben oder nicht möchten, klicken Sie bitte hier:<br><br>
    <a href="%s" style="display: inline-block; padding: 10px 20px; background-color: #2997FF; color: white; text-decoration: none; border-radius: 5px;">Diese Einstellung ablehnen</a>',
    $new_billing_email,
    $user->display_name,
    esc_url($verification_link)
);
$message = yprint_get_email_template('Bestätigung: Rechnungsempfänger', 'Hallo', $message_content);

                    $headers = array('Content-Type: text/html; charset=UTF-8');
                    wp_mail($new_billing_email, 'Bestätigung: Rechnungsempfänger bei YPrint', $message_content, $headers);
                    
                    update_user_meta($user_id, 'alt_billing_email', $new_billing_email);
                    update_user_meta($user_id, 'billing_email', $new_billing_email);
                    $email_changed = true;
                }
            }
        } else {
            // Wenn die Checkbox nicht ausgewählt ist, alternative E-Mail entfernen
            delete_user_meta($user_id, 'alt_billing_email');
            $user = get_userdata($user_id);
            update_user_meta($user_id, 'billing_email', $user->user_email);
        }

        // WooCommerce Metadaten aktualisieren
        foreach ($fields_to_update as $key => $value) {
            update_user_meta($user_id, $key, $value);
        }
        
        $message = 'Deine Rechnungsdaten wurden erfolgreich gespeichert.';
        $message_type = 'success';
        
        // Redirect um die URL sauber zu halten und Formular-Resubmit zu verhindern
        if (!$email_changed) {
            wp_redirect(add_query_arg(
                array(
                    'tab' => 'billing',
                    'message' => urlencode($message),
                    'type' => $message_type
                ),
                remove_query_arg(array('message', 'type'))
            ));
            exit;
        }
    }
    
    // Formular ausgeben
    ?>
    <div class="yprint-settings-page">
        
        <?php if ($message): ?>
        <div class="yprint-message yprint-message-<?php echo esc_attr($message_type); ?>">
            <?php echo esc_html($message); ?>
        </div>
        <?php endif; ?>
        
        <!-- Email Change Overlay -->
        <div id="emailChangeOverlay" class="yprint-overlay" style="display: none;">
            <div class="yprint-overlay-content">
                <h3>Rechnungs-E-Mail wurde geändert</h3>
                <p>Eine Bestätigungs-E-Mail wurde an die neue Adresse gesendet.</p>
            </div>
        </div>
        
        <form method="POST" class="yprint-settings-form" id="billing-settings-form">
            <?php wp_nonce_field('save_billing_settings', 'billing_settings_nonce'); ?>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="billing_first_name" class="yprint-form-label">Vorname</label>
                    <input type="text" 
                           id="billing_first_name" 
                           name="billing_first_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_first_name); ?>" 
                           placeholder="Vorname" 
                           required>
                </div>
                <div class="yprint-form-group">
                    <label for="billing_last_name" class="yprint-form-label">Nachname</label>
                    <input type="text" 
                           id="billing_last_name" 
                           name="billing_last_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_last_name); ?>" 
                           placeholder="Nachname" 
                           required>
                </div>
            </div>
            
            <!-- Unternehmensdaten -->
            <div class="yprint-checkbox-group">
                <input type="checkbox" 
                       id="is_company" 
                       name="is_company" 
                       <?php checked($is_company, true); ?>>
                <label for="is_company">Ich bin Unternehmer</label>
            </div>
            
            <div id="company_fields" class="yprint-conditional-fields" <?php echo $is_company ? 'style="display: block;"' : 'style="display: none;"'; ?>>
                <div class="yprint-form-row">
                    <div class="yprint-form-group">
                        <label for="billing_company" class="yprint-form-label">Unternehmensname</label>
                        <input type="text" 
                               id="billing_company" 
                               name="billing_company" 
                               class="yprint-form-input" 
                               value="<?php echo esc_attr($billing_company); ?>" 
                               placeholder="Unternehmensname">
                    </div>
                    
                    <div class="yprint-form-group">
                        <label for="billing_vat" class="yprint-form-label">USt.-ID</label>
                        <input type="text" 
                               id="billing_vat" 
                               name="billing_vat" 
                               class="yprint-form-input" 
                               value="<?php echo esc_attr($billing_vat); ?>" 
                               placeholder="USt.-ID">
                    </div>
                </div>
            </div>
            
            <!-- Adressdaten mit Adresssuche -->
            <div class="yprint-form-group yprint-address-search">
                <label for="address_search_billing" class="yprint-form-label">Adresse suchen</label>
                <input type="text" 
                       id="address_search_billing" 
                       class="yprint-form-input" 
                       placeholder="Adresse eingeben...">
                <div id="billing_address_loader" class="yprint-loader"></div>
                <div id="billing_address_suggestions" class="yprint-address-suggestions"></div>
            </div>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="billing_address_1" class="yprint-form-label">Straße</label>
                    <input type="text" 
                           id="billing_address_1" 
                           name="billing_address_1" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_address_1); ?>" 
                           placeholder="Straße" 
                           required>
                </div>
                
                <div class="yprint-form-group">
                    <label for="billing_address_2" class="yprint-form-label">Hausnummer</label>
                    <input type="text" 
                           id="billing_address_2" 
                           name="billing_address_2" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_address_2); ?>" 
                           placeholder="Hausnummer" 
                           required>
                </div>
            </div>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="billing_postcode" class="yprint-form-label">PLZ</label>
                    <input type="text" 
                           id="billing_postcode" 
                           name="billing_postcode" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_postcode); ?>" 
                           placeholder="PLZ" 
                           required>
                </div>
                
                <div class="yprint-form-group">
                    <label for="billing_city" class="yprint-form-label">Stadt</label>
                    <input type="text" 
                           id="billing_city" 
                           name="billing_city" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($billing_city); ?>" 
                           placeholder="Stadt" 
                           required>
                </div>
            </div>
            
            <div class="yprint-form-group">
                <label for="billing_country" class="yprint-form-label">Land</label>
                <select id="billing_country" 
                        name="billing_country" 
                        class="yprint-form-select" 
                        required>
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_countries();
                    foreach ($countries as $code => $name) {
                        $selected = ($billing_country === $code) ? 'selected' : '';
                        echo '<option value="' . esc_attr($code) . '" ' . $selected . '>' . esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
            
            <!-- Alternative Rechnungs-E-Mail -->
            <div class="yprint-checkbox-group">
                <input type="checkbox" 
                       id="different_billing_email" 
                       name="different_billing_email" 
                       <?php checked(!empty($alt_billing_email), true); ?>>
                <label for="different_billing_email">Abweichende E-Mail für Rechnungen</label>
            </div>
            
            <div id="different_billing_email_field" class="yprint-conditional-fields" 
                 <?php echo !empty($alt_billing_email) ? 'style="display: block;"' : 'style="display: none;"'; ?>>
                <div class="yprint-form-group">
                    <label for="alt_billing_email" class="yprint-form-label">E-Mail für Rechnungen</label>
                    <input type="email" 
                           id="alt_billing_email" 
                           name="alt_billing_email" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($alt_billing_email); ?>" 
                           placeholder="E-Mail für Rechnungen">
                </div>
            </div>
            
            <div>
                <button type="submit" class="yprint-button">Speichern</button>
            </div>
        </form>
    </div>
    
    <script>
    jQuery(document).ready(function($) {
        // HERE API Initialisierung
        const API_KEY = 'xPlTGXIrjg1O6Oea3e2gvo5lrN-iO1gT47Sc-VojWdU';
        
        // Unternehmerfeld Toggle
        $('#is_company').change(function() {
            if (this.checked) {
                $('#company_fields').slideDown(300);
            } else {
                $('#company_fields').slideUp(300);
            }
        });

        // Alternative Rechnungs-E-Mail Toggle
        $('#different_billing_email').change(function() {
            if (this.checked) {
                $('#different_billing_email_field').slideDown(300);
            } else {
                $('#different_billing_email_field').slideUp(300);
                $('#alt_billing_email').val('');
            }
        });

        <?php if (isset($email_changed) && $email_changed): ?>
        // Overlay anzeigen
        $('#emailChangeOverlay').css('display', 'flex');
        
        // Nach 3 Sekunden ausblenden
        setTimeout(function() {
            $('#emailChangeOverlay').fadeOut();
        }, 3000);
        <?php endif; ?>
        
        // Erfolgsbenachrichtigung nach 3 Sekunden ausblenden
        setTimeout(function() {
            $('.yprint-message').fadeOut();
        }, 3000);
        
        // Adresssuche für Rechnungsadresse
        setupAddressSearch('billing');
        
        // Adresssuche-Funktion
        function setupAddressSearch(prefix) {
            let searchTimeout;
            $(`#address_search_${prefix}`).on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val();
                
                $(`#${prefix}_address_loader`).hide();
                
                if (query.length < 3) {
                    $(`#${prefix}_address_suggestions`).hide();
                    return;
                }

                $(`#${prefix}_address_loader`).show();

                searchTimeout = setTimeout(function() {
                    $.ajax({
                        url: 'https://geocode.search.hereapi.com/v1/geocode',
                        data: {
                            q: query,
                            apiKey: API_KEY,
                            limit: 5,
                            lang: 'de',
                            in: 'countryCode:DEU,AUT'
                        },
                        type: 'GET',
                        success: function(data) {
                            $(`#${prefix}_address_loader`).hide();
                            const $suggestions = $(`#${prefix}_address_suggestions`);
                            $suggestions.empty();

                            if (data && data.items && data.items.length > 0) {
                                data.items.forEach(function(item) {
                                    const address = item.address;
                                    
                                    // Hauptadresszeile
                                    const mainLine = [
                                        address.street,
                                        address.houseNumber,
                                        address.postalCode,
                                        address.city
                                    ].filter(Boolean).join(' ');

                                    // Zusätzliche Informationen
                                    const secondaryLine = [
                                        address.district,
                                        address.state,
                                        address.countryName
                                    ].filter(Boolean).join(', ');

                                    const $suggestion = $('<div>').addClass('yprint-address-suggestion')
                                        .append($('<div>').addClass('yprint-suggestion-main').text(mainLine))
                                        .append($('<div>').addClass('yprint-suggestion-secondary').text(secondaryLine))
                                        .data('address', address);

                                    $suggestion.on('click', function() {
                                        const address = $(this).data('address');
                                        
                                        // Straße und Hausnummer trennen
                                        const street = address.street || '';
                                        const houseNumber = address.houseNumber || '';
                                        
                                        // Felder befüllen
                                        $(`#${prefix}_address_1`).val(street);
                                        $(`#${prefix}_address_2`).val(houseNumber);
                                        $(`#${prefix}_postcode`).val(address.postalCode || '');
                                        $(`#${prefix}_city`).val(address.city || '');
                                        
                                        // Land setzen
                                        if (address.countryCode) {
                                            const countryCode = address.countryCode.toUpperCase();
                                            $(`#${prefix}_country`).val(countryCode);
                                        }

                                        $suggestions.hide();
                                        $(`#address_search_${prefix}`).val('');
                                    });

                                    $suggestions.append($suggestion);
                                });

                                $suggestions.show();
                            }
                        },
                        error: function(xhr, status, error) {
                            $(`#${prefix}_address_loader`).hide();
                            console.error('Fehler bei der Adresssuche:', error);
                        }
                    });
                }, 500);
            });
            
            // Klick außerhalb schließt Vorschläge
            $(document).on('click', function(e) {
                if (!$(e.target).closest(`#address_search_${prefix}, #${prefix}_address_suggestions`).length) {
                    $(`#${prefix}_address_suggestions`).hide();
                }
            });
        }
    });
    </script>
    <?php
    
    return ob_get_clean();
}
add_shortcode('yprint_billing_settings', 'yprint_billing_settings_shortcode');

/**
 * Lieferadresse Settings Shortcode
 */
function yprint_shipping_settings_shortcode() {
    ob_start();
    
    // Aktuelle Benutzerdaten abrufen
    $user_id = get_current_user_id();
    $message = '';
    $message_type = '';
    
    // WooCommerce Shipping Felder abrufen
    $shipping_first_name = get_user_meta($user_id, 'shipping_first_name', true);
    $shipping_last_name = get_user_meta($user_id, 'shipping_last_name', true);
    $shipping_company = get_user_meta($user_id, 'shipping_company', true);
    $shipping_address_1 = get_user_meta($user_id, 'shipping_address_1', true);
    $shipping_address_2 = get_user_meta($user_id, 'shipping_address_2', true);
    $shipping_postcode = get_user_meta($user_id, 'shipping_postcode', true);
    $shipping_city = get_user_meta($user_id, 'shipping_city', true);
    $shipping_country = get_user_meta($user_id, 'shipping_country', true) ?: 'DE';
    $is_company_shipping = get_user_meta($user_id, 'is_company_shipping', true);
    
    // Wenn Firma in Rechnungsdaten gesetzt ist, auch hier vorschlagen
    $billing_company = get_user_meta($user_id, 'billing_company', true);
    $is_company_billing = get_user_meta($user_id, 'is_company', true);

    // Formular-Verarbeitung
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['shipping_settings_nonce']) && 
        wp_verify_nonce($_POST['shipping_settings_nonce'], 'save_shipping_settings')) {
        
        // Standardfelder aktualisieren
        $fields_to_update = [
            'shipping_first_name' => isset($_POST['shipping_first_name']) ? sanitize_text_field($_POST['shipping_first_name']) : '',
            'shipping_last_name' => isset($_POST['shipping_last_name']) ? sanitize_text_field($_POST['shipping_last_name']) : '',
            'shipping_address_1' => isset($_POST['shipping_address_1']) ? sanitize_text_field($_POST['shipping_address_1']) : '',
            'shipping_address_2' => isset($_POST['shipping_address_2']) ? sanitize_text_field($_POST['shipping_address_2']) : '',
            'shipping_postcode' => isset($_POST['shipping_postcode']) ? sanitize_text_field($_POST['shipping_postcode']) : '',
            'shipping_city' => isset($_POST['shipping_city']) ? sanitize_text_field($_POST['shipping_city']) : '',
            'shipping_country' => isset($_POST['shipping_country']) ? sanitize_text_field($_POST['shipping_country']) : 'DE',
        ];

        // Unternehmensdaten aktualisieren
        $is_company_shipping = isset($_POST['is_company_shipping']);
        update_user_meta($user_id, 'is_company_shipping', $is_company_shipping);
        
        if ($is_company_shipping) {
            $fields_to_update['shipping_company'] = isset($_POST['shipping_company']) ? sanitize_text_field($_POST['shipping_company']) : '';
        }

        // WooCommerce Metadaten aktualisieren
        foreach ($fields_to_update as $key => $value) {
            update_user_meta($user_id, $key, $value);
        }
        
        $message = 'Deine Lieferadresse wurde erfolgreich gespeichert.';
        $message_type = 'success';
        
        // Redirect um die URL sauber zu halten und Formular-Resubmit zu verhindern
        wp_redirect(add_query_arg(
            array(
                'tab' => 'shipping',
                'message' => urlencode($message),
                'type' => $message_type
            ),
            remove_query_arg(array('message', 'type'))
        ));
        exit;
    }
    
    // Formular ausgeben
    ?>
    <div class="yprint-settings-page">
        
        <?php if ($message): ?>
        <div class="yprint-message yprint-message-<?php echo esc_attr($message_type); ?>">
            <?php echo esc_html($message); ?>
        </div>
        <?php endif; ?>
        
        <div class="yprint-info-message" style="background-color: #E3F2FD; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9rem; border-left: 4px solid #2196F3; color: #0D47A1;">
            <p style="margin: 0;">Hier kannst du deine Standard-Lieferadresse hinterlegen. Im Bestellprozess hast du weiterhin die Möglichkeit, eine abweichende Lieferadresse anzugeben.</p>
        </div>
        
        <form method="POST" class="yprint-settings-form" id="shipping-settings-form">
            <?php wp_nonce_field('save_shipping_settings', 'shipping_settings_nonce'); ?>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="shipping_first_name" class="yprint-form-label">Vorname</label>
                    <input type="text" 
                           id="shipping_first_name" 
                           name="shipping_first_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_first_name); ?>" 
                           placeholder="Vorname" 
                           required>
                </div>
                
                <div class="yprint-form-group">
                    <label for="shipping_last_name" class="yprint-form-label">Nachname</label>
                    <input type="text" 
                           id="shipping_last_name" 
                           name="shipping_last_name" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_last_name); ?>" 
                           placeholder="Nachname" 
                           required>
                </div>
            </div>
            
            <!-- Unternehmensdaten -->
            <div class="yprint-checkbox-group">
                <input type="checkbox" 
                       id="is_company_shipping" 
                       name="is_company_shipping" 
                       <?php checked($is_company_shipping, true); ?>>
                <label for="is_company_shipping">Lieferung an Firma</label>
            </div>
            
            <div id="company_shipping_fields" class="yprint-conditional-fields" <?php echo $is_company_shipping ? 'style="display: block;"' : 'style="display: none;"'; ?>>
                <div class="yprint-form-group">
                    <label for="shipping_company" class="yprint-form-label">Firmenname</label>
                    <input type="text" 
                           id="shipping_company" 
                           name="shipping_company" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_company); ?>" 
                           placeholder="Firmenname">
                    <?php if ($is_company_billing && $billing_company): ?>
                    <div class="yprint-company-suggestion" style="margin-top: 8px; font-size: 0.9rem;">
                        <a href="#" id="use-billing-company" style="color: #2997FF; text-decoration: none;">
                            '<?php echo esc_html($billing_company); ?>' aus Rechnungsdaten übernehmen
                        </a>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            
            <!-- Adressdaten mit Adresssuche -->
            <div class="yprint-form-group yprint-address-search">
                <label for="address_search_shipping" class="yprint-form-label">Adresse suchen</label>
                <input type="text" 
                       id="address_search_shipping" 
                       class="yprint-form-input" 
                       placeholder="Adresse eingeben...">
                <div id="shipping_address_loader" class="yprint-loader"></div>
                <div id="shipping_address_suggestions" class="yprint-address-suggestions"></div>
            </div>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="shipping_address_1" class="yprint-form-label">Straße</label>
                    <input type="text" 
                           id="shipping_address_1" 
                           name="shipping_address_1" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_address_1); ?>" 
                           placeholder="Straße" 
                           required>
                </div>
                
                <div class="yprint-form-group">
                    <label for="shipping_address_2" class="yprint-form-label">Hausnummer</label>
                    <input type="text" 
                           id="shipping_address_2" 
                           name="shipping_address_2" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_address_2); ?>" 
                           placeholder="Hausnummer" 
                           required>
                </div>
            </div>
            
            <div class="yprint-form-row">
                <div class="yprint-form-group">
                    <label for="shipping_postcode" class="yprint-form-label">PLZ</label>
                    <input type="text" 
                           id="shipping_postcode" 
                           name="shipping_postcode" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_postcode); ?>" 
                           placeholder="PLZ" 
                           required>
                </div>
                
                <div class="yprint-form-group">
                    <label for="shipping_city" class="yprint-form-label">Stadt</label>
                    <input type="text" 
                           id="shipping_city" 
                           name="shipping_city" 
                           class="yprint-form-input" 
                           value="<?php echo esc_attr($shipping_city); ?>" 
                           placeholder="Stadt" 
                           required>
                </div>
            </div>
            
            <div class="yprint-form-group">
                <label for="shipping_country" class="yprint-form-label">Land</label>
                <select id="shipping_country" 
                        name="shipping_country" 
                        class="yprint-form-select" 
                        required>
                    <?php
                    $countries_obj = new WC_Countries();
                    $countries = $countries_obj->get_shipping_countries();
                    foreach ($countries as $code => $name) {
                        $selected = ($shipping_country === $code) ? 'selected' : '';
                        echo '<option value="' . esc_attr($code) . '" ' . $selected . '>' . esc_html($name) . '</option>';
                    }
                    ?>
                </select>
            </div>
            
            <div>
                <button type="submit" class="yprint-button">Speichern</button>
            </div>
        </form>
    </div>
    
    <script>
    jQuery(document).ready(function($) {
        // HERE API Initialisierung
        const API_KEY = 'xPlTGXIrjg1O6Oea3e2gvo5lrN-iO1gT47Sc-VojWdU';
        
        // Unternehmerfeld Toggle
        $('#is_company_shipping').change(function() {
            if (this.checked) {
                $('#company_shipping_fields').slideDown(300);
            } else {
                $('#company_shipping_fields').slideUp(300);
            }
        });
        
        // Firmennamen aus Rechnungsdaten übernehmen
        $('#use-billing-company').click(function(e) {
            e.preventDefault();
            $('#shipping_company').val('<?php echo esc_js($billing_company); ?>');
        });

        // Erfolgsbenachrichtigung nach 3 Sekunden ausblenden
        setTimeout(function() {
            $('.yprint-message').fadeOut();
        }, 3000);
        
        // Adresssuche für Lieferadresse
        setupAddressSearch('shipping');
        
        // Adresssuche-Funktion
        function setupAddressSearch(prefix) {
            let searchTimeout;
            $(`#address_search_${prefix}`).on('input', function() {
                clearTimeout(searchTimeout);
                const query = $(this).val();
                
                $(`#${prefix}_address_loader`).hide();
                
                if (query.length < 3) {
                    $(`#${prefix}_address_suggestions`).hide();
                    return;
                }

                $(`#${prefix}_address_loader`).show();

                searchTimeout = setTimeout(function() {
                    $.ajax({
                        url: 'https://geocode.search.hereapi.com/v1/geocode',
                        data: {
                            q: query,
                            apiKey: API_KEY,
                            limit: 5,
                            lang: 'de',
                            in: 'countryCode:DEU,AUT'
                        },
                        type: 'GET',
                        success: function(data) {
                            $(`#${prefix}_address_loader`).hide();
                            const $suggestions = $(`#${prefix}_address_suggestions`);
                            $suggestions.empty();

                            if (data && data.items && data.items.length > 0) {
                                data.items.forEach(function(item) {
                                    const address = item.address;
                                    
                                    // Hauptadresszeile
                                    const mainLine = [
                                        address.street,
                                        address.houseNumber,
                                        address.postalCode,
                                        address.city
                                    ].filter(Boolean).join(' ');

                                    // Zusätzliche Informationen
                                    const secondaryLine = [
                                        address.district,
                                        address.state,
                                        address.countryName
                                    ].filter(Boolean).join(', ');

                                    const $suggestion = $('<div>').addClass('yprint-address-suggestion')
                                        .append($('<div>').addClass('yprint-suggestion-main').text(mainLine))
                                        .append($('<div>').addClass('yprint-suggestion-secondary').text(secondaryLine))
                                        .data('address', address);

                                    $suggestion.on('click', function() {
                                        const address = $(this).data('address');
                                        
                                        // Straße und Hausnummer trennen
                                        const street = address.street || '';
                                        const houseNumber = address.houseNumber || '';
                                        
                                        // Felder befüllen
                                        $(`#${prefix}_address_1`).val(street);
                                        $(`#${prefix}_address_2`).val(houseNumber);
                                        $(`#${prefix}_postcode`).val(address.postalCode || '');
                                        $(`#${prefix}_city`).val(address.city || '');
                                        
                                        // Land setzen
                                        if (address.countryCode) {
                                            const countryCode = address.countryCode.toUpperCase();
                                            $(`#${prefix}_country`).val(countryCode);
                                        }

                                        $suggestions.hide();
                                        $(`#address_search_${prefix}`).val('');
                                    });

                                    $suggestions.append($suggestion);
                                });

                                $suggestions.show();
                            }
                        },
                        error: function(xhr, status, error) {
                            $(`#${prefix}_address_loader`).hide();
                            console.error('Fehler bei der Adresssuche:', error);
                        }
                    });
                }, 500);
            });
            
            // Klick außerhalb schließt Vorschläge
            $(document).on('click', function(e) {
                if (!$(e.target).closest(`#address_search_${prefix}, #${prefix}_address_suggestions`).length) {
                    $(`#${prefix}_address_suggestions`).hide();
                }
            });
        }
    });
    </script>
    <?php
    
    // CSS einbinden
echo yprint_settings_styles();

// CSS einbinden
echo yprint_settings_styles();

return ob_get_clean();

}
add_shortcode('yprint_shipping_settings', 'yprint_shipping_settings_shortcode');

/**
 * Optimierungen für den Checkout-Prozess
 * - Integration der Benutzereinstellungen in den Checkout
 * - Automatische Vorauswahl für Deutschland
 */

/**
 * Standard-Land für neue Benutzer setzen
 */
function yprint_set_default_country($user_id) {
    // Standard-Land auf DE setzen, wenn noch nicht vorhanden
    if (!get_user_meta($user_id, 'billing_country', true)) {
        update_user_meta($user_id, 'billing_country', 'DE');
    }
    
    if (!get_user_meta($user_id, 'shipping_country', true)) {
        update_user_meta($user_id, 'shipping_country', 'DE');
    }
}
add_action('user_register', 'yprint_set_default_country');

/**
 * Integriere Einstellungen mit WooCommerce Checkout - Übertrage die verschiedenen Felder
 */
function yprint_checkout_load_user_data($checkout_fields) {
    if (!is_user_logged_in()) {
        // Für nicht eingeloggte Benutzer Standard-Land setzen
        $checkout_fields['billing']['billing_country']['default'] = 'DE';
        $checkout_fields['shipping']['shipping_country']['default'] = 'DE';
        return $checkout_fields;
    }
    
    $user_id = get_current_user_id();
    
    // Unternehmereinstellungen abrufen
    $is_company = get_user_meta($user_id, 'is_company', true);
    $is_company_shipping = get_user_meta($user_id, 'is_company_shipping', true);
    
    // WooCommerce-Checkout um unsere angepassten Felder ergänzen
    if ($is_company) {
        $checkout_fields['billing']['billing_company']['required'] = true;
        
        // USt-ID Feld hinzufügen, falls noch nicht vorhanden
        if (!isset($checkout_fields['billing']['billing_vat'])) {
            $checkout_fields['billing']['billing_vat'] = array(
                'label'     => 'USt.-ID',
                'required'  => false,
                'class'     => array('form-row-wide'),
                'clear'     => true
            );
        }
    }
    
    // Firmenfeld für Lieferadresse anpassen
    if ($is_company_shipping) {
        $checkout_fields['shipping']['shipping_company']['required'] = true;
    }
    
    return $checkout_fields;
}
add_filter('woocommerce_checkout_fields', 'yprint_checkout_load_user_data');

/**
 * Gleiche Firmendaten für Lieferadresse übernehmen, wenn angehakt
 */
function yprint_copy_billing_company_to_shipping() {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    
    $is_company = get_user_meta($user_id, 'is_company', true);
    $is_company_shipping = get_user_meta($user_id, 'is_company_shipping', true);
    
    if ($is_company && $is_company_shipping) {
        $billing_company = get_user_meta($user_id, 'billing_company', true);
        $shipping_company = get_user_meta($user_id, 'shipping_company', true);
        
        // Wenn Lieferfirma leer ist aber Rechnungsfirma existiert, übernehmen
        if (empty($shipping_company) && !empty($billing_company)) {
            update_user_meta($user_id, 'shipping_company', $billing_company);
        }
    }
}
add_action('woocommerce_before_checkout_form', 'yprint_copy_billing_company_to_shipping');

/**
 * USt-ID im Checkout anzeigen und speichern
 */
function yprint_checkout_vat_field($checkout) {
    $user_id = get_current_user_id();
    $is_company = get_user_meta($user_id, 'is_company', true);
    $billing_vat = get_user_meta($user_id, 'billing_vat', true);
    
    // Nur anzeigen, wenn Unternehmerstatus gesetzt ist
    if ($is_company) {
        echo '<div id="vat_number_field">';
        
        woocommerce_form_field('billing_vat', array(
            'type'        => 'text',
            'class'       => array('form-row-wide'),
            'label'       => 'USt.-ID',
            'placeholder' => 'DE123456789',
            'required'    => false,
            'default'     => $billing_vat,
        ), $checkout->get_value('billing_vat'));
        
        echo '</div>';
    }
}
add_action('woocommerce_after_checkout_billing_form', 'yprint_checkout_vat_field');

/**
 * Speichert die USt-ID bei der Bestellung
 */
function yprint_save_vat_with_order($order_id) {
    if (isset($_POST['billing_vat']) && !empty($_POST['billing_vat'])) {
        $vat_number = sanitize_text_field($_POST['billing_vat']);
        update_post_meta($order_id, '_billing_vat', $vat_number);
        
        // Auch im Kundenprofil speichern, wenn eingeloggt
        if (is_user_logged_in()) {
            update_user_meta(get_current_user_id(), 'billing_vat', $vat_number);
        }
    }
}
add_action('woocommerce_checkout_update_order_meta', 'yprint_save_vat_with_order');

/**
 * Aktualisiert den Checkout mit Benutzerdaten aus den anderen Einstellungen
 */
function yprint_checkout_use_saved_user_data() {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    
    // Prüfen ob alternative Rechnungs-E-Mail eingestellt ist
    $alt_billing_email = get_user_meta($user_id, 'alt_billing_email', true);
    if (!empty($alt_billing_email)) {
        // Im Checkout verwenden
        add_filter('woocommerce_checkout_get_value', function($value, $input) use ($alt_billing_email) {
            if ($input === 'billing_email') {
                return $alt_billing_email;
            }
            return $value;
        }, 10, 2);
        
        // Bei Bestellungen automatisch setzen
        add_filter('woocommerce_email_recipient_customer_invoice', function($recipient, $order) use ($alt_billing_email) {
            if ($order) {
                return $alt_billing_email;
            }
            return $recipient;
        }, 10, 2);
    }
    
    // Hier können weitere Anpassungen je nach Bedarf hinzugefügt werden
}
add_action('woocommerce_before_checkout_form', 'yprint_checkout_use_saved_user_data');

/**
 * Force Logout AJAX Handler für E-Mail-Änderung
 */
function yprint_force_logout() {
    check_ajax_referer('force_logout_nonce', 'security');
    
    wp_logout();
    wp_clear_auth_cookie();
    wp_send_json_success();
    wp_die();
}
add_action('wp_ajax_custom_force_logout', 'yprint_force_logout');

/**
 * Funktion für E-Mail-Ablehnungsverarbeitung (Billing)
 */
function yprint_handle_billing_email_rejection() {
    if (isset($_GET['action']) && $_GET['action'] === 'reject_billing_email' && 
        isset($_GET['token']) && isset($_GET['user_id'])) {
        
        $user_id = intval($_GET['user_id']);
        $token = sanitize_text_field($_GET['token']);
        $stored_token = get_user_meta($user_id, 'billing_email_verification_token', true);
        
        if ($token === $stored_token) {
            // Token löschen
            delete_user_meta($user_id, 'billing_email_verification_token');
            
            // Betroffener Benutzer
            $user = get_userdata($user_id);
            $rejected_email = get_user_meta($user_id, 'alt_billing_email', true);
            
            // Ursprüngliche Benutzer-E-Mail wiederherstellen
            update_user_meta($user_id, 'billing_email', $user->user_email);
            delete_user_meta($user_id, 'alt_billing_email');
            
            // Benachrichtigung an Administratoren senden
$admin_message_content = sprintf(
    'Eine Rechnungs-E-Mail-Änderung wurde abgelehnt:<br><br>
    Benutzer: %s (ID: %d)<br>
    Abgelehnte E-Mail: %s<br>
    Ursprüngliche E-Mail: %s<br><br>
    Bitte prüfen Sie den Fall.',
    $user->display_name,
    $user_id,
    $rejected_email,
    $user->user_email
);
$admin_message = yprint_get_email_template('Rechnungs-E-Mail-Änderung abgelehnt', 'Admin', $admin_message_content);
            
            $headers = array('Content-Type: text/html; charset=UTF-8');
            wp_mail('max@yprint.de', 'Rechnungs-E-Mail-Änderung abgelehnt', $admin_message, $headers);
            
            // Benutzer auf eine Bestätigungsseite weiterleiten
            wp_safe_redirect(home_url('/email-ablehnung-bestaetigt/'));
            exit;
        }
    }
}
add_action('init', 'yprint_handle_billing_email_rejection');

/**
 * Integriere die alternativen Rechnungs-E-Mails in WooCommerce
 */
function yprint_update_order_billing_email($order_id) {
    $order = wc_get_order($order_id);
    if (!$order) return;
    
    $user_id = $order->get_user_id();
    if (!$user_id) return;
    
    $alt_billing_email = get_user_meta($user_id, 'alt_billing_email', true);
    if (!empty($alt_billing_email)) {
        $order->set_billing_email($alt_billing_email);
        $order->save();
    }
}
add_action('woocommerce_checkout_update_order_meta', 'yprint_update_order_billing_email');

/**
 * Änderungen für abweichende Rechnungsadresse im Checkout
 */
function yprint_copy_billing_data_to_different_billing() {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    
    // Wenn Unternehmerstatus im Profil gesetzt ist, auch im Checkout aktivieren
    $is_company = get_user_meta($user_id, 'is_company', true);
    if ($is_company) {
        ?>
        <script>
        jQuery(document).ready(function($) {
            // Unternehmerfeld im Checkout aktivieren, wenn in Einstellungen gesetzt
            $('#different_billing').prop('checked', true).trigger('change');
            
            // Unternehmensinformationen im Checkout anzeigen
            if ($('#different_billing_company').length) {
                $('#different_billing_company').val('<?php echo esc_js(get_user_meta($user_id, 'billing_company', true)); ?>');
            }
            
            if ($('#billing_vat').length) {
                $('#billing_vat').val('<?php echo esc_js(get_user_meta($user_id, 'billing_vat', true)); ?>');
            }
        });
        </script>
        <?php
    }
}
add_action('woocommerce_before_checkout_form', 'yprint_copy_billing_data_to_different_billing');

/**
 * Integration der Adresssuche in den Checkout
 */
function yprint_add_address_search_to_checkout() {
    ?>
    <script>
    jQuery(document).ready(function($) {
        const API_KEY = 'xPlTGXIrjg1O6Oea3e2gvo5lrN-iO1gT47Sc-VojWdU';
        
        // Checkout Form Style anpassen
        $('select.select2-hidden-accessible').css({
            'background-color': '#FFF',
            'border': '1px solid #D1D1D6',
            'border-radius': '6px'
        });
        
        // Checkout Adresssuche hinzufügen
        addAddressSearch('billing');
        addAddressSearch('shipping');
        
        function addAddressSearch(addressType) {
            // Input-Feld erstellen
            const searchField = `
                <div class="form-row form-row-wide address-search">
                    <label>Adresse suchen</label>
                    <input type="text" id="address_search_${addressType}" placeholder="Adresse eingeben..." class="input-text" style="width: 100%; margin-bottom: 10px;">
                    <div id="${addressType}_suggestions" style="display: none; position: absolute; z-index: 1000; background: white; width: 100%; border: 1px solid #ddd; max-height: 200px; overflow-y: auto;"></div>
                </div>
            `;
            
            // Vor das erste Adressfeld einfügen
            $(`#${addressType}_address_1_field`).before(searchField);
            
            // Event-Handler für Adresssuche
            $(`#address_search_${addressType}`).on('input', function() {
                const query = $(this).val();
                if (query.length < 3) {
                    $(`#${addressType}_suggestions`).hide();
                    return;
                }
                
                // HERE API-Abfrage
                $.ajax({
                    url: 'https://geocode.search.hereapi.com/v1/geocode',
                    data: {
                        q: query,
                        apiKey: API_KEY,
                        limit: 5,
                        lang: 'de',
                        in: 'countryCode:DEU,AUT'
                    },
                    type: 'GET',
                    success: function(data) {
                        const $suggestions = $(`#${addressType}_suggestions`);
                        $suggestions.empty();
                        
                        if (data && data.items && data.items.length > 0) {
                            data.items.forEach(function(item) {
                                const address = item.address;
                                const mainLine = [
                                    address.street,
                                    address.houseNumber,
                                    address.postalCode,
                                    address.city
                                ].filter(Boolean).join(' ');
                                
                                const secondaryLine = [
                                    address.district,
                                    address.state,
                                    address.countryName
                                ].filter(Boolean).join(', ');
                                
                                const $suggestion = $('<div>')
                                    .css({
                                        'padding': '10px',
                                        'cursor': 'pointer',
                                        'border-bottom': '1px solid #f0f0f0'
                                    })
                                    .hover(
                                        function() { $(this).css('background-color', '#f5f5f5'); },
                                        function() { $(this).css('background-color', ''); }
                                    )
                                    .append($('<div>').css('font-weight', 'bold').text(mainLine))
                                    .append($('<div>').css('font-size', '0.9em', 'color', '#666').text(secondaryLine))
                                    .data('address', address);
                                
                                $suggestion.on('click', function() {
                                    const address = $(this).data('address');
                                    
                                    // Straße und Hausnummer trennen
                                    const street = address.street || '';
                                    const houseNumber = address.houseNumber || '';
                                    
                                    // Felder befüllen
                                    $(`#${addressType}_address_1`).val(street);
                                    $(`#${addressType}_address_2`).val(houseNumber);
                                    $(`#${addressType}_postcode`).val(address.postalCode || '');
                                    $(`#${addressType}_city`).val(address.city || '');
                                    
                                    // Land setzen
                                    if (address.countryCode) {
                                        const countryCode = address.countryCode.toUpperCase();
                                        $(`#${addressType}_country`).val(countryCode).trigger('change');
                                    }
                                    
                                    $suggestions.hide();
                                    $(`#address_search_${addressType}`).val('');
                                });
                                
                                $suggestions.append($suggestion);
                            });
                            
                            $suggestions.show();
                        }
                    }
                });
            });
            
            // Klick außerhalb schließt Vorschläge
            $(document).on('click', function(e) {
                if (!$(e.target).closest(`#address_search_${addressType}, #${addressType}_suggestions`).length) {
                    $(`#${addressType}_suggestions`).hide();
                }
            });
        }
    });
    </script>
    <style>
    /* Checkout-Styles für Adresssuche */
    .form-row.address-search {
        position: relative;
        margin-bottom: 15px !important;
    }
    
    #billing_suggestions div, 
    #shipping_suggestions div {
        margin-bottom: 0 !important;
    }
    
    /* Select-Felder anpassen */
    .select2-container--default .select2-selection--single {
        background-color: #FFF !important;
        border: 1px solid #D1D1D6 !important;
        border-radius: 6px !important;
        height: auto !important;
        padding: 8px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px !important;
    }
    </style>
    <?php
}
add_action('woocommerce_before_checkout_form', 'yprint_add_address_search_to_checkout');

/**
 * Initialisiert das Einstellungssystem
 */
function yprint_init_settings_system() {
    // Alle benötigten Shortcodes registrieren
    add_shortcode('yprint_user_settings', 'yprint_user_settings_shortcode');
    add_shortcode('yprint_personal_settings', 'yprint_personal_settings_shortcode');
    add_shortcode('yprint_billing_settings', 'yprint_billing_settings_shortcode');
    add_shortcode('yprint_shipping_settings', 'yprint_shipping_settings_shortcode');
    
    // Overlay-Styles für die Benachrichtigungen
    add_action('wp_head', 'yprint_add_overlay_styles');
}
add_action('init', 'yprint_init_settings_system');

/**
 * Overlay-Styles im Header ausgeben
 */
function yprint_add_overlay_styles() {
    ?>
    <style>
    .yprint-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 99999;
        justify-content: center;
        align-items: center;
    }
    
    .yprint-overlay-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    </style>
    <?php
}

/**
 * Benutzergerechte Fehlermeldungen im Checkout
 */
function yprint_customize_validation_messages($fields) {
    // Benutzerfreundlichere Fehlermeldungen
    $fields['billing']['billing_first_name']['required_message'] = 'Bitte gib deinen Vornamen ein';
    $fields['billing']['billing_last_name']['required_message'] = 'Bitte gib deinen Nachnamen ein';
    $fields['billing']['billing_address_1']['required_message'] = 'Bitte gib deine Straße ein';
    $fields['billing']['billing_postcode']['required_message'] = 'Bitte gib deine PLZ ein';
    $fields['billing']['billing_city']['required_message'] = 'Bitte gib deine Stadt ein';
    
    $fields['shipping']['shipping_first_name']['required_message'] = 'Bitte gib deinen Vornamen ein';
    $fields['shipping']['shipping_last_name']['required_message'] = 'Bitte gib deinen Nachnamen ein';
    $fields['shipping']['shipping_address_1']['required_message'] = 'Bitte gib deine Straße ein';
    $fields['shipping']['shipping_postcode']['required_message'] = 'Bitte gib deine PLZ ein';
    $fields['shipping']['shipping_city']['required_message'] = 'Bitte gib deine Stadt ein';
    
    return $fields;
}
add_filter('woocommerce_checkout_fields', 'yprint_customize_validation_messages', 20);

/**
 * Synchronisiere Benutzereinstellungen mit dem Checkout
 * 
 * Diese Funktion sorgt dafür, dass die im Benutzerprofil gespeicherten Daten
 * zum Checkout übertragen werden und umgekehrt.
 */
function yprint_sync_user_settings_with_checkout($order_id) {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    $order = wc_get_order($order_id);
    
    // Unternehmensstatus prüfen und speichern
    $is_company_in_order = !empty($order->get_billing_company());
    update_user_meta($user_id, 'is_company', $is_company_in_order);
    
    if ($is_company_in_order) {
        // USt-ID speichern
        $vat = get_post_meta($order_id, '_billing_vat', true);
        if (!empty($vat)) {
            update_user_meta($user_id, 'billing_vat', $vat);
        }
    }
    
    // Ebenso für Shipping Company
    $is_company_shipping_in_order = !empty($order->get_shipping_company());
    update_user_meta($user_id, 'is_company_shipping', $is_company_shipping_in_order);
    
    // Alternative Rechnungs-E-Mail synchronisieren
    if (isset($_POST['different_billing_email']) && isset($_POST['alt_billing_email']) && 
        !empty($_POST['alt_billing_email'])) {
        
        $alt_email = sanitize_email($_POST['alt_billing_email']);
        update_user_meta($user_id, 'alt_billing_email', $alt_email);
        update_user_meta($user_id, 'billing_email', $alt_email);
    }
}
add_action('woocommerce_checkout_update_order_meta', 'yprint_sync_user_settings_with_checkout');

/**
 * Behandlung von Bedingungen für abweichende Rechnungsadressen im Checkout
 */
function yprint_handle_different_billing_fields() {
    if (!is_user_logged_in()) return;
    
    $user_id = get_current_user_id();
    
    // Prüfen ob verschiedene Elemente gesetzt sind
    $is_company = get_user_meta($user_id, 'is_company', true);
    $billing_company = get_user_meta($user_id, 'billing_company', true);
    $billing_vat = get_user_meta($user_id, 'billing_vat', true);
    
    ?>
    <script>
    jQuery(document).ready(function($) {
        const isCompany = <?php echo $is_company ? 'true' : 'false'; ?>;
        
        if (isCompany) {
            // Wenn Benutzer Unternehmer ist, abweichende Rechnungsadresse-Checkbox aktivieren
            if ($('#different_billing').length) {
                $('#different_billing').prop('checked', true).trigger('change');
            }
            
            // Unternehmensdaten vorausfüllen
            <?php if (!empty($billing_company)) : ?>
            if ($('#billing_company').length) {
                $('#billing_company').val('<?php echo esc_js($billing_company); ?>');
            }
            <?php endif; ?>
            
            <?php if (!empty($billing_vat)) : ?>
            if ($('#billing_vat').length) {
                $('#billing_vat').val('<?php echo esc_js($billing_vat); ?>');
            }
            <?php endif; ?>
        }
    });
    </script>
    <?php
}
add_action('woocommerce_before_checkout_form', 'yprint_handle_different_billing_fields');

//----------------------------------------------------------------------------------------------------------------------------------------

/**
 * Stellt sicher, dass die print_design-Daten während des Checkouts erhalten bleiben
 */
add_filter('woocommerce_checkout_create_order_line_item', 'yprint_add_design_data_to_order_item', 10, 4);
function yprint_add_design_data_to_order_item($item, $cart_item_key, $values, $order) {
    // Überprüfen, ob es print_design-Daten gibt
    if (isset($values['print_design']) && !empty($values['print_design'])) {
        $design = $values['print_design'];
        
        // Debugging: Protokolliere die Design-Daten
        error_log("Verarbeite Design-Daten für Bestellung: " . print_r($design, true));
        
        // Design-Metadaten zum Bestelleintrag hinzufügen
        foreach ($design as $meta_key => $meta_value) {
            if (is_array($meta_value)) {
                $meta_value = json_encode($meta_value);
            }
            $item->add_meta_data('_design_' . $meta_key, $meta_value);
        }
        
        // Setze die Hauptinformationen für die einfache Anzeige in der Bestellansicht
        $item->add_meta_data('_design_id', $design['design_id'] ?? '');
        $item->add_meta_data('_design_name', $design['name'] ?? '');
        $item->add_meta_data('_design_color', $design['variation_name'] ?? '');
        $item->add_meta_data('_design_size', $design['size_name'] ?? '');
        $item->add_meta_data('_design_preview_url', $design['preview_url'] ?? '');
        
        // Stelle sicher, dass diese Informationen auch für das OctoPrint Plugin verfügbar sind
        $item->add_meta_data('_has_print_design', 'yes');
        
        // Zusätzliche spezifische Meta-Daten für Octo Plugin
        $item->add_meta_data('print_design', $design);
        
        // Speichere den Item, um sicherzustellen, dass die Meta-Daten persistiert werden
        $item->save();
    }
}

function yprint_consolidate_cart_items() {
    if (!class_exists('WooCommerce')) {
        return;
    }
    
    $cart = WC()->cart;
    $cart_items = $cart->get_cart();
    
    if (empty($cart_items)) {
        return;
    }
    
    // Produkte nach ID gruppieren
    $products_by_id = array();
    
    foreach ($cart_items as $cart_item_key => $cart_item) {
        $product_id = $cart_item['product_id'];
        $variation_id = isset($cart_item['variation_id']) ? $cart_item['variation_id'] : 0;
        $variation_attributes = isset($cart_item['variation']) ? $cart_item['variation'] : array();
        
        // Spezielle Behandlung für print_design
        if (isset($cart_item['print_design'])) {
            // Bei print_design Produkten behandeln wir jedes Design als einzigartiges Produkt
            // und überspringen die Konsolidierung, da diese Produkte immer einzigartig sein sollen
            continue;
        } else {
            // ALLE benutzerdefinierten Daten berücksichtigen
            $custom_data = array();
            foreach ($cart_item as $key => $value) {
                // Alle Nicht-Standardschlüssel als benutzerdefinierte Daten behandeln
                if (!in_array($key, array('product_id', 'variation_id', 'variation', 'quantity', 'data', 'key'))) {
                    $custom_data[$key] = $value;
                }
            }
            
            // Eindeutiger Schlüssel für Produkt + Variation + Custom Data
            $unique_key = $product_id . '_' . $variation_id . '_' . md5(serialize($variation_attributes) . serialize($custom_data));
        }
        
        if (!isset($products_by_id[$unique_key])) {
            $products_by_id[$unique_key] = array(
                'keys' => array($cart_item_key),
                'quantity' => $cart_item['quantity'],
                'product_id' => $product_id,
                'variation_id' => $variation_id,
                'variation' => $variation_attributes,
                'custom_data' => isset($custom_data) ? $custom_data : array()
            );
        } else {
            $products_by_id[$unique_key]['keys'][] = $cart_item_key;
            $products_by_id[$unique_key]['quantity'] += $cart_item['quantity'];
        }
    }
    
    // Doppelte Einträge konsolidieren
    $changes = false;
    foreach ($products_by_id as $product_data) {
        if (count($product_data['keys']) > 1) {
            $changes = true;
            // Alle Einträge außer dem ersten entfernen
            $keep_key = array_shift($product_data['keys']);
            
            // Menge beim ersten Eintrag aktualisieren
            $cart->set_quantity($keep_key, $product_data['quantity'], true); // true = Berechne Gesamtsummen neu
            
            // Übrige Einträge entfernen
            foreach ($product_data['keys'] as $remove_key) {
                $cart->remove_cart_item($remove_key);
            }
        }
    }
    
    return $changes;
}

// Ajax-Endpunkt für Warenkorb-Konsolidierung registrieren
add_action('wp_ajax_yprint_consolidate_cart', 'yprint_ajax_consolidate_cart');
add_action('wp_ajax_nopriv_yprint_consolidate_cart', 'yprint_ajax_consolidate_cart');

add_action('woocommerce_add_to_cart', 'yprint_after_add_to_cart', 20, 6);

function yprint_after_add_to_cart($cart_item_key, $product_id, $quantity, $variation_id, $variation, $cart_item_data) {
    // Verhindert rekursive Aufrufe
    static $is_processing = false;
    
    if ($is_processing) {
        return;
    }
    
    $is_processing = true;
    
    // Entferne den Hook temporär
    remove_action('woocommerce_add_to_cart', 'yprint_after_add_to_cart', 20);
    
    // Prüfe auf print_design Daten im aktuellen Produkt
    $has_print_design = isset($cart_item_data['print_design']);
    
    // Konsolidiere den Warenkorb, aber nur wenn es kein Print-Design-Produkt ist
    if (!$has_print_design) {
        yprint_consolidate_cart_items();
    } else {
        // Wenn es ein Print-Design-Produkt ist, markieren wir es als solches
        $current_cart_item = WC()->cart->get_cart_item($cart_item_key);
        if ($current_cart_item && isset($current_cart_item['print_design'])) {
            // Speichere das Design-Flag für dieses Produkt
            WC()->cart->cart_contents[$cart_item_key]['_is_design_product'] = true;
            
            // Generiere einen eindeutigen Schlüssel für dieses Design
            if (isset($current_cart_item['print_design']['design_id'])) {
                $unique_design_key = md5(json_encode($current_cart_item['print_design']));
                WC()->cart->cart_contents[$cart_item_key]['unique_design_key'] = $unique_design_key;
            }
            
            // Persistiere den Warenkorb
            WC()->cart->set_session();
        }
    }
    
    // Füge den Hook wieder hinzu
    add_action('woocommerce_add_to_cart', 'yprint_after_add_to_cart', 20, 6);
    
    // Event für AJAX-Aktualisierung triggern
    do_action('yprint_cart_updated');
    
    $is_processing = false;
}

/**
 * Designdaten in den Bestelldetails anzeigen
 */
add_action('woocommerce_order_item_meta_end', 'yprint_display_design_data_in_order', 10, 3);
function yprint_display_design_data_in_order($item_id, $item, $order) {
    // Überprüfen, ob es sich um ein Print-Design-Produkt handelt
    if ($item->get_meta('_has_print_design') === 'yes') {
        echo '<div class="print-design-info" style="margin-top: 10px; padding-top: 10px; border-top: 1px dotted #ccc;">';
        echo '<p><strong>Design-Details:</strong></p>';
        
        $design_name = $item->get_meta('_design_name');
        if (!empty($design_name)) {
            echo '<p>Name: ' . esc_html($design_name) . '</p>';
        }
        
        $design_color = $item->get_meta('_design_color');
        if (!empty($design_color)) {
            echo '<p>Farbe: ' . esc_html($design_color) . '</p>';
        }
        
        $design_size = $item->get_meta('_design_size');
        if (!empty($design_size)) {
            echo '<p>Größe: ' . esc_html($design_size) . '</p>';
        }
        
        $preview_url = $item->get_meta('_design_preview_url');
        if (!empty($preview_url)) {
            echo '<p><img src="' . esc_url($preview_url) . '" style="max-width: 100px; height: auto;" alt="Vorschau"></p>';
        }
        
        echo '</div>';
    }
}

/**
 * Designdaten in Bestell-E-Mails anzeigen
 */
add_action('woocommerce_email_order_item_meta', 'yprint_display_design_data_in_email', 10, 4);
function yprint_display_design_data_in_email($item_id, $item, $order, $plain_text) {
    if ($plain_text) {
        return; // Überspringe einfachen Text und füge nur HTML hinzu
    }
    
    // Überprüfen, ob es sich um ein Print-Design-Produkt handelt
    if ($item->get_meta('_has_print_design') === 'yes') {
        echo '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px dotted #ccc;">';
        echo '<p><strong>Design-Details:</strong></p>';
        
        $design_name = $item->get_meta('_design_name');
        if (!empty($design_name)) {
            echo '<p>Name: ' . esc_html($design_name) . '</p>';
        }
        
        $design_color = $item->get_meta('_design_color');
        if (!empty($design_color)) {
            echo '<p>Farbe: ' . esc_html($design_color) . '</p>';
        }
        
        $design_size = $item->get_meta('_design_size');
        if (!empty($design_size)) {
            echo '<p>Größe: ' . esc_html($design_size) . '</p>';
        }
        
        echo '</div>';
    }
}

/**
 * Erstellt eine WooCommerce-Bestellung aus den Checkout-Daten
 */
function create_woocommerce_order($checkout_data) {
    // Neues Bestellobjekt erstellen
    $order = wc_create_order();
    
    // Den aktuellen Benutzer explizit als Kunden für die Bestellung festlegen
    $user_id = get_current_user_id();
    if ($user_id > 0) {
        $order->set_customer_id($user_id);
    }
    
    // Produkte aus dem Warenkorb zur Bestellung hinzufügen
    foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
        // Produkt zur Bestellung hinzufügen
        $item_id = $order->add_product(
            $cart_item['data'],
            $cart_item['quantity'],
            array(
                'subtotal' => $cart_item['line_subtotal'],
                'total' => $cart_item['line_total'],
                'subtotal_tax' => $cart_item['line_subtotal_tax'],
                'total_tax' => $cart_item['line_tax']
            )
        );
        
        // Überprüfen, ob es ein print_design Produkt ist und die Meta-Daten hinzufügen
        if (isset($cart_item['print_design']) && !empty($cart_item['print_design'])) {
            $item = $order->get_item($item_id);
            $design = $cart_item['print_design'];
            
            // Design-Metadaten zum Bestelleintrag hinzufügen
            if ($item) {
                // Das komplette Design-Objekt als Meta speichern für OctoPrint
                $item->add_meta_data('print_design', $design);
                
                foreach ($design as $meta_key => $meta_value) {
                    if (is_array($meta_value)) {
                        $meta_value = json_encode($meta_value);
                    }
                    $item->add_meta_data('_design_' . $meta_key, $meta_value);
                }
                
                // Setze die Hauptinformationen für die einfache Anzeige in der Bestellansicht
                $item->add_meta_data('_design_id', $design['design_id'] ?? '');
                $item->add_meta_data('_design_name', $design['name'] ?? '');
                $item->add_meta_data('_design_color', $design['variation_name'] ?? '');
                $item->add_meta_data('_design_size', $design['size_name'] ?? '');
                $item->add_meta_data('_design_preview_url', $design['preview_url'] ?? '');
                $item->add_meta_data('_has_print_design', 'yes');
                
                // Speichern der Item-Daten
                $item->save();
            }
        }
        
        // Alle anderen benutzerdefinierten Daten hinzufügen
        foreach ($cart_item as $key => $value) {
            if (!in_array($key, array('product_id', 'variation_id', 'variation', 'quantity', 'data', 'key', 'line_subtotal', 'line_total', 'line_subtotal_tax', 'line_tax', 'print_design'))) {
                if (is_array($value)) {
                    $value = json_encode($value);
                }
                $item = $order->get_item($item_id);
                if ($item) {
                    $item->add_meta_data('_' . $key, $value);
                }
            }
        }
    }
    
    // Versandkosten hinzufügen
    foreach (WC()->shipping->get_packages() as $package_key => $package) {
        if (isset($package['rates'][WC()->session->get('chosen_shipping_methods')[$package_key]])) {
            $shipping_rate = $package['rates'][WC()->session->get('chosen_shipping_methods')[$package_key]];
            $item = new WC_Order_Item_Shipping();
            $item->set_shipping_rate($shipping_rate);
            $item->set_order_id($order->get_id());
            $item->save();
            $order->add_item($item);
        }
    }
    
    // Rabatte hinzufügen
    if (WC()->cart->get_coupon_discount_totals()) {
        foreach (WC()->cart->get_coupon_discount_totals() as $code => $amount) {
            $item = new WC_Order_Item_Coupon();
            $item->set_code($code);
            $item->set_discount($amount);
            $order->add_item($item);
        }
    }
    
    // Lieferadresse setzen
    if (!empty($checkout_data['shipping_address'])) {
        $order->set_shipping_first_name($checkout_data['shipping_address']['first_name'] ?? '');
        $order->set_shipping_last_name($checkout_data['shipping_address']['last_name'] ?? '');
        $order->set_shipping_address_1($checkout_data['shipping_address']['address_1'] ?? '');
        $order->set_shipping_address_2($checkout_data['shipping_address']['address_2'] ?? '');
        $order->set_shipping_city($checkout_data['shipping_address']['city'] ?? '');
        $order->set_shipping_postcode($checkout_data['shipping_address']['postcode'] ?? '');
        $order->set_shipping_country($checkout_data['shipping_address']['country'] ?? 'DE');
    }
    
    // Rechnungsadresse setzen
    if (!empty($checkout_data['different_billing']) && $checkout_data['different_billing'] && !empty($checkout_data['different_billing_address'])) {
        // Abweichende Rechnungsadresse verwenden
        $order->set_billing_first_name($checkout_data['different_billing_address']['different_billing_first_name'] ?? '');
        $order->set_billing_last_name($checkout_data['different_billing_address']['different_billing_last_name'] ?? '');
        $order->set_billing_email($checkout_data['different_billing_address']['different_billing_email'] ?? '');
        $order->set_billing_address_1($checkout_data['different_billing_address']['different_billing_address_1'] ?? '');
        $order->set_billing_address_2($checkout_data['different_billing_address']['different_billing_address_2'] ?? '');
        $order->set_billing_city($checkout_data['different_billing_address']['different_billing_city'] ?? '');
        $order->set_billing_postcode($checkout_data['different_billing_address']['different_billing_postcode'] ?? '');
        $order->set_billing_country($checkout_data['different_billing_address']['different_billing_country'] ?? 'DE');
    } else {
        // Lieferadresse als Rechnungsadresse verwenden
        $order->set_billing_first_name($checkout_data['shipping_address']['first_name'] ?? '');
        $order->set_billing_last_name($checkout_data['shipping_address']['last_name'] ?? '');
        $order->set_billing_email(wp_get_current_user()->user_email ?: '');
        $order->set_billing_address_1($checkout_data['shipping_address']['address_1'] ?? '');
        $order->set_billing_address_2($checkout_data['shipping_address']['address_2'] ?? '');
        $order->set_billing_city($checkout_data['shipping_address']['city'] ?? '');
        $order->set_billing_postcode($checkout_data['shipping_address']['postcode'] ?? '');
        $order->set_billing_country($checkout_data['shipping_address']['country'] ?? 'DE');
    }
    
    // Zahlungsmethode setzen
    if (!empty($checkout_data['payment_method'])) {
        $order->set_payment_method($checkout_data['payment_method']);
    }
    
    // Bestellsummen berechnen
    $order->calculate_totals();
    
    // Bestellung speichern und die ID zurückgeben
    $order->save();
    
    return $order->get_id();
}

/**
 * Bearbeitet cart sessions, um sicherzustellen, dass print_design-Daten erhalten bleiben
 */
add_filter('woocommerce_get_cart_item_from_session', 'yprint_get_cart_item_from_session', 10, 2);
function yprint_get_cart_item_from_session($cart_item, $values) {
    if (isset($values['print_design'])) {
        $cart_item['print_design'] = $values['print_design'];
        
        // Markiere das Item als Design-Produkt, damit es nicht konsolidiert wird
        $cart_item['_is_design_product'] = true;
        
        // Stelle sicher, dass der unique_key erhalten bleibt
        if (isset($values['unique_key'])) {
            $cart_item['unique_key'] = $values['unique_key'];
        }
    }
    return $cart_item;
}

// Spezieller Filter für das Persistieren von Design-Daten während des Checkout
add_filter('woocommerce_checkout_create_order_line_item', 'yprint_preserve_design_data_in_order', 20, 4);
function yprint_preserve_design_data_in_order($item, $cart_item_key, $values, $order) {
    // Überprüfe, ob es ein Design-Produkt ist
    if (isset($values['print_design']) && !empty($values['print_design'])) {
        // Speichere die Design-Daten direkt als Meta-Feld für das Octo-Plugin
        $item->update_meta_data('print_design', $values['print_design']);
        
        // Stelle sicher, dass es als Design-Produkt markiert ist
        $item->update_meta_data('_is_design_product', true);
        
        // Speichere auch alle individuellen Design-Parameter als Meta-Daten
        foreach ($values['print_design'] as $key => $value) {
            if (is_array($value) || is_object($value)) {
                $value = wp_json_encode($value);
            }
            $item->update_meta_data('design_' . $key, $value);
        }
    }
}

/**
 * Passt den Preis basierend auf Designdaten an
 */
add_filter('woocommerce_get_cart_item_from_session', 'yprint_update_price_from_session', 20, 2);
function yprint_update_price_from_session($cart_item, $values) {
    if (isset($cart_item['print_design']) && isset($cart_item['print_design']['calculated_price'])) {
        $product = $cart_item['data'];
        
        // Originalpreis speichern, falls nicht gesetzt
        if (!isset($cart_item['original_price'])) {
            $cart_item['original_price'] = $product->get_price();
        }
        
        // Preis basierend auf berechneter Designpreis setzen
        $product->set_price($cart_item['print_design']['calculated_price']);
    }
    
    return $cart_item;
}

/**
 * Passt den Produkttitel im Warenkorb an, um Designinformationen anzuzeigen
 */
add_filter('woocommerce_cart_item_name', 'yprint_modify_cart_item_name', 10, 3);
function yprint_modify_cart_item_name($name, $cart_item, $cart_item_key) {
    if (isset($cart_item['print_design'])) {
        $design = $cart_item['print_design'];
        
        // Designname hinzufügen, falls vorhanden
        if (!empty($design['name'])) {
            $name .= ' - <span class="design-name">' . esc_html($design['name']) . '</span>';
        }
        
        // Variation und Größe hinzufügen, falls vorhanden
        $details = [];
        if (!empty($design['variation_name'])) {
            $details[] = esc_html($design['variation_name']);
        }
        if (!empty($design['size_name'])) {
            $details[] = esc_html($design['size_name']);
        }
        
        if (!empty($details)) {
            $name .= ' <span class="design-details">(' . implode(', ', $details) . ')</span>';
        }
    }
    
    return $name;
}

/**
 * Fügt eine Vorschaubilder-Miniaturansicht zum Warenkorbartikel hinzu
 */
add_filter('woocommerce_cart_item_thumbnail', 'yprint_custom_cart_item_thumbnail', 10, 3);
function yprint_custom_cart_item_thumbnail($thumbnail, $cart_item, $cart_item_key) {
    if (isset($cart_item['print_design']) && !empty($cart_item['print_design']['preview_url'])) {
        $preview_url = $cart_item['print_design']['preview_url'];
        
        // Original-Thumbnail erhalten und darunter Designvorschau anzeigen
        $thumbnail .= '<div class="design-preview" style="margin-top: 5px;"><img src="' . esc_url($preview_url) . '" style="max-width: 50px; height: auto;" alt="Design Preview"></div>';
    }
    
    return $thumbnail;
}

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

/**
 * Lädt die E-Mail-Vorlage und ersetzt die Platzhalter
 * 
 * @param string $headline Die Überschrift der E-Mail
 * @param string $first_name Der Vorname des Empfängers
 * @param string $message Der Nachrichteninhalt
 * @return string Die formatierte E-Mail-Nachricht
 */
function yprint_get_email_template($headline, $first_name, $message) {
    // Vorlage laden
    $template_url = 'https://yprint.de/wp-content/uploads/2025/02/yprint-email-vorlage.html';
    $template = @file_get_contents($template_url);
    
    // Fallback, wenn die Vorlage nicht geladen werden kann
    if (!$template) {
        error_log("E-Mail-Vorlage konnte nicht von {$template_url} geladen werden");
        return $message; // Fallback zur einfachen Nachricht
    }
    
    // Platzhalter ersetzen
    $template = str_replace('{{headline}}', $headline, $template);
    $template = str_replace('{{first_name}}', $first_name, $template);
    $template = str_replace('{{message}}', $message, $template);
    
    return $template;
}


?>
